<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOFA AI Evaluator - San Mateo County FY26-27</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- ExcelJS for formatting-preserving Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        .drop-zone { transition: all 0.3s ease; }
        .drop-zone.dragover { background: #dbeafe; border-color: #3b82f6; transform: scale(1.02); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .ai-thinking { background: linear-gradient(90deg, #f0f9ff, #e0f2fe, #f0f9ff); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .score-btn { transition: all 0.15s ease; }
        .score-btn:hover { transform: translateY(-2px); }
        .score-btn.selected { transform: scale(1.05); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .score-btn:focus { outline: 3px solid #3b82f6; outline-offset: 2px; }
        .typing-indicator span { animation: blink 1.4s infinite both; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }
        .pdf-viewer { max-height: 70vh; overflow-y: auto; }
        .pdf-viewer::-webkit-scrollbar { width: 8px; }
        .pdf-viewer::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .pdf-viewer::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .highlight-text { background: linear-gradient(120deg, #fef08a 0%, #fde047 100%); padding: 2px 4px; border-radius: 2px; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .auto-save-indicator { position: fixed; bottom: 20px; right: 20px; z-index: 50; transition: all 0.3s ease; }
        .toast { position: fixed; top: 20px; right: 20px; z-index: 60; transform: translateX(120%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .impact-positive { color: #059669; }
        .impact-negative { color: #dc2626; }
        .score-change-highlight { animation: scoreHighlight 0.5s ease; }
        @keyframes scoreHighlight { 0%, 100% { background-color: transparent; } 50% { background-color: #fef08a; } }
        .global-review-card { transition: all 0.2s ease; }
        .global-review-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 text-center shadow-2xl">
            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
            <h3 id="loadingTitle" class="text-xl font-bold text-slate-800 mb-2">Processing...</h3>
            <p id="loadingMessage" class="text-slate-600">Please wait while we process your file.</p>
            <div id="loadingProgress" class="mt-4 hidden">
                <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div id="loadingProgressBar" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="loadingProgressText" class="text-sm text-slate-500 mt-2">0%</p>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast bg-white rounded-xl shadow-lg border border-slate-200 p-4 max-w-sm">
        <div class="flex items-start gap-3">
            <div id="toastIcon" class="w-6 h-6 flex-shrink-0"></div>
            <div>
                <p id="toastTitle" class="font-semibold text-slate-800"></p>
                <p id="toastMessage" class="text-sm text-slate-600"></p>
            </div>
            <button onclick="hideToast()" class="text-slate-400 hover:text-slate-600 ml-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Auto-save Indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator hidden">
        <div class="bg-green-100 border border-green-300 text-green-800 px-4 py-2 rounded-lg text-sm flex items-center gap-2 shadow-md">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span>Progress saved</span>
        </div>
    </div>

    <div id="app" class="max-w-6xl mx-auto p-4 md:p-6">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-900 via-blue-800 to-indigo-900 text-white rounded-2xl p-6 mb-6 shadow-xl">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">NOFA AI Evaluator</h1>
                            <p class="text-blue-200 text-sm">Winter FY26-27 • San Mateo County • AI-Assisted Scoring</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="autoAnalyzeHeaderBtn" onclick="autoAnalyzeRemaining()" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-lg text-sm font-medium items-center gap-2 transition-colors hidden" aria-label="Auto-analyze remaining criteria">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        <span class="hidden sm:inline" id="autoAnalyzeBtnText">Auto-Analyze All</span>
                    </button>
                    <button onclick="showSettings()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors" aria-label="Open settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span class="hidden sm:inline">Settings</span>
                    </button>
                    <div id="apiStatus" class="flex items-center gap-2 bg-white/10 px-3 py-2 rounded-lg" role="status" aria-live="polite">
                        <div id="apiDot" class="w-2 h-2 rounded-full bg-red-400" aria-hidden="true"></div>
                        <span id="apiText" class="text-xs">No API Key</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Draft Recovery Banner -->
        <div id="draftBanner" class="hidden mb-6 bg-amber-50 border border-amber-200 rounded-xl p-4">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-amber-800">Unsaved evaluation found</p>
                        <p id="draftInfo" class="text-sm text-amber-700"></p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="discardDraft()" class="px-4 py-2 text-amber-700 hover:bg-amber-100 rounded-lg text-sm font-medium transition-colors">
                        Discard
                    </button>
                    <button onclick="restoreDraft()" class="px-4 py-2 bg-amber-600 text-white rounded-lg text-sm font-medium hover:bg-amber-700 transition-colors">
                        Restore
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent">
            <!-- Will be dynamically populated -->
        </div>
    </div>
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="bg-white rounded-2xl max-w-md w-full shadow-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 overflow-y-auto flex-1">
                <div class="flex items-center justify-between mb-6">
                    <h3 id="settingsTitle" class="text-xl font-bold text-slate-800">Settings</h3>
                    <button onclick="hideSettings()" class="text-slate-400 hover:text-slate-600" aria-label="Close settings">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label for="apiKeyInput" class="block text-sm font-medium text-slate-700 mb-2">Anthropic API Key</label>
                        <div class="relative">
                            <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..."
                                class="w-full px-4 py-3 pr-12 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                                aria-describedby="apiKeyHelp">
                            <button onclick="toggleApiKeyVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600" aria-label="Toggle API key visibility">
                                <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </button>
                        </div>
                        <p id="apiKeyHelp" class="text-xs text-slate-500 mt-2">Your API key is stored locally and only sent to Anthropic's API.</p>
                    </div>

                    <div class="bg-blue-50 rounded-xl p-4">
                        <p class="text-sm font-medium text-blue-800 mb-2">How to get an API key:</p>
                        <ol class="text-sm text-blue-700 space-y-1 list-decimal list-inside">
                            <li>Go to <a href="https://console.anthropic.com" target="_blank" class="underline">console.anthropic.com</a></li>
                            <li>Create an account or sign in</li>
                            <li>Navigate to API Keys</li>
                            <li>Create a new key and copy it here</li>
                        </ol>
                    </div>

                    <div>
                        <label for="reviewerName" class="block text-sm font-medium text-slate-700 mb-2">Reviewer Name</label>
                        <input type="text" id="reviewerName" placeholder="Your name"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label for="reviewerSheet" class="block text-sm font-medium text-slate-700 mb-2">Your Reviewer Role</label>
                        <select id="reviewerSheet" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="Threshold+Scoring - Reviewer 1">Reviewer 1 - Threshold + Scoring</option>
                            <option value="Scoring Sheet - Reviewer 2" selected>Reviewer 2 - Scoring Only</option>
                        </select>
                        <div class="mt-3 p-3 bg-slate-50 rounded-lg text-xs">
                            <p class="font-semibold text-slate-700 mb-2">Understanding Your Role:</p>
                            <div class="space-y-2 text-slate-600">
                                <div class="flex items-start gap-2">
                                    <span class="text-blue-600 font-bold">R1:</span>
                                    <span><strong>Reviewer 1</strong> evaluates both <em>Threshold Criteria</em> (pass/fail eligibility) AND <em>Scoring Criteria</em></span>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-green-600 font-bold">R2:</span>
                                    <span><strong>Reviewer 2</strong> evaluates <em>Scoring Criteria</em> only (threshold already completed by R1)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Template Configuration Section -->
                <div class="mt-6 pt-4 border-t border-slate-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-700">Template Profile</p>
                            <p class="text-xs text-slate-500" id="activeProfileDisplay">San Mateo NOFA FY26-27 (Default)</p>
                        </div>
                        <button onclick="hideSettings(); showTemplateConfig();" class="px-3 py-1.5 text-sm border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50 transition-colors">
                            Configure
                        </button>
                    </div>
                </div>

                <!-- Vision Analysis Section -->
                <div class="mt-6 pt-4 border-t border-slate-200">
                    <p class="text-sm font-medium text-slate-700 mb-3">Vision Analysis (Charts & Graphs)</p>

                    <!-- Auto-detect toggle -->
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm text-slate-600">Auto-detect visual content</p>
                            <p class="text-xs text-slate-400">Automatically enable vision when charts/graphs detected</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="visionAutoDetectToggle" class="sr-only peer" onchange="toggleVisionAutoDetect()">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>

                    <!-- Manual toggle -->
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-600">Always use vision analysis</p>
                            <p class="text-xs text-slate-400">Force vision on for all documents</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="visionToggle" class="sr-only peer" onchange="toggleVisionAnalysis()">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <div class="mt-3 p-2 bg-blue-50 rounded-lg">
                        <p class="text-xs text-blue-700"><strong>How it works:</strong> The system scans PDFs for pages with charts, graphs, tables, or low-text content. When detected, vision analysis automatically activates to analyze visual elements.</p>
                        <p class="text-xs mt-1" id="visionStatusText">Status: Auto-detect enabled</p>
                    </div>
                </div>

                <!-- Consistency Cache Section -->
                <div class="mt-6 pt-4 border-t border-slate-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-700">AI Response Cache</p>
                            <p class="text-xs text-slate-500">Cached responses ensure consistent scoring for the same document</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="clearResponseCache(); hideSettings();" class="px-3 py-1.5 text-sm border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50 transition-colors" title="Clear localStorage cache only - keeps current session data">
                                Clear Cache
                            </button>
                            <button onclick="clearAllAndReset();" class="px-3 py-1.5 text-sm border border-red-300 text-red-700 rounded-lg hover:bg-red-50 transition-colors" title="Clear cache AND reset current AI suggestions for fresh re-analysis">
                                Full Reset
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mt-2">Clear Cache: removes stored responses. Full Reset: also clears current session's AI suggestions for complete re-analysis.</p>
                </div>

                <!-- Admin Diagnostics Section -->
                <div class="mt-6 pt-4 border-t border-slate-200">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-medium text-slate-700">Admin Diagnostics</p>
                            <p class="text-xs text-slate-500">Document analysis statistics</p>
                        </div>
                        <button onclick="toggleDiagnosticsPanel()" class="px-3 py-1.5 text-sm border border-slate-300 text-slate-600 rounded-lg hover:bg-slate-50 transition-colors">
                            <span id="diagnosticsToggleText">Show</span>
                        </button>
                    </div>
                    <div id="diagnosticsPanel" class="hidden bg-slate-50 rounded-lg p-3 text-xs font-mono space-y-1">
                        <div class="grid grid-cols-2 gap-2">
                            <div class="text-slate-600">Total Pages:</div>
                            <div id="diagTotalPages" class="text-slate-800 font-semibold">-</div>
                            <div class="text-slate-600">Total Characters:</div>
                            <div id="diagTotalChars" class="text-slate-800 font-semibold">-</div>
                            <div class="text-slate-600">Attachments Start:</div>
                            <div id="diagAttachStart" class="text-slate-800 font-semibold">-</div>
                        </div>
                        <div class="border-t border-slate-200 my-2 pt-2">
                            <div class="text-slate-500 mb-1">AI Analysis Coverage:</div>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="text-slate-600">Main Content:</div>
                                <div id="diagMainChars" class="text-green-700 font-semibold">-</div>
                                <div class="text-slate-600">Attachments:</div>
                                <div id="diagAttachChars" class="text-green-700 font-semibold">-</div>
                                <div class="text-slate-600">Total to AI:</div>
                                <div id="diagTotalToAI" class="text-blue-700 font-semibold">-</div>
                                <div class="text-slate-600">Coverage:</div>
                                <div id="diagCoverage" class="text-blue-700 font-semibold">-</div>
                            </div>
                        </div>
                        <div class="border-t border-slate-200 my-2 pt-2">
                            <div class="grid grid-cols-2 gap-2">
                                <div class="text-slate-600">Criteria Analyzed:</div>
                                <div id="diagCriteriaCount" class="text-slate-800 font-semibold">-</div>
                                <div class="text-slate-600">Last Analysis:</div>
                                <div id="diagLastAnalysis" class="text-slate-800 font-semibold">-</div>
                                <div class="text-slate-600">Vision Analysis:</div>
                                <div id="diagVisionStatus" class="text-slate-500">Disabled</div>
                            </div>
                        </div>
                        <button onclick="copyDiagnosticsToClipboard()" class="w-full mt-2 px-2 py-1 text-xs bg-slate-200 hover:bg-slate-300 rounded transition-colors">
                            Copy to Clipboard
                        </button>
                    </div>
                </div>

            </div>
            <!-- Fixed footer with buttons - always visible -->
            <div class="p-4 border-t border-slate-200 bg-white rounded-b-2xl flex-shrink-0">
                <div class="flex gap-3">
                    <button onclick="clearApiKey()" class="flex-1 px-4 py-3 border border-slate-300 rounded-xl text-slate-600 hover:bg-slate-50 transition-colors">
                        Clear Key
                    </button>
                    <button onclick="saveSettings()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors">
                        Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Configuration Modal -->
    <div id="templateConfigModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="templateConfigTitle">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] shadow-2xl flex flex-col">
            <div class="p-4 border-b border-slate-200 flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="templateConfigTitle" class="text-lg font-bold text-slate-800">Template Configuration</h3>
                        <p class="text-sm text-slate-500">Map Excel cells to scoring fields</p>
                    </div>
                </div>
                <button onclick="hideTemplateConfig()" class="text-slate-400 hover:text-slate-600 p-2" aria-label="Close">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="templateConfigContent" class="flex-1 overflow-y-auto p-6">
                <!-- Template configuration content will be rendered dynamically -->
            </div>
            <div class="p-4 border-t border-slate-200 bg-slate-50 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex gap-2">
                        <select id="templateProfileSelector" class="px-3 py-2 border border-slate-300 rounded-lg text-sm" onchange="loadSelectedTemplateProfile()">
                            <!-- Options populated dynamically -->
                        </select>
                        <button onclick="createNewTemplateProfile()" class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm hover:bg-purple-200 transition-colors">
                            + New Profile
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="hideTemplateConfig()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-100 text-sm transition-colors">
                            Cancel
                        </button>
                        <button onclick="saveTemplateConfig()" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors">
                            Save Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdfViewerModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="pdfViewerTitle">
        <div class="bg-white rounded-2xl max-w-5xl w-full max-h-[90vh] shadow-2xl flex flex-col">
            <div class="p-4 border-b border-slate-200 flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-3">
                    <button id="backToEvidenceBtn" onclick="backToEvidenceModal()" class="hidden px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        Back to Evidence
                    </button>
                    <div>
                        <h3 id="pdfViewerTitle" class="text-lg font-bold text-slate-800">Application Document</h3>
                        <p id="pdfViewerContext" class="text-sm text-slate-500">Reviewing relevant section</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- View Mode Toggle -->
                    <div class="flex items-center bg-slate-100 rounded-lg p-1">
                        <button id="visualViewBtn" onclick="setPdfViewMode('visual')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors bg-white text-blue-600 shadow-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            Visual
                        </button>
                        <button id="textViewBtn" onclick="setPdfViewMode('text')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors text-slate-600 hover:text-slate-800">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            Text
                        </button>
                    </div>
                    <!-- Zoom Controls (visual mode only) -->
                    <div id="zoomControls" class="flex items-center gap-1">
                        <button onclick="zoomPdf(-0.25)" class="px-2 py-1 border border-slate-300 rounded hover:bg-slate-100 text-sm" title="Zoom out">−</button>
                        <span id="zoomLevel" class="text-xs text-slate-600 w-12 text-center">100%</span>
                        <button onclick="zoomPdf(0.25)" class="px-2 py-1 border border-slate-300 rounded hover:bg-slate-100 text-sm" title="Zoom in">+</button>
                    </div>
                    <button onclick="hidePdfViewer()" class="text-slate-400 hover:text-slate-600 p-2" aria-label="Close PDF viewer">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Visual PDF View (canvas rendering) -->
            <div id="pdfVisualView" class="flex-1 overflow-auto bg-slate-200 flex items-start justify-center p-4" style="min-height: 500px;">
                <canvas id="pdfCanvas" class="shadow-lg bg-white"></canvas>
            </div>
            <!-- Text View (original) -->
            <div id="pdfTextView" class="pdf-viewer p-6 flex-1 overflow-y-auto hidden" role="document">
                <!-- PDF text content will be rendered here -->
            </div>
            <div class="p-4 border-t border-slate-200 bg-slate-50 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <button onclick="pdfViewerPrevPage()" class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-100 text-sm" aria-label="Previous page">
                            ← Previous
                        </button>
                        <div class="flex items-center gap-1 text-sm text-slate-600">
                            <span>Page</span>
                            <input type="number" id="pdfPageInput" min="1" value="1"
                                class="w-14 px-2 py-1 border border-slate-300 rounded text-center text-sm"
                                onkeyup="if(event.key==='Enter')goToPage()"
                                onchange="goToPage()"
                                aria-label="Go to page number">
                            <span>of <span id="pdfTotalPages">1</span></span>
                        </div>
                        <button onclick="pdfViewerNextPage()" class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-100 text-sm" aria-label="Next page">
                            Next →
                        </button>
                    </div>
                    <label class="sr-only" for="pdfSearchInput">Search in document</label>
                    <input type="text" id="pdfSearchInput" placeholder="Search in document..."
                        class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm w-48"
                        onkeyup="if(event.key==='Enter')searchInPdf()">
                </div>
            </div>
        </div>
    </div>

    <!-- Comment Prompt Modal -->
    <div id="commentPromptModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="commentPromptTitle">
        <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="commentPromptTitle" class="text-lg font-bold text-slate-800">Add Your Reasoning</h3>
                        <p class="text-sm text-slate-500">Help other reviewers understand your decision</p>
                    </div>
                </div>

                <p id="commentPromptText" class="text-slate-700 mb-4"></p>

                <div class="bg-blue-50 rounded-xl p-4 mb-4">
                    <p class="text-sm font-medium text-blue-800 mb-2">Suggested reasoning starters:</p>
                    <div id="reasoningSuggestions" class="space-y-2" role="list">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <label for="promptedComment" class="sr-only">Your reasoning</label>
                <textarea id="promptedComment" rows="4"
                    class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 resize-none"
                    placeholder="Explain why you selected this score..."></textarea>

                <div class="flex gap-3 mt-4">
                    <button onclick="skipCommentPrompt()" class="flex-1 px-4 py-3 border border-slate-300 rounded-xl text-slate-600 hover:bg-slate-50 transition-colors">
                        Skip
                    </button>
                    <button onclick="savePromptedComment()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors">
                        Save Comment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" role="alertdialog" aria-modal="true" aria-labelledby="errorTitle">
        <div class="bg-white rounded-2xl max-w-md w-full shadow-2xl">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h3 id="errorTitle" class="text-lg font-bold text-slate-800">Error Occurred</h3>
                </div>
                <p id="errorMessage" class="text-slate-700 mb-4"></p>
                <p id="errorDetails" class="text-sm text-slate-500 bg-slate-50 rounded-lg p-3 mb-4 font-mono hidden"></p>
                <div class="flex gap-3">
                    <button onclick="hideErrorModal()" class="flex-1 px-4 py-3 border border-slate-300 rounded-xl text-slate-600 hover:bg-slate-50 transition-colors">
                        Dismiss
                    </button>
                    <button id="errorRetryBtn" onclick="retryLastAction()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors hidden">
                        Retry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ============================================================
    // CONFIGURATION & CONSTANTS
    // ============================================================
    const CONFIG = {
        MODEL: 'claude-sonnet-4-20250514',
        MAX_TOKENS: 4096,
        API_URL: 'https://api.anthropic.com/v1/messages',
        MAX_PDF_SIZE_MB: 50,
        AUTO_SAVE_KEY: 'nofa_evaluation_draft',
        AUTO_SAVE_DEBOUNCE_MS: 1000,
        RESPONSE_CACHE_KEY: 'nofa_ai_response_cache',  // Cache AI responses by input hash
        TEXT_CHUNK_SIZE: 40000,  // Increased chunk size to capture more content including attachments
        ATTACHMENT_CHUNK_SIZE: 30000,  // Additional space for attachment/exhibit content
        TEMPLATE_PROFILES_KEY: 'nofa_template_profiles',  // Storage key for custom templates
        // Vision analysis settings
        VISION_ENABLED_KEY: 'nofa_vision_enabled',
        VISION_AUTO_DETECT_KEY: 'nofa_vision_auto_detect',
        VISION_MAX_PAGES: 10,  // Max pages to send as images (to control costs)
        VISION_IMAGE_SCALE: 1.5,  // Scale factor for rendering (1.5 = good quality, reasonable size)
        VISION_IMAGE_QUALITY: 0.8,  // JPEG quality (0.8 = good balance of quality/size)
        // Auto-detection thresholds
        VISION_MIN_CHARS_PER_PAGE: 200,  // Pages with fewer chars likely have charts/images
        VISION_CHART_KEYWORDS: ['chart', 'graph', 'figure', 'table', 'diagram', 'org chart', 'organizational chart', 'pie chart', 'bar graph', 'timeline', 'flowchart', 'infographic'],
        // Performance optimizations
        API_RETRY_ATTEMPTS: 3,  // Number of retry attempts for failed API calls
        API_RETRY_DELAY_MS: 1000,  // Base delay between retries (doubles each attempt)
        API_PARALLEL_BATCH_SIZE: 3,  // Number of parallel API calls (balance speed vs rate limits)
        RENDER_DEBOUNCE_MS: 50  // Debounce rapid render calls
    };

    // ============================================================
    // CONSISTENCY & CACHING UTILITIES
    // ============================================================

    // In-memory cache for faster lookups (avoids repeated JSON parsing)
    let responseCacheMap = null;
    let cacheDirty = false;

    // Initialize in-memory cache from localStorage
    function initResponseCache() {
        if (responseCacheMap === null) {
            try {
                const stored = localStorage.getItem(CONFIG.RESPONSE_CACHE_KEY);
                responseCacheMap = stored ? new Map(Object.entries(JSON.parse(stored))) : new Map();
            } catch (e) {
                console.warn('Cache init error:', e);
                responseCacheMap = new Map();
            }
        }
        return responseCacheMap;
    }

    // Persist cache to localStorage (debounced to avoid frequent writes)
    let cacheWriteTimeout = null;
    function persistCache() {
        if (!cacheDirty || !responseCacheMap) return;
        if (cacheWriteTimeout) clearTimeout(cacheWriteTimeout);
        cacheWriteTimeout = setTimeout(() => {
            try {
                // Convert Map to object and filter old entries
                const now = Date.now();
                const expiry = 24 * 60 * 60 * 1000;
                const obj = {};
                responseCacheMap.forEach((value, key) => {
                    if (value.timestamp > now - expiry) {
                        obj[key] = value;
                    }
                });
                localStorage.setItem(CONFIG.RESPONSE_CACHE_KEY, JSON.stringify(obj));
                cacheDirty = false;
            } catch (e) {
                console.warn('Cache persist error:', e);
            }
        }, 500);
    }

    // Generate a deterministic hash from text (for caching AI responses)
    async function hashText(text) {
        const encoder = new TextEncoder();
        const data = encoder.encode(text);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Normalize text for consistent processing (removes variations that don't affect meaning)
    function normalizeText(text) {
        return text
            .replace(/\r\n/g, '\n')           // Normalize line endings
            .replace(/\r/g, '\n')              // Handle old Mac line endings
            .replace(/[ \t]+/g, ' ')           // Collapse multiple spaces/tabs to single space
            .replace(/\n{3,}/g, '\n\n')        // Collapse multiple newlines to max 2
            .replace(/^\s+|\s+$/gm, '')        // Trim each line
            .trim();                           // Trim overall
    }

    // Get cached AI response by hash, or return null if not cached
    function getCachedResponse(hash, criterionId) {
        const cache = initResponseCache();
        const key = `${hash}_${criterionId}`;
        const entry = cache.get(key);
        if (entry && entry.timestamp > Date.now() - 24 * 60 * 60 * 1000) {
            console.log(`[Cache HIT] Using cached response for ${criterionId}`);
            return entry.response;
        }
        return null;
    }

    // Store AI response in cache with hash key
    function setCachedResponse(hash, criterionId, response) {
        const cache = initResponseCache();
        const key = `${hash}_${criterionId}`;
        cache.set(key, {
            response: response,
            timestamp: Date.now()
        });
        cacheDirty = true;
        persistCache();
        console.log(`[Cache SET] Stored response for ${criterionId}`);
    }

    // Clear the response cache (for debugging or when user wants fresh analysis)
    function clearResponseCache() {
        localStorage.removeItem(CONFIG.RESPONSE_CACHE_KEY);
        responseCacheMap = new Map();  // Clear in-memory cache too
        cacheDirty = false;
        console.log('[Cache CLEARED]');
        showToast('info', 'Cache Cleared', 'AI responses will be regenerated on next analysis.');
    }

    // Full reset: clear cache AND in-memory AI suggestions for complete fresh start
    function clearAllAndReset() {
        // Clear localStorage cache
        localStorage.removeItem(CONFIG.RESPONSE_CACHE_KEY);

        // Clear in-memory AI suggestions
        state.aiSuggestions = {};

        // Reset diagnostics counters
        state.diagnostics.mainContentChars = 0;
        state.diagnostics.attachmentChars = 0;
        state.diagnostics.criteriaAnalyzed = 0;
        state.diagnostics.lastAnalysisTimestamp = null;
        state.cachedCriteriaCount = 0;

        console.log('[FULL RESET] Cache and AI suggestions cleared');
        hideSettings();
        showToast('warning', 'Full Reset Complete', 'All AI suggestions cleared. Run Auto-Analyze to generate fresh analysis.');
        render();
    }

    // Get deterministic text chunk for AI analysis
    function getConsistentTextChunk(text, maxLength = CONFIG.TEXT_CHUNK_SIZE) {
        const normalized = normalizeText(text);
        // Always take from the beginning for consistency
        return normalized.substring(0, maxLength);
    }

    // Extract attachment/exhibit sections from document for comprehensive AI analysis
    function extractAttachmentContent(text) {
        const normalized = normalizeText(text);
        const attachmentContent = [];

        // Patterns to find attachment/exhibit sections
        const attachmentPatterns = [
            /attachment\s*\d+[:\s]*[^\n]{0,100}/gi,
            /exhibit\s*[a-z0-9]+[:\s]*[^\n]{0,100}/gi,
            /appendix\s*[a-z0-9]+[:\s]*[^\n]{0,100}/gi,
            /--- page \d+ ---[\s\S]{0,5000}(?=--- page|$)/gi  // Capture page blocks
        ];

        // Find where attachments section starts (usually has "Attachments" or "Attachment 1")
        const attachmentStartPatterns = [
            /attachment\s*1\s*:/i,
            /attachments?\s*index/i,
            /section\s*\d+\s*:\s*attachments/i,
            /exhibit\s*a\s*:/i
        ];

        let attachmentStartIndex = -1;
        for (const pattern of attachmentStartPatterns) {
            const match = normalized.search(pattern);
            if (match !== -1 && (attachmentStartIndex === -1 || match < attachmentStartIndex)) {
                attachmentStartIndex = match;
            }
        }

        // If we found an attachments section, extract it
        if (attachmentStartIndex !== -1) {
            const attachmentSection = normalized.substring(attachmentStartIndex, attachmentStartIndex + CONFIG.ATTACHMENT_CHUNK_SIZE);
            return attachmentSection;
        }

        return '';
    }

    // Get comprehensive text for AI including main content and attachments
    function getComprehensiveTextForAI(text, mainChunkSize = CONFIG.TEXT_CHUNK_SIZE) {
        const mainContent = getConsistentTextChunk(text, mainChunkSize);
        const attachmentContent = extractAttachmentContent(text);

        // Update diagnostics
        state.diagnostics.mainContentChars = mainContent.length;
        state.diagnostics.attachmentChars = attachmentContent.length;
        state.diagnostics.lastAnalysisTimestamp = new Date().toISOString();

        // If we have attachment content that's not already in main content, append it
        if (attachmentContent && !mainContent.includes(attachmentContent.substring(0, 200))) {
            const combined = mainContent + '\n\n=== ATTACHMENTS & EXHIBITS ===\n' + attachmentContent;
            console.log(`[AI Text] Main: ${mainContent.length} chars, Attachments: ${attachmentContent.length} chars, Total: ${combined.length} chars`);
            return combined;
        }

        console.log(`[AI Text] Main content only: ${mainContent.length} chars (attachments already included or not found)`);
        return mainContent;
    }

    // ============================================================
    // TEMPLATE PROFILE SYSTEM
    // ============================================================
    // Template profiles allow the app to work with different scoring templates
    // Each profile defines: reviewer sheets configuration + scoring criteria

    // Default profile for San Mateo County NOFA FY26-27
    const DEFAULT_TEMPLATE_PROFILE = {
        id: 'san-mateo-nofa-fy26-27',
        name: 'San Mateo County NOFA FY26-27',
        description: 'Winter FY26-27 Community Development Public Services',
        version: '1.0',
        isDefault: true,

        // Detection patterns for auto-matching templates
        detectionPatterns: {
            sheetNames: ['Threshold+Scoring - Reviewer 1', 'Scoring Sheet - Reviewer 2'],
            cellSignatures: {
                'E8': 'applicant',  // Cell E8 contains applicant name
                'H8': 'reviewer'    // Cell H8 contains reviewer name
            }
        },

        // Reviewer sheet configurations
        reviewerSheets: {
            'Threshold+Scoring - Reviewer 1': {
                name: 'Reviewer 1',
                description: 'Threshold + Scoring',
                hasThreshold: true,
                scores: {
                    '1a': 'H64', '1b': 'H65',
                    '2a': 'H68', '2b': 'H69', '2c': 'H70', '2d': 'H71',
                    '3a': 'H74', '3b': 'H75', '3c': 'H76', '3d': 'H77', '3e': 'H78',
                    '4a': 'H80',
                    '5b': 'H85', '5c': 'H86', '5d': 'H87'
                },
                comments: {
                    '1a': 'G64', '1b': 'G65',
                    '2a': 'G68', '2b': 'G69', '2c': 'G70', '2d': 'G71',
                    '3a': 'G74', '3b': 'G75', '3c': 'G76', '3d': 'G77', '3e': 'G78',
                    '4a': 'G80',
                    '5b': 'G85', '5c': 'G86', '5d': 'G87'
                },
                projectInfo: {
                    applicant: 'E8',
                    reviewedBy: 'H8',
                    project: 'E9',
                    reviewDate: 'H9',
                    amountRequested: 'E10',
                    totalCost: 'E11',
                    clientsServed: 'E12',
                    projectDescription: 'E14'
                },
                recommendation: {
                    yesNo: 'F19',
                    fundingSource: 'F20',
                    briefSummary: 'F21',
                    summaryComments: 'B100',
                    questionCells: ['D90', 'D91', 'D92', 'D93', 'D94']
                }
            },
            'Scoring Sheet - Reviewer 2': {
                name: 'Reviewer 2',
                description: 'Scoring Only',
                hasThreshold: false,
                scores: {
                    '1a': 'H36', '1b': 'H37',
                    '2a': 'H40', '2b': 'H41', '2c': 'H42', '2d': 'H43',
                    '3a': 'H46', '3b': 'H47', '3c': 'H48', '3d': 'H49', '3e': 'H50',
                    '4a': 'H52',
                    '5b': 'H57', '5c': 'H58', '5d': 'H59'
                },
                comments: {
                    '1a': 'G36', '1b': 'G37',
                    '2a': 'G40', '2b': 'G41', '2c': 'G42', '2d': 'G43',
                    '3a': 'G46', '3b': 'G47', '3c': 'G48', '3d': 'G49', '3e': 'G50',
                    '4a': 'G52',
                    '5b': 'G57', '5c': 'G58', '5d': 'G59'
                },
                projectInfo: {
                    applicant: 'E8',
                    reviewedBy: 'H8',
                    project: 'E9',
                    reviewDate: 'H9',
                    amountRequested: 'E10',
                    totalCost: 'E11',
                    clientsServed: 'E12',
                    projectDescription: 'E14'
                },
                recommendation: {
                    yesNo: 'F19',
                    fundingSource: 'F20',
                    briefSummary: 'F21',
                    summaryComments: 'B72',
                    questionCells: ['D62', 'D63', 'D64', 'D65', 'D66']
                }
            }
        },

        // Scoring criteria definitions
        criteria: [] // Will be populated below
    };

    // Template profiles storage (includes default + user-created profiles)
    let TEMPLATE_PROFILES = {
        'san-mateo-nofa-fy26-27': DEFAULT_TEMPLATE_PROFILE
    };

    // Active profile reference (defaults to San Mateo)
    let activeProfileId = 'san-mateo-nofa-fy26-27';

    // Helper functions for template profile system
    function getActiveProfile() {
        return TEMPLATE_PROFILES[activeProfileId] || DEFAULT_TEMPLATE_PROFILE;
    }

    function getReviewerSheets() {
        return getActiveProfile().reviewerSheets;
    }

    function getCriteria() {
        return getActiveProfile().criteria;
    }

    function setActiveProfile(profileId) {
        if (TEMPLATE_PROFILES[profileId]) {
            activeProfileId = profileId;
            localStorage.setItem('nofa_active_profile', profileId);
            return true;
        }
        return false;
    }

    // Load saved template profiles from localStorage
    function loadTemplateProfiles() {
        try {
            const saved = localStorage.getItem(CONFIG.TEMPLATE_PROFILES_KEY);
            if (saved) {
                const customProfiles = JSON.parse(saved);
                // Merge with default (default always takes precedence for its ID)
                TEMPLATE_PROFILES = { ...customProfiles, 'san-mateo-nofa-fy26-27': DEFAULT_TEMPLATE_PROFILE };
            }
            // Load active profile preference
            const savedActive = localStorage.getItem('nofa_active_profile');
            if (savedActive && TEMPLATE_PROFILES[savedActive]) {
                activeProfileId = savedActive;
            }
        } catch (e) {
            console.warn('Failed to load template profiles:', e);
        }
    }

    // Save custom template profiles to localStorage
    function saveTemplateProfiles() {
        try {
            // Only save non-default profiles
            const customProfiles = {};
            for (const [id, profile] of Object.entries(TEMPLATE_PROFILES)) {
                if (!profile.isDefault) {
                    customProfiles[id] = profile;
                }
            }
            localStorage.setItem(CONFIG.TEMPLATE_PROFILES_KEY, JSON.stringify(customProfiles));
        } catch (e) {
            console.warn('Failed to save template profiles:', e);
        }
    }

    // Detect which template profile matches a given workbook
    function detectTemplateProfile(workbook) {
        for (const [id, profile] of Object.entries(TEMPLATE_PROFILES)) {
            const patterns = profile.detectionPatterns;
            if (!patterns) continue;

            // Check if sheet names match
            if (patterns.sheetNames) {
                const workbookSheets = workbook.SheetNames || [];
                const matchCount = patterns.sheetNames.filter(name => workbookSheets.includes(name)).length;
                if (matchCount >= patterns.sheetNames.length * 0.5) {
                    return id;
                }
            }
        }
        return null; // No matching profile found
    }

    // Backwards compatibility: REVIEWER_SHEETS and CRITERIA as getters
    // This ensures existing code continues to work without modification
    const REVIEWER_SHEETS = new Proxy({}, {
        get: (target, prop) => getReviewerSheets()[prop],
        ownKeys: () => Object.keys(getReviewerSheets()),
        getOwnPropertyDescriptor: (target, prop) => {
            const sheets = getReviewerSheets();
            if (prop in sheets) {
                return { enumerable: true, configurable: true, value: sheets[prop] };
            }
        },
        has: (target, prop) => prop in getReviewerSheets()
    });

    // Default scoring criteria for San Mateo NOFA FY26-27
    // This populates the DEFAULT_TEMPLATE_PROFILE.criteria array
    DEFAULT_TEMPLATE_PROFILE.criteria = [
        {
            id: '1a', section: 1, sectionTitle: 'Funding Priority',
            question: 'Which County priority does project meet or need?',
            validScores: [0, 3],
            scoringRule: '0 - The project does not meet a County priority.\n3 - The project does meet a County priority.',
            aiPrompt: 'Does this project address a priority from the San Mateo County Consolidated Plan? Look for mentions of: homelessness prevention, fair housing, public services for low-income residents, housing rehabilitation, or economic development.',
            reasoningStarters: [
                'The project addresses the County priority of...',
                'Based on the Consolidated Plan, this project aligns with...',
                'The application does not clearly demonstrate connection to County priorities because...',
                'While the project has merit, the stated priority of... is not directly aligned with...'
            ]
        },
        {
            id: '1b', section: 1, sectionTitle: 'Funding Priority',
            question: 'What population is the program targeting?',
            validScores: [0, 1, 2, 3],
            scoringRule: '3 for ELI (0-30% AMI)\n2 for ELI to VLI (0-50% AMI)\n1 for VLI to Moderate (30-80% AMI)\n0 for moderate income only',
            aiPrompt: 'What income level population does this project serve? Look for: ELI (Extremely Low Income, 0-30% AMI), VLI (Very Low Income, 30-50% AMI), LI (Low Income, 50-80% AMI), or Moderate Income.',
            reasoningStarters: [
                'The application indicates they serve primarily... income households',
                'Based on the demographic data provided, the target population is...',
                'The income eligibility requirements specify...',
                'Historical client data shows the majority served are at... AMI level'
            ]
        },
        {
            id: '2a', section: 2, sectionTitle: 'Applicant Capacity',
            question: 'What is experience/capacity of applicant in performing proposed services?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if no demonstrated positive outcomes or missed targets by >50%\n1-2 if demonstrated outcomes with related work or met 50-75% targets\n3 if demonstrated outcomes with exact project type and 75%+ targets',
            aiPrompt: 'Does the applicant have experience with this exact type of program? What outcomes have they achieved? Have they met their targets in the past?',
            reasoningStarters: [
                'The applicant has... years of experience operating similar programs',
                'Past performance reports indicate they achieved...% of their targets',
                'While experienced in related services, this specific program type is new for them',
                'The organization lacks documented outcomes for this type of service'
            ]
        },
        {
            id: '2b', section: 2, sectionTitle: 'Applicant Capacity',
            question: "What is applicant's ability to measure the need/impact of services?",
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if they have no process/ability\n1-2 if they have some process\n3 if they have a very well defined process/ability',
            aiPrompt: 'Does the applicant describe how they will track outcomes and measure impact? Do they have data collection systems, reporting processes, or evaluation methods?',
            reasoningStarters: [
                'The application describes a comprehensive data collection system including...',
                'Their outcome measurement process includes...',
                'The evaluation methodology is limited to...',
                'No clear process for measuring impact was described in the application'
            ]
        },
        {
            id: '2c', section: 2, sectionTitle: 'Applicant Capacity',
            question: "What is the applicant's ability to complete administrative requirements (QPRs, HMIS)?",
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if no direct or related experience\n1 if direct experience that is not good or only related experience\n2 if direct experience that is OK\n3 if direct and positive experience',
            aiPrompt: 'Has the applicant managed federal or county grants before? Do they have experience with Quarterly Performance Reports (QPRs) or HMIS?',
            reasoningStarters: [
                'The applicant has successfully managed... grants with timely reporting',
                'Past QPR submissions have been...',
                'HMIS experience is evidenced by...',
                'The organization is new to federal grant reporting requirements'
            ]
        },
        {
            id: '2d', section: 2, sectionTitle: 'Applicant Capacity',
            question: 'Is organization fiscally and programmatically stable?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if there are concerns in their audit\n1-2 if they seem to be operating based on reserves\n3 if their income matches or exceeds annual expenses',
            aiPrompt: 'Review Exhibit 7 (audit). Does the organization have a clean audit? Is their income exceeding expenses or are they relying on reserves?',
            reasoningStarters: [
                'The audit shows a clean financial position with...',
                'Revenue exceeds expenses by... indicating strong fiscal health',
                'The organization is operating on reserves, which raises concerns about...',
                'Audit findings indicate... which may impact program delivery'
            ]
        },
        {
            id: '3a', section: 3, sectionTitle: 'Project Feasibility',
            question: 'Is this an on-going program already in existence or a new program?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if not yet launched\n1 if launched within past 3 months\n2 if launched within past 6 months\n3 if launched 7+ months ago',
            aiPrompt: 'Is this an existing/continuing program or completely new? When did it start or when will it start?',
            reasoningStarters: [
                'This is a continuing program that has been operating since...',
                'The program launched... months ago and has served... clients',
                'This is a new program scheduled to begin...',
                'The program is in planning stages with implementation expected...'
            ]
        },
        {
            id: '3b', section: 3, sectionTitle: 'Project Feasibility',
            question: 'If new, when will program operations begin?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if it will start after Oct 1, 2026\n1 if by Sep 1, 2026\n2 if by Aug 15, 2026\n3 if by July 2026 or ongoing project',
            aiPrompt: 'When will the program begin operations? The fiscal year starts July 1, 2026. If ongoing, score as 3.',
            reasoningStarters: [
                'As an ongoing program, services will continue seamlessly into the new fiscal year',
                'The program is prepared to launch by... 2026',
                'Staff hiring and setup indicate a start date of...',
                'Implementation timeline shows operations beginning after October 2026'
            ]
        },
        {
            id: '3c', section: 3, sectionTitle: 'Project Feasibility',
            question: 'Have they received CDBG/County funding for this program before?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if never received County support\n1 if received local city support\n2 if received federal support from another city/county\n3 if received San Mateo County support',
            aiPrompt: 'Has this organization received San Mateo County CDBG or other County funding before? Or funding from other jurisdictions?',
            reasoningStarters: [
                'The applicant has received San Mateo County CDBG funding for... years',
                'Previous County support includes... totaling...',
                'The organization has managed CDBG funds from... (other jurisdiction)',
                'This would be the applicant\'s first County or federal grant'
            ]
        },
        {
            id: '3d', section: 3, sectionTitle: 'Project Feasibility',
            question: 'How will program be administered? Any partnerships/collaborations?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if done alone\n1-2 if done in partnership with 1-2 entities\n3 if done with an ecosystem of partners',
            aiPrompt: 'Does the applicant work with partners or collaborators? How many partner organizations are involved?',
            reasoningStarters: [
                'The applicant has established partnerships with... organizations including...',
                'Collaboration includes referral agreements with...',
                'The program operates with limited partnerships, primarily...',
                'No formal partnerships or collaborations were identified'
            ]
        },
        {
            id: '3e', section: 3, sectionTitle: 'Project Feasibility',
            question: 'Are there any unique features that may impede (0-1) or contribute (2-3) to success?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0-1 if concerns may impede success\n2-3 if unique features contribute to success',
            aiPrompt: 'Are there any innovative approaches, special partnerships, or unique features? Any red flags or concerns that could impede success?',
            reasoningStarters: [
                'Unique strengths include... which should enhance program success',
                'The innovative approach of... differentiates this program',
                'Potential concerns include... which may require monitoring',
                'Risk factors such as... could impede successful delivery'
            ]
        },
        {
            id: '4a', section: 4, sectionTitle: 'Cost Effectiveness',
            question: 'Is total unit cost of service (cost per household served) reasonable?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if it does not seem reasonable\n3 if it seems very reasonable\n*Intermediate scores allowed. Explain in comments.',
            aiPrompt: 'Calculate cost per client (Total Cost / Clients Served). Is this reasonable for the type of service?',
            requiresComment: true,
            reasoningStarters: [
                'At $... per client, the cost is reasonable given the intensity of services',
                'The cost per household of $... is competitive compared to similar programs',
                'While the unit cost of $... appears high, the comprehensive services justify...',
                'The cost of $... per client raises concerns because...'
            ]
        },
        {
            id: '5b', section: 5, sectionTitle: 'Leveraging',
            question: 'What is the timeframe for securing other funds?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if unclear\n1-2 if within 6 months\n3 if evidence of receipt within 6 months or already committed',
            aiPrompt: 'When will the applicant secure their other funding sources? Is funding already committed or pending?',
            reasoningStarters: [
                'Matching funds of $... are already committed from...',
                'The applicant expects to secure additional funding by...',
                'Award notifications for... funding are expected in...',
                'The timeline for securing other funds is unclear or speculative'
            ]
        },
        {
            id: '5c', section: 5, sectionTitle: 'Leveraging',
            question: 'What is probability that applicant will secure funding commitments?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if unlikely\n1-2 if relatively likely\n3 if highly probable or already secured',
            aiPrompt: 'How likely is it that they will receive their other funding sources? Are these established funders?',
            reasoningStarters: [
                'Funding from... is highly likely based on their multi-year relationship',
                'The applicant has a strong track record with... funder',
                'Pending applications to... have reasonable likelihood of success',
                'The identified funding sources appear speculative with no clear commitment'
            ]
        },
        {
            id: '5d', section: 5, sectionTitle: 'Leveraging',
            question: 'Is percentage of County request to total cost reasonable?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if 100% County funding\n1 if 75%+ County\n2 if 51-75% County\n3 if 50% or less County',
            aiPrompt: 'Calculate: (Amount Requested / Total Cost) x 100. Lower percentage = better leveraging.',
            autoCalculate: true,
            reasoningStarters: [
                'County funds represent...% of the total budget, demonstrating strong leveraging',
                'The applicant is leveraging $... in other funds for every County dollar',
                'At...% County funding, there is moderate leveraging',
                'The project relies heavily on County funds at...% of total cost'
            ]
        }
    ];

    // Backwards compatibility: CRITERIA as a proxy that returns the active profile's criteria
    // This ensures existing code continues to work without modification
    const CRITERIA = new Proxy([], {
        get: (target, prop) => {
            const criteria = getCriteria();
            if (prop === 'length') return criteria.length;
            if (prop === 'filter') return criteria.filter.bind(criteria);
            if (prop === 'map') return criteria.map.bind(criteria);
            if (prop === 'forEach') return criteria.forEach.bind(criteria);
            if (prop === 'find') return criteria.find.bind(criteria);
            if (prop === 'findIndex') return criteria.findIndex.bind(criteria);
            if (prop === 'some') return criteria.some.bind(criteria);
            if (prop === 'every') return criteria.every.bind(criteria);
            if (prop === 'reduce') return criteria.reduce.bind(criteria);
            if (prop === Symbol.iterator) return criteria[Symbol.iterator].bind(criteria);
            return criteria[prop];
        },
        has: (target, prop) => prop in getCriteria(),
        ownKeys: () => Reflect.ownKeys(getCriteria())
    });

    // ============================================================
    // STATE MANAGEMENT
    // ============================================================
    // ============================================================
    // SHARED API KEY CONFIGURATION
    // ============================================================
    // To pre-configure a shared API key for your team, replace the empty string below
    // with your Anthropic API key. Users can still override this in Settings.
    // Example: const SHARED_API_KEY = 'sk-ant-api03-xxxxxxxxxxxx';
    const SHARED_API_KEY = '';  // <-- PASTE YOUR SHARED API KEY HERE

    let state = {
        apiKey: localStorage.getItem('nofa_api_key') || SHARED_API_KEY,
        reviewerName: localStorage.getItem('nofa_reviewer') || '',
        reviewerSheet: localStorage.getItem('nofa_reviewer_sheet') || 'Scoring Sheet - Reviewer 2',
        activeTemplateId: localStorage.getItem('nofa_active_profile') || 'san-mateo-nofa-fy26-27', // Current template profile
        templateData: null,
        templateName: '',
        scoringWorkbook: null, // Parsed XLSX workbook for export
        applicationPDF: null,
        pdfDocument: null,  // PDF.js document reference for vision rendering
        applicationText: '',
        pdfPages: [],
        projectInfo: {},
        scores: {},
        comments: {},
        aiSuggestions: {},
        recommendation: {},
        currentStep: 'upload',
        currentCriterionIndex: 0,
        pdfViewerCurrentPage: 0,
        lastSaved: null,
        hasUnsavedChanges: false,
        autoAnalyzeProgress: 0,
        isAutoAnalyzing: false,
        originalScores: {}, // For tracking changes in global review
        documentHash: null, // Hash of normalized document for consistency tracking
        cachedCriteriaCount: 0, // Number of criteria served from cache
        returnToSummary: false, // Flag to return to summary after editing a single criterion
        // Diagnostics tracking
        diagnostics: {
            totalPages: 0,
            totalCharacters: 0,
            mainContentChars: 0,
            attachmentChars: 0,
            attachmentStartPage: null,
            lastAnalysisTimestamp: null,
            criteriaAnalyzed: 0,
            visionPagesAnalyzed: 0
        },
        // Vision analysis
        visionEnabled: localStorage.getItem('nofa_vision_enabled') === 'true',
        visionAutoDetect: localStorage.getItem('nofa_vision_auto_detect') !== 'false',  // Default to true
        visionAutoEnabled: false,  // Track if vision was auto-enabled for this document
        visualContentDetected: false,  // Whether visual content was detected in current PDF
        pdfPageImages: [],  // Base64 images of PDF pages for vision analysis
        visionAnalysisCache: {}  // Cache vision analysis results per page
    };

    let autoSaveTimeout = null;
    let lastRetryAction = null;

    // ============================================================
    // AUTO-SAVE FUNCTIONALITY
    // ============================================================
    function saveToLocalStorage() {
        const saveData = {
            projectInfo: state.projectInfo,
            scores: state.scores,
            comments: state.comments,
            aiSuggestions: state.aiSuggestions,
            recommendation: state.recommendation,
            currentStep: state.currentStep,
            currentCriterionIndex: state.currentCriterionIndex,
            applicationText: state.applicationText,
            pdfPages: state.pdfPages,
            templateName: state.templateName,
            savedAt: new Date().toISOString()
        };

        try {
            localStorage.setItem(CONFIG.AUTO_SAVE_KEY, JSON.stringify(saveData));
            state.lastSaved = new Date();
            state.hasUnsavedChanges = false;
            showAutoSaveIndicator();
        } catch (e) {
            console.error('Auto-save failed:', e);
        }
    }

    function debouncedAutoSave() {
        state.hasUnsavedChanges = true;
        if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(saveToLocalStorage, CONFIG.AUTO_SAVE_DEBOUNCE_MS);
    }

    function showAutoSaveIndicator() {
        const indicator = document.getElementById('autoSaveIndicator');
        indicator.classList.remove('hidden');
        setTimeout(() => indicator.classList.add('hidden'), 2000);
    }

    function checkForDraft() {
        try {
            const saved = localStorage.getItem(CONFIG.AUTO_SAVE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                if (data.projectInfo?.applicant) {
                    const savedDate = new Date(data.savedAt);
                    const draftInfo = document.getElementById('draftInfo');
                    draftInfo.textContent = `${data.projectInfo.applicant} - saved ${savedDate.toLocaleString()}`;
                    document.getElementById('draftBanner').classList.remove('hidden');
                    return true;
                }
            }
        } catch (e) {
            console.error('Error checking draft:', e);
        }
        return false;
    }

    function restoreDraft() {
        try {
            const saved = localStorage.getItem(CONFIG.AUTO_SAVE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                state.projectInfo = data.projectInfo || {};
                state.scores = data.scores || {};
                state.comments = data.comments || {};
                state.aiSuggestions = data.aiSuggestions || {};
                state.recommendation = data.recommendation || {};
                state.currentStep = data.currentStep || 'upload';
                state.currentCriterionIndex = data.currentCriterionIndex || 0;
                state.applicationText = data.applicationText || '';
                state.pdfPages = data.pdfPages || [];
                state.templateName = data.templateName || '';

                document.getElementById('draftBanner').classList.add('hidden');
                showToast('success', 'Draft Restored', 'Your previous evaluation has been restored.');
                render();
            }
        } catch (e) {
            showToast('error', 'Restore Failed', 'Could not restore the draft. Starting fresh.');
        }
    }

    function discardDraft() {
        localStorage.removeItem(CONFIG.AUTO_SAVE_KEY);
        document.getElementById('draftBanner').classList.add('hidden');
        showToast('info', 'Draft Discarded', 'Starting a fresh evaluation.');
    }

    // ============================================================
    // CLOSE WARNING
    // ============================================================
    window.addEventListener('beforeunload', (e) => {
        if (state.hasUnsavedChanges || (state.currentStep !== 'upload' && state.currentStep !== 'summary')) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });

    // ============================================================
    // TOAST NOTIFICATIONS
    // ============================================================
    function showToast(type, title, message) {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toastIcon');

        const icons = {
            success: '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
            error: '<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
            info: '<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
        };

        icon.innerHTML = icons[type] || icons.info;
        document.getElementById('toastTitle').textContent = title;
        document.getElementById('toastMessage').textContent = message;

        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 5000);
    }

    function hideToast() {
        document.getElementById('toast').classList.remove('show');
    }

    // ============================================================
    // LOADING OVERLAY
    // ============================================================
    function showLoading(title, message, showProgress = false) {
        document.getElementById('loadingTitle').textContent = title;
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingProgress').classList.toggle('hidden', !showProgress);
        document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function updateLoadingProgress(percent, text) {
        document.getElementById('loadingProgressBar').style.width = percent + '%';
        document.getElementById('loadingProgressText').textContent = text || (percent + '%');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    // ============================================================
    // ERROR HANDLING
    // ============================================================
    function showError(message, details = null, retryFn = null) {
        document.getElementById('errorMessage').textContent = message;
        const detailsEl = document.getElementById('errorDetails');
        const retryBtn = document.getElementById('errorRetryBtn');

        if (details) {
            detailsEl.textContent = details;
            detailsEl.classList.remove('hidden');
        } else {
            detailsEl.classList.add('hidden');
        }

        if (retryFn) {
            lastRetryAction = retryFn;
            retryBtn.classList.remove('hidden');
        } else {
            retryBtn.classList.add('hidden');
        }

        document.getElementById('errorModal').classList.remove('hidden');
    }

    function hideErrorModal() {
        document.getElementById('errorModal').classList.add('hidden');
    }

    function retryLastAction() {
        hideErrorModal();
        if (lastRetryAction) lastRetryAction();
    }

    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================
    function formatCurrency(amount) {
        if (amount === null || amount === undefined || isNaN(amount)) return '$0.00';
        return new Intl.NumberFormat('en-US', {
            style: 'currency', currency: 'USD',
            minimumFractionDigits: 2, maximumFractionDigits: 2
        }).format(amount);
    }

    function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) return '0';
        return new Intl.NumberFormat('en-US').format(num);
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // ============================================================
    // INITIALIZATION
    // ============================================================
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    function init() {
        initResponseCache();  // Initialize in-memory cache early
        loadTemplateProfiles(); // Load saved template profiles from localStorage
        updateApiStatus();
        checkForDraft();
        renderImmediate();  // Use immediate render for initial load (no debounce)
        setupDropZones();
    }

    function updateApiStatus() {
        const dot = document.getElementById('apiDot');
        const text = document.getElementById('apiText');
        if (state.apiKey) {
            dot.className = 'w-2 h-2 rounded-full bg-green-400';
            text.textContent = 'API Connected';
        } else {
            dot.className = 'w-2 h-2 rounded-full bg-red-400';
            text.textContent = 'No API Key';
        }
    }

    // ============================================================
    // SETTINGS
    // ============================================================
    function showSettings() {
        document.getElementById('apiKeyInput').value = state.apiKey;
        document.getElementById('reviewerName').value = state.reviewerName;
        document.getElementById('reviewerSheet').value = state.reviewerSheet;

        // Update active profile display
        const profile = getActiveProfile();
        const displayEl = document.getElementById('activeProfileDisplay');
        if (displayEl) {
            displayEl.textContent = profile.name + (profile.isDefault ? ' (Default)' : '');
        }

        // Set vision toggle states
        const visionAutoDetectToggle = document.getElementById('visionAutoDetectToggle');
        if (visionAutoDetectToggle) {
            visionAutoDetectToggle.checked = state.visionAutoDetect;
        }

        const visionToggle = document.getElementById('visionToggle');
        if (visionToggle) {
            // Show manual toggle as checked only if explicitly enabled (not auto-enabled)
            visionToggle.checked = state.visionEnabled && !state.visionAutoEnabled;
        }

        updateVisionStatusText();

        const modal = document.getElementById('settingsModal');
        modal.classList.remove('hidden');

        // Focus the modal for keyboard events
        modal.focus();
    }

    function hideSettings() {
        document.getElementById('settingsModal').classList.add('hidden');
    }

    // Global keyboard handler for modals (Escape to close)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            // Close any open modal
            const settingsModal = document.getElementById('settingsModal');
            const pdfViewerModal = document.getElementById('pdfViewerModal');
            const evidenceModal = document.getElementById('evidenceModal');
            const counterArgModal = document.getElementById('counterArgModal');
            const commentPromptModal = document.getElementById('commentPromptModal');

            if (settingsModal && !settingsModal.classList.contains('hidden')) {
                hideSettings();
            } else if (pdfViewerModal && !pdfViewerModal.classList.contains('hidden')) {
                hidePdfViewer();
            } else if (evidenceModal) {
                evidenceModal.remove();
            } else if (counterArgModal) {
                counterArgModal.remove();
            } else if (commentPromptModal && !commentPromptModal.classList.contains('hidden')) {
                commentPromptModal.classList.add('hidden');
            }
        }
    });

    // Click outside modal to close (for Settings modal)
    document.getElementById('settingsModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            hideSettings();
        }
    });

    // Prevent background scroll when modal is open and mouse is over modal content
    function preventBackgroundScroll(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;

        // When modal is shown, prevent body scroll
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === 'class') {
                    if (!modal.classList.contains('hidden')) {
                        document.body.style.overflow = 'hidden';
                    } else {
                        document.body.style.overflow = '';
                    }
                }
            });
        });
        observer.observe(modal, { attributes: true });

        // Also handle wheel events on the modal backdrop to prevent scroll-through
        modal.addEventListener('wheel', function(e) {
            const scrollableContent = modal.querySelector('.overflow-auto, .overflow-y-auto');
            if (scrollableContent) {
                const isScrollable = scrollableContent.scrollHeight > scrollableContent.clientHeight;
                const isAtTop = scrollableContent.scrollTop === 0;
                const isAtBottom = scrollableContent.scrollTop + scrollableContent.clientHeight >= scrollableContent.scrollHeight;

                // Allow scroll if content is scrollable and not at boundaries
                // Or if scrolling in the allowed direction at boundaries
                if (isScrollable) {
                    if ((isAtTop && e.deltaY < 0) || (isAtBottom && e.deltaY > 0)) {
                        e.preventDefault(); // Prevent scroll-through at boundaries
                    }
                    // Otherwise let the scroll happen naturally within the modal
                } else {
                    e.preventDefault(); // No scrollable content, prevent all scroll
                }
            }
        }, { passive: false });
    }

    // Apply scroll prevention to all modals
    preventBackgroundScroll('settingsModal');
    preventBackgroundScroll('pdfViewerModal');
    preventBackgroundScroll('commentPromptModal');

    // ============================================================
    // VISION ANALYSIS TOGGLE
    // ============================================================
    function toggleVisionAutoDetect() {
        state.visionAutoDetect = document.getElementById('visionAutoDetectToggle').checked;
        localStorage.setItem(CONFIG.VISION_AUTO_DETECT_KEY, state.visionAutoDetect);
        updateVisionStatusText();
        console.log(`[Vision] Auto-detect ${state.visionAutoDetect ? 'enabled' : 'disabled'}`);
    }

    function toggleVisionAnalysis() {
        const manualEnabled = document.getElementById('visionToggle').checked;
        state.visionEnabled = manualEnabled;
        state.visionAutoEnabled = false;  // Manual toggle overrides auto
        localStorage.setItem(CONFIG.VISION_ENABLED_KEY, state.visionEnabled);
        updateVisionStatusText();
        console.log(`[Vision] Vision analysis manually ${state.visionEnabled ? 'enabled' : 'disabled'}`);

        // If enabling and we have a PDF loaded, render pages for vision
        if (state.visionEnabled && state.pdfDocument && state.pdfPageImages.length === 0) {
            renderPdfPagesForVision(state.pdfDocument).then(() => {
                console.log(`[Vision] Rendered ${state.pdfPageImages.length} pages for vision analysis`);
                updateVisionStatusText();
            });
        }
    }

    function updateVisionStatusText() {
        const statusEl = document.getElementById('visionStatusText');
        if (!statusEl) return;

        let statusText = '';
        let statusClass = 'text-xs mt-1 ';

        if (state.visionAutoEnabled) {
            // Vision was auto-enabled for this document
            statusText = `Status: Auto-enabled for this document (${state.pdfPageImages.length} pages)`;
            statusClass += 'text-green-600 font-medium';
        } else if (state.visionEnabled) {
            // Vision is manually enabled
            if (state.pdfPageImages.length > 0) {
                statusText = `Status: Always on (${state.pdfPageImages.length} pages ready)`;
                statusClass += 'text-blue-600';
            } else if (state.pdfDocument) {
                statusText = 'Status: Always on (preparing pages...)';
                statusClass += 'text-amber-600';
            } else {
                statusText = 'Status: Always on (load a PDF to begin)';
                statusClass += 'text-blue-600';
            }
        } else if (state.visionAutoDetect) {
            // Auto-detect is on but no visual content detected yet
            if (state.visualContentDetected === false && state.pdfDocument) {
                statusText = 'Status: No visual content detected in current PDF';
                statusClass += 'text-slate-500';
            } else {
                statusText = 'Status: Auto-detect enabled (will scan PDFs for charts/graphs)';
                statusClass += 'text-slate-600';
            }
        } else {
            statusText = 'Status: Disabled (text-only analysis)';
            statusClass += 'text-slate-500';
        }

        statusEl.textContent = statusText;
        statusEl.className = statusClass;
    }

    // ============================================================
    // ADMIN DIAGNOSTICS PANEL
    // ============================================================
    function toggleDiagnosticsPanel() {
        const panel = document.getElementById('diagnosticsPanel');
        const toggleText = document.getElementById('diagnosticsToggleText');
        if (panel.classList.contains('hidden')) {
            updateDiagnosticsPanel();
            panel.classList.remove('hidden');
            toggleText.textContent = 'Hide';
        } else {
            panel.classList.add('hidden');
            toggleText.textContent = 'Show';
        }
    }

    function updateDiagnosticsPanel() {
        const diag = state.diagnostics;

        // Recalculate document stats if they're missing but document is loaded
        // (This happens after page refresh since diagnostics aren't persisted)
        if (diag.totalPages === 0 && state.pdfPages && state.pdfPages.length > 0) {
            diag.totalPages = state.pdfPages.length;
            diag.totalCharacters = state.applicationText ? state.applicationText.length : 0;
            // Recalculate attachment start page
            const attachmentPageIndex = state.pdfPages.findIndex(pageText =>
                /attachment\s*1\s*:|attachments?\s*index|exhibit\s*a\s*:/i.test(pageText)
            );
            diag.attachmentStartPage = attachmentPageIndex !== -1 ? attachmentPageIndex + 1 : null;
            console.log(`[Diagnostics] Recalculated from loaded document: ${diag.totalPages} pages, ${diag.totalCharacters} chars`);
        }

        // Total document info
        document.getElementById('diagTotalPages').textContent = diag.totalPages > 0 ? diag.totalPages : 'No PDF loaded';
        document.getElementById('diagTotalChars').textContent = diag.totalCharacters > 0 ? diag.totalCharacters.toLocaleString() : '-';
        document.getElementById('diagAttachStart').textContent = diag.attachmentStartPage ? `Page ${diag.attachmentStartPage}` : 'Not detected';

        // AI analysis coverage - show "Pending analysis" if document loaded but not analyzed yet
        const hasDocument = diag.totalPages > 0;
        const hasAnalysis = diag.mainContentChars > 0 || diag.criteriaAnalyzed > 0;
        const pendingText = hasDocument ? 'Pending analysis' : '-';

        document.getElementById('diagMainChars').textContent = diag.mainContentChars > 0 ? diag.mainContentChars.toLocaleString() : pendingText;
        document.getElementById('diagAttachChars').textContent = diag.attachmentChars > 0 ? diag.attachmentChars.toLocaleString() : pendingText;

        const totalToAI = diag.mainContentChars + diag.attachmentChars;
        document.getElementById('diagTotalToAI').textContent = totalToAI > 0 ? totalToAI.toLocaleString() : pendingText;

        // Calculate coverage percentage
        if (diag.totalCharacters > 0 && totalToAI > 0) {
            const coverage = Math.min(100, (totalToAI / diag.totalCharacters) * 100).toFixed(1);
            document.getElementById('diagCoverage').textContent = `${coverage}%`;
        } else {
            document.getElementById('diagCoverage').textContent = pendingText;
        }

        // Criteria and timestamp
        document.getElementById('diagCriteriaCount').textContent = diag.criteriaAnalyzed > 0 ? diag.criteriaAnalyzed : pendingText;

        if (diag.lastAnalysisTimestamp) {
            const date = new Date(diag.lastAnalysisTimestamp);
            document.getElementById('diagLastAnalysis').textContent = date.toLocaleString();
        } else {
            document.getElementById('diagLastAnalysis').textContent = 'Not yet analyzed';
        }

        // Vision analysis status
        const visionStatusEl = document.getElementById('diagVisionStatus');
        if (visionStatusEl) {
            if (state.visionAutoEnabled) {
                visionStatusEl.textContent = `Auto-enabled (${state.pdfPageImages.length} pages)`;
                visionStatusEl.className = 'text-green-600 font-medium';
            } else if (state.visionEnabled) {
                if (state.pdfPageImages.length > 0) {
                    visionStatusEl.textContent = `Always on (${state.pdfPageImages.length} pages)`;
                    visionStatusEl.className = 'text-blue-600 font-medium';
                } else {
                    visionStatusEl.textContent = 'Always on (no pages rendered)';
                    visionStatusEl.className = 'text-amber-600 font-medium';
                }
            } else if (state.visionAutoDetect) {
                visionStatusEl.textContent = 'Auto-detect (no visuals found)';
                visionStatusEl.className = 'text-slate-500';
            } else {
                visionStatusEl.textContent = 'Disabled';
                visionStatusEl.className = 'text-slate-500';
            }
        }
    }

    function copyDiagnosticsToClipboard() {
        const diag = state.diagnostics;
        const totalToAI = diag.mainContentChars + diag.attachmentChars;
        const coverage = diag.totalCharacters > 0 ? ((totalToAI / diag.totalCharacters) * 100).toFixed(1) : 0;

        let visionStatus = 'Disabled';
        if (state.visionAutoEnabled) {
            visionStatus = `Auto-enabled (${state.pdfPageImages.length} pages rendered)`;
        } else if (state.visionEnabled) {
            visionStatus = `Always on (${state.pdfPageImages.length} pages rendered)`;
        } else if (state.visionAutoDetect) {
            visionStatus = 'Auto-detect enabled (no visuals detected)';
        }

        const text = `NOFA AI Evaluator - Document Diagnostics
==========================================
Document: ${state.projectInfo.projectName || 'Unnamed'}
Total Pages: ${diag.totalPages}
Total Characters: ${diag.totalCharacters.toLocaleString()}
Attachments Start: ${diag.attachmentStartPage ? 'Page ' + diag.attachmentStartPage : 'Not detected'}

AI Analysis Coverage:
- Main Content: ${diag.mainContentChars.toLocaleString()} chars
- Attachments: ${diag.attachmentChars.toLocaleString()} chars
- Total Sent to AI: ${totalToAI.toLocaleString()} chars
- Coverage: ${coverage}%
- Vision Analysis: ${visionStatus}

Criteria Analyzed: ${diag.criteriaAnalyzed}
Last Analysis: ${diag.lastAnalysisTimestamp ? new Date(diag.lastAnalysisTimestamp).toLocaleString() : 'N/A'}
==========================================`;

        navigator.clipboard.writeText(text).then(() => {
            showToast('success', 'Copied', 'Diagnostics copied to clipboard');
        }).catch(() => {
            showToast('error', 'Copy Failed', 'Could not copy to clipboard');
        });
    }

    function saveSettings() {
        state.apiKey = document.getElementById('apiKeyInput').value.trim();
        state.reviewerName = document.getElementById('reviewerName').value.trim();
        state.reviewerSheet = document.getElementById('reviewerSheet').value;
        localStorage.setItem('nofa_api_key', state.apiKey);
        localStorage.setItem('nofa_reviewer', state.reviewerName);
        localStorage.setItem('nofa_reviewer_sheet', state.reviewerSheet);
        updateApiStatus();
        hideSettings();
        showToast('success', 'Settings Saved', 'Your settings have been updated.');
        render();
    }

    function clearApiKey() {
        state.apiKey = '';
        localStorage.removeItem('nofa_api_key');
        document.getElementById('apiKeyInput').value = '';
        updateApiStatus();
    }

    function toggleApiKeyVisibility() {
        const input = document.getElementById('apiKeyInput');
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    // ============================================================
    // TEMPLATE CONFIGURATION UI
    // ============================================================
    let editingProfileId = null;
    let editingProfile = null;

    function showTemplateConfig() {
        editingProfileId = activeProfileId;
        editingProfile = JSON.parse(JSON.stringify(getActiveProfile())); // Deep copy
        populateTemplateProfileSelector();
        renderTemplateConfigContent();
        document.getElementById('templateConfigModal').classList.remove('hidden');
    }

    function hideTemplateConfig() {
        document.getElementById('templateConfigModal').classList.add('hidden');
        editingProfileId = null;
        editingProfile = null;
    }

    function populateTemplateProfileSelector() {
        const selector = document.getElementById('templateProfileSelector');
        selector.innerHTML = '';
        for (const [id, profile] of Object.entries(TEMPLATE_PROFILES)) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = profile.name + (profile.isDefault ? ' (Default)' : '');
            option.selected = id === editingProfileId;
            selector.appendChild(option);
        }
    }

    function loadSelectedTemplateProfile() {
        const selector = document.getElementById('templateProfileSelector');
        editingProfileId = selector.value;
        editingProfile = JSON.parse(JSON.stringify(TEMPLATE_PROFILES[editingProfileId]));
        renderTemplateConfigContent();
    }

    function createNewTemplateProfile() {
        const baseName = 'Custom Template';
        let count = 1;
        let newId = 'custom-' + Date.now();

        // Create new profile based on default
        const newProfile = JSON.parse(JSON.stringify(DEFAULT_TEMPLATE_PROFILE));
        newProfile.id = newId;
        newProfile.name = baseName + ' ' + count;
        newProfile.isDefault = false;
        newProfile.description = 'Custom scoring template';
        newProfile.version = '1.0';

        TEMPLATE_PROFILES[newId] = newProfile;
        editingProfileId = newId;
        editingProfile = JSON.parse(JSON.stringify(newProfile));

        populateTemplateProfileSelector();
        renderTemplateConfigContent();
        showToast('info', 'New Profile', 'Created new template profile. Configure and save.');
    }

    function renderTemplateConfigContent() {
        const content = document.getElementById('templateConfigContent');
        if (!editingProfile) {
            content.innerHTML = '<p class="text-slate-500">No profile selected</p>';
            return;
        }

        const sheets = editingProfile.reviewerSheets || {};
        const sheetNames = Object.keys(sheets);

        let html = `
            <div class="space-y-6">
                <!-- Profile Info -->
                <div class="bg-slate-50 rounded-xl p-4">
                    <h4 class="font-semibold text-slate-800 mb-3">Profile Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Profile Name</label>
                            <input type="text" id="profileName" value="${editingProfile.name || ''}"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"
                                ${editingProfile.isDefault ? 'disabled' : ''}>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                            <input type="text" id="profileDescription" value="${editingProfile.description || ''}"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"
                                ${editingProfile.isDefault ? 'disabled' : ''}>
                        </div>
                    </div>
                    ${editingProfile.isDefault ? '<p class="text-xs text-amber-600 mt-2">Default profile cannot be modified. Create a new profile to customize.</p>' : ''}
                </div>

                <!-- Reviewer Sheets Configuration -->
                <div>
                    <h4 class="font-semibold text-slate-800 mb-3">Reviewer Sheet Mappings</h4>
                    <div class="space-y-4">
        `;

        for (const [sheetKey, sheetConfig] of Object.entries(sheets)) {
            html += `
                <div class="border border-slate-200 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h5 class="font-medium text-slate-800">${sheetConfig.name}</h5>
                            <p class="text-xs text-slate-500">Sheet: ${sheetKey}</p>
                        </div>
                        <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs">${sheetConfig.description}</span>
                    </div>

                    <!-- Project Info Mappings -->
                    <div class="mb-4">
                        <p class="text-sm font-medium text-slate-700 mb-2">Project Info Fields</p>
                        <div class="grid grid-cols-4 gap-2">
                            ${Object.entries(sheetConfig.projectInfo || {}).map(([field, cell]) => `
                                <div class="flex items-center gap-2">
                                    <label class="text-xs text-slate-600 w-20 truncate" title="${field}">${field}:</label>
                                    <input type="text" value="${cell}"
                                        data-sheet="${sheetKey}" data-section="projectInfo" data-field="${field}"
                                        class="flex-1 px-2 py-1 border border-slate-300 rounded text-xs font-mono template-cell-input"
                                        ${editingProfile.isDefault ? 'disabled' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Score Mappings -->
                    <div class="mb-4">
                        <p class="text-sm font-medium text-slate-700 mb-2">Score Cells</p>
                        <div class="grid grid-cols-7 gap-2">
                            ${Object.entries(sheetConfig.scores || {}).map(([id, cell]) => `
                                <div class="flex items-center gap-1">
                                    <label class="text-xs text-slate-600">${id}:</label>
                                    <input type="text" value="${cell}"
                                        data-sheet="${sheetKey}" data-section="scores" data-field="${id}"
                                        class="flex-1 px-2 py-1 border border-slate-300 rounded text-xs font-mono template-cell-input"
                                        ${editingProfile.isDefault ? 'disabled' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Comment Mappings -->
                    <div class="mb-4">
                        <p class="text-sm font-medium text-slate-700 mb-2">Comment Cells</p>
                        <div class="grid grid-cols-7 gap-2">
                            ${Object.entries(sheetConfig.comments || {}).map(([id, cell]) => `
                                <div class="flex items-center gap-1">
                                    <label class="text-xs text-slate-600">${id}:</label>
                                    <input type="text" value="${cell}"
                                        data-sheet="${sheetKey}" data-section="comments" data-field="${id}"
                                        class="flex-1 px-2 py-1 border border-slate-300 rounded text-xs font-mono template-cell-input"
                                        ${editingProfile.isDefault ? 'disabled' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Recommendation Mappings -->
                    <div>
                        <p class="text-sm font-medium text-slate-700 mb-2">Recommendation Fields</p>
                        <div class="grid grid-cols-3 gap-2">
                            ${Object.entries(sheetConfig.recommendation || {}).filter(([k]) => k !== 'questionCells').map(([field, cell]) => `
                                <div class="flex items-center gap-2">
                                    <label class="text-xs text-slate-600 w-24 truncate" title="${field}">${field}:</label>
                                    <input type="text" value="${cell}"
                                        data-sheet="${sheetKey}" data-section="recommendation" data-field="${field}"
                                        class="flex-1 px-2 py-1 border border-slate-300 rounded text-xs font-mono template-cell-input"
                                        ${editingProfile.isDefault ? 'disabled' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        html += `
                    </div>
                </div>

                <!-- Help Section -->
                <div class="bg-blue-50 rounded-xl p-4">
                    <h4 class="font-semibold text-blue-800 mb-2">Cell Reference Format</h4>
                    <p class="text-sm text-blue-700">
                        Use Excel-style cell references (e.g., A1, B23, H64). These map to specific cells in your scoring template spreadsheet.
                    </p>
                </div>
            </div>
        `;

        content.innerHTML = html;

        // Add event listeners for cell inputs
        if (!editingProfile.isDefault) {
            document.querySelectorAll('.template-cell-input').forEach(input => {
                input.addEventListener('change', updateEditingProfile);
            });
        }
    }

    function updateEditingProfile(event) {
        const input = event.target;
        const sheetKey = input.dataset.sheet;
        const section = input.dataset.section;
        const field = input.dataset.field;
        const value = input.value.trim().toUpperCase();

        if (editingProfile && editingProfile.reviewerSheets[sheetKey]) {
            if (!editingProfile.reviewerSheets[sheetKey][section]) {
                editingProfile.reviewerSheets[sheetKey][section] = {};
            }
            editingProfile.reviewerSheets[sheetKey][section][field] = value;
        }
    }

    function saveTemplateConfig() {
        if (!editingProfile) return;

        // Update profile name and description
        const nameInput = document.getElementById('profileName');
        const descInput = document.getElementById('profileDescription');
        if (nameInput && !editingProfile.isDefault) {
            editingProfile.name = nameInput.value.trim() || editingProfile.name;
        }
        if (descInput && !editingProfile.isDefault) {
            editingProfile.description = descInput.value.trim() || editingProfile.description;
        }

        // Save to TEMPLATE_PROFILES
        TEMPLATE_PROFILES[editingProfileId] = editingProfile;

        // Set as active profile
        setActiveProfile(editingProfileId);
        state.activeTemplateId = editingProfileId;

        // Save to localStorage
        saveTemplateProfiles();

        hideTemplateConfig();
        showToast('success', 'Template Saved', `Profile "${editingProfile.name}" saved and activated.`);
        render();
    }

    // ============================================================
    // PDF VIEWER
    // ============================================================
    let currentEvidenceCriterion = null; // Track which criterion's evidence we're viewing
    let currentSearchTerms = []; // Store current search terms for highlighting
    let pdfViewMode = 'visual'; // 'visual' or 'text'
    let pdfZoomScale = 1.0; // Current zoom level for visual mode

    function showPdfViewer(context, searchTerms = [], fromEvidenceModal = false, criterionId = null) {
        document.getElementById('pdfViewerContext').textContent = context;
        document.getElementById('pdfViewerModal').classList.remove('hidden');

        // Store search terms for use when navigating pages
        currentSearchTerms = searchTerms;

        // Show/hide back button based on whether we came from evidence modal
        const backBtn = document.getElementById('backToEvidenceBtn');
        if (fromEvidenceModal && criterionId) {
            currentEvidenceCriterion = criterionId;
            backBtn.classList.remove('hidden');
            backBtn.classList.add('flex');
        } else {
            currentEvidenceCriterion = null;
            backBtn.classList.add('hidden');
            backBtn.classList.remove('flex');
        }

        // Set initial view mode and render
        setPdfViewMode(pdfViewMode);
        renderPdfPage(state.pdfViewerCurrentPage, searchTerms);
    }

    // Switch between visual and text view modes
    function setPdfViewMode(mode) {
        pdfViewMode = mode;
        const visualView = document.getElementById('pdfVisualView');
        const textView = document.getElementById('pdfTextView');
        const visualBtn = document.getElementById('visualViewBtn');
        const textBtn = document.getElementById('textViewBtn');
        const zoomControls = document.getElementById('zoomControls');

        if (mode === 'visual') {
            visualView.classList.remove('hidden');
            textView.classList.add('hidden');
            visualBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-md transition-colors bg-white text-blue-600 shadow-sm';
            textBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-md transition-colors text-slate-600 hover:text-slate-800';
            zoomControls.classList.remove('hidden');
            // Render visual PDF page
            renderVisualPdfPage(state.pdfViewerCurrentPage);
        } else {
            visualView.classList.add('hidden');
            textView.classList.remove('hidden');
            textBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-md transition-colors bg-white text-blue-600 shadow-sm';
            visualBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-md transition-colors text-slate-600 hover:text-slate-800';
            zoomControls.classList.add('hidden');
            // Render text view
            renderTextPdfPage(state.pdfViewerCurrentPage, currentSearchTerms);
        }
    }

    // Zoom controls for visual PDF view
    function zoomPdf(delta) {
        pdfZoomScale = Math.max(0.5, Math.min(3.0, pdfZoomScale + delta));
        document.getElementById('zoomLevel').textContent = Math.round(pdfZoomScale * 100) + '%';
        renderVisualPdfPage(state.pdfViewerCurrentPage);
    }

    // Render PDF page as visual image (shows graphics, charts, etc.)
    async function renderVisualPdfPage(pageIndex) {
        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');

        // Check if PDF document is available
        if (!state.pdfDocument) {
            console.warn('[PDF Visual] No PDF document loaded, attempting to reload from file');

            // Try to reload the PDF from the stored file
            if (state.applicationPDF) {
                try {
                    const arrayBuffer = await state.applicationPDF.arrayBuffer();
                    state.pdfDocument = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    console.log('[PDF Visual] Reloaded PDF document');
                } catch (reloadError) {
                    console.error('[PDF Visual] Failed to reload PDF:', reloadError);
                    showPdfLoadError(canvas, ctx, 'PDF not available. Please reload the document.');
                    return;
                }
            } else {
                showPdfLoadError(canvas, ctx, 'No PDF loaded. Please upload a document.');
                return;
            }
        }

        try {
            const pageNum = Math.max(1, Math.min(pageIndex + 1, state.pdfDocument.numPages));
            console.log(`[PDF Visual] Rendering page ${pageNum} of ${state.pdfDocument.numPages}`);

            const page = await state.pdfDocument.getPage(pageNum);

            // Calculate scale based on zoom level
            const baseScale = 1.5; // Base rendering quality
            const scale = baseScale * pdfZoomScale;
            const viewport = page.getViewport({ scale });

            // Set canvas dimensions
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            // Ensure canvas is visible
            canvas.style.display = 'block';

            // Clear canvas with white background first
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Render the PDF page
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport,
                background: 'white'
            };

            await page.render(renderContext).promise;

            console.log(`[PDF Visual] Successfully rendered page ${pageNum} (${canvas.width}x${canvas.height}) at ${Math.round(pdfZoomScale * 100)}% zoom`);
        } catch (error) {
            console.error('[PDF Visual] Render error:', error);
            showPdfLoadError(canvas, ctx, 'Unable to render page: ' + error.message);
        }
    }

    // Helper to show error message on canvas
    function showPdfLoadError(canvas, ctx, message) {
        canvas.width = 600;
        canvas.height = 400;
        ctx.fillStyle = '#f1f5f9';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#64748b';
        ctx.font = '16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(message, canvas.width / 2, canvas.height / 2);
    }

    // Render PDF page as text with highlighting (original functionality)
    function renderTextPdfPage(pageIndex, searchTerms = null) {
        if (!state.pdfPages.length) return;
        const termsToUse = searchTerms !== null ? searchTerms : currentSearchTerms;
        const pageText = state.pdfPages[pageIndex] || '';
        let displayText = pageText;

        // Build search phrases and apply highlighting (same as before)
        const searchPhrases = [];
        termsToUse.forEach(term => {
            if (term && term.length > 3) {
                const normalizedTerm = term.replace(/\s+/g, ' ').trim();
                if (normalizedTerm.length <= 100) searchPhrases.push(normalizedTerm);
                const phrases = normalizedTerm.split(/[.!?]/).filter(p => p.trim().length > 15);
                phrases.forEach(p => {
                    const cleaned = p.trim();
                    if (cleaned.length > 15 && cleaned.length <= 80) searchPhrases.push(cleaned);
                    if (cleaned.length > 40) searchPhrases.push(cleaned.substring(0, 40));
                });
                if (normalizedTerm.length > 50) searchPhrases.push(normalizedTerm.substring(0, 50));
                if (normalizedTerm.length > 30) searchPhrases.push(normalizedTerm.substring(0, 30));
            }
        });

        const uniquePhrases = [...new Set(searchPhrases)].sort((a, b) => b.length - a.length);
        uniquePhrases.forEach(phrase => {
            if (phrase && phrase.length > 10) {
                const escaped = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const flexiblePattern = escaped.replace(/ /g, '\\s+');
                try {
                    const regex = new RegExp(`(${flexiblePattern})`, 'gi');
                    displayText = displayText.replace(regex, '<span class="highlight-text">$1</span>');
                } catch (e) { /* skip invalid regex */ }
            }
        });

        document.getElementById('pdfTextView').innerHTML = `<div class="prose max-w-none"><div class="text-sm text-slate-600 whitespace-pre-wrap leading-relaxed">${displayText}</div></div>`;
    }

    function hidePdfViewer() {
        document.getElementById('pdfViewerModal').classList.add('hidden');
        currentEvidenceCriterion = null;
        currentSearchTerms = [];
        document.getElementById('backToEvidenceBtn').classList.add('hidden');
    }

    function backToEvidenceModal() {
        if (currentEvidenceCriterion) {
            // BUGFIX: Save criterion ID before hidePdfViewer() clears it
            const criterionId = currentEvidenceCriterion;
            hidePdfViewer();
            showEvidenceForCriterion(criterionId);
        }
    }

    // Main render function that handles both visual and text modes
    function renderPdfPage(pageIndex, searchTerms = null) {
        if (!state.pdfPages.length) return;

        // Store search terms
        if (searchTerms !== null) {
            currentSearchTerms = searchTerms;
        }

        // Update current page index
        state.pdfViewerCurrentPage = Math.max(0, Math.min(pageIndex, state.pdfPages.length - 1));

        // Update page input and total
        document.getElementById('pdfPageInput').value = state.pdfViewerCurrentPage + 1;
        document.getElementById('pdfPageInput').max = state.pdfPages.length;
        document.getElementById('pdfTotalPages').textContent = state.pdfPages.length;

        // Render based on current view mode
        if (pdfViewMode === 'visual') {
            renderVisualPdfPage(state.pdfViewerCurrentPage);
        } else {
            renderTextPdfPage(state.pdfViewerCurrentPage, currentSearchTerms);
        }
    }

    function pdfViewerPrevPage() { renderPdfPage(state.pdfViewerCurrentPage - 1); }
    function pdfViewerNextPage() { renderPdfPage(state.pdfViewerCurrentPage + 1); }

    function goToPage() {
        const input = document.getElementById('pdfPageInput');
        let pageNum = parseInt(input.value, 10);
        if (isNaN(pageNum) || pageNum < 1) pageNum = 1;
        if (pageNum > state.pdfPages.length) pageNum = state.pdfPages.length;
        input.value = pageNum; // Correct any out-of-range input
        renderPdfPage(pageNum - 1, currentSearchTerms);
    }

    function searchInPdf() {
        const term = document.getElementById('pdfSearchInput').value.trim();
        if (!term) return;

        // Find all pages containing the search term
        const matchingPages = [];
        for (let i = 0; i < state.pdfPages.length; i++) {
            if (state.pdfPages[i].toLowerCase().includes(term.toLowerCase())) {
                matchingPages.push(i);
            }
        }

        if (matchingPages.length === 0) {
            showToast('info', 'Not Found', `"${term}" not found in document.`);
            return;
        }

        // Find next matching page from current position (allows cycling through matches)
        let nextPage = matchingPages.find(p => p > state.pdfViewerCurrentPage);
        if (nextPage === undefined) {
            nextPage = matchingPages[0]; // Wrap to first match
        }

        // Update search terms and navigate to page
        currentSearchTerms = [term];
        state.pdfViewerCurrentPage = nextPage;
        renderPdfPage(nextPage, [term]);

        // Show result message
        if (pdfViewMode === 'visual') {
            showToast('success', 'Found', `Page ${nextPage + 1} (${matchingPages.length} match${matchingPages.length > 1 ? 'es' : ''}). Use Text view for highlighting.`);
        } else {
            showToast('success', 'Found', `Page ${nextPage + 1} of ${matchingPages.length} match${matchingPages.length > 1 ? 'es' : ''}`);
        }
    }

    // Helper function to find the best page for excerpts
    function findBestPageForExcerpts(excerpts) {
        if (!excerpts || excerpts.length === 0) return 0;

        // Try each excerpt and find the page with the best match
        for (const excerpt of excerpts) {
            // Normalize the excerpt - remove extra whitespace
            const normalizedExcerpt = excerpt.replace(/\s+/g, ' ').trim();

            // Try progressively shorter search terms
            const searchLengths = [80, 50, 30, 20];
            for (const len of searchLengths) {
                if (normalizedExcerpt.length < len) continue;
                const searchTerm = normalizedExcerpt.substring(0, len).toLowerCase();

                for (let i = 0; i < state.pdfPages.length; i++) {
                    // Normalize page text too
                    const normalizedPage = state.pdfPages[i].replace(/\s+/g, ' ').toLowerCase();
                    if (normalizedPage.includes(searchTerm)) {
                        return i;
                    }
                }
            }

            // Try searching for key phrases (split by commas or periods)
            const keyPhrases = normalizedExcerpt.split(/[,.]/).filter(p => p.trim().length > 15);
            for (const phrase of keyPhrases) {
                const cleanPhrase = phrase.trim().toLowerCase().substring(0, 40);
                for (let i = 0; i < state.pdfPages.length; i++) {
                    const normalizedPage = state.pdfPages[i].replace(/\s+/g, ' ').toLowerCase();
                    if (normalizedPage.includes(cleanPhrase)) {
                        return i;
                    }
                }
            }
        }

        return 0; // Default to first page if nothing found
    }

    // View document for a specific criterion - uses AI excerpts if available
    function viewDocumentForCriterion(criterionId) {
        const suggestion = state.aiSuggestions[criterionId];
        const criterion = CRITERIA.find(c => c.id === criterionId);
        const excerpts = suggestion?.relevantExcerpts || [];

        if (excerpts.length > 0) {
            state.pdfViewerCurrentPage = findBestPageForExcerpts(excerpts);
            showPdfViewer(`Reviewing: ${criterion?.question || criterionId}`, excerpts);
        } else {
            showPdfViewer(`Reviewing: ${criterion?.question || criterionId}`, []);
        }
    }

    // View document with specific excerpts and navigate to first match
    function viewDocumentWithExcerpts(excerpts) {
        if (excerpts && excerpts.length > 0) {
            state.pdfViewerCurrentPage = findBestPageForExcerpts(excerpts);
            showPdfViewer('Evidence Location', excerpts);
        } else {
            showPdfViewer('Document', []);
        }
    }

    // ============================================================
    // COMMENT PROMPT MODAL
    // ============================================================
    let pendingCommentCallback = null;

    function showCommentPrompt(criterion, selectedScore, aiSuggestedScore) {
        const isDifferentFromAI = aiSuggestedScore !== undefined && selectedScore !== aiSuggestedScore;
        let promptText = isDifferentFromAI
            ? `You selected a score of ${selectedScore}, which differs from the AI suggestion of ${aiSuggestedScore}. Please explain your reasoning.`
            : `Please provide your reasoning for the score of ${selectedScore}.`;
        document.getElementById('commentPromptText').textContent = promptText;
        const suggestionsHtml = criterion.reasoningStarters.map((starter, i) => `
            <button onclick="useReasoningStarter(${i})" class="text-left w-full px-3 py-2 text-sm text-blue-700 hover:bg-blue-100 rounded-lg transition-colors" role="listitem">
                "${starter}"
            </button>
        `).join('');
        document.getElementById('reasoningSuggestions').innerHTML = suggestionsHtml;
        document.getElementById('promptedComment').value = state.comments[criterion.id] || '';
        document.getElementById('commentPromptModal').classList.remove('hidden');
        pendingCommentCallback = criterion;
    }

    function useReasoningStarter(index) {
        const criterion = pendingCommentCallback;
        if (criterion && criterion.reasoningStarters[index]) {
            document.getElementById('promptedComment').value = criterion.reasoningStarters[index];
        }
    }

    function savePromptedComment() {
        if (pendingCommentCallback) {
            state.comments[pendingCommentCallback.id] = document.getElementById('promptedComment').value;
            debouncedAutoSave();
        }
        document.getElementById('commentPromptModal').classList.add('hidden');
        pendingCommentCallback = null;
        proceedToNextCriterion();
    }

    function skipCommentPrompt() {
        document.getElementById('commentPromptModal').classList.add('hidden');
        pendingCommentCallback = null;
        proceedToNextCriterion();
    }

    // ============================================================
    // DROP ZONES & FILE HANDLING
    // ============================================================
    function setupDropZones() {
        setTimeout(() => {
            const templateZone = document.getElementById('templateDropZone');
            const templateInput = document.getElementById('templateInput');
            if (templateZone && templateInput) setupDropZone(templateZone, templateInput, handleTemplateUpload);
            const pdfZone = document.getElementById('pdfDropZone');
            const pdfInput = document.getElementById('pdfInput');
            if (pdfZone && pdfInput) setupDropZone(pdfZone, pdfInput, handlePDFUpload);
        }, 100);
    }

    function setupDropZone(zone, input, handler) {
        // BUGFIX: Prevent duplicate event listeners by checking if already setup
        if (zone.dataset.dropzoneInitialized === 'true') return;
        zone.dataset.dropzoneInitialized = 'true';

        // Also mark the input to prevent duplicate change handlers
        if (input.dataset.inputInitialized === 'true') return;
        input.dataset.inputInitialized = 'true';

        zone.addEventListener('click', () => input.click());
        input.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handler(e.target.files[0]);
                // Reset the input value so the same file can be re-uploaded if needed
                e.target.value = '';
            }
        });
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', (e) => { e.preventDefault(); zone.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) handler(e.dataTransfer.files[0]); });
    }

    async function handlePDFUpload(file) {
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            showError('Invalid File Type', 'Please upload a PDF file.');
            return;
        }
        const maxSize = CONFIG.MAX_PDF_SIZE_MB * 1024 * 1024;
        if (file.size > maxSize) {
            showError('File Too Large', `Maximum file size is ${CONFIG.MAX_PDF_SIZE_MB}MB. Your file is ${formatFileSize(file.size)}.`);
            return;
        }
        state.applicationPDF = file;
        state.pdfDocument = null; // Store reference for vision rendering
        showLoading('Processing PDF', `Extracting text from ${file.name}...`, true);
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            state.pdfDocument = pdf; // Store for later vision rendering

            // OPTIMIZATION: Extract pages in parallel batches for faster processing
            const numPages = pdf.numPages;
            const pageTexts = new Array(numPages);
            const batchSize = 5; // Process 5 pages at a time

            for (let start = 0; start < numPages; start += batchSize) {
                const end = Math.min(start + batchSize, numPages);
                updateLoadingProgress(Math.round((start / numPages) * 100), `Pages ${start + 1}-${end} of ${numPages}`);

                // Process batch in parallel
                const batchPromises = [];
                for (let i = start; i < end; i++) {
                    batchPromises.push(
                        pdf.getPage(i + 1).then(async page => {
                            const textContent = await page.getTextContent();
                            return { index: i, text: textContent.items.map(item => item.str).join(' ') };
                        })
                    );
                }
                const results = await Promise.all(batchPromises);
                results.forEach(r => { pageTexts[r.index] = r.text; });
            }

            // Build full text from ordered pages
            state.pdfPages = pageTexts;
            let fullText = pageTexts.map((text, i) => `\n--- Page ${i + 1} ---\n${text}`).join('');
            state.applicationText = fullText;

            // CONSISTENCY: Compute and store document hash for tracking
            const normalizedText = normalizeText(fullText);
            state.documentHash = await hashText(normalizedText);
            state.cachedCriteriaCount = 0; // Reset cache counter for new document
            console.log(`[Document Hash] ${state.documentHash.substring(0, 16)}...`);

            // Update diagnostics
            state.diagnostics.totalPages = pdf.numPages;
            state.diagnostics.totalCharacters = fullText.length;
            state.diagnostics.criteriaAnalyzed = 0;

            // Find which page attachments start on
            const attachmentPageIndex = state.pdfPages.findIndex(pageText =>
                /attachment\s*1\s*:|attachments?\s*index|exhibit\s*a\s*:/i.test(pageText)
            );
            state.diagnostics.attachmentStartPage = attachmentPageIndex !== -1 ? attachmentPageIndex + 1 : null;

            console.log(`[Diagnostics] Pages: ${pdf.numPages}, Total chars: ${fullText.length}, Attachments start: Page ${state.diagnostics.attachmentStartPage || 'N/A'}`);

            // Auto-detect visual content if auto-detection is enabled
            state.visionAutoEnabled = false;
            state.visualContentDetected = false;

            if (state.visionAutoDetect && !state.visionEnabled) {
                const visualDetection = detectVisualContent(state.pdfPages, pdf);
                state.visualContentDetected = visualDetection.hasVisualContent;

                if (visualDetection.hasVisualContent) {
                    console.log(`[Vision Auto-Detect] Visual content detected: ${visualDetection.reasons.join(', ')}`);
                    state.visionEnabled = true;
                    state.visionAutoEnabled = true;
                    // Don't save to localStorage - this is just for this session
                }
            }

            // If vision is enabled (manually or auto), render pages to images
            if (state.visionEnabled) {
                updateLoadingProgress(100, 'Rendering pages for vision analysis...');
                await renderPdfPagesForVision(pdf);
            }

            hideLoading();

            // Build toast message
            let toastMessage = `Successfully extracted ${pdf.numPages} pages.`;
            if (state.visionAutoEnabled) {
                toastMessage += ' Visual content detected - Vision analysis auto-enabled.';
            } else if (state.visionEnabled) {
                toastMessage += ' Vision analysis enabled.';
            }
            showToast('success', 'PDF Loaded', toastMessage);
            if (state.apiKey) await extractProjectInfo();
            render();
        } catch (error) {
            hideLoading();
            showError('PDF Processing Failed', 'Could not extract text from the PDF. The file may be corrupted or password-protected.', () => handlePDFUpload(file));
        }
    }

    // Detect visual content in PDF (charts, graphs, images)
    function detectVisualContent(pdfPages, pdf) {
        const reasons = [];
        let hasVisualContent = false;

        // Check 1: Look for pages with very little text (likely image/chart pages)
        let lowTextPages = 0;
        const pagesWithLowText = [];
        pdfPages.forEach((pageText, index) => {
            const charCount = pageText.trim().length;
            if (charCount < CONFIG.VISION_MIN_CHARS_PER_PAGE && charCount > 0) {
                lowTextPages++;
                pagesWithLowText.push(index + 1);
            }
        });

        if (lowTextPages >= 2) {
            hasVisualContent = true;
            reasons.push(`${lowTextPages} pages with minimal text (likely charts/images)`);
        }

        // Check 2: Look for chart/graph keywords in the text
        const fullText = pdfPages.join(' ').toLowerCase();
        const foundKeywords = CONFIG.VISION_CHART_KEYWORDS.filter(keyword =>
            fullText.includes(keyword.toLowerCase())
        );

        if (foundKeywords.length >= 2) {
            hasVisualContent = true;
            reasons.push(`Keywords found: ${foundKeywords.slice(0, 3).join(', ')}`);
        }

        // Check 3: Look for references to figures, exhibits, or attachments with visual content
        const figurePattern = /figure\s*\d+|exhibit\s*[a-z0-9]+|chart\s*\d+|graph\s*\d+|appendix\s*[a-z]/gi;
        const figureMatches = fullText.match(figurePattern);

        if (figureMatches && figureMatches.length >= 2) {
            hasVisualContent = true;
            reasons.push(`${figureMatches.length} figure/exhibit references`);
        }

        // Check 4: Pages in attachment section with low text (attachments often contain charts)
        if (state.diagnostics.attachmentStartPage) {
            const attachmentPages = pdfPages.slice(state.diagnostics.attachmentStartPage - 1);
            const lowTextAttachPages = attachmentPages.filter(p => p.trim().length < CONFIG.VISION_MIN_CHARS_PER_PAGE).length;
            if (lowTextAttachPages >= 1) {
                hasVisualContent = true;
                reasons.push(`${lowTextAttachPages} attachment pages likely contain visuals`);
            }
        }

        console.log(`[Vision Auto-Detect] Analysis complete. Visual content: ${hasVisualContent}. Reasons: ${reasons.length > 0 ? reasons.join('; ') : 'None'}`);

        return {
            hasVisualContent,
            reasons,
            lowTextPages: pagesWithLowText,
            keywords: foundKeywords
        };
    }

    // Render PDF pages to images for vision analysis
    async function renderPdfPagesForVision(pdf) {
        state.pdfPageImages = [];
        const maxPages = Math.min(pdf.numPages, CONFIG.VISION_MAX_PAGES);

        // Determine which pages to render - prioritize attachment pages if detected
        let pagesToRender = [];
        const attachStart = state.diagnostics.attachmentStartPage;

        if (attachStart && attachStart <= pdf.numPages) {
            // Include some main content pages and attachment pages
            const mainContentPages = Math.min(3, attachStart - 1);
            const attachmentPages = maxPages - mainContentPages;

            // First few pages of main content
            for (let i = 1; i <= mainContentPages; i++) {
                pagesToRender.push(i);
            }
            // Attachment pages
            for (let i = attachStart; i < attachStart + attachmentPages && i <= pdf.numPages; i++) {
                pagesToRender.push(i);
            }
        } else {
            // No attachments detected - render first N pages
            for (let i = 1; i <= maxPages; i++) {
                pagesToRender.push(i);
            }
        }

        console.log(`[Vision] Rendering ${pagesToRender.length} pages for vision analysis: ${pagesToRender.join(', ')}`);

        for (const pageNum of pagesToRender) {
            try {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: CONFIG.VISION_IMAGE_SCALE });

                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');

                // Render page to canvas
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                // Convert to base64 JPEG
                const imageData = canvas.toDataURL('image/jpeg', CONFIG.VISION_IMAGE_QUALITY);
                // Remove the data URL prefix for API
                const base64Data = imageData.replace(/^data:image\/jpeg;base64,/, '');

                state.pdfPageImages.push({
                    pageNum: pageNum,
                    base64: base64Data,
                    width: viewport.width,
                    height: viewport.height
                });

                console.log(`[Vision] Rendered page ${pageNum}: ${Math.round(base64Data.length / 1024)}KB`);
            } catch (err) {
                console.warn(`[Vision] Failed to render page ${pageNum}:`, err);
            }
        }

        state.diagnostics.visionPagesAnalyzed = state.pdfPageImages.length;
        console.log(`[Vision] Total ${state.pdfPageImages.length} pages rendered for vision analysis`);
    }

    async function handleTemplateUpload(file) {
        try {
            showLoading('Loading Template', `Parsing ${file.name}...`);
            const arrayBuffer = await file.arrayBuffer();
            state.templateData = arrayBuffer;
            state.templateName = file.name;

            // Parse the workbook using SheetJS (XLSX library)
            // cellStyles: true preserves cell formatting, colors, fills, etc.
            const workbook = XLSX.read(arrayBuffer, {
                type: 'array',
                cellStyles: true,    // Preserve cell styles
                cellNF: true,        // Preserve number formats
                cellDates: true      // Preserve date formatting
            });
            state.scoringWorkbook = workbook;

            // Try to detect and match template profile
            const detectedProfileId = detectTemplateProfile(workbook);
            if (detectedProfileId && detectedProfileId !== activeProfileId) {
                setActiveProfile(detectedProfileId);
                state.activeTemplateId = detectedProfileId;
                const profile = getActiveProfile();
                showToast('info', 'Template Detected', `Using profile: ${profile.name}`);
            }

            // Verify the reviewer sheet exists
            if (!workbook.SheetNames.includes(state.reviewerSheet)) {
                hideLoading();
                const availableSheets = workbook.SheetNames.join(', ');
                showToast('warning', 'Sheet Not Found', `"${state.reviewerSheet}" not found. Available: ${availableSheets}`);
                // Try to find a matching reviewer sheet
                const reviewerSheets = workbook.SheetNames.filter(s => s.toLowerCase().includes('reviewer') || s.toLowerCase().includes('scoring'));
                if (reviewerSheets.length > 0) {
                    state.reviewerSheet = reviewerSheets[0];
                    localStorage.setItem('nofa_reviewer_sheet', state.reviewerSheet);
                    showToast('info', 'Sheet Auto-Selected', `Using "${state.reviewerSheet}"`);
                }
            }

            hideLoading();
            showToast('success', 'Template Loaded', `${file.name} - Ready for export to "${state.reviewerSheet}"`);
            render();
        } catch (e) {
            hideLoading();
            showError('Template Load Failed', e.message);
        }
    }

    function clearTemplate() { state.templateData = null; state.templateName = ''; state.scoringWorkbook = null; render(); }
    function clearPdf() { state.applicationText = ''; state.pdfPages = []; state.projectInfo = {}; render(); }

    // ============================================================
    // AI INTEGRATION
    // ============================================================

    // Retry helper with exponential backoff
    async function withRetry(fn, maxAttempts = CONFIG.API_RETRY_ATTEMPTS) {
        let lastError;
        for (let attempt = 1; attempt <= maxAttempts; attempt++) {
            try {
                return await fn();
            } catch (error) {
                lastError = error;
                const isRetryable = error.message?.includes('rate') ||
                                   error.message?.includes('overloaded') ||
                                   error.message?.includes('529') ||
                                   error.message?.includes('500') ||
                                   error.message?.includes('timeout');

                if (attempt < maxAttempts && isRetryable) {
                    const delay = CONFIG.API_RETRY_DELAY_MS * Math.pow(2, attempt - 1);
                    console.log(`[API Retry] Attempt ${attempt} failed, retrying in ${delay}ms...`);
                    await new Promise(r => setTimeout(r, delay));
                } else if (!isRetryable) {
                    throw error; // Don't retry non-retryable errors
                }
            }
        }
        throw lastError;
    }

    async function callClaude(systemPrompt, userPrompt) {
        if (!state.apiKey) throw new Error('API key not configured');

        return withRetry(async () => {
            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: CONFIG.MODEL,
                    max_tokens: CONFIG.MAX_TOKENS,
                    temperature: 0,  // CRITICAL: Set to 0 for deterministic, consistent scoring
                    system: systemPrompt,
                    messages: [{ role: 'user', content: userPrompt }]
                })
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `API request failed (${response.status})`);
            }
            const data = await response.json();
            return data.content[0].text;
        });
    }

    // Call Claude with vision capability - sends images along with text
    async function callClaudeWithVision(systemPrompt, userPrompt, images = []) {
        if (!state.apiKey) throw new Error('API key not configured');

        // Build message content with text and images
        const messageContent = [];

        // Add images first (Claude processes them in order)
        for (const img of images) {
            messageContent.push({
                type: 'image',
                source: {
                    type: 'base64',
                    media_type: 'image/jpeg',
                    data: img.base64
                }
            });
        }

        // Add the text prompt
        messageContent.push({
            type: 'text',
            text: userPrompt
        });

        return withRetry(async () => {
            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: CONFIG.MODEL,
                    max_tokens: CONFIG.MAX_TOKENS,
                    temperature: 0,
                    system: systemPrompt,
                    messages: [{ role: 'user', content: messageContent }]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `API request failed (${response.status})`);
            }
            const data = await response.json();
            return data.content[0].text;
        });
    }

    async function extractProjectInfo() {
        showLoading('Analyzing Application', 'AI is extracting project information...');
        // CONSISTENCY: Use normalized text for project info extraction
        const normalizedText = getConsistentTextChunk(state.applicationText, 15000);
        const systemPrompt = `You are a NOFA application reviewer for San Mateo County. Extract key project information from the application text. Return ONLY a JSON object with these exact fields: { "applicant": "Organization name", "project": "Project title", "amountRequested": 75000, "totalCost": 150000, "clientsServed": 500, "projectDescription": "Brief 2-3 sentence description" }. Use numbers without formatting for monetary values. If not found, use null.`;
        try {
            const response = await callClaude(systemPrompt, `Extract project information:\n\n${normalizedText}`);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) state.projectInfo = JSON.parse(jsonMatch[0]);
            hideLoading();
            debouncedAutoSave();
            render();
        } catch (error) {
            hideLoading();
            showError('AI Extraction Failed', error.message, extractProjectInfo);
        }
    }

    async function getAISuggestion(criterion) {
        const costPerClient = state.projectInfo.totalCost && state.projectInfo.clientsServed ? state.projectInfo.totalCost / state.projectInfo.clientsServed : null;
        const countyPercent = state.projectInfo.amountRequested && state.projectInfo.totalCost ? (state.projectInfo.amountRequested / state.projectInfo.totalCost) * 100 : null;

        // CONSISTENCY: Get comprehensive text including main content AND attachments/exhibits
        const normalizedText = getComprehensiveTextForAI(state.applicationText, CONFIG.TEXT_CHUNK_SIZE);

        // Include vision flag in cache key so vision/non-vision results are cached separately
        const visionFlag = state.visionEnabled && state.pdfPageImages.length > 0 ? '_vision' : '';

        // CONSISTENCY: Generate hash for caching
        const inputForHash = `${criterion.id}_${normalizedText}_${JSON.stringify(state.projectInfo)}${visionFlag}`;
        const inputHash = await hashText(inputForHash);

        // CONSISTENCY: Check cache first
        const cachedResponse = getCachedResponse(inputHash, criterion.id);
        if (cachedResponse) {
            state.cachedCriteriaCount++;
            console.log(`[Cache HIT] Criterion ${criterion.id} - Total cached: ${state.cachedCriteriaCount}`);
            return cachedResponse;
        }

        // Build system prompt - add vision context if enabled
        const visionContext = state.visionEnabled && state.pdfPageImages.length > 0
            ? `\n\nVISION ANALYSIS: You are also provided with ${state.pdfPageImages.length} page images from the PDF. Carefully examine these images for charts, graphs, tables, organizational diagrams, financial statements, and any visual evidence that supports or contradicts the application. Reference specific visual elements in your reasoning.`
            : '';

        const systemPrompt = `You are an expert NOFA reviewer for San Mateo County Department of Housing. You are evaluating criterion: "${criterion.question}"\n\nSCORING RULE:\n${criterion.scoringRule}\n\nPROJECT INFO:\n- Applicant: ${state.projectInfo.applicant || 'Unknown'}\n- Project: ${state.projectInfo.project || 'Unknown'}\n- Amount Requested: ${formatCurrency(state.projectInfo.amountRequested)}\n- Total Cost: ${formatCurrency(state.projectInfo.totalCost)}\n- Clients Served: ${formatNumber(state.projectInfo.clientsServed)}\n- Cost Per Client: ${costPerClient ? formatCurrency(costPerClient) : 'N/A'}\n- County % of Total: ${countyPercent ? countyPercent.toFixed(1) + '%' : 'N/A'}\n\nIMPORTANT: The application text includes BOTH the main narrative AND attachments/exhibits section. Look for evidence in attachments (financial statements, audits, organizational charts, letters of support, etc.) when evaluating criteria that reference them.${visionContext}\n\nProvide BOTH a recommendation AND a counter-argument.\n\nRespond with ONLY a JSON object:\n{\n    "suggestedScore": 2,\n    "reasoning": "Your detailed reasoning citing specific evidence from the application AND attachments${state.visionEnabled ? ', including any charts, graphs, or visual elements you observed' : ''}",\n    "counterArgument": "A thoughtful argument for why a different score might be appropriate",\n    "counterScore": 1,\n    "relevantExcerpts": ["Exact quote 1", "Exact quote 2"],\n    "pageReferences": [1, 3],\n    "confidence": "high|medium|low"\n}\n\nOnly suggest scores from: ${criterion.validScores.join(', ')}`;

        try {
            let response;

            // Use vision API if enabled and images are available
            if (state.visionEnabled && state.pdfPageImages.length > 0) {
                console.log(`[Vision] Analyzing criterion ${criterion.id} with ${state.pdfPageImages.length} page images`);
                response = await callClaudeWithVision(
                    systemPrompt,
                    `${criterion.aiPrompt}\n\nAPPLICATION TEXT:\n${normalizedText}\n\nThe images above show pages from the PDF application. Please analyze both the text and the visual elements (charts, graphs, tables, diagrams) when evaluating this criterion.`,
                    state.pdfPageImages
                );
            } else {
                // Standard text-only API call
                response = await callClaude(systemPrompt, `${criterion.aiPrompt}\n\nAPPLICATION TEXT:\n${normalizedText}`);
            }

            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const parsedResponse = JSON.parse(jsonMatch[0]);
                // CONSISTENCY: Cache the response
                setCachedResponse(inputHash, criterion.id, parsedResponse);
                // Track criteria analyzed for diagnostics
                state.diagnostics.criteriaAnalyzed++;
                return parsedResponse;
            }
            return null;
        } catch (error) {
            showToast('error', 'AI Analysis Failed', error.message);
            return null;
        }
    }

    // ============================================================
    // RENDERING
    // ============================================================

    // Debounced render to prevent rapid DOM thrashing
    let renderTimeout = null;
    let renderScheduled = false;

    function render() {
        // Debounce rapid render calls
        if (renderScheduled) return;
        renderScheduled = true;

        if (renderTimeout) clearTimeout(renderTimeout);
        renderTimeout = setTimeout(() => {
            renderScheduled = false;
            renderImmediate();
        }, CONFIG.RENDER_DEBOUNCE_MS);
    }

    // Direct render without debouncing (for initial load)
    function renderImmediate() {
        const main = document.getElementById('mainContent');
        switch (state.currentStep) {
            case 'upload': renderUploadStep(main); break;
            case 'projectInfo': renderProjectInfoStep(main); break;
            case 'scoring': renderScoringStep(main); break;
            case 'globalReview': renderGlobalReviewStep(main); break;
            case 'recommendation': renderRecommendationStep(main); break;
            case 'summary': renderSummaryStep(main); break;
        }
        setTimeout(setupDropZones, 100);
        updateAutoAnalyzeButton();
    }

    function updateAutoAnalyzeButton() {
        const btn = document.getElementById('autoAnalyzeHeaderBtn');
        const btnText = document.getElementById('autoAnalyzeBtnText');
        if (!btn || !btnText) return;

        // Count unscored criteria (check for both undefined and null)
        const unscoredCount = CRITERIA.filter(c => state.scores[c.id] === undefined || state.scores[c.id] === null).length;
        const hasApplication = state.applicationText && state.applicationText.length > 0;
        const hasApiKey = state.apiKey && state.apiKey.length > 0;

        // Show button when we have application loaded and API key, and we're in a relevant step
        const relevantSteps = ['projectInfo', 'scoring', 'globalReview'];
        const shouldShow = hasApplication && hasApiKey && relevantSteps.includes(state.currentStep);

        if (shouldShow) {
            // Use inline style to guarantee visibility
            btn.style.display = 'flex';
            btn.classList.remove('hidden');
            if (unscoredCount === CRITERIA.length) {
                btnText.textContent = 'Auto-Analyze All';
            } else if (unscoredCount > 0) {
                btnText.textContent = `Auto-Analyze (${unscoredCount} left)`;
            } else {
                btnText.textContent = 'Re-Analyze All';
            }
        } else {
            btn.style.display = 'none';
            btn.classList.add('hidden');
        }
    }

    function renderUploadStep(container) {
        container.innerHTML = `
            <div class="fade-in space-y-6">
                ${!state.apiKey ? `
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4" role="alert">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-amber-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-amber-800">API Key Required</p>
                                <p class="text-sm text-amber-700 mt-1">Click Settings to add your Anthropic API key for AI-assisted scoring.</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
                <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                    <h2 class="text-xl font-bold text-slate-800 mb-2">Step 1: Load Excel Template</h2>
                    <p class="text-slate-500 mb-4">Load the official County scoring template. Your evaluation will be exported to <strong>"${state.reviewerSheet}"</strong>.</p>
                    ${state.templateData ? `
                        <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    <span class="text-green-700 font-medium">${state.templateName || 'Template loaded'}</span>
                                </div>
                                <button onclick="clearTemplate()" class="text-sm text-green-600 hover:text-green-800">Change</button>
                            </div>
                        </div>
                    ` : `
                        <div id="templateDropZone" class="drop-zone border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-green-400 hover:bg-green-50/50 transition-all" role="button" tabindex="0" aria-label="Upload Excel template">
                            <svg class="w-12 h-12 mx-auto mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            <p class="text-slate-600 font-medium">Drop Excel template here or click to browse</p>
                            <p class="text-xs text-slate-400 mt-2">Supports .xlsx and .xls files (max ${CONFIG.MAX_PDF_SIZE_MB}MB)</p>
                            <input type="file" id="templateInput" accept=".xlsx,.xls" class="hidden" aria-hidden="true">
                        </div>
                    `}
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                    <h2 class="text-xl font-bold text-slate-800 mb-2">Step 2: Upload NOFA Application (PDF)</h2>
                    <p class="text-slate-500 mb-4">Upload the PDF application to begin AI-assisted evaluation</p>
                    ${state.applicationText ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        <span class="text-blue-700 font-medium">Application Loaded</span>
                                    </div>
                                    <p class="text-sm text-blue-600 ml-7">${state.pdfPages.length} pages extracted</p>
                                </div>
                                <button onclick="clearPdf()" class="text-sm text-blue-600 hover:text-blue-800">Change</button>
                            </div>
                        </div>
                    ` : `
                        <div id="pdfDropZone" class="drop-zone border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50/50 transition-all" role="button" tabindex="0" aria-label="Upload PDF application">
                            <svg class="w-12 h-12 mx-auto mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                            <p class="text-slate-600 font-medium">Drop PDF application here or click to browse</p>
                            <p class="text-xs text-slate-400 mt-2">Maximum file size: ${CONFIG.MAX_PDF_SIZE_MB}MB</p>
                            <input type="file" id="pdfInput" accept=".pdf" class="hidden" aria-hidden="true">
                        </div>
                    `}
                </div>
                ${state.templateData && state.applicationText && state.projectInfo.applicant ? `
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                        <p class="font-semibold text-green-800">Ready to evaluate: ${state.projectInfo.applicant}</p>
                        ${state.projectInfo.project ? `<p class="text-green-700">${state.projectInfo.project}</p>` : ''}
                        ${state.projectInfo.amountRequested ? `<p class="text-green-600 text-sm">Requesting: ${formatCurrency(state.projectInfo.amountRequested)}</p>` : ''}
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="text-lg font-bold text-slate-800 mb-3">Choose Your Evaluation Method</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="goToProjectInfo()" class="bg-blue-50 border-2 border-blue-200 text-left p-5 rounded-xl hover:border-blue-400 hover:bg-blue-100 transition-all group">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-blue-800 group-hover:text-blue-900">Manual Step-by-Step</p>
                                        <p class="text-sm text-blue-600 mt-1">Evaluate each criterion individually with AI assistance</p>
                                    </div>
                                </div>
                            </button>

                            <button onclick="startAutoAnalyzeAll()" class="bg-purple-50 border-2 border-purple-200 text-left p-5 rounded-xl hover:border-purple-400 hover:bg-purple-100 transition-all group">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-purple-800 group-hover:text-purple-900">Auto-Analyze All</p>
                                        <p class="text-sm text-purple-600 mt-1">AI analyzes everything, then you review and adjust in one view</p>
                                    </div>
                                </div>
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-3 text-center">Both methods let you modify scores and comments. Auto-analyze is faster but uses more API calls.</p>
                    </div>
                ` : `<p class="text-center text-slate-500">Upload both files to continue</p>`}
            </div>`;
    }

    function goToProjectInfo() { state.currentStep = 'projectInfo'; render(); }

    function renderProjectInfoStep(container) {
        const info = state.projectInfo;
        container.innerHTML = `
            <div class="fade-in">
                <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <button onclick="goBack()" class="text-slate-400 hover:text-slate-600" aria-label="Go back">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        </button>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Project Information</h2>
                            <p class="text-sm text-slate-500">Verify AI-extracted data (edit if needed)</p>
                        </div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4" role="alert">
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <p class="text-sm text-blue-800">This information was extracted by AI. Please verify accuracy before proceeding.</p>
                        </div>
                    </div>

                    ${state.documentHash ? `
                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-3 mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                                <span class="text-xs font-medium text-slate-600">Document Hash (Consistency ID)</span>
                            </div>
                            <code class="text-xs bg-white px-2 py-1 rounded border border-slate-200 font-mono text-slate-700">${state.documentHash.substring(0, 16)}...</code>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">This hash ensures consistent AI scoring. Same document = same scores.</p>
                    </div>
                    ` : ''}
                    <div class="space-y-4">
                        <div>
                            <label for="infoApplicant" class="block text-sm font-medium text-slate-700 mb-1">Applicant/Organization</label>
                            <input type="text" id="infoApplicant" value="${info.applicant || ''}" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="infoProject" class="block text-sm font-medium text-slate-700 mb-1">Project Title</label>
                            <input type="text" id="infoProject" value="${info.project || ''}" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="infoAmount" class="block text-sm font-medium text-slate-700 mb-1">Amount Requested</label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                    <input type="number" id="infoAmount" value="${info.amountRequested || ''}" class="w-full pl-8 pr-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div>
                                <label for="infoTotalCost" class="block text-sm font-medium text-slate-700 mb-1">Total Project Cost</label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                    <input type="number" id="infoTotalCost" value="${info.totalCost || ''}" class="w-full pl-8 pr-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="infoClients" class="block text-sm font-medium text-slate-700 mb-1">Clients/Households Served</label>
                            <input type="number" id="infoClients" value="${info.clientsServed || ''}" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="infoDescription" class="block text-sm font-medium text-slate-700 mb-1">Project Description</label>
                            <textarea id="infoDescription" rows="3" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 resize-none">${info.projectDescription || ''}</textarea>
                        </div>
                    </div>
                    <button onclick="saveProjectInfoAndContinue()" class="mt-6 w-full bg-blue-600 text-white py-4 rounded-xl font-semibold hover:bg-blue-700 transition-colors">
                        Continue to Scoring
                    </button>
                </div>
            </div>`;
    }

    function saveProjectInfoAndContinue() {
        state.projectInfo = {
            applicant: document.getElementById('infoApplicant').value,
            project: document.getElementById('infoProject').value,
            amountRequested: parseFloat(document.getElementById('infoAmount').value) || 0,
            totalCost: parseFloat(document.getElementById('infoTotalCost').value) || 0,
            clientsServed: parseInt(document.getElementById('infoClients').value) || 0,
            projectDescription: document.getElementById('infoDescription').value
        };
        state.currentStep = 'scoring';
        state.currentCriterionIndex = 0;
        debouncedAutoSave();
        render();
    }

    async function renderScoringStep(container) {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const currentScore = state.scores[criterion.id];
        const currentComment = state.comments[criterion.id] || '';
        const suggestion = state.aiSuggestions[criterion.id];
        const progress = Math.round(((state.currentCriterionIndex) / CRITERIA.length) * 100);
        const totalScore = Object.values(state.scores).reduce((a, b) => a + b, 0);

        container.innerHTML = `
            <div class="fade-in">
                <div class="bg-white rounded-xl border border-slate-200 p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-slate-600">Question ${state.currentCriterionIndex + 1} of ${CRITERIA.length}</span>
                        <div class="flex items-center gap-3">
                            ${state.cachedCriteriaCount > 0 ? `
                            <span class="text-xs text-green-600 flex items-center gap-1" title="Cached responses ensure consistent scoring">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                ${state.cachedCriteriaCount} cached
                            </span>
                            ` : ''}
                            <span class="text-sm font-bold text-blue-600">${totalScore} pts scored</span>
                        </div>
                    </div>
                    <div class="h-2 bg-slate-100 rounded-full overflow-hidden" role="progressbar" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                        <div class="h-full bg-blue-600 transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="bg-gradient-to-r from-slate-50 to-slate-100 p-4 border-b border-slate-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-600 text-white rounded-xl flex items-center justify-center font-bold">${criterion.section}</div>
                                <div>
                                    <h3 class="font-bold text-slate-800">${criterion.sectionTitle}</h3>
                                    <p class="text-sm text-slate-500">Max ${criterion.validScores[criterion.validScores.length - 1]} points</p>
                                </div>
                            </div>
                            <button onclick="viewDocumentForCriterion('${criterion.id}')" class="flex items-center gap-2 px-3 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 text-sm text-slate-600 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                View Document
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="mb-6">
                            <p class="text-lg font-semibold text-slate-800 mb-3">${criterion.question}</p>
                            <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                                <p class="text-xs font-semibold text-slate-500 mb-1">SCORING RULE:</p>
                                <p class="text-sm text-slate-700 whitespace-pre-line">${criterion.scoringRule}</p>
                            </div>
                        </div>
                        <div id="aiSuggestionArea" class="mb-6">
                            ${suggestion ? renderAISuggestion(suggestion) : `
                                <button onclick="requestAISuggestion()" class="w-full bg-purple-50 border border-purple-200 rounded-xl p-4 text-left hover:bg-purple-100 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                                        <div>
                                            <p class="font-medium text-purple-800">Analyze with AI</p>
                                            <p class="text-sm text-purple-600">Get a recommendation and counter-argument</p>
                                        </div>
                                    </div>
                                </button>
                            `}
                        </div>
                        <div class="mb-6">
                            <p class="text-sm font-medium text-slate-700 mb-3">Your Score:</p>
                            <div class="flex flex-wrap gap-3" role="group" aria-label="Score selection">
                                ${criterion.validScores.map(score => `
                                    <button onclick="selectScore('${criterion.id}', ${score})"
                                        class="score-btn w-14 h-14 rounded-xl font-bold text-lg border-2 transition-all ${currentScore === score ? 'bg-blue-600 text-white border-blue-600 selected' : 'bg-white text-slate-700 border-slate-200 hover:border-blue-400'}"
                                        aria-pressed="${currentScore === score}" aria-label="Score ${score}">
                                        ${score}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <label for="criterionComment" class="block text-sm font-medium text-slate-700 mb-2">
                                Your Reasoning ${criterion.requiresComment ? '<span class="text-red-500">(Required)</span>' : '<span class="text-slate-400">(Recommended)</span>'}
                            </label>
                            <textarea id="criterionComment" rows="3" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 resize-none" placeholder="Explain why you selected this score...">${currentComment}</textarea>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 border-t border-slate-200 flex items-center justify-between">
                        ${state.returnToSummary ? `
                            <button onclick="cancelEditAndReturn()" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                Cancel
                            </button>
                            <button onclick="saveAndReturnToSummary()" class="px-6 py-2.5 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                Save & Return to Summary
                            </button>
                        ` : `
                            <button onclick="goBack()" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                                Back
                            </button>
                            <button onclick="handleNextCriterion()" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center gap-2">
                                ${state.currentCriterionIndex < CRITERIA.length - 1 ? 'Next' : 'Finish'}
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            </button>
                        `}
                    </div>
                </div>
            </div>`;
    }

    function renderAISuggestion(suggestion) {
        // Escape quotes for JSON embedding in onclick handlers
        const escapedExcerpts = suggestion.relevantExcerpts ? JSON.stringify(suggestion.relevantExcerpts).replace(/'/g, "\\'").replace(/"/g, '&quot;') : '[]';
        const escapedReasoning = (suggestion.reasoning || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

        return `
            <div class="space-y-4">
                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span class="font-semibold text-green-800">Recommendation: Score ${suggestion.suggestedScore}</span>
                        <span class="text-xs bg-green-200 text-green-700 px-2 py-0.5 rounded-full">${suggestion.confidence} confidence</span>
                    </div>
                    <p class="text-sm text-green-900 mb-3">${suggestion.reasoning}</p>
                    ${suggestion.relevantExcerpts?.length ? `
                        <div class="bg-white rounded-lg p-3 border border-green-100">
                            <p class="text-xs font-semibold text-green-600 mb-2">SUPPORTING EVIDENCE:</p>
                            ${suggestion.relevantExcerpts.map(e => `<p class="text-xs text-slate-600 italic mb-1">"${e}"</p>`).join('')}
                            <button onclick="viewDocumentWithExcerpts(JSON.parse('${escapedExcerpts}'))" class="mt-2 text-xs text-green-600 hover:text-green-800 font-medium flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                View in document →
                            </button>
                        </div>
                    ` : ''}
                    <div class="mt-3">
                        <button onclick="useAIReasoningAsComment()" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            Accept: Score ${suggestion.suggestedScore} + Comment
                        </button>
                    </div>
                </div>
                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span class="font-semibold text-amber-800">Counter-Argument: Consider Score ${suggestion.counterScore}</span>
                    </div>
                    <p class="text-sm text-amber-900">${suggestion.counterArgument}</p>
                    <div class="mt-3">
                        <button onclick="useCounterArgumentAsComment()" class="text-xs bg-amber-600 text-white px-3 py-1.5 rounded-lg hover:bg-amber-700 transition-colors flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            Accept: Score ${suggestion.counterScore} + Comment
                        </button>
                    </div>
                </div>
            </div>`;
    }

    function useAIReasoningAsComment() {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const suggestion = state.aiSuggestions[criterion.id];
        if (suggestion && suggestion.reasoning) {
            const commentEl = document.getElementById('criterionComment');
            if (commentEl) {
                // Build a comprehensive comment from AI reasoning + evidence
                let comment = suggestion.reasoning;
                if (suggestion.relevantExcerpts?.length) {
                    comment += '\n\nEvidence: ' + suggestion.relevantExcerpts.map(e => '"' + e + '"').join('; ');
                }
                commentEl.value = comment;
                state.comments[criterion.id] = comment;

                // Auto-select the corresponding score
                state.scores[criterion.id] = suggestion.suggestedScore;

                debouncedAutoSave();
                showToast('success', 'Score & Comment Set', `Score ${suggestion.suggestedScore} selected with AI reasoning.`);
                render();
            }
        }
    }

    function useCounterArgumentAsComment() {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const suggestion = state.aiSuggestions[criterion.id];
        if (suggestion && suggestion.counterArgument) {
            const commentEl = document.getElementById('criterionComment');
            if (commentEl) {
                // Use counter-argument as the comment
                let comment = suggestion.counterArgument;
                commentEl.value = comment;
                state.comments[criterion.id] = comment;

                // Auto-select the corresponding counter score
                state.scores[criterion.id] = suggestion.counterScore;

                debouncedAutoSave();
                showToast('success', 'Score & Comment Set', `Score ${suggestion.counterScore} selected with counter-argument reasoning.`);
                render();
            }
        }
    }

    // ============================================================
    // AUTO-ANALYZE ALL FUNCTIONALITY
    // ============================================================

    // Called from header button - analyzes remaining unscored criteria
    async function autoAnalyzeRemaining() {
        if (!state.apiKey) {
            showToast('error', 'API Key Required', 'Please add your Anthropic API key in Settings to use Auto-Analyze.');
            showSettings();
            return;
        }

        if (!state.applicationText) {
            showToast('error', 'No Application', 'Please upload a PDF application first.');
            return;
        }

        // Find criteria that still need scoring (include null scores from AI unable to determine)
        const remainingCriteria = CRITERIA.filter(c =>
            state.scores[c.id] === undefined ||
            state.scores[c.id] === null ||
            !state.aiSuggestions[c.id]
        );

        if (remainingCriteria.length === 0) {
            // All scored - offer to re-analyze
            if (confirm('All criteria have been scored. Do you want to re-analyze everything with AI? This will generate new suggestions but preserve your current scores.')) {
                await reAnalyzeAll();
            }
            return;
        }

        state.isAutoAnalyzing = true;
        state.autoAnalyzeProgress = 0;
        const totalToAnalyze = remainingCriteria.length;
        showLoading(`Auto-Analyzing ${totalToAnalyze} Criteria`, `Starting analysis...`, true);

        try {
            for (let i = 0; i < remainingCriteria.length; i++) {
                const criterion = remainingCriteria[i];
                state.autoAnalyzeProgress = Math.round(((i) / totalToAnalyze) * 100);
                updateLoadingProgress(state.autoAnalyzeProgress, `Analyzing ${criterion.id.toUpperCase()}: ${criterion.question.substring(0, 40)}...`);

                const suggestion = await getAISuggestion(criterion);
                if (suggestion) {
                    state.aiSuggestions[criterion.id] = suggestion;
                    // Only auto-fill if not already scored (include null scores)
                    if (state.scores[criterion.id] === undefined || state.scores[criterion.id] === null) {
                        state.scores[criterion.id] = suggestion.suggestedScore;
                        let comment = suggestion.reasoning;
                        if (suggestion.relevantExcerpts?.length) {
                            comment += '\n\nEvidence: ' + suggestion.relevantExcerpts.map(e => '"' + e + '"').join('; ');
                        }
                        state.comments[criterion.id] = comment;
                    }
                }
            }

            // Store original scores for impact tracking (preserve existing manual scores)
            if (Object.keys(state.originalScores).length === 0) {
                state.originalScores = { ...state.scores };
            }

            updateLoadingProgress(100, 'Analysis complete!');
            await new Promise(resolve => setTimeout(resolve, 500));

            hideLoading();
            state.isAutoAnalyzing = false;
            state.currentStep = 'globalReview';
            debouncedAutoSave();
            render();
            showToast('success', 'Auto-Analysis Complete', `${totalToAnalyze} criteria analyzed. Review and adjust scores below.`);
        } catch (error) {
            hideLoading();
            state.isAutoAnalyzing = false;
            showError('Auto-Analysis Failed', error.message, autoAnalyzeRemaining);
        }
    }

    // Re-analyze all criteria (generates new suggestions but doesn't overwrite existing scores)
    async function reAnalyzeAll() {
        state.isAutoAnalyzing = true;
        showLoading('Re-Analyzing All Criteria', `Generating fresh AI suggestions...`, true);

        try {
            for (let i = 0; i < CRITERIA.length; i++) {
                const criterion = CRITERIA[i];
                updateLoadingProgress(Math.round((i / CRITERIA.length) * 100), `Re-analyzing ${criterion.id.toUpperCase()}...`);

                const suggestion = await getAISuggestion(criterion);
                if (suggestion) {
                    state.aiSuggestions[criterion.id] = suggestion;
                }
            }

            updateLoadingProgress(100, 'Re-analysis complete!');
            await new Promise(resolve => setTimeout(resolve, 500));

            hideLoading();
            state.isAutoAnalyzing = false;
            state.currentStep = 'globalReview';
            debouncedAutoSave();
            render();
            showToast('success', 'Re-Analysis Complete', 'Fresh AI suggestions generated. Your scores are preserved.');
        } catch (error) {
            hideLoading();
            state.isAutoAnalyzing = false;
            showError('Re-Analysis Failed', error.message, reAnalyzeAll);
        }
    }

    // Original function - starts fresh auto-analyze from upload screen
    async function startAutoAnalyzeAll() {
        if (!state.apiKey) {
            showToast('error', 'API Key Required', 'Please add your Anthropic API key in Settings to use Auto-Analyze.');
            showSettings();
            return;
        }

        state.isAutoAnalyzing = true;
        state.autoAnalyzeProgress = 0;
        showLoading('Auto-Analyzing All Criteria', `Preparing batch analysis...`, true);

        try {
            // Filter criteria that need analysis (don't have suggestions yet)
            const criteriaToAnalyze = CRITERIA.filter(c => !state.aiSuggestions[c.id]);
            const totalToAnalyze = criteriaToAnalyze.length;
            let completed = 0;

            // Process in parallel batches for speed (respects rate limits)
            const batchSize = CONFIG.API_PARALLEL_BATCH_SIZE;

            for (let i = 0; i < criteriaToAnalyze.length; i += batchSize) {
                const batch = criteriaToAnalyze.slice(i, i + batchSize);
                const batchIds = batch.map(c => c.id.toUpperCase()).join(', ');

                updateLoadingProgress(
                    Math.round((completed / totalToAnalyze) * 100),
                    `Analyzing batch: ${batchIds}...`
                );

                // Process batch in parallel
                const results = await Promise.allSettled(
                    batch.map(criterion => getAISuggestion(criterion))
                );

                // Process results
                results.forEach((result, idx) => {
                    const criterion = batch[idx];
                    if (result.status === 'fulfilled' && result.value) {
                        const suggestion = result.value;
                        state.aiSuggestions[criterion.id] = suggestion;
                        state.scores[criterion.id] = suggestion.suggestedScore;
                        let comment = suggestion.reasoning;
                        if (suggestion.relevantExcerpts?.length) {
                            comment += '\n\nEvidence: ' + suggestion.relevantExcerpts.map(e => '"' + e + '"').join('; ');
                        }
                        state.comments[criterion.id] = comment;
                    } else if (result.status === 'rejected') {
                        console.warn(`[Auto-Analyze] Failed for ${criterion.id}:`, result.reason);
                    }
                    completed++;
                });

                // Small delay between batches to avoid rate limiting
                if (i + batchSize < criteriaToAnalyze.length) {
                    await new Promise(r => setTimeout(r, 200));
                }
            }

            // Store original scores for impact tracking
            state.originalScores = { ...state.scores };

            updateLoadingProgress(100, 'Analysis complete!');
            await new Promise(resolve => setTimeout(resolve, 500)); // Brief pause to show completion

            hideLoading();
            state.isAutoAnalyzing = false;
            state.currentStep = 'globalReview';
            debouncedAutoSave();
            render();

            const cachedCount = CRITERIA.length - totalToAnalyze;
            const msg = cachedCount > 0
                ? `Analyzed ${totalToAnalyze} criteria (${cachedCount} from cache). Review and adjust below.`
                : `All ${CRITERIA.length} criteria analyzed. Review and adjust below.`;
            showToast('success', 'Auto-Analysis Complete', msg);
        } catch (error) {
            hideLoading();
            state.isAutoAnalyzing = false;
            showError('Auto-Analysis Failed', error.message, startAutoAnalyzeAll);
        }
    }

    function calculateImpact() {
        const totalScore = Object.values(state.scores).reduce((a, b) => a + (b || 0), 0);
        const maxScore = CRITERIA.reduce((a, c) => a + c.validScores[c.validScores.length - 1], 0);
        const percentage = Math.round((totalScore / maxScore) * 100);

        // Calculate changes from original
        let changes = [];
        for (const c of CRITERIA) {
            const original = state.originalScores[c.id];
            const current = state.scores[c.id];
            if (original !== undefined && current !== undefined && original !== current) {
                changes.push({
                    criterion: c,
                    original,
                    current,
                    diff: current - original
                });
            }
        }

        // Funding recommendation based on score
        let fundingRecommendation = '';
        let fundingClass = '';
        if (percentage >= 75) {
            fundingRecommendation = 'Strong Candidate - Recommend Full Funding';
            fundingClass = 'text-green-600';
        } else if (percentage >= 60) {
            fundingRecommendation = 'Good Candidate - Recommend Funding with Conditions';
            fundingClass = 'text-blue-600';
        } else if (percentage >= 45) {
            fundingRecommendation = 'Marginal Candidate - Consider Partial Funding';
            fundingClass = 'text-amber-600';
        } else {
            fundingRecommendation = 'Weak Candidate - Not Recommended for Funding';
            fundingClass = 'text-red-600';
        }

        return { totalScore, maxScore, percentage, changes, fundingRecommendation, fundingClass };
    }

    function renderGlobalReviewStep(container) {
        const impact = calculateImpact();
        const sections = [...new Set(CRITERIA.map(c => c.section))];

        container.innerHTML = `
            <div class="fade-in">
                <!-- Header with Impact Summary -->
                <div class="bg-gradient-to-r from-purple-900 via-purple-800 to-indigo-900 text-white rounded-2xl p-6 mb-6 shadow-xl">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div>
                            <h2 class="text-2xl font-bold mb-1">Global Review</h2>
                            <p class="text-purple-200">AI has pre-filled all criteria. Review, adjust, and see the impact of your changes.</p>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl font-bold">${impact.totalScore} / ${impact.maxScore}</div>
                            <div class="text-purple-200">${impact.percentage}% score</div>
                        </div>
                    </div>

                    <!-- Funding Recommendation Banner -->
                    <div class="mt-4 bg-white/10 rounded-xl p-4">
                        <div class="flex items-center gap-3">
                            <svg class="w-6 h-6 ${impact.fundingClass === 'text-green-600' ? 'text-green-300' : impact.fundingClass === 'text-amber-600' ? 'text-amber-300' : impact.fundingClass === 'text-red-600' ? 'text-red-300' : 'text-blue-300'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-lg">${impact.fundingRecommendation}</p>
                                <p class="text-purple-200 text-sm">Based on current scores. Adjust scores below to see how the recommendation changes.</p>
                            </div>
                        </div>
                    </div>

                    ${impact.changes.length > 0 ? `
                        <div class="mt-4 bg-amber-500/20 rounded-xl p-3">
                            <p class="font-medium text-amber-200 text-sm">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                You've changed ${impact.changes.length} score(s) from AI recommendations:
                                ${impact.changes.map(ch => `${ch.criterion.id.toUpperCase()} (${ch.original}→${ch.current})`).join(', ')}
                            </p>
                        </div>
                    ` : ''}
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    ${sections.map(s => {
                        const sectionCriteria = CRITERIA.filter(c => c.section === s);
                        const sectionScore = sectionCriteria.reduce((a, c) => a + (state.scores[c.id] || 0), 0);
                        const sectionMax = sectionCriteria.reduce((a, c) => a + c.validScores[c.validScores.length - 1], 0);
                        const sectionPct = Math.round((sectionScore / sectionMax) * 100);
                        return `
                            <div class="bg-white rounded-xl border border-slate-200 p-4 text-center">
                                <p class="text-xs text-slate-500 uppercase tracking-wide mb-1">${sectionCriteria[0].sectionTitle}</p>
                                <p class="text-2xl font-bold ${sectionPct >= 70 ? 'text-green-600' : sectionPct >= 50 ? 'text-amber-600' : 'text-red-600'}">${sectionScore}/${sectionMax}</p>
                                <p class="text-xs text-slate-400">${sectionPct}%</p>
                            </div>
                        `;
                    }).join('')}
                </div>

                <!-- All Criteria Cards -->
                <div class="space-y-4 mb-6">
                    ${CRITERIA.map((c, idx) => {
                        const suggestion = state.aiSuggestions[c.id];
                        const currentScore = state.scores[c.id];
                        const originalScore = state.originalScores[c.id];
                        const hasChanged = originalScore !== undefined && currentScore !== originalScore;
                        const currentComment = state.comments[c.id] || '';

                        return `
                            <div class="global-review-card bg-white rounded-xl border ${hasChanged ? 'border-amber-300 ring-2 ring-amber-100' : 'border-slate-200'} shadow-sm overflow-hidden">
                                <div class="flex items-center justify-between px-4 py-3 bg-slate-50 border-b border-slate-200">
                                    <div class="flex items-center gap-3">
                                        <span class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center text-sm font-bold">${c.id.toUpperCase()}</span>
                                        <div>
                                            <p class="font-semibold text-slate-800 text-sm">${c.question.substring(0, 60)}${c.question.length > 60 ? '...' : ''}</p>
                                            <p class="text-xs text-slate-500">${c.sectionTitle} • Max ${c.validScores[c.validScores.length - 1]} pts</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        ${hasChanged ? `<span class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded">Changed from ${originalScore}</span>` : ''}
                                        ${suggestion ? `<span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">${suggestion.confidence} confidence</span>` : ''}
                                    </div>
                                </div>
                                <div class="p-4">
                                    <div class="flex items-start gap-4">
                                        <!-- Score Selection -->
                                        <div class="flex-shrink-0">
                                            <p class="text-xs font-medium text-slate-500 mb-2">SCORE</p>
                                            <div class="flex gap-1">
                                                ${c.validScores.map(score => `
                                                    <button onclick="updateGlobalScore('${c.id}', ${score})"
                                                        class="w-10 h-10 rounded-lg font-bold text-sm border-2 transition-all ${currentScore === score ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-600 border-slate-200 hover:border-blue-400'}">
                                                        ${score}
                                                    </button>
                                                `).join('')}
                                            </div>
                                        </div>

                                        <!-- AI Reasoning & Comment -->
                                        <div class="flex-1 min-w-0" data-criterion="${c.id}">
                                            ${suggestion ? `
                                                <div class="mb-3 grid grid-cols-1 ${suggestion.counterScore !== undefined && suggestion.counterScore > suggestion.suggestedScore ? 'md:grid-cols-2' : ''} gap-2">
                                                    <!-- AI Recommendation -->
                                                    <div class="bg-green-50 border border-green-200 rounded-lg p-2">
                                                        <div class="flex items-center gap-2 mb-1">
                                                            <p class="text-xs font-bold ${suggestion.suggestedScore === currentScore ? 'text-green-700' : 'text-green-600'}">
                                                                RECOMMEND: Score ${suggestion.suggestedScore}
                                                                ${suggestion.suggestedScore === currentScore ? ' ✓' : ''}
                                                            </p>
                                                        </div>
                                                        <p class="text-xs text-green-800 line-clamp-2">${suggestion.reasoning?.substring(0, 100)}...</p>
                                                        <button onclick="acceptRecommendationForCriterion('${c.id}')" class="text-xs text-green-700 hover:text-green-900 font-medium mt-1">
                                                            ${suggestion.suggestedScore === currentScore ? 'Already selected' : 'Accept →'}
                                                        </button>
                                                    </div>

                                                    ${suggestion.counterScore !== undefined && suggestion.counterScore > suggestion.suggestedScore ? `
                                                        <!-- Counter-Argument (shown prominently when higher score) -->
                                                        <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-2">
                                                            <div class="flex items-center gap-2 mb-1">
                                                                <p class="text-xs font-bold text-amber-700">
                                                                    ⬆️ HIGHER SCORE POSSIBLE: ${suggestion.counterScore}
                                                                    ${suggestion.counterScore === currentScore ? ' ✓' : ''}
                                                                </p>
                                                            </div>
                                                            <p class="text-xs text-amber-800 line-clamp-2">${suggestion.counterArgument?.substring(0, 100)}...</p>
                                                            <button onclick="acceptCounterFromModal('${c.id}')" class="text-xs text-amber-700 hover:text-amber-900 font-medium mt-1">
                                                                ${suggestion.counterScore === currentScore ? 'Already selected' : 'Accept higher score →'}
                                                            </button>
                                                        </div>
                                                    ` : suggestion.counterArgument ? `
                                                        <!-- Counter at lower score - less prominent -->
                                                        <button onclick="showCounterArgumentModal('${c.id}')" class="text-xs text-amber-600 hover:text-amber-800 bg-amber-50 px-2 py-1 rounded self-start">
                                                            View counter (Score ${suggestion.counterScore}) →
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            ` : ''}
                                            <div>
                                                <p class="text-xs font-medium ${!currentComment.trim() ? 'text-red-500' : 'text-slate-500'} mb-1">
                                                    YOUR COMMENT <span class="text-red-500">*</span>
                                                    ${!currentComment.trim() ? '(Required)' : ''}
                                                </p>
                                                <textarea onchange="updateGlobalComment('${c.id}', this.value)" rows="2"
                                                    class="w-full px-3 py-2 text-xs border ${!currentComment.trim() ? 'border-red-300 bg-red-50' : 'border-slate-200'} rounded-lg focus:ring-2 focus:ring-blue-500 resize-none"
                                                    placeholder="Required: Explain your reasoning for this score...">${currentComment}</textarea>
                                            </div>
                                        </div>

                                        <!-- View Evidence Button -->
                                        <div class="flex-shrink-0">
                                            ${suggestion?.relevantExcerpts?.length ? `
                                                <button onclick="showEvidenceForCriterion('${c.id}')" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="View evidence in document">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <!-- Navigation -->
                <div class="flex items-center justify-between">
                    <button onclick="goBack()" class="px-6 py-3 border border-slate-300 text-slate-700 rounded-xl hover:bg-slate-50 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        Back
                    </button>
                    <div class="flex items-center gap-3">
                        <button onclick="resetToAIRecommendations()" class="px-4 py-3 text-purple-600 hover:bg-purple-50 rounded-xl transition-colors text-sm font-medium">
                            Reset to AI Recommendations
                        </button>
                        <button onclick="proceedFromGlobalReview()" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl flex items-center gap-2">
                            Continue to Recommendation
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function updateGlobalScore(criterionId, score) {
        state.scores[criterionId] = score;
        debouncedAutoSave();
        render();
    }

    function updateGlobalComment(criterionId, comment) {
        state.comments[criterionId] = comment;
        debouncedAutoSave();
    }

    function showEvidenceForCriterion(criterionId) {
        const suggestion = state.aiSuggestions[criterionId];
        const criterion = CRITERIA.find(c => c.id === criterionId);

        if (!suggestion) {
            showToast('info', 'No AI Analysis', 'No AI analysis available for this criterion. Run AI scoring first.');
            return;
        }

        // Create evidence modal with reasoning and excerpts
        const overlay = document.createElement('div');
        overlay.id = 'evidenceModal';
        overlay.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
        overlay.innerHTML = `
            <div class="bg-white rounded-2xl max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="p-6 border-b border-slate-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">${criterionId.toUpperCase()}: Evidence & Reasoning</h3>
                            <p class="text-sm text-slate-500 mt-1">${criterion?.question || ''}</p>
                        </div>
                        <button onclick="document.getElementById('evidenceModal').remove()" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto flex-1">
                    <!-- Score Badge -->
                    <div class="flex items-center gap-3 mb-4">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
                            AI Suggested Score: ${suggestion.suggestedScore}
                        </span>
                        <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs">
                            Confidence: ${suggestion.confidence || 'medium'}
                        </span>
                    </div>

                    <!-- Reasoning Section -->
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            AI Reasoning
                        </h4>
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <p class="text-sm text-slate-700 leading-relaxed">${suggestion.reasoning || 'No reasoning provided.'}</p>
                        </div>
                    </div>

                    <!-- Evidence Excerpts -->
                    ${suggestion.relevantExcerpts?.length ? `
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            Evidence from Application
                            ${suggestion.pageReferences?.length ? `<span class="text-xs text-slate-400">(Pages: ${suggestion.pageReferences.join(', ')})</span>` : ''}
                        </h4>
                        <div class="space-y-2">
                            ${suggestion.relevantExcerpts.map((excerpt, i) => `
                                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 cursor-pointer hover:bg-amber-100 transition-colors" onclick="findExcerptInPdf('${excerpt.replace(/'/g, "\\'")}', '${criterionId}')">
                                    <p class="text-sm text-slate-700 italic">"${excerpt}"</p>
                                    <p class="text-xs text-amber-600 mt-1">Click to find in document →</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : '<p class="text-sm text-slate-500 italic mb-6">No specific excerpts identified.</p>'}

                    <!-- Counter Argument if exists -->
                    ${suggestion.counterArgument ? `
                    <div>
                        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                            <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Counter-Argument (Score ${suggestion.counterScore})
                        </h4>
                        <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                            <p class="text-sm text-slate-700 leading-relaxed">${suggestion.counterArgument}</p>
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="p-4 border-t border-slate-200 bg-slate-50">
                    <button onclick="document.getElementById('evidenceModal').remove(); showPdfViewer('Full Document', ${JSON.stringify(suggestion.relevantExcerpts || []).replace(/"/g, '&quot;')}, true, '${criterionId}')" class="w-full px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors">
                        Open Document Viewer
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
        overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
    }

    function findExcerptInPdf(searchText, criterionId = null) {
        document.getElementById('evidenceModal')?.remove();

        // Use the improved page finding logic with whitespace normalization
        const foundPage = findBestPageForExcerpts([searchText]);

        if (foundPage > 0 || state.pdfPages.length > 0) {
            // Set page BEFORE showing viewer so it opens on the correct page
            state.pdfViewerCurrentPage = foundPage;
            showPdfViewer('Evidence Location', [searchText], true, criterionId);

            // Only show "not found" toast if we defaulted to page 0 and couldn't actually find the text
            if (foundPage === 0) {
                // Double-check if text was actually found on page 0
                const normalizedSearch = searchText.replace(/\s+/g, ' ').trim().toLowerCase().substring(0, 30);
                const normalizedPage0 = (state.pdfPages[0] || '').replace(/\s+/g, ' ').toLowerCase();
                if (!normalizedPage0.includes(normalizedSearch)) {
                    showToast('info', 'Excerpt Location', 'Showing document from beginning. Text may be on a different page.');
                }
            }
        } else {
            showPdfViewer('Document', [searchText], true, criterionId);
            showToast('info', 'Excerpt Not Found', 'Could not locate exact text. Showing full document.');
        }
    }

    function acceptRecommendationForCriterion(criterionId) {
        const suggestion = state.aiSuggestions[criterionId];
        if (suggestion) {
            state.scores[criterionId] = suggestion.suggestedScore;
            let comment = suggestion.reasoning;
            if (suggestion.relevantExcerpts?.length) {
                comment += '\n\nEvidence: ' + suggestion.relevantExcerpts.map(e => '"' + e + '"').join('; ');
            }
            state.comments[criterionId] = comment;
            debouncedAutoSave();
            render();
            showToast('success', 'Score & Comment Set', `${criterionId.toUpperCase()} set to ${suggestion.suggestedScore} with AI reasoning.`);
        }
    }

    function showCounterArgumentModal(criterionId) {
        const suggestion = state.aiSuggestions[criterionId];
        const criterion = CRITERIA.find(c => c.id === criterionId);
        if (!suggestion || !criterion) return;

        // Create a simple modal overlay
        const overlay = document.createElement('div');
        overlay.id = 'counterArgModal';
        overlay.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
        overlay.innerHTML = `
            <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-800">Counter-Argument for ${criterionId.toUpperCase()}</h3>
                        <button onclick="document.getElementById('counterArgModal').remove()" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <span class="font-semibold text-amber-800">Consider Score ${suggestion.counterScore}</span>
                        </div>
                        <p class="text-sm text-amber-900">${suggestion.counterArgument}</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="document.getElementById('counterArgModal').remove()" class="flex-1 px-4 py-2 border border-slate-300 rounded-xl text-slate-600 hover:bg-slate-50">
                            Keep Current Score
                        </button>
                        <button onclick="acceptCounterFromModal('${criterionId}')" class="flex-1 px-4 py-2 bg-amber-600 text-white rounded-xl hover:bg-amber-700">
                            Accept Score ${suggestion.counterScore}
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
    }

    function acceptCounterFromModal(criterionId) {
        const suggestion = state.aiSuggestions[criterionId];
        if (suggestion) {
            state.scores[criterionId] = suggestion.counterScore;
            state.comments[criterionId] = suggestion.counterArgument;
            debouncedAutoSave();
            document.getElementById('counterArgModal')?.remove();
            render();
            showToast('success', 'Score Updated', `${criterionId.toUpperCase()} set to ${suggestion.counterScore} with counter-argument.`);
        }
    }

    function resetToAIRecommendations() {
        for (const c of CRITERIA) {
            const suggestion = state.aiSuggestions[c.id];
            if (suggestion) {
                state.scores[c.id] = suggestion.suggestedScore;
                let comment = suggestion.reasoning;
                if (suggestion.relevantExcerpts?.length) {
                    comment += '\n\nEvidence: ' + suggestion.relevantExcerpts.map(e => '"' + e + '"').join('; ');
                }
                state.comments[c.id] = comment;
            }
        }
        state.originalScores = { ...state.scores };
        debouncedAutoSave();
        render();
        showToast('info', 'Scores Reset', 'All scores have been reset to AI recommendations.');
    }

    function proceedFromGlobalReview() {
        // Check all scores are filled (check for both undefined AND null)
        const missingScores = CRITERIA.filter(c => state.scores[c.id] === undefined || state.scores[c.id] === null);
        if (missingScores.length > 0) {
            showToast('error', 'Missing Scores', `Please score: ${missingScores.map(c => c.id.toUpperCase()).join(', ')}`);
            return;
        }

        // Check all comments are filled (required)
        const missingComments = CRITERIA.filter(c => !state.comments[c.id] || state.comments[c.id].trim() === '');
        if (missingComments.length > 0) {
            showToast('error', 'Comments Required', `Please add comments for: ${missingComments.map(c => c.id.toUpperCase()).join(', ')}`);
            // Highlight the first missing comment
            const firstMissing = document.querySelector(`[data-criterion="${missingComments[0].id}"]`);
            if (firstMissing) firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        state.currentStep = 'recommendation';
        debouncedAutoSave();
        render();
    }

    function selectScore(criterionId, score) {
        state.scores[criterionId] = score;
        debouncedAutoSave();
        render();
    }

    // Jump directly to a specific criterion from summary/review screens
    function jumpToCriterion(index) {
        state.currentCriterionIndex = index;
        state.currentStep = 'scoring';
        state.returnToSummary = true; // Flag to return to summary after editing
        debouncedAutoSave();
        render();
        showToast('info', 'Edit Mode', `Editing criterion ${CRITERIA[index].id.toUpperCase()}. Click "Save & Return" when done.`);
    }

    // Save the current criterion and return to summary
    function saveAndReturnToSummary() {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const commentEl = document.getElementById('criterionComment');
        if (commentEl) state.comments[criterion.id] = commentEl.value;

        // Validate score is selected
        if (state.scores[criterion.id] === undefined || state.scores[criterion.id] === null) {
            showToast('error', 'Score Required', 'Please select a score before saving.');
            return;
        }

        // Clear the return flag and go back to summary
        state.returnToSummary = false;
        state.currentStep = 'summary';
        debouncedAutoSave();
        render();
        showToast('success', 'Saved', `${criterion.id.toUpperCase()} updated successfully.`);
    }

    // Cancel editing and return to summary without saving changes
    function cancelEditAndReturn() {
        state.returnToSummary = false;
        state.currentStep = 'summary';
        render();
    }

    async function requestAISuggestion() {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const area = document.getElementById('aiSuggestionArea');
        area.innerHTML = `<div class="ai-thinking rounded-xl p-4"><div class="flex items-center gap-3"><div class="typing-indicator flex gap-1"><span class="w-2 h-2 bg-blue-600 rounded-full"></span><span class="w-2 h-2 bg-blue-600 rounded-full"></span><span class="w-2 h-2 bg-blue-600 rounded-full"></span></div><span class="text-blue-800 font-medium">Analyzing application...</span></div></div>`;
        const suggestion = await getAISuggestion(criterion);
        if (suggestion) {
            state.aiSuggestions[criterion.id] = suggestion;
            debouncedAutoSave();
        }
        render();
    }

    function handleNextCriterion() {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const suggestion = state.aiSuggestions[criterion.id];
        const commentEl = document.getElementById('criterionComment');
        if (commentEl) state.comments[criterion.id] = commentEl.value;
        if (state.scores[criterion.id] === undefined || state.scores[criterion.id] === null) {
            showToast('error', 'Score Required', 'Please select a score before continuing.');
            return;
        }
        const currentComment = state.comments[criterion.id] || '';
        const aiSuggestedScore = suggestion?.suggestedScore;
        const selectedScore = state.scores[criterion.id];
        if (!currentComment.trim()) {
            showCommentPrompt(criterion, selectedScore, aiSuggestedScore);
            return;
        }
        debouncedAutoSave();
        proceedToNextCriterion();
    }

    function proceedToNextCriterion() {
        if (state.currentCriterionIndex < CRITERIA.length - 1) {
            state.currentCriterionIndex++;
            render();
        } else {
            state.currentStep = 'recommendation';
            render();
        }
    }

    function goBack() {
        if (state.currentStep === 'scoring' && state.currentCriterionIndex > 0) {
            const criterion = CRITERIA[state.currentCriterionIndex];
            const commentEl = document.getElementById('criterionComment');
            if (commentEl) state.comments[criterion.id] = commentEl.value;
            state.currentCriterionIndex--;
        } else if (state.currentStep === 'scoring') {
            state.currentStep = 'projectInfo';
        } else if (state.currentStep === 'projectInfo') {
            state.currentStep = 'upload';
        } else if (state.currentStep === 'globalReview') {
            state.currentStep = 'upload';
        } else if (state.currentStep === 'recommendation') {
            // Go back to globalReview if we came from there, otherwise scoring
            if (Object.keys(state.originalScores).length > 0) {
                state.currentStep = 'globalReview';
            } else {
                state.currentStep = 'scoring';
                state.currentCriterionIndex = CRITERIA.length - 1;
            }
        } else if (state.currentStep === 'summary') {
            state.currentStep = 'recommendation';
        }
        render();
    }

    function renderRecommendationStep(container) {
        const totalScore = Object.values(state.scores).reduce((a, b) => a + b, 0);
        const maxScore = CRITERIA.reduce((a, c) => a + c.validScores[c.validScores.length - 1], 0);
        const percentage = Math.round((totalScore / maxScore) * 100);

        // Determine recommendation strength
        let recommendationStrength = '';
        let strengthColor = '';
        if (percentage >= 75) { recommendationStrength = 'Strong Candidate'; strengthColor = 'text-green-600'; }
        else if (percentage >= 60) { recommendationStrength = 'Good Candidate'; strengthColor = 'text-blue-600'; }
        else if (percentage >= 45) { recommendationStrength = 'Marginal Candidate'; strengthColor = 'text-amber-600'; }
        else { recommendationStrength = 'Weak Candidate'; strengthColor = 'text-red-600'; }

        container.innerHTML = `
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center gap-3 mb-6">
                    <button onclick="goBack()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Go back">
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Recommendation</h2>
                        <p class="text-slate-500">Provide your final funding recommendation</p>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-semibold text-slate-800">${state.projectInfo.projectName || 'Project'}</h3>
                            <p class="text-sm text-slate-500">${state.projectInfo.applicantName || 'Applicant'}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold ${percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-amber-600' : 'text-red-600'}">${totalScore} / ${maxScore}</div>
                            <div class="text-sm text-slate-500">${percentage}% of maximum</div>
                            <div class="text-sm font-medium ${strengthColor}">${recommendationStrength}</div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2" for="fundingSource">Recommended Funding Source *</label>
                            <select id="fundingSource" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" aria-required="true">
                                <option value="">Select funding source...</option>
                                <option value="HOME" ${state.recommendation.fundingSource === 'HOME' ? 'selected' : ''}>HOME</option>
                                <option value="CDBG" ${state.recommendation.fundingSource === 'CDBG' ? 'selected' : ''}>CDBG</option>
                                <option value="HOME+CDBG" ${state.recommendation.fundingSource === 'HOME+CDBG' ? 'selected' : ''}>HOME + CDBG</option>
                                <option value="Other" ${state.recommendation.fundingSource === 'Other' ? 'selected' : ''}>Other</option>
                                <option value="None" ${state.recommendation.fundingSource === 'None' ? 'selected' : ''}>Do Not Recommend</option>
                            </select>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-slate-700" for="summaryComments">Summary Comments *</label>
                                <button onclick="generateAISummary()" class="text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded-lg flex items-center gap-1 transition-colors" id="generateSummaryBtn">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    Generate AI Summary
                                </button>
                            </div>
                            <textarea id="summaryComments" rows="6" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Provide your overall assessment and recommendation rationale..." aria-required="true">${state.recommendation.summaryComments || ''}</textarea>
                            <p class="text-xs text-slate-400 mt-1">AI will synthesize all criteria scores and comments into a comprehensive recommendation.</p>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-slate-700" for="questions">Questions for Applicant</label>
                                <button onclick="generateAIQuestions()" class="text-xs bg-amber-100 hover:bg-amber-200 text-amber-700 px-3 py-1 rounded-lg flex items-center gap-1 transition-colors" id="generateQuestionsBtn">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    Generate AI Questions
                                </button>
                            </div>
                            <textarea id="questions" rows="5" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Any questions or clarifications needed from the applicant...">${state.recommendation.questions || ''}</textarea>
                            <p class="text-xs text-slate-400 mt-1">AI will suggest clarifying questions based on weak areas and general due diligence.</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center">
                    <button onclick="generateAIBoth()" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-semibold rounded-xl hover:from-purple-600 hover:to-indigo-600 transition-all shadow-lg hover:shadow-xl flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        Generate All with AI
                    </button>
                    <button onclick="handleRecommendationNext()" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl">
                        Review Summary
                        <svg class="w-5 h-5 inline ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </button>
                </div>
            </div>`;

        // Auto-generate if empty and API key available
        if (state.apiKey && !state.recommendation.summaryComments && !state.recommendation.questions) {
            setTimeout(() => generateAIBoth(), 500);
        }
    }

    // Generate AI Summary for recommendation
    async function generateAISummary() {
        if (!state.apiKey) {
            showToast('error', 'API Key Required', 'Please add your Anthropic API key in Settings.');
            return;
        }

        const btn = document.getElementById('generateSummaryBtn');
        if (btn) btn.innerHTML = '<span class="animate-spin">⏳</span> Generating...';

        try {
            const totalScore = Object.values(state.scores).reduce((a, b) => a + b, 0);
            const maxScore = CRITERIA.reduce((a, c) => a + c.validScores[c.validScores.length - 1], 0);
            const percentage = Math.round((totalScore / maxScore) * 100);

            // Build criteria summary
            const criteriaBreakdown = CRITERIA.map(c => {
                const score = state.scores[c.id];
                const maxCriteriaScore = c.validScores[c.validScores.length - 1];
                const comment = state.comments[c.id] || '';
                return `${c.id.toUpperCase()} (${c.name}): ${score}/${maxCriteriaScore} - ${comment.substring(0, 200)}`;
            }).join('\n');

            const prompt = `You are an expert NOFA (Notice of Funding Availability) evaluator for San Mateo County. Based on the following evaluation scores and comments, write a comprehensive summary recommendation.

PROJECT: ${state.projectInfo.projectName || 'Unknown'}
APPLICANT: ${state.projectInfo.applicantName || 'Unknown'}
TOTAL SCORE: ${totalScore}/${maxScore} (${percentage}%)

CRITERIA BREAKDOWN:
${criteriaBreakdown}

Write a 2-3 paragraph professional summary that:
1. Opens with the overall recommendation (fund/conditional fund/do not fund) and score context
2. Highlights the key STRENGTHS of the application (criteria where they scored well)
3. Notes areas of CONCERN or WEAKNESS (low-scoring criteria)
4. Provides a balanced conclusion on project viability and community impact
5. If score is below 60%, emphasize what would need to improve for future funding

Be direct, professional, and specific. Reference actual criteria scores. Do not use bullet points - write in flowing paragraphs.`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    temperature: 0,  // Consistent output for summaries
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (!response.ok) throw new Error('API request failed');
            const data = await response.json();
            const summary = data.content[0].text;

            document.getElementById('summaryComments').value = summary;
            state.recommendation.summaryComments = summary;
            debouncedAutoSave();
            showToast('success', 'Summary Generated', 'AI summary has been added. Feel free to edit.');

        } catch (error) {
            console.error('Error generating summary:', error);
            showToast('error', 'Generation Failed', error.message);
        } finally {
            if (btn) btn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Generate AI Summary';
        }
    }

    // Generate AI Questions for applicant
    async function generateAIQuestions() {
        if (!state.apiKey) {
            showToast('error', 'API Key Required', 'Please add your Anthropic API key in Settings.');
            return;
        }

        const btn = document.getElementById('generateQuestionsBtn');
        if (btn) btn.innerHTML = '<span class="animate-spin">⏳</span> Generating...';

        try {
            const totalScore = Object.values(state.scores).reduce((a, b) => a + b, 0);
            const maxScore = CRITERIA.reduce((a, c) => a + c.validScores[c.validScores.length - 1], 0);
            const percentage = Math.round((totalScore / maxScore) * 100);

            // Find weak areas (criteria scoring below 50% of max)
            const weakAreas = CRITERIA.filter(c => {
                const score = state.scores[c.id] || 0;
                const maxCriteriaScore = c.validScores[c.validScores.length - 1];
                return score < maxCriteriaScore * 0.5;
            }).map(c => `${c.id.toUpperCase()} (${c.name}): scored ${state.scores[c.id]}/${c.validScores[c.validScores.length - 1]}`);

            // Build criteria summary
            const criteriaBreakdown = CRITERIA.map(c => {
                const score = state.scores[c.id];
                const maxCriteriaScore = c.validScores[c.validScores.length - 1];
                const comment = state.comments[c.id] || '';
                return `${c.id.toUpperCase()} (${c.name}): ${score}/${maxCriteriaScore} - ${comment.substring(0, 150)}`;
            }).join('\n');

            const prompt = `You are an expert NOFA evaluator for San Mateo County conducting due diligence on a funding application.

PROJECT: ${state.projectInfo.projectName || 'Unknown'}
APPLICANT: ${state.projectInfo.applicantName || 'Unknown'}
TOTAL SCORE: ${totalScore}/${maxScore} (${percentage}%)

CRITERIA SCORES:
${criteriaBreakdown}

${weakAreas.length > 0 ? `WEAK AREAS NEEDING CLARIFICATION:\n${weakAreas.join('\n')}` : 'No major weak areas identified.'}

Generate EXACTLY 5 specific questions for the applicant (the template has 5 question slots). Include:

1. CLARIFYING QUESTIONS (2): Questions about weak scoring areas that could improve their score if answered well
2. DUE DILIGENCE QUESTIONS (2): Standard questions any funder should ask regardless of score (financial capacity, timeline feasibility, risk mitigation)
3. OPPORTUNITY QUESTION (1): A question that could reveal additional strengths not captured in the application

Format each question on its own numbered line (1., 2., 3., 4., 5.). Be specific and reference actual project details when possible. Questions should be professional and constructive, not accusatory.`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    temperature: 0,  // Consistent output for questions
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (!response.ok) throw new Error('API request failed');
            const data = await response.json();
            const questions = data.content[0].text;

            document.getElementById('questions').value = questions;
            state.recommendation.questions = questions;
            debouncedAutoSave();
            showToast('success', 'Questions Generated', 'AI questions have been added. Feel free to edit.');

        } catch (error) {
            console.error('Error generating questions:', error);
            showToast('error', 'Generation Failed', error.message);
        } finally {
            if (btn) btn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Generate AI Questions';
        }
    }

    // Generate both summary and questions
    async function generateAIBoth() {
        showLoading('Generating AI Recommendation', 'Creating summary and questions...', true);
        try {
            updateLoadingProgress(30, 'Generating summary...');
            await generateAISummary();
            updateLoadingProgress(70, 'Generating questions...');
            await generateAIQuestions();
            updateLoadingProgress(100, 'Complete!');
            hideLoading();
            showToast('success', 'AI Generation Complete', 'Summary and questions have been generated.');
        } catch (error) {
            hideLoading();
            showToast('error', 'Generation Failed', error.message);
        }
    }

    function handleRecommendationNext() {
        const fundingSource = document.getElementById('fundingSource').value;
        const summaryComments = document.getElementById('summaryComments').value;
        const questions = document.getElementById('questions').value;

        if (!fundingSource) {
            showToast('error', 'Required Field', 'Please select a funding source recommendation.');
            return;
        }
        if (!summaryComments.trim()) {
            showToast('error', 'Required Field', 'Please provide summary comments.');
            return;
        }

        state.recommendation = { fundingSource, summaryComments, questions };
        debouncedAutoSave();
        state.currentStep = 'summary';
        render();
    }

    function renderSummaryStep(container) {
        const totalScore = Object.values(state.scores).reduce((a, b) => a + b, 0);
        const maxScore = CRITERIA.reduce((a, c) => a + c.validScores[c.validScores.length - 1], 0);
        const percentage = Math.round((totalScore / maxScore) * 100);

        container.innerHTML = `
            <div class="max-w-5xl mx-auto">
                <div class="flex items-center gap-3 mb-6">
                    <button onclick="goBack()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Go back">
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Evaluation Summary</h2>
                        <p class="text-slate-500">Review your evaluation before exporting</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg border border-slate-200 p-6">
                        <h3 class="font-semibold text-slate-800 mb-4">Score Summary</h3>
                        <p class="text-xs text-slate-500 mb-3">Click any row to edit that criterion</p>
                        <div class="space-y-3">
                            ${CRITERIA.map((c, idx) => {
                                const isMissing = state.scores[c.id] === undefined || state.scores[c.id] === null;
                                const hasNoComment = !state.comments[c.id] || state.comments[c.id].trim() === '';
                                return `
                                <div onclick="jumpToCriterion(${idx})" class="flex items-center justify-between py-2 border-b border-slate-100 cursor-pointer hover:bg-slate-50 rounded-lg px-2 -mx-2 transition-colors ${isMissing ? 'bg-red-50 hover:bg-red-100' : ''}">
                                    <div class="flex items-center gap-2">
                                        ${isMissing ? '<svg class="w-4 h-4 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>' : ''}
                                        ${hasNoComment && !isMissing ? '<svg class="w-4 h-4 text-amber-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>' : ''}
                                        <span class="text-sm ${isMissing ? 'text-red-700 font-medium' : 'text-slate-600'}">${c.id.toUpperCase()}: ${c.question.substring(0, 45)}${c.question.length > 45 ? '...' : ''}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-semibold ${isMissing ? 'text-red-500' : 'text-slate-800'}">${isMissing ? 'Missing' : state.scores[c.id]}</span>
                                        <span class="text-slate-400">/ ${c.validScores[c.validScores.length - 1]}</span>
                                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                    </div>
                                </div>
                            `}).join('')}
                            <div class="flex items-center justify-between py-3 mt-2 bg-slate-50 rounded-xl px-4">
                                <span class="font-bold text-slate-800">Total Score</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl font-bold ${percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-amber-600' : 'text-red-600'}">${totalScore}</span>
                                    <span class="text-slate-400">/ ${maxScore}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6">
                        <h3 class="font-semibold text-slate-800 mb-4">Recommendation</h3>
                        <div class="space-y-4">
                            <div>
                                <p class="text-xs text-slate-500 uppercase tracking-wide">Funding Source</p>
                                <p class="font-semibold text-slate-800">${state.recommendation.fundingSource || 'Not specified'}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-500 uppercase tracking-wide">Summary</p>
                                <p class="text-sm text-slate-600">${state.recommendation.summaryComments || 'No comments'}</p>
                            </div>
                            ${state.recommendation.questions ? `
                                <div>
                                    <p class="text-xs text-slate-500 uppercase tracking-wide">Questions</p>
                                    <p class="text-sm text-slate-600">${state.recommendation.questions}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 mb-6">
                    <h3 class="font-semibold text-slate-800 mb-4">Export Settings</h3>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-600">
                                Exporting as: <span class="font-semibold ${state.reviewerSheet.includes('Reviewer 1') ? 'text-blue-600' : 'text-green-600'}">
                                    ${REVIEWER_SHEETS[state.reviewerSheet]?.name || 'Unknown'} - ${REVIEWER_SHEETS[state.reviewerSheet]?.description || ''}
                                </span>
                            </p>
                            <p class="text-xs text-slate-500 mt-1">
                                Tab: "${state.reviewerSheet}" • Scores and comments will be written to this sheet
                            </p>
                            ${REVIEWER_SHEETS[state.reviewerSheet]?.hasThreshold ?
                                '<p class="text-xs text-blue-600 mt-1 font-medium">Note: As Reviewer 1, you are also responsible for Threshold evaluation (pass/fail eligibility)</p>' :
                                '<p class="text-xs text-green-600 mt-1 font-medium">Note: Threshold evaluation was completed by Reviewer 1</p>'
                            }
                        </div>
                        <button onclick="showSettings()" class="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                            Change
                        </button>
                    </div>

                    <!-- Template Upload Section -->
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        ${state.scoringWorkbook ? `
                            <div class="flex items-center gap-2 text-green-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <span class="text-sm font-medium">Template loaded: ${state.templateName || 'Ready for export'}</span>
                            </div>
                        ` : `
                            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                                <div class="flex items-start gap-3">
                                    <svg class="w-6 h-6 text-amber-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="font-semibold text-amber-800">Excel Template Required</p>
                                        <p class="text-sm text-amber-700 mt-1">Upload the County scoring template to export your evaluation.</p>
                                        <div id="summaryTemplateDropZone" class="mt-3 drop-zone border-2 border-dashed border-amber-300 rounded-lg p-4 text-center cursor-pointer hover:border-green-400 hover:bg-green-50/50 transition-all" role="button" tabindex="0">
                                            <svg class="w-8 h-8 mx-auto mb-2 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                            <p class="text-amber-700 font-medium text-sm">Click to upload Excel template</p>
                                            <input type="file" id="summaryTemplateInput" accept=".xlsx,.xls" class="hidden">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                </div>

                <div class="flex justify-between">
                    <button onclick="startNewEvaluation()" class="px-6 py-3 border border-slate-300 text-slate-700 font-semibold rounded-xl hover:bg-slate-50 transition-colors">
                        Start New Evaluation
                    </button>
                    <button onclick="exportToExcel()" class="px-8 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-semibold rounded-xl hover:from-green-700 hover:to-emerald-700 transition-all shadow-lg hover:shadow-xl ${!state.scoringWorkbook ? 'opacity-50' : ''}">
                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Export to Excel
                    </button>
                </div>
            </div>`;

        // Setup template upload zone on summary page
        setTimeout(() => {
            const summaryZone = document.getElementById('summaryTemplateDropZone');
            const summaryInput = document.getElementById('summaryTemplateInput');
            if (summaryZone && summaryInput) {
                setupDropZone(summaryZone, summaryInput, handleTemplateUpload);
            }
        }, 100);
    }

    // Helper function to set cell value while preserving formatting (for SheetJS - kept for backward compatibility)
    function setCellValue(sheet, cellAddress, value, type) {
        if (!cellAddress) return;
        const existingCell = sheet[cellAddress] || {};
        sheet[cellAddress] = {
            ...existingCell,
            t: type,
            v: value
        };
    }

    // NEW: ExcelJS-based export that preserves all formatting
    async function exportToExcel() {
        // Validate all scores are entered (check for both undefined AND null)
        const missingScores = CRITERIA.filter(c => state.scores[c.id] === undefined || state.scores[c.id] === null);
        if (missingScores.length > 0) {
            showToast('error', 'Missing Scores', `Please complete scoring for: ${missingScores.map(c => c.id.toUpperCase()).join(', ')}`);
            return;
        }

        if (!state.templateData) {
            showToast('error', 'No Template', 'Please upload a scoring template first.');
            return;
        }

        try {
            showLoading('Exporting to Excel...', 'Preserving template formatting...');
            const sheetMapping = REVIEWER_SHEETS[state.reviewerSheet];
            if (!sheetMapping) {
                throw new Error(`Sheet mapping not found for ${state.reviewerSheet}`);
            }

            // Use ExcelJS to load the original template (preserves ALL formatting)
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(state.templateData);

            // Find the target worksheet
            const worksheet = workbook.getWorksheet(state.reviewerSheet);
            if (!worksheet) {
                throw new Error(`Sheet "${state.reviewerSheet}" not found in workbook`);
            }

            // Helper to parse cell address (e.g., "H36" -> {col: 8, row: 36})
            function parseCellAddress(addr) {
                const match = addr.match(/^([A-Z]+)(\d+)$/);
                if (!match) return null;
                const colLetters = match[1];
                const row = parseInt(match[2]);
                let col = 0;
                for (let i = 0; i < colLetters.length; i++) {
                    col = col * 26 + (colLetters.charCodeAt(i) - 64);
                }
                return { col, row };
            }

            // Write scores - ExcelJS preserves cell formatting automatically
            for (const criterion of CRITERIA) {
                const scoreCell = sheetMapping.scores[criterion.id];
                const commentCell = sheetMapping.comments[criterion.id];

                if (scoreCell && state.scores[criterion.id] !== undefined) {
                    const pos = parseCellAddress(scoreCell);
                    if (pos) {
                        const cell = worksheet.getCell(pos.row, pos.col);
                        cell.value = state.scores[criterion.id];
                        // ExcelJS preserves all existing styling (fill, font, border, etc.)
                    }
                }
                if (commentCell && state.comments[criterion.id]) {
                    const pos = parseCellAddress(commentCell);
                    if (pos) {
                        const cell = worksheet.getCell(pos.row, pos.col);
                        cell.value = state.comments[criterion.id];
                        // Enable word wrap for comments to display properly
                        cell.alignment = { ...cell.alignment, wrapText: true, vertical: 'top' };
                    }
                }
            }

            // Write Project Info fields
            if (sheetMapping.projectInfo) {
                const pi = sheetMapping.projectInfo;

                // Applicant name
                if (pi.applicant && state.projectInfo.applicant) {
                    const pos = parseCellAddress(pi.applicant);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = state.projectInfo.applicant;
                }

                // Project title
                if (pi.project && state.projectInfo.project) {
                    const pos = parseCellAddress(pi.project);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = state.projectInfo.project;
                }

                // Reviewer name
                if (pi.reviewedBy && state.reviewerName) {
                    const pos = parseCellAddress(pi.reviewedBy);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = state.reviewerName;
                }

                // Review date (today's date)
                if (pi.reviewDate) {
                    const pos = parseCellAddress(pi.reviewDate);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = new Date().toLocaleDateString();
                }

                // Amount Requested
                if (pi.amountRequested && state.projectInfo.amountRequested) {
                    const pos = parseCellAddress(pi.amountRequested);
                    if (pos) {
                        const cell = worksheet.getCell(pos.row, pos.col);
                        cell.value = state.projectInfo.amountRequested;
                        cell.numFmt = '"$"#,##0';
                    }
                    // Also write to Completion Checklist E10 so formulas work
                    const checklistSheet = workbook.getWorksheet('Completion Checklist');
                    if (checklistSheet) {
                        const checklistCell = checklistSheet.getCell('E10');
                        checklistCell.value = state.projectInfo.amountRequested;
                        checklistCell.numFmt = '"$"#,##0';
                    }
                }

                // Total Project Cost
                if (pi.totalCost && state.projectInfo.totalCost) {
                    const pos = parseCellAddress(pi.totalCost);
                    if (pos) {
                        const cell = worksheet.getCell(pos.row, pos.col);
                        cell.value = state.projectInfo.totalCost;
                        cell.numFmt = '"$"#,##0';
                    }
                    // Also write to Completion Checklist E11 so formulas work
                    const checklistSheet = workbook.getWorksheet('Completion Checklist');
                    if (checklistSheet) {
                        const checklistCell = checklistSheet.getCell('E11');
                        checklistCell.value = state.projectInfo.totalCost;
                        checklistCell.numFmt = '"$"#,##0';
                    }
                }

                // Clients served
                if (pi.clientsServed && state.projectInfo.clientsServed) {
                    const pos = parseCellAddress(pi.clientsServed);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = state.projectInfo.clientsServed;
                }

                // Project description
                if (pi.projectDescription && state.projectInfo.projectDescription) {
                    const pos = parseCellAddress(pi.projectDescription);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = state.projectInfo.projectDescription;
                }
            }

            // Write Recommendation fields
            if (sheetMapping.recommendation) {
                const rec = sheetMapping.recommendation;

                // Recommendation Yes/No (derived from fundingSource - "None" means No)
                if (rec.yesNo && state.recommendation.fundingSource) {
                    const pos = parseCellAddress(rec.yesNo);
                    if (pos) {
                        const isApproved = state.recommendation.fundingSource !== 'None';
                        worksheet.getCell(pos.row, pos.col).value = isApproved ? 'Yes' : 'No';
                    }
                }

                // Funding source
                if (rec.fundingSource && state.recommendation.fundingSource) {
                    const pos = parseCellAddress(rec.fundingSource);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = state.recommendation.fundingSource;
                }

                // Brief summary (abbreviated version for the header section)
                if (rec.briefSummary && state.recommendation.summaryComments) {
                    const pos = parseCellAddress(rec.briefSummary);
                    if (pos) {
                        // Create abbreviated summary - first 2-3 sentences or key points
                        const fullSummary = state.recommendation.summaryComments;
                        let briefText = '';

                        // Try to extract the recommendation and key reason
                        const isApproved = state.recommendation.fundingSource !== 'None';
                        const recommendText = isApproved ? 'RECOMMEND FOR FUNDING' : 'DO NOT RECOMMEND FOR FUNDING';

                        // Get first meaningful sentence after any header
                        const lines = fullSummary.split('\n').filter(l => l.trim().length > 0);
                        let keyPoints = [];

                        for (const line of lines) {
                            // Skip header lines with ** or all caps
                            if (line.includes('**') || line === line.toUpperCase()) continue;
                            // Get first 2-3 content lines
                            const cleaned = line.replace(/^\d+[\.\)]\s*/, '').trim();
                            if (cleaned.length > 20 && keyPoints.length < 3) {
                                keyPoints.push(cleaned);
                            }
                        }

                        if (keyPoints.length > 0) {
                            briefText = `${recommendText}. ${keyPoints[0]}`;
                            // Truncate to ~200 chars for the cell
                            if (briefText.length > 200) {
                                briefText = briefText.substring(0, 197) + '...';
                            }
                        } else {
                            // Fallback: just use first 200 chars of summary
                            briefText = `${recommendText}. ${fullSummary.substring(0, 150).replace(/\n/g, ' ')}...`;
                        }

                        const cell = worksheet.getCell(pos.row, pos.col);
                        cell.value = briefText;
                        cell.alignment = { wrapText: true, vertical: 'top' };
                    }
                }

                // Summary comments - with word wrap and auto-height
                if (rec.summaryComments && state.recommendation.summaryComments) {
                    const pos = parseCellAddress(rec.summaryComments);
                    if (pos) {
                        const cell = worksheet.getCell(pos.row, pos.col);
                        cell.value = state.recommendation.summaryComments;
                        cell.alignment = { wrapText: true, vertical: 'top' };
                        // Calculate row height based on content (roughly 15 per line, min 100)
                        const lineCount = (state.recommendation.summaryComments.match(/\n/g) || []).length + 1;
                        const charPerLine = 100; // Approximate characters per line in the cell
                        const estimatedLines = Math.ceil(state.recommendation.summaryComments.length / charPerLine);
                        const totalLines = Math.max(lineCount, estimatedLines);
                        worksheet.getRow(pos.row).height = Math.max(100, totalLines * 15);
                    }
                }

                // Questions to applicant - split into separate rows
                if (rec.questionCells && state.recommendation.questions) {
                    const questionsText = state.recommendation.questions;

                    // Split questions by numbered patterns (1., 2., etc.) at line starts
                    // This handles formats like "1. **QUESTION**:" or "1. Question text"
                    const questionParts = questionsText.split(/\n(?=\d+[\.\:\)]\s*)/)
                        .map(q => q.trim())
                        .filter(q => q.length > 0);

                    // If no numbered split found, try splitting by double newlines
                    let cleanedQuestions;
                    if (questionParts.length <= 1 && questionsText.includes('\n\n')) {
                        cleanedQuestions = questionsText.split(/\n\n+/)
                            .map(q => q.trim())
                            .filter(q => q.length > 0);
                    } else {
                        // Clean up each question - remove leading number and clean markdown
                        cleanedQuestions = questionParts.map(q => {
                            // Remove leading "1. " pattern
                            let cleaned = q.replace(/^\d+[\.\:\)]\s*/, '').trim();
                            // Remove markdown bold markers **text** -> text
                            cleaned = cleaned.replace(/\*\*([^*]+)\*\*/g, '$1');
                            return cleaned;
                        }).filter(q => q.length > 0);
                    }

                    // Write each question to its corresponding cell
                    // If more questions than cells, combine extras into the last cell
                    const maxCells = rec.questionCells.length;
                    rec.questionCells.forEach((cellAddr, index) => {
                        const pos = parseCellAddress(cellAddr);
                        if (pos) {
                            let questionText = cleanedQuestions[index] || '';

                            // For the last cell, append any overflow questions
                            if (index === maxCells - 1 && cleanedQuestions.length > maxCells) {
                                const overflow = cleanedQuestions.slice(maxCells);
                                if (overflow.length > 0) {
                                    questionText += '\n\n' + overflow.map((q, i) => `${maxCells + i + 1}. ${q}`).join('\n\n');
                                }
                            }

                            if (questionText) {
                                const cell = worksheet.getCell(pos.row, pos.col);
                                cell.value = questionText;
                                cell.alignment = { wrapText: true, vertical: 'top' };
                                // Calculate row height based on content length
                                const charPerLine = 80;
                                const estimatedLines = Math.ceil(questionText.length / charPerLine);
                                worksheet.getRow(pos.row).height = Math.max(45, estimatedLines * 15);
                            }
                        }
                    });
                }
            }

            // Generate filename
            const projectName = (state.projectInfo.projectName || 'Evaluation').replace(/[^a-zA-Z0-9]/g, '_');
            const date = new Date().toISOString().split('T')[0];
            const filename = `${projectName}_Scored_${date}.xlsx`;

            // Export using ExcelJS - preserves ALL formatting
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Clear draft after successful export
            localStorage.removeItem(CONFIG.AUTO_SAVE_KEY);
            state.hasUnsavedChanges = false;

            hideLoading();
            showToast('success', 'Export Complete', `Saved as ${filename} with formatting preserved!`);
        } catch (error) {
            hideLoading();
            console.error('Export error:', error);
            showErrorModal('Export Failed', `Could not export to Excel: ${error.message}`, () => exportToExcel());
        }
    }

    function startNewEvaluation() {
        if (state.hasUnsavedChanges) {
            if (!confirm('You have unsaved changes. Are you sure you want to start a new evaluation?')) {
                return;
            }
        }

        // Clear localStorage
        localStorage.removeItem(CONFIG.AUTO_SAVE_KEY);

        // Reset state
        state.applicationPdf = null;
        state.applicationText = '';
        state.scoringWorkbook = null;
        state.projectInfo = {};
        state.scores = {};
        state.comments = {};
        state.aiSuggestions = {};
        state.recommendation = {};
        state.currentStep = 'upload';
        state.currentCriterionIndex = 0;
        state.hasUnsavedChanges = false;

        render();
        showToast('info', 'New Evaluation', 'Ready to start a new evaluation.');
    }

    // Initialize the application
    init();
    </script>
</body>
</html>
