<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOFA AI Evaluator v7.21 - San Mateo County FY26-27</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- ExcelJS for formatting-preserving Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <!-- Mammoth.js for Word document (.docx) parsing (v7.19) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        /* San Mateo County HCD Color Palette (v7.21) */
        :root {
            --smc-blue: #036CB6;
            --smc-blue-dark: #02538C;
            --smc-blue-light: #7CBEEC;
            --smc-teal: #38939B;
            --smc-teal-dark: #2a7078;
            --smc-teal-light: #5bb5bd;
            --smc-orange: #E98A41;
            --smc-orange-light: #FFD7B8;
            --smc-green: #8DC63F;
            --smc-green-light: #BDE0A7;
            --smc-gray: #555A5A;
        }
        .drop-zone { transition: all 0.3s ease; }
        .drop-zone.dragover { background: #E3EDF5; border-color: var(--smc-teal); transform: scale(1.02); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .ai-thinking { background: linear-gradient(90deg, #E3EDF5, #F1F9F9, #E3EDF5); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .score-btn { transition: all 0.15s ease; }
        .score-btn:hover { transform: translateY(-2px); }
        .score-btn.selected { transform: scale(1.05); box-shadow: 0 4px 12px rgba(56, 147, 155, 0.4); }
        .score-btn:focus { outline: 3px solid var(--smc-teal); outline-offset: 2px; }
        .typing-indicator span { animation: blink 1.4s infinite both; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }
        .pdf-viewer { max-height: 70vh; overflow-y: auto; }
        .pdf-viewer::-webkit-scrollbar { width: 8px; }
        .pdf-viewer::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .pdf-viewer::-webkit-scrollbar-thumb { background: var(--smc-gray); border-radius: 4px; }
        .highlight-text { background: linear-gradient(120deg, var(--smc-orange-light) 0%, var(--smc-orange) 100%); padding: 2px 4px; border-radius: 2px; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(3, 108, 182, 0.85); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .auto-save-indicator { position: fixed; bottom: 20px; right: 20px; z-index: 50; transition: all 0.3s ease; }
        .toast { position: fixed; top: 20px; right: 20px; z-index: 60; transform: translateX(120%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .impact-positive { color: #059669; }
        .impact-negative { color: #dc2626; }
        .score-change-highlight { animation: scoreHighlight 0.5s ease; }
        @keyframes scoreHighlight { 0%, 100% { background-color: transparent; } 50% { background-color: var(--smc-orange-light); } }
        .global-review-card { transition: all 0.2s ease; }
        .global-review-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        /* SMC branded gradients */
        .smc-header-gradient { background: linear-gradient(135deg, #036CB6 0%, #02538C 50%, #38939B 100%); }
        .smc-review-gradient { background: linear-gradient(135deg, #38939B 0%, #2a7078 50%, #036CB6 100%); }
        /* Simple/Pro Mode visibility (v7.21) */
        body.simple-mode .pro-mode-only { display: none !important; }
        body.pro-mode .simple-mode-only { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 text-center shadow-2xl">
            <div class="w-16 h-16 border-4 border-teal-200 border-t-teal-600 rounded-full animate-spin mx-auto mb-4"></div>
            <h3 id="loadingTitle" class="text-xl font-bold text-slate-800 mb-2">Processing...</h3>
            <p id="loadingMessage" class="text-slate-600">Please wait while we process your file.</p>
            <div id="loadingProgress" class="mt-4 hidden">
                <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div id="loadingProgressBar" class="h-full bg-teal-600 transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="loadingProgressText" class="text-sm text-slate-500 mt-2">0%</p>
            </div>
            <!-- Cancel Button (v7.21) - Made more prominent -->
            <button id="loadingCancelBtn" onclick="cancelAutoAnalyze()" class="hidden mt-6 px-6 py-3 text-sm font-bold text-white bg-red-500 hover:bg-red-600 border-2 border-red-600 rounded-xl transition-colors shadow-md">
                ‚èπ Stop Analysis
            </button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast bg-white rounded-xl shadow-lg border border-slate-200 p-4 max-w-sm">
        <div class="flex items-start gap-3">
            <div id="toastIcon" class="w-6 h-6 flex-shrink-0"></div>
            <div>
                <p id="toastTitle" class="font-semibold text-slate-800"></p>
                <p id="toastMessage" class="text-sm text-slate-600"></p>
            </div>
            <button onclick="hideToast()" class="text-slate-400 hover:text-slate-600 ml-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Auto-save Indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator hidden">
        <div class="bg-green-100 border border-green-300 text-green-800 px-4 py-2 rounded-lg text-sm flex items-center gap-2 shadow-md">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span>Progress saved</span>
        </div>
    </div>

    <div id="app" class="max-w-6xl mx-auto p-4 md:p-6">
        <!-- Header - San Mateo County HCD Colors -->
        <header class="smc-header-gradient text-white rounded-2xl p-6 mb-6 shadow-xl">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">NOFA AI Evaluator <span class="text-teal-200 text-lg">v7.21</span></h1>
                            <p class="text-teal-100 text-sm">Winter FY26-27 ‚Ä¢ San Mateo County ‚Ä¢ AI-Assisted Scoring</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Simple/Pro Mode Toggle (v7.21) -->
                    <div id="modeToggle" class="flex items-center gap-2 bg-white/10 rounded-lg p-1">
                        <button onclick="setUIMode('simple')" id="simpleModeBtn" class="px-3 py-1.5 rounded-md text-xs font-medium transition-all">
                            Simple
                        </button>
                        <button onclick="setUIMode('pro')" id="proModeBtn" class="px-3 py-1.5 rounded-md text-xs font-medium transition-all">
                            Pro
                        </button>
                    </div>
                    <button id="autoAnalyzeHeaderBtn" onclick="autoAnalyzeRemaining()" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-lg text-sm font-medium items-center gap-2 transition-colors hidden" aria-label="Auto-analyze remaining criteria">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        <span class="hidden sm:inline" id="autoAnalyzeBtnText">Auto-Analyze All</span>
                    </button>
                    <button onclick="showSettings()" id="settingsBtn" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors" aria-label="Open settings">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span class="hidden sm:inline">Settings</span>
                    </button>
                    <!-- Undo Button (v7.21) -->
                    <button id="undoBtn" onclick="undoLastScoreChange()" class="hidden bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg text-sm font-medium items-center gap-1.5 transition-colors" title="Undo last score change (Ctrl+Z)">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                        <span class="hidden sm:inline">Undo</span>
                    </button>
                    <!-- Last Saved Indicator (v7.21) -->
                    <div id="lastSavedIndicator" class="hidden items-center gap-1.5 bg-white/10 px-3 py-2 rounded-lg text-xs text-teal-100">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        <span id="lastSavedText">Saved</span>
                    </div>
                    <div id="apiStatus" class="flex items-center gap-2 bg-white/10 px-3 py-2 rounded-lg" role="status" aria-live="polite">
                        <div id="apiDot" class="w-2 h-2 rounded-full bg-red-400" aria-hidden="true"></div>
                        <span id="apiText" class="text-xs">No API Key</span>
                    </div>
                    <!-- API Error Warning Indicator (v7.19) -->
                    <button id="apiErrorIndicator" onclick="showLastErrorSummary()" class="hidden items-center gap-2 bg-amber-500/90 hover:bg-amber-500 px-3 py-2 rounded-lg transition-colors cursor-pointer" title="Click for details">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <span id="apiErrorText" class="text-xs text-white font-medium">0 Failed</span>
                    </button>
                    <!-- Red Flags Eligibility Indicator (v7.20) -->
                    <button id="redFlagsIndicator" onclick="showRedFlagsModal()" class="hidden items-center gap-2 bg-red-600/90 hover:bg-red-600 px-3 py-2 rounded-lg transition-colors cursor-pointer animate-pulse" title="Click for eligibility details">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/>
                        </svg>
                        <span id="redFlagsText" class="text-xs text-white font-bold">0 Red Flags</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Draft Recovery Banner -->
        <div id="draftBanner" class="hidden mb-6 bg-amber-50 border border-amber-200 rounded-xl p-4">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-amber-800">Unsaved evaluation found</p>
                        <p id="draftInfo" class="text-sm text-amber-700"></p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="discardDraft()" class="px-4 py-2 text-amber-700 hover:bg-amber-100 rounded-lg text-sm font-medium transition-colors">
                        Discard
                    </button>
                    <button onclick="restoreDraft()" class="px-4 py-2 bg-amber-600 text-white rounded-lg text-sm font-medium hover:bg-amber-700 transition-colors">
                        Restore
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent">
            <!-- Will be dynamically populated -->
        </div>
    </div>
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <div class="bg-white rounded-2xl max-w-md w-full shadow-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 overflow-y-auto flex-1">
                <div class="flex items-center justify-between mb-6">
                    <h3 id="settingsTitle" class="text-xl font-bold text-slate-800">Settings</h3>
                    <button onclick="hideSettings()" class="text-slate-400 hover:text-slate-600" aria-label="Close settings">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label for="apiKeyInput" class="block text-sm font-medium text-slate-700 mb-2">Anthropic API Key</label>
                        <div class="relative">
                            <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..."
                                class="w-full px-4 py-3 pr-12 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#38939B] focus:border-[#38939B] font-mono text-sm"
                                aria-describedby="apiKeyHelp">
                            <button onclick="toggleApiKeyVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600" aria-label="Toggle API key visibility">
                                <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </button>
                        </div>
                        <p id="apiKeyHelp" class="text-xs text-slate-500 mt-2">Your API key is stored locally and only sent to Anthropic's API.</p>
                        <!-- Security Warning (v7.21) -->
                        <div class="mt-2 p-2.5 bg-amber-50 border border-amber-200 rounded-lg">
                            <div class="flex items-start gap-2">
                                <svg class="w-4 h-4 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <div class="text-xs text-amber-800">
                                    <p class="font-medium">Security Note</p>
                                    <p class="mt-0.5 text-amber-700">Your API key is stored in browser localStorage, which is not encrypted. Avoid using this tool on shared or public computers. Consider clearing your browser data when done on shared devices.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-[#F3FAFE] rounded-xl p-4">
                        <p class="text-sm font-medium text-[#02538C] mb-2">How to get an API key:</p>
                        <ol class="text-sm text-[#036CB6] space-y-1 list-decimal list-inside">
                            <li>Go to <a href="https://console.anthropic.com" target="_blank" class="underline">console.anthropic.com</a></li>
                            <li>Create an account or sign in</li>
                            <li>Navigate to API Keys</li>
                            <li>Create a new key and copy it here</li>
                        </ol>
                    </div>

                    <div>
                        <label for="reviewerName" class="block text-sm font-medium text-slate-700 mb-2">Reviewer Name</label>
                        <input type="text" id="reviewerName" placeholder="Your name"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#38939B] focus:border-[#38939B]">
                    </div>

                    <div>
                        <label for="reviewerSheet" class="block text-sm font-medium text-slate-700 mb-2">Your Reviewer Role</label>
                        <select id="reviewerSheet" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#38939B] focus:border-[#38939B]">
                            <option value="Threshold+Scoring - Reviewer 1">Reviewer 1 - Threshold + Scoring</option>
                            <option value="Scoring Sheet - Reviewer 2" selected>Reviewer 2 - Scoring Only</option>
                        </select>
                        <div class="mt-3 p-3 bg-slate-50 rounded-lg text-xs">
                            <p class="font-semibold text-slate-700 mb-2">Understanding Your Role:</p>
                            <div class="space-y-2 text-slate-600">
                                <div class="flex items-start gap-2">
                                    <span class="text-[#036CB6] font-bold">R1:</span>
                                    <span><strong>Reviewer 1</strong> evaluates both <em>Threshold Criteria</em> (pass/fail eligibility) AND <em>Scoring Criteria</em></span>
                                </div>
                                <div class="flex items-start gap-2">
                                    <span class="text-green-600 font-bold">R2:</span>
                                    <span><strong>Reviewer 2</strong> evaluates <em>Scoring Criteria</em> only (threshold already completed by R1)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Template Configuration Section (Pro Mode Only) -->
                <div class="mt-6 pt-4 border-t border-slate-200 pro-mode-only">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-700">Template Profile</p>
                            <p class="text-xs text-slate-500" id="activeProfileDisplay">San Mateo NOFA FY26-27 (Default)</p>
                        </div>
                        <button onclick="hideSettings(); showTemplateConfig();" class="px-3 py-1.5 text-sm border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50 transition-colors">
                            Configure
                        </button>
                    </div>
                </div>

                <!-- Vision Analysis Section (Pro Mode Only) -->
                <div class="mt-6 pt-4 border-t border-slate-200 pro-mode-only">
                    <p class="text-sm font-medium text-slate-700 mb-3">Vision Analysis (Charts & Graphs)</p>

                    <!-- Auto-detect toggle -->
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm text-slate-600">Auto-detect visual content</p>
                            <p class="text-xs text-slate-400">Automatically enable vision when charts/graphs detected</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="visionAutoDetectToggle" class="sr-only peer" onchange="toggleVisionAutoDetect()">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>

                    <!-- Manual toggle -->
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-600">Always use vision analysis</p>
                            <p class="text-xs text-slate-400">Force vision on for all documents</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="visionToggle" class="sr-only peer" onchange="toggleVisionAnalysis()">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[#E3EDF5] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#38939B]"></div>
                        </label>
                    </div>

                    <div class="mt-3 p-2 bg-[#F3FAFE] rounded-lg">
                        <p class="text-xs text-[#036CB6]"><strong>How it works:</strong> The system scans PDFs for pages with charts, graphs, tables, or low-text content. When detected, vision analysis automatically activates to analyze visual elements.</p>
                        <p class="text-xs mt-1" id="visionStatusText">Status: Auto-detect enabled</p>
                    </div>
                </div>

                <!-- Consistency Cache Section (Pro Mode Only) -->
                <div class="mt-6 pt-4 border-t border-slate-200 pro-mode-only">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-slate-700">AI Response Cache</p>
                            <p class="text-xs text-slate-500">Cached responses ensure consistent scoring for the same document</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="clearResponseCache(); hideSettings();" class="px-3 py-1.5 text-sm border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50 transition-colors" title="Clear localStorage cache only - keeps current session data">
                                Clear Cache
                            </button>
                            <button onclick="clearAllAndReset();" class="px-3 py-1.5 text-sm border border-red-300 text-red-700 rounded-lg hover:bg-red-50 transition-colors" title="Clear cache AND reset current AI suggestions for fresh re-analysis">
                                Full Reset
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mt-2">Clear Cache: removes stored responses. Full Reset: also clears current session's AI suggestions for complete re-analysis.</p>
                </div>

                <!-- Admin Diagnostics Section (Pro Mode Only) -->
                <div class="mt-6 pt-4 border-t border-slate-200 pro-mode-only">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-medium text-slate-700">Admin Diagnostics</p>
                            <p class="text-xs text-slate-500">Document analysis statistics</p>
                        </div>
                        <button onclick="toggleDiagnosticsPanel()" class="px-3 py-1.5 text-sm border border-slate-300 text-slate-600 rounded-lg hover:bg-slate-50 transition-colors">
                            <span id="diagnosticsToggleText">Show</span>
                        </button>
                    </div>
                    <div id="diagnosticsPanel" class="hidden bg-slate-50 rounded-lg p-3 text-xs font-mono space-y-1">
                        <div class="grid grid-cols-2 gap-2">
                            <div class="text-slate-600">Total Pages:</div>
                            <div id="diagTotalPages" class="text-slate-800 font-semibold">-</div>
                            <div class="text-slate-600">Total Characters:</div>
                            <div id="diagTotalChars" class="text-slate-800 font-semibold">-</div>
                            <div class="text-slate-600">Attachments Start:</div>
                            <div id="diagAttachStart" class="text-slate-800 font-semibold">-</div>
                        </div>
                        <div class="border-t border-slate-200 my-2 pt-2">
                            <div class="text-slate-500 mb-1">AI Analysis Coverage:</div>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="text-slate-600">Main Content:</div>
                                <div id="diagMainChars" class="text-green-700 font-semibold">-</div>
                                <div class="text-slate-600">Attachments:</div>
                                <div id="diagAttachChars" class="text-green-700 font-semibold">-</div>
                                <div class="text-slate-600">Total to AI:</div>
                                <div id="diagTotalToAI" class="text-[#036CB6] font-semibold">-</div>
                                <div class="text-slate-600">Coverage:</div>
                                <div id="diagCoverage" class="text-[#036CB6] font-semibold">-</div>
                            </div>
                        </div>
                        <div class="border-t border-slate-200 my-2 pt-2">
                            <div class="grid grid-cols-2 gap-2">
                                <div class="text-slate-600">Criteria Analyzed:</div>
                                <div id="diagCriteriaCount" class="text-slate-800 font-semibold">-</div>
                                <div class="text-slate-600">Last Analysis:</div>
                                <div id="diagLastAnalysis" class="text-slate-800 font-semibold">-</div>
                                <div class="text-slate-600">Vision Analysis:</div>
                                <div id="diagVisionStatus" class="text-slate-500">Disabled</div>
                            </div>
                        </div>
                        <button onclick="copyDiagnosticsToClipboard()" class="w-full mt-2 px-2 py-1 text-xs bg-slate-200 hover:bg-slate-300 rounded transition-colors">
                            Copy to Clipboard
                        </button>
                    </div>
                </div>

                <!-- Reference Documents Section (v7.1) (Pro Mode Only) -->
                <div class="mt-6 pt-4 border-t border-slate-200 pro-mode-only">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-medium text-slate-700">üìö Reference Documents</p>
                            <p class="text-xs text-slate-500">Upload funding priorities & guidelines for AI context</p>
                        </div>
                        <button onclick="hideSettings(); showReferenceDocsModal();" class="px-3 py-1.5 text-sm border border-green-300 text-green-700 rounded-lg hover:bg-green-50 transition-colors">
                            Manage
                        </button>
                    </div>
                    <div id="refDocsStatusPreview" class="text-xs space-y-1">
                        <!-- Status preview will be populated by updateRefDocsPreview() -->
                    </div>
                </div>

                <!-- Linked Documents Section (v7.17) (Pro Mode Only) -->
                <div class="mt-4 pt-4 border-t border-slate-200 pro-mode-only">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-medium text-slate-700">üîó Linked Documents</p>
                            <p class="text-xs text-slate-500">Supporting documents linked in the application PDF</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="linkedDocsCount" class="hidden px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full font-medium">0</span>
                            <button onclick="hideSettings(); toggleLinkedDocsPanel();" class="px-3 py-1.5 text-sm border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50 transition-colors">
                                View
                            </button>
                        </div>
                    </div>
                    <div id="linkedDocsStatusPreview" class="text-xs text-slate-500">
                        Upload an application PDF to detect linked documents
                    </div>
                </div>

            </div>
            <!-- Fixed footer with buttons - always visible -->
            <div class="p-4 border-t border-slate-200 bg-white rounded-b-2xl flex-shrink-0">
                <div class="flex gap-3">
                    <button onclick="clearApiKey()" class="flex-1 px-4 py-3 border border-slate-300 rounded-xl text-slate-600 hover:bg-slate-50 transition-colors">
                        Clear Key
                    </button>
                    <button onclick="saveSettings()" class="flex-1 px-4 py-3 bg-[#38939B] text-white rounded-xl font-medium hover:bg-[#2a7078] transition-colors">
                        Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Configuration Modal -->
    <div id="templateConfigModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="templateConfigTitle">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] shadow-2xl flex flex-col">
            <div class="p-4 border-b border-slate-200 flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="templateConfigTitle" class="text-lg font-bold text-slate-800">Template Configuration</h3>
                        <p class="text-sm text-slate-500">Map Excel cells to scoring fields</p>
                    </div>
                </div>
                <button onclick="hideTemplateConfig()" class="text-slate-400 hover:text-slate-600 p-2" aria-label="Close">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="templateConfigContent" class="flex-1 overflow-y-auto p-6">
                <!-- Template configuration content will be rendered dynamically -->
            </div>
            <div class="p-4 border-t border-slate-200 bg-slate-50 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex gap-2">
                        <select id="templateProfileSelector" class="px-3 py-2 border border-slate-300 rounded-lg text-sm" onchange="loadSelectedTemplateProfile()">
                            <!-- Options populated dynamically -->
                        </select>
                        <button onclick="createNewTemplateProfile()" class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm hover:bg-purple-200 transition-colors">
                            + New Profile
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="hideTemplateConfig()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-600 hover:bg-slate-100 text-sm transition-colors">
                            Cancel
                        </button>
                        <button onclick="saveTemplateConfig()" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors">
                            Save Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdfViewerModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="pdfViewerTitle">
        <div class="bg-white rounded-2xl max-w-5xl w-full max-h-[90vh] shadow-2xl flex flex-col">
            <div class="p-4 border-b border-slate-200 flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-3">
                    <button id="backToEvidenceBtn" onclick="backToEvidenceModal()" class="hidden px-3 py-1.5 bg-[#E3EDF5] text-[#036CB6] rounded-lg hover:bg-[#B2D5EE] text-sm font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        Back to Evidence
                    </button>
                    <div>
                        <h3 id="pdfViewerTitle" class="text-lg font-bold text-slate-800">Application Document</h3>
                        <p id="pdfViewerContext" class="text-sm text-slate-500">Reviewing relevant section</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <!-- View Mode Toggle -->
                    <div class="flex items-center bg-slate-100 rounded-lg p-1">
                        <button id="visualViewBtn" onclick="setPdfViewMode('visual')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors bg-white text-[#036CB6] shadow-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            Visual
                        </button>
                        <button id="textViewBtn" onclick="setPdfViewMode('text')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors text-slate-600 hover:text-slate-800">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            Text
                        </button>
                    </div>
                    <!-- Zoom Controls (visual mode only) -->
                    <div id="zoomControls" class="flex items-center gap-1">
                        <button onclick="zoomPdf(-0.25)" class="px-2 py-1 border border-slate-300 rounded hover:bg-slate-100 text-sm" title="Zoom out">‚àí</button>
                        <span id="zoomLevel" class="text-xs text-slate-600 w-12 text-center">100%</span>
                        <button onclick="zoomPdf(0.25)" class="px-2 py-1 border border-slate-300 rounded hover:bg-slate-100 text-sm" title="Zoom in">+</button>
                    </div>
                    <button onclick="hidePdfViewer()" class="text-slate-400 hover:text-slate-600 p-2" aria-label="Close PDF viewer">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Visual PDF View (canvas rendering) -->
            <div id="pdfVisualView" class="flex-1 overflow-auto bg-slate-200 p-4" style="min-height: 500px;">
                <div id="pdfCanvasWrapper" class="flex items-start justify-center min-w-fit">
                    <canvas id="pdfCanvas" class="shadow-lg bg-white"></canvas>
                </div>
            </div>
            <!-- Text View (original) -->
            <div id="pdfTextView" class="pdf-viewer p-6 flex-1 overflow-y-auto hidden" role="document">
                <!-- PDF text content will be rendered here -->
            </div>

            <!-- Linked Documents Panel in PDF Viewer (v7.17) -->
            <div id="pdfLinkedDocsPanel" class="border-t border-slate-200 bg-gradient-to-r from-[#F3FAFE] to-[#E3EDF5] hidden">
                <button onclick="togglePdfLinkedDocsPanel()" class="w-full px-4 py-2 flex items-center justify-between hover:bg-[#E3EDF5]/50 transition-colors">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-[#036CB6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                        </svg>
                        <span class="font-medium text-[#02538C]">Linked Documents</span>
                        <span id="pdfLinkedDocsCount" class="bg-[#38939B] text-white text-xs px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <svg id="pdfLinkedDocsChevron" class="w-5 h-5 text-[#036CB6] transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div id="pdfLinkedDocsContent" class="hidden px-4 pb-4 max-h-64 overflow-y-auto">
                    <p class="text-xs text-slate-500 mb-2">Click any document to open it in a new tab for manual review:</p>
                    <div id="pdfLinkedDocsList" class="space-y-1">
                        <!-- Linked documents will be rendered here -->
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200 bg-slate-50 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <button onclick="pdfViewerPrevPage()" class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-100 text-sm" aria-label="Previous page">
                            ‚Üê Previous
                        </button>
                        <div class="flex items-center gap-1 text-sm text-slate-600">
                            <span>Page</span>
                            <input type="number" id="pdfPageInput" min="1" value="1"
                                class="w-14 px-2 py-1 border border-slate-300 rounded text-center text-sm"
                                onkeyup="if(event.key==='Enter')goToPage()"
                                onchange="goToPage()"
                                aria-label="Go to page number">
                            <span>of <span id="pdfTotalPages">1</span></span>
                        </div>
                        <button onclick="pdfViewerNextPage()" class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-100 text-sm" aria-label="Next page">
                            Next ‚Üí
                        </button>
                    </div>
                    <label class="sr-only" for="pdfSearchInput">Search in document</label>
                    <input type="text" id="pdfSearchInput" placeholder="Search in document..."
                        class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm w-48"
                        onkeyup="if(event.key==='Enter')searchInPdf()">
                </div>
            </div>
        </div>
    </div>

    <!-- Comment Prompt Modal -->
    <div id="commentPromptModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="commentPromptTitle">
        <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="commentPromptTitle" class="text-lg font-bold text-slate-800">Add Your Reasoning</h3>
                        <p class="text-sm text-slate-500">Help other reviewers understand your decision</p>
                    </div>
                </div>

                <p id="commentPromptText" class="text-slate-700 mb-4"></p>

                <div class="bg-[#F3FAFE] rounded-xl p-4 mb-4">
                    <p class="text-sm font-medium text-[#02538C] mb-2">Suggested reasoning starters:</p>
                    <div id="reasoningSuggestions" class="space-y-2" role="list">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <label for="promptedComment" class="sr-only">Your reasoning</label>
                <textarea id="promptedComment" rows="4"
                    class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#38939B] resize-none"
                    placeholder="Explain why you selected this score..."></textarea>

                <div class="flex gap-3 mt-4">
                    <button onclick="skipCommentPrompt()" class="flex-1 px-4 py-3 border border-slate-300 rounded-xl text-slate-600 hover:bg-slate-50 transition-colors">
                        Skip
                    </button>
                    <button onclick="savePromptedComment()" class="flex-1 px-4 py-3 bg-[#38939B] text-white rounded-xl font-medium hover:bg-[#2a7078] transition-colors">
                        Save Comment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" role="alertdialog" aria-modal="true" aria-labelledby="errorTitle">
        <div class="bg-white rounded-2xl max-w-md w-full shadow-2xl">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h3 id="errorTitle" class="text-lg font-bold text-slate-800">Error Occurred</h3>
                </div>
                <p id="errorMessage" class="text-slate-700 mb-4"></p>
                <p id="errorDetails" class="text-sm text-slate-500 bg-slate-50 rounded-lg p-3 mb-4 font-mono hidden"></p>
                <div class="flex gap-3">
                    <button onclick="hideErrorModal()" class="flex-1 px-4 py-3 border border-slate-300 rounded-xl text-slate-600 hover:bg-slate-50 transition-colors">
                        Dismiss
                    </button>
                    <button id="errorRetryBtn" onclick="retryLastAction()" class="flex-1 px-4 py-3 bg-[#38939B] text-white rounded-xl font-medium hover:bg-[#2a7078] transition-colors hidden">
                        Retry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reference Documents Modal (v7.1) -->
    <div id="referenceDocsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="refDocsTitle">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] shadow-2xl flex flex-col">
            <div class="p-6 border-b border-slate-200 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 id="refDocsTitle" class="text-lg font-bold text-slate-800">Reference Documents</h3>
                            <p class="text-sm text-slate-500">Upload documents to provide context for AI evaluation</p>
                        </div>
                    </div>
                    <button onclick="hideReferenceDocsModal()" class="text-slate-400 hover:text-slate-600 p-2" aria-label="Close">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="p-6 flex-1 overflow-y-auto space-y-6">
                <!-- Funding Priorities -->
                <div class="border border-slate-200 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h4 class="font-semibold text-slate-800">üìã Funding Priorities</h4>
                            <p class="text-xs text-slate-500">County funding priorities document (PDF)</p>
                        </div>
                        <div id="fundingPrioritiesStatus" class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">
                            Not loaded
                        </div>
                    </div>
                    <div id="fundingPrioritiesInfo" class="hidden mb-3 p-3 bg-green-50 rounded-lg">
                        <p class="text-sm text-green-800 font-medium" id="fundingPrioritiesName"></p>
                        <p class="text-xs text-green-600" id="fundingPrioritiesDetails"></p>
                    </div>
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer">
                            <input type="file" accept=".pdf" class="hidden" onchange="uploadReferenceDoc(event, 'fundingPriorities')">
                            <div class="px-4 py-2 border border-dashed border-slate-300 rounded-lg text-center text-sm text-slate-600 hover:bg-slate-50 hover:border-slate-400 transition-colors">
                                üì§ Upload PDF
                            </div>
                        </label>
                        <button onclick="clearReferenceDoc('fundingPriorities')" class="px-4 py-2 border border-red-200 text-red-600 rounded-lg text-sm hover:bg-red-50 transition-colors">
                            Clear
                        </button>
                        <button onclick="previewReferenceDoc('fundingPriorities')" class="px-4 py-2 border border-[#7CBEEC] text-[#036CB6] rounded-lg text-sm hover:bg-[#E3EDF5] transition-colors">
                            Preview
                        </button>
                    </div>
                </div>

                <!-- Guidelines -->
                <div class="border border-slate-200 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h4 class="font-semibold text-slate-800">üìñ NOFA Guidelines</h4>
                            <p class="text-xs text-slate-500">Program guidelines and requirements (PDF)</p>
                        </div>
                        <div id="guidelinesStatus" class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600">
                            Not loaded
                        </div>
                    </div>
                    <div id="guidelinesInfo" class="hidden mb-3 p-3 bg-green-50 rounded-lg">
                        <p class="text-sm text-green-800 font-medium" id="guidelinesName"></p>
                        <p class="text-xs text-green-600" id="guidelinesDetails"></p>
                    </div>
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer">
                            <input type="file" accept=".pdf" class="hidden" onchange="uploadReferenceDoc(event, 'guidelines')">
                            <div class="px-4 py-2 border border-dashed border-slate-300 rounded-lg text-center text-sm text-slate-600 hover:bg-slate-50 hover:border-slate-400 transition-colors">
                                üì§ Upload PDF
                            </div>
                        </label>
                        <button onclick="clearReferenceDoc('guidelines')" class="px-4 py-2 border border-red-200 text-red-600 rounded-lg text-sm hover:bg-red-50 transition-colors">
                            Clear
                        </button>
                        <button onclick="previewReferenceDoc('guidelines')" class="px-4 py-2 border border-[#7CBEEC] text-[#036CB6] rounded-lg text-sm hover:bg-[#E3EDF5] transition-colors">
                            Preview
                        </button>
                    </div>
                </div>

                <!-- How It Works -->
                <div class="bg-[#F3FAFE] rounded-xl p-4">
                    <h4 class="font-semibold text-[#02538C] mb-2">üí° How Reference Documents Work</h4>
                    <ul class="text-sm text-[#036CB6] space-y-1 list-disc list-inside">
                        <li><strong>Funding Priorities:</strong> Helps AI match projects to specific County priorities</li>
                        <li><strong>Guidelines:</strong> Provides scoring criteria context and eligibility requirements</li>
                        <li>Documents are stored locally in your browser and persist across sessions</li>
                        <li>Text is extracted and included in AI prompts during evaluation</li>
                        <li>Upload new versions anytime when priorities change</li>
                    </ul>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200 bg-slate-50 flex-shrink-0">
                <div class="flex justify-between items-center">
                    <button onclick="clearAllReferenceDocs()" class="px-4 py-2 border border-red-300 text-red-600 rounded-lg text-sm hover:bg-red-50 transition-colors">
                        Clear All Documents
                    </button>
                    <button onclick="hideReferenceDocsModal()" class="px-6 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
                        Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Linked Documents Modal (v7.17) -->
    <div id="linkedDocsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="linkedDocsTitle">
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] shadow-2xl flex flex-col">
            <div class="p-6 border-b border-slate-200 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                            </svg>
                        </div>
                        <div>
                            <h3 id="linkedDocsTitle" class="text-lg font-bold text-slate-800">Linked Documents</h3>
                            <p class="text-sm text-slate-500">Supporting documents found in the application PDF</p>
                        </div>
                    </div>
                    <button onclick="toggleLinkedDocsPanel()" class="text-slate-400 hover:text-slate-600 p-2" aria-label="Close">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="p-6 flex-1 overflow-y-auto">
                <!-- Fetch Button & Status -->
                <div class="mb-4 p-4 bg-purple-50 rounded-xl">
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <p class="text-sm text-purple-800 font-medium">Auto-fetch retrieves linked PDF documents and includes their content in AI analysis.</p>
                            <p id="linkedDocsFetchStatus" class="text-xs text-purple-600 mt-1"></p>
                        </div>
                        <button id="fetchLinkedDocsBtn" onclick="autoFetchLinkedDocuments()" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed">
                            Auto-Fetch Documents
                        </button>
                    </div>
                </div>

                <!-- Linked Documents List -->
                <div id="linkedDocsPanel" class="mb-4">
                    <h4 class="font-semibold text-slate-700 mb-3">Found Hyperlinks</h4>
                    <div id="linkedDocsList" class="space-y-2 max-h-[40vh] overflow-y-auto">
                        <p class="text-sm text-slate-500 italic">Upload an application PDF to see linked documents.</p>
                    </div>
                </div>

                <!-- How It Works -->
                <div class="bg-[#F3FAFE] rounded-xl p-4">
                    <h4 class="font-semibold text-[#02538C] mb-2">üí° How Linked Documents Work</h4>
                    <ul class="text-sm text-[#036CB6] space-y-1 list-disc list-inside">
                        <li><strong>Auto-Detection:</strong> Hyperlinks are extracted when you upload an application PDF</li>
                        <li><strong>Auto-Fetch:</strong> Click the button to automatically retrieve and analyze linked PDFs</li>
                        <li><strong>AI Integration:</strong> Fetched content (audits, budgets, exhibits) is included in scoring analysis</li>
                        <li><strong>Manual Review:</strong> Click the link icon to open any document in a new tab</li>
                        <li>Documents that couldn't be fetched (CORS, etc.) can still be reviewed manually</li>
                    </ul>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200 bg-slate-50 flex-shrink-0">
                <div class="flex justify-end">
                    <button onclick="toggleLinkedDocsPanel()" class="px-6 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors">
                        Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- External Document Viewer Modal (v7.19) -->
    <div id="externalDocViewerModal" class="fixed inset-0 bg-black/70 z-[60] hidden flex items-center justify-center p-4" role="dialog" aria-modal="true">
        <div class="bg-white rounded-2xl w-full max-w-6xl h-[90vh] shadow-2xl flex flex-col">
            <div class="p-4 border-b border-slate-200 flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="externalDocTitle" class="text-lg font-bold text-slate-800">Document Viewer</h3>
                        <p id="externalDocSubtitle" class="text-sm text-slate-500">Legacy format - viewing via external service</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <a id="externalDocDownloadBtn" href="#" target="_blank" class="px-3 py-2 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-200 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Open Original
                    </a>
                    <button onclick="closeExternalDocViewer()" class="text-slate-400 hover:text-slate-600 p-2" aria-label="Close">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex-1 bg-slate-100 relative overflow-hidden">
                <div id="externalDocLoading" class="absolute inset-0 flex items-center justify-center bg-white">
                    <div class="text-center">
                        <div class="w-12 h-12 border-4 border-amber-200 border-t-amber-600 rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-slate-600">Loading document viewer...</p>
                        <p class="text-xs text-slate-400 mt-1">Using Google Docs Viewer</p>
                    </div>
                </div>
                <iframe id="externalDocFrame" class="w-full h-full border-0" src="about:blank"></iframe>
            </div>
            <div class="p-3 border-t border-slate-200 bg-slate-50 flex-shrink-0">
                <p class="text-xs text-slate-500 text-center">
                    <span class="text-amber-600">‚ö†Ô∏è</span> Legacy .doc files are displayed using Google Docs Viewer. For best results and AI analysis, ask applicants to submit .docx or PDF formats.
                </p>
            </div>
        </div>
    </div>

    <script>
    // ============================================================
    // CONFIGURATION & CONSTANTS
    // ============================================================
    const CONFIG = {
        MODEL: 'claude-sonnet-4-20250514',
        MAX_TOKENS: 4096,
        API_URL: 'https://api.anthropic.com/v1/messages',
        MAX_PDF_SIZE_MB: 50,
        AUTO_SAVE_KEY: 'nofa_evaluation_draft',
        AUTO_SAVE_DEBOUNCE_MS: 1000,
        RESPONSE_CACHE_KEY: 'nofa_ai_response_cache',  // Cache AI responses by input hash
        TEXT_CHUNK_SIZE: 40000,  // Increased chunk size to capture more content including attachments
        ATTACHMENT_CHUNK_SIZE: 30000,  // Additional space for attachment/exhibit content
        TEMPLATE_PROFILES_KEY: 'nofa_template_profiles',  // Storage key for custom templates
        // Vision analysis settings
        VISION_ENABLED_KEY: 'nofa_vision_enabled',
        VISION_AUTO_DETECT_KEY: 'nofa_vision_auto_detect',
        VISION_MAX_PAGES: 10,  // Max pages to send as images (to control costs)
        VISION_IMAGE_SCALE: 1.5,  // Scale factor for rendering (1.5 = good quality, reasonable size)
        VISION_IMAGE_QUALITY: 0.8,  // JPEG quality (0.8 = good balance of quality/size)
        // Auto-detection thresholds
        VISION_MIN_CHARS_PER_PAGE: 200,  // Pages with fewer chars likely have charts/images
        VISION_CHART_KEYWORDS: ['chart', 'graph', 'figure', 'table', 'diagram', 'org chart', 'organizational chart', 'pie chart', 'bar graph', 'timeline', 'flowchart', 'infographic'],
        // Performance optimizations
        API_RETRY_ATTEMPTS: 3,  // Number of retry attempts for failed API calls
        API_RETRY_DELAY_MS: 1000,  // Base delay between retries (doubles each attempt)
        API_PARALLEL_BATCH_SIZE: 3,  // Number of parallel API calls (balance speed vs rate limits)
        RENDER_DEBOUNCE_MS: 50,  // Debounce rapid render calls
        // Reference document settings (v7.1)
        REF_DOC_MAX_CHARS: 25000,  // Max characters to include from each reference document
        REF_FUNDING_PRIORITIES_KEY: 'nofa_ref_funding_priorities',
        REF_GUIDELINES_KEY: 'nofa_ref_guidelines',
        REF_OTHER_KEY: 'nofa_ref_other'
    };

    // ============================================================
    // REFERENCE DOCUMENTS MANAGEMENT (v7.1)
    // ============================================================

    // Show/hide reference documents modal
    function showReferenceDocsModal() {
        document.getElementById('referenceDocsModal').classList.remove('hidden');
        updateReferenceDocsUI();
    }

    function hideReferenceDocsModal() {
        document.getElementById('referenceDocsModal').classList.add('hidden');
        updateRefDocsPreview();
    }

    // Upload a reference document
    async function uploadReferenceDoc(event, docType) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.name.toLowerCase().endsWith('.pdf')) {
            showToast('error', 'Invalid File', 'Please upload a PDF file.');
            return;
        }

        showLoading('Processing Document', `Extracting text from ${file.name}...`);

        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            let fullText = '';
            const totalPages = pdf.numPages;

            for (let i = 1; i <= totalPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += `\n--- Page ${i} ---\n${pageText}`;
            }

            // Truncate if too long
            const truncatedText = fullText.substring(0, CONFIG.REF_DOC_MAX_CHARS);
            const wasTruncated = fullText.length > CONFIG.REF_DOC_MAX_CHARS;

            const docData = {
                name: file.name,
                uploadedAt: new Date().toISOString(),
                pageCount: totalPages,
                charCount: fullText.length,
                truncated: wasTruncated,
                text: truncatedText
            };

            // Save to state and localStorage
            state.referenceDocuments[docType] = docData;
            const storageKey = docType === 'fundingPriorities' ? CONFIG.REF_FUNDING_PRIORITIES_KEY : CONFIG.REF_GUIDELINES_KEY;
            localStorage.setItem(storageKey, JSON.stringify(docData));

            hideLoading();
            updateReferenceDocsUI();
            showToast('success', 'Document Uploaded', `${file.name} (${totalPages} pages) loaded successfully.`);

            // Clear the response cache since context has changed
            clearResponseCache();

        } catch (error) {
            hideLoading();
            console.error('Error processing reference document:', error);
            showToast('error', 'Upload Failed', `Could not process ${file.name}: ${error.message}`);
        }

        // Reset the file input
        event.target.value = '';
    }

    // Clear a reference document
    function clearReferenceDoc(docType) {
        state.referenceDocuments[docType] = null;
        const storageKey = docType === 'fundingPriorities' ? CONFIG.REF_FUNDING_PRIORITIES_KEY : CONFIG.REF_GUIDELINES_KEY;
        localStorage.removeItem(storageKey);
        updateReferenceDocsUI();
        showToast('info', 'Document Cleared', `${docType === 'fundingPriorities' ? 'Funding Priorities' : 'Guidelines'} document removed.`);
        clearResponseCache();
    }

    // Clear all reference documents
    function clearAllReferenceDocs() {
        if (!confirm('Are you sure you want to clear all reference documents?')) return;

        state.referenceDocuments = {
            fundingPriorities: null,
            guidelines: null,
            other: []
        };
        localStorage.removeItem(CONFIG.REF_FUNDING_PRIORITIES_KEY);
        localStorage.removeItem(CONFIG.REF_GUIDELINES_KEY);
        localStorage.removeItem(CONFIG.REF_OTHER_KEY);

        updateReferenceDocsUI();
        showToast('warning', 'All Cleared', 'All reference documents have been removed.');
        clearResponseCache();
    }

    // Preview reference document content
    function previewReferenceDoc(docType) {
        const doc = state.referenceDocuments[docType];
        if (!doc) {
            showToast('info', 'No Document', 'No document uploaded for this category.');
            return;
        }

        // Create a preview modal with the text content
        const previewText = doc.text.substring(0, 5000) + (doc.text.length > 5000 ? '\n\n... [Content truncated for preview]' : '');

        alert(`üìÑ ${doc.name}\n\nPages: ${doc.pageCount}\nCharacters: ${doc.charCount.toLocaleString()}${doc.truncated ? ' (truncated)' : ''}\n\n--- Content Preview ---\n${previewText.substring(0, 2000)}`);
    }

    // ============================================================
    // LINKED DOCUMENTS EXTRACTION & FETCHING (v7.17)
    // ============================================================

    // Extract hyperlinks from a PDF document
    async function extractHyperlinksFromPDF(pdf) {
        const links = [];
        const seenUrls = new Set();

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            try {
                const page = await pdf.getPage(pageNum);
                const annotations = await page.getAnnotations();

                for (const annot of annotations) {
                    if (annot.subtype === 'Link' && annot.url) {
                        let url = annot.url;

                        // Skip javascript: links and already seen URLs
                        if (url.startsWith('javascript:')) {
                            // Extract actual URL from javascript:myOpen() calls
                            const match = url.match(/myOpen\(['"]([^'"]+)['"]/);
                            if (match) url = match[1];
                            else continue;
                        }

                        if (seenUrls.has(url)) continue;
                        seenUrls.add(url);

                        // Categorize the link
                        const linkInfo = categorizeLink(url);
                        links.push({
                            url: url,
                            pageNum: pageNum,
                            type: linkInfo.type,
                            name: linkInfo.name,
                            fetchable: linkInfo.fetchable
                        });
                    }
                }
            } catch (err) {
                console.warn(`[Linked Docs] Error extracting links from page ${pageNum}:`, err);
            }
        }

        console.log(`[Linked Docs] Found ${links.length} unique hyperlinks in PDF`);
        return links;
    }

    // Categorize a link based on its URL
    function categorizeLink(url) {
        const lowerUrl = url.toLowerCase();
        const fileName = url.split('/').pop().split('?')[0];

        // Determine document type
        let type = 'other';
        let fetchable = false;

        if (lowerUrl.includes('audit') || lowerUrl.includes('financial_statement')) {
            type = 'audit';
            fetchable = true;
        } else if (lowerUrl.includes('budget')) {
            type = 'budget';
            fetchable = true;
        } else if (lowerUrl.includes('board') && (lowerUrl.includes('resolution') || lowerUrl.includes('roster'))) {
            type = 'board';
            fetchable = true;
        } else if (lowerUrl.includes('exhibit') || lowerUrl.includes('attestation')) {
            type = 'exhibit';
            fetchable = true;
        } else if (lowerUrl.includes('irs') || lowerUrl.includes('non_profit') || lowerUrl.includes('nonprofit')) {
            type = 'nonprofit-status';
            fetchable = true;
        } else if (lowerUrl.includes('organization') && lowerUrl.includes('chart')) {
            type = 'org-chart';
            fetchable = true;
        } else if (lowerUrl.includes('by-law') || lowerUrl.includes('bylaw') || lowerUrl.includes('article')) {
            type = 'governance';
            fetchable = true;
        } else if (lowerUrl.includes('conflict') && lowerUrl.includes('interest')) {
            type = 'compliance';
            fetchable = true;
        } else if (lowerUrl.includes('mission')) {
            type = 'mission';
            fetchable = true;
        } else if (lowerUrl.includes('nofa') || lowerUrl.includes('help')) {
            type = 'reference';
            fetchable = false; // Don't auto-fetch NOFA reference docs
        } else if (fileName.endsWith('.pdf') || fileName.endsWith('.doc') || fileName.endsWith('.docx')) {
            type = 'document';
            fetchable = true;
        }

        // Generate friendly name from filename
        let name = fileName
            .replace(/[-_]/g, ' ')
            .replace(/\.[^.]+$/, '')  // Remove extension
            .replace(/\s+/g, ' ')
            .trim();

        // Capitalize first letter of each word
        name = name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');

        if (name.length > 50) name = name.substring(0, 47) + '...';
        if (!name) name = 'Linked Document';

        return { type, name, fetchable };
    }

    // Get type label for display
    function getLinkTypeLabel(type) {
        const labels = {
            'audit': 'üìä Audit/Financial',
            'budget': 'üí∞ Budget',
            'board': 'üë• Board Document',
            'exhibit': 'üìé Exhibit',
            'nonprofit-status': '‚úÖ Nonprofit Status',
            'org-chart': 'üè¢ Org Chart',
            'governance': 'üìú Governance',
            'compliance': '‚öñÔ∏è Compliance',
            'mission': 'üéØ Mission',
            'reference': 'üìñ Reference',
            'document': 'üìÑ Document',
            'other': 'üîó Link'
        };
        return labels[type] || labels['other'];
    }

    // Criteria to relevant document types mapping (v7.17)
    // Maps criterion IDs to document types that are relevant for evaluation
    const CRITERIA_DOCUMENT_MAP = {
        // Section 2: Applicant Capacity
        '2a': {
            docTypes: ['exhibit', 'reference', 'document'],
            reason: 'Experience documentation, past performance reports, and program outcomes may be in exhibits'
        },
        '2b': {
            docTypes: ['exhibit', 'document'],
            reason: 'Outcome measurement tools, data collection forms, or evaluation methods may be attached'
        },
        '2c': {
            docTypes: ['exhibit', 'compliance', 'document'],
            reason: 'Past QPR submissions or HMIS documentation may demonstrate administrative experience'
        },
        '2d': {
            docTypes: ['audit', 'budget', 'nonprofit-status'],
            reason: 'Audited financial statements (Exhibit 7), budget documents, and IRS determination letters show fiscal stability',
            priority: true
        },
        // Section 3: Project Feasibility
        '3a': {
            docTypes: ['exhibit', 'document'],
            reason: 'Program history, start dates, and operational timelines may be in supporting documents'
        },
        '3b': {
            docTypes: ['exhibit', 'document'],
            reason: 'Implementation timelines and launch schedules may be attached'
        },
        '3c': {
            docTypes: ['exhibit', 'document', 'reference'],
            reason: 'Previous grant award letters or funding history documentation'
        },
        '3d': {
            docTypes: ['exhibit', 'org-chart', 'governance'],
            reason: 'Partnership agreements, MOUs, or collaboration documentation may be attached'
        },
        '3e': {
            docTypes: ['exhibit', 'document'],
            reason: 'Unique program features or innovative approaches may be detailed in exhibits'
        },
        // Section 4: Cost Effectiveness
        '4a': {
            docTypes: ['budget', 'exhibit'],
            reason: 'Detailed budget breakdown shows how costs are calculated per client',
            priority: true
        },
        // Section 5: Leveraging
        '5b': {
            docTypes: ['budget', 'exhibit', 'document'],
            reason: 'Funding commitment letters, grant award notices, or pending application documentation'
        },
        '5c': {
            docTypes: ['budget', 'exhibit', 'document'],
            reason: 'Letters of commitment, funding history, or relationship documentation with funders'
        },
        '5d': {
            docTypes: ['budget'],
            reason: 'Budget documents show the breakdown of County vs. other funding sources',
            priority: true
        },
        // Section 1: Need for Project (if present)
        '1a': {
            docTypes: ['exhibit', 'document', 'reference'],
            reason: 'Needs assessment data, demographic analysis, or priority population documentation'
        },
        '1b': {
            docTypes: ['exhibit', 'document'],
            reason: 'Client demographic data and income eligibility documentation'
        }
    };

    // Get recommended linked documents for a specific criterion (v7.17)
    function getRecommendedDocumentsForCriterion(criterionId) {
        const links = state.linkedDocuments.links;
        if (!links || links.length === 0) return null;

        const mapping = CRITERIA_DOCUMENT_MAP[criterionId];
        if (!mapping) return null;

        // Find linked documents that match the relevant types
        const relevantDocs = links.filter(link => mapping.docTypes.includes(link.type));

        if (relevantDocs.length === 0) return null;

        return {
            documents: relevantDocs,
            reason: mapping.reason,
            priority: mapping.priority || false
        };
    }

    // Build HTML for document recommendations (v7.17)
    function buildDocumentRecommendationsHTML(criterionId) {
        const recommendations = getRecommendedDocumentsForCriterion(criterionId);
        if (!recommendations) return '';

        const fetched = state.linkedDocuments.fetched;
        const { documents, reason, priority } = recommendations;

        let html = `
            <div class="mt-3 p-3 rounded-lg ${priority ? 'bg-amber-50 border border-amber-200' : 'bg-[#F3FAFE] border border-[#7CBEEC]'}">
                <div class="flex items-start gap-2 mb-2">
                    <svg class="w-5 h-5 ${priority ? 'text-amber-600' : 'text-[#036CB6]'} flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div>
                        <p class="text-sm font-medium ${priority ? 'text-amber-800' : 'text-[#02538C]'}">
                            ${priority ? '‚≠ê Key Supporting Documents' : 'üìé Related Supporting Documents'}
                        </p>
                        <p class="text-xs ${priority ? 'text-amber-700' : 'text-[#036CB6]'} mt-0.5">${reason}</p>
                    </div>
                </div>
                <div class="space-y-1 ml-7">`;

        documents.forEach(doc => {
            const fetchedDoc = fetched[doc.url];
            let statusBadge = '';
            if (fetchedDoc?.status === 'success') {
                statusBadge = '<span class="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded ml-2">‚úì Analyzed by AI</span>';
            }

            html += `
                <a href="${doc.url}" target="_blank" rel="noopener noreferrer"
                   class="flex items-center justify-between p-2 bg-white rounded border border-slate-200 hover:border-[#7CBEEC] hover:bg-[#E3EDF5] transition-colors group text-sm">
                    <div class="flex items-center gap-2 min-w-0">
                        <span class="text-xs text-slate-500">${getLinkTypeLabel(doc.type)}</span>
                        <span class="font-medium text-slate-700 truncate" title="${doc.name}">${doc.name}</span>
                        ${statusBadge}
                    </div>
                    <svg class="w-4 h-4 text-[#38939B] flex-shrink-0 group-hover:text-[#036CB6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                </a>`;
        });

        html += `
                </div>
            </div>`;

        return html;
    }

    // Build compact document hint for criterion cards (v7.17)
    function buildCriterionDocumentHint(criterionId) {
        const recommendations = getRecommendedDocumentsForCriterion(criterionId);
        if (!recommendations) return '';

        const { documents, reason, priority } = recommendations;
        const fetchedCount = documents.filter(d => state.linkedDocuments.fetched[d.url]?.status === 'success').length;

        // Get unique document types
        const docTypes = [...new Set(documents.map(d => getLinkTypeLabel(d.type)))];

        return `
            <div class="mt-3 p-2 rounded-lg ${priority ? 'bg-amber-50 border border-amber-100' : 'bg-[#F3FAFE] border border-[#B2D5EE]'}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 ${priority ? 'text-amber-500' : 'text-[#38939B]'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                        </svg>
                        <span class="text-xs ${priority ? 'text-amber-700' : 'text-[#036CB6]'}">
                            ${priority ? '‚≠ê Review:' : 'üìé May reference:'} ${docTypes.slice(0, 3).join(', ')}${docTypes.length > 3 ? '...' : ''}
                        </span>
                        ${fetchedCount > 0 ? `<span class="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded">${fetchedCount} analyzed</span>` : ''}
                    </div>
                    <button onclick="showDocumentRecommendationsModal('${criterionId}')" class="text-xs ${priority ? 'text-amber-600 hover:text-amber-800' : 'text-[#036CB6] hover:text-[#02538C]'} font-medium">
                        View ${documents.length} docs ‚Üí
                    </button>
                </div>
            </div>`;
    }

    // Show modal with document recommendations for a criterion (v7.17)
    function showDocumentRecommendationsModal(criterionId) {
        const criterion = CRITERIA.find(c => c.id === criterionId);
        const recommendations = getRecommendedDocumentsForCriterion(criterionId);

        if (!recommendations) return;

        const overlay = document.createElement('div');
        overlay.id = 'docRecommendationsModal';
        overlay.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
        overlay.innerHTML = `
            <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
                <div class="p-4 border-b border-slate-200 bg-gradient-to-r from-[#F3FAFE] to-[#E3EDF5]">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">${criterionId.toUpperCase()}: Supporting Documents</h3>
                            <p class="text-sm text-slate-600 mt-1">${criterion?.question || ''}</p>
                        </div>
                        <button onclick="document.getElementById('docRecommendationsModal').remove()" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                </div>
                <div class="p-4 overflow-y-auto flex-1">
                    <div class="bg-slate-50 rounded-lg p-3 mb-4">
                        <p class="text-sm text-slate-700">
                            <span class="font-semibold">üí° Why these documents?</span><br>
                            ${recommendations.reason}
                        </p>
                    </div>
                    <p class="text-xs font-semibold text-slate-500 mb-2">LINKED DOCUMENTS (${recommendations.documents.length}):</p>
                    <div class="space-y-2">
                        ${recommendations.documents.map(doc => {
                            const fetchedDoc = state.linkedDocuments.fetched[doc.url];
                            let statusBadge = '';
                            let bgClass = 'bg-white';

                            if (fetchedDoc?.status === 'success') {
                                statusBadge = '<span class="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded">‚úì Analyzed by AI</span>';
                                bgClass = 'bg-green-50';
                            } else if (fetchedDoc?.status === 'error') {
                                statusBadge = '<span class="text-xs bg-red-100 text-red-700 px-1.5 py-0.5 rounded">‚ö† Fetch failed</span>';
                            }

                            return `
                                <a href="${doc.url}" target="_blank" rel="noopener noreferrer"
                                   class="flex items-center justify-between p-3 ${bgClass} rounded-lg border border-slate-200 hover:border-[#7CBEEC] hover:bg-[#E3EDF5] transition-colors group">
                                    <div class="flex-1 min-w-0 mr-2">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xs text-slate-500">${getLinkTypeLabel(doc.type)}</span>
                                            ${statusBadge}
                                        </div>
                                        <p class="font-medium text-slate-700 truncate" title="${doc.name}">${doc.name}</p>
                                        <p class="text-xs text-slate-500">Found on page ${doc.pageNum}</p>
                                    </div>
                                    <svg class="w-5 h-5 text-[#38939B] flex-shrink-0 group-hover:text-[#036CB6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                </a>`;
                        }).join('')}
                    </div>
                </div>
                <div class="p-4 border-t border-slate-200 bg-slate-50">
                    <button onclick="document.getElementById('docRecommendationsModal').remove()" class="w-full px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                        Close
                    </button>
                </div>
            </div>`;

        document.body.appendChild(overlay);
        overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
    }

    // Fetch a single linked document
    // CORS-aware fetch helper (v7.19) - tries direct fetch first, then CORS proxy
    async function fetchWithCorsRetry(url) {
        // First try direct fetch
        try {
            const response = await fetch(url);
            if (response.ok) {
                return { response, method: 'direct' };
            }
            throw new Error(`HTTP ${response.status}`);
        } catch (directError) {
            // Check if it's likely a CORS error (Failed to fetch from file:// origin)
            const isCorsError = directError.message === 'Failed to fetch' ||
                               directError.message.includes('CORS') ||
                               directError.message.includes('NetworkError');

            if (isCorsError) {
                console.log(`[Linked Docs] CORS blocked for ${url}, trying proxy...`);

                // Try multiple CORS proxies as fallbacks
                const corsProxies = [
                    'https://corsproxy.io/?',
                    'https://api.allorigins.win/raw?url=',
                    'https://cors-anywhere.herokuapp.com/'
                ];

                for (const proxy of corsProxies) {
                    try {
                        const proxyUrl = proxy + encodeURIComponent(url);
                        const response = await fetch(proxyUrl);
                        if (response.ok) {
                            console.log(`[Linked Docs] Successfully fetched via proxy: ${proxy}`);
                            return { response, method: 'proxy', proxy };
                        }
                    } catch (proxyError) {
                        console.log(`[Linked Docs] Proxy ${proxy} failed:`, proxyError.message);
                        continue; // Try next proxy
                    }
                }

                // All proxies failed - throw CORS-specific error
                throw new Error('CORS_BLOCKED: Document server does not allow cross-origin requests. Click the link icon to open directly.');
            }

            // Re-throw non-CORS errors
            throw directError;
        }
    }

    async function fetchLinkedDocument(link) {
        const url = link.url;

        // Check if already fetched
        if (state.linkedDocuments.fetched[url]) {
            return state.linkedDocuments.fetched[url];
        }

        try {
            // Determine if it's a PDF or text document
            const isPDF = url.toLowerCase().endsWith('.pdf');
            const isDoc = url.toLowerCase().match(/\.(doc|docx)$/);

            if (isPDF) {
                // Fetch and extract PDF using CORS-aware helper
                const { response } = await fetchWithCorsRetry(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const arrayBuffer = await response.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let fullText = '';
                for (let i = 1; i <= Math.min(pdf.numPages, 20); i++) { // Limit to 20 pages
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += `\n--- Page ${i} ---\n${pageText}`;
                }

                // Truncate if needed
                const maxChars = 50000;
                const truncated = fullText.length > maxChars;
                const text = truncated ? fullText.substring(0, maxChars) : fullText;

                const result = {
                    text: text,
                    name: link.name,
                    type: link.type,
                    status: 'success',
                    pageCount: pdf.numPages,
                    charCount: text.length,
                    truncated: truncated,
                    fetchedAt: new Date().toISOString()
                };

                state.linkedDocuments.fetched[url] = result;
                return result;

            } else if (isDoc) {
                // Parse Word documents using Mammoth.js (v7.19)
                const isDocx = url.toLowerCase().endsWith('.docx');
                const isOldDoc = url.toLowerCase().endsWith('.doc');

                if (isDocx && typeof mammoth !== 'undefined') {
                    // Fetch and parse .docx with Mammoth.js using CORS-aware helper
                    const { response } = await fetchWithCorsRetry(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const arrayBuffer = await response.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    const text = result.value || '';

                    const maxChars = 50000;
                    const truncated = text.length > maxChars;
                    const finalText = truncated ? text.substring(0, maxChars) : text;

                    const docResult = {
                        text: finalText,
                        name: link.name,
                        type: link.type,
                        status: 'success',
                        charCount: finalText.length,
                        truncated: truncated,
                        format: 'docx',
                        fetchedAt: new Date().toISOString()
                    };

                    state.linkedDocuments.fetched[url] = docResult;
                    return docResult;

                } else if (isOldDoc) {
                    // Old .doc format is not supported (binary format requires server-side processing)
                    state.linkedDocuments.fetched[url] = {
                        text: null,
                        name: link.name,
                        type: link.type,
                        status: 'unsupported',
                        error: 'Legacy .doc format requires conversion. Please save as .docx or PDF.',
                        format: 'doc',
                        fetchedAt: new Date().toISOString()
                    };
                    return state.linkedDocuments.fetched[url];

                } else {
                    // Mammoth.js not loaded, fall back to unsupported
                    state.linkedDocuments.fetched[url] = {
                        text: null,
                        name: link.name,
                        type: link.type,
                        status: 'unsupported',
                        error: 'Word document parser not available. Please review manually.',
                        fetchedAt: new Date().toISOString()
                    };
                    return state.linkedDocuments.fetched[url];
                }

            } else {
                // Try to fetch as text using CORS-aware helper
                const { response } = await fetchWithCorsRetry(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const text = await response.text();
                const result = {
                    text: text.substring(0, 50000),
                    name: link.name,
                    type: link.type,
                    status: 'success',
                    charCount: text.length,
                    truncated: text.length > 50000,
                    fetchedAt: new Date().toISOString()
                };

                state.linkedDocuments.fetched[url] = result;
                return result;
            }

        } catch (error) {
            console.warn(`[Linked Docs] Failed to fetch ${url}:`, error.message);

            // Check if this is a CORS error (v7.19)
            const isCorsError = error.message.includes('CORS_BLOCKED') ||
                               error.message === 'Failed to fetch';

            state.linkedDocuments.fetched[url] = {
                text: null,
                name: link.name,
                type: link.type,
                status: isCorsError ? 'cors_blocked' : 'error',
                error: isCorsError
                    ? 'Cross-origin blocked. Open document directly using the link icon.'
                    : error.message,
                fetchedAt: new Date().toISOString()
            };
            return state.linkedDocuments.fetched[url];
        }
    }

    // AI-powered document classification based on content (v7.18)
    async function classifyDocumentWithAI(text, currentType, documentName) {
        // Skip if no API key or text is too short
        if (!state.apiKey || !text || text.length < 100) {
            return currentType;
        }

        // Take a sample of the document (first 3000 chars) for classification
        const sample = text.substring(0, 3000);

        const classificationPrompt = `Analyze this document excerpt and classify it into ONE of these categories:

CATEGORIES:
- audit: Financial audits, audited financial statements, audit reports, single audit reports, A-133 audits
- budget: Program budgets, operating budgets, budget narratives, budget justifications, line-item budgets
- board: Board resolutions, board meeting minutes, board rosters, board member lists
- nonprofit-status: IRS determination letters, 501(c)(3) status letters, tax-exempt status documentation
- exhibit: General exhibits, attachments, supplementary materials (use if clearly labeled as exhibit)
- org-chart: Organizational charts, staff structure diagrams, reporting hierarchies
- governance: Bylaws, articles of incorporation, corporate governance documents
- compliance: Conflict of interest policies, code of ethics, compliance certifications
- mission: Mission statements, vision statements, organizational purpose documents
- other: Documents that don't clearly fit any category above

DOCUMENT NAME: "${documentName}"

DOCUMENT EXCERPT:
${sample}

Respond with ONLY the category name (one word, lowercase). If unsure, respond with the most likely category based on content.`;

        try {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 50,
                    messages: [{
                        role: 'user',
                        content: classificationPrompt
                    }]
                })
            });

            if (!response.ok) {
                console.warn('[AI Classification] API error, using URL-based classification');
                return currentType;
            }

            const data = await response.json();
            const classification = data.content?.[0]?.text?.trim().toLowerCase();

            // Validate the classification is one of our known types
            const validTypes = ['audit', 'budget', 'board', 'nonprofit-status', 'exhibit', 'org-chart', 'governance', 'compliance', 'mission', 'other'];
            if (validTypes.includes(classification)) {
                console.log(`[AI Classification] "${documentName}": ${currentType} ‚Üí ${classification}`);
                return classification;
            }

            return currentType;

        } catch (error) {
            console.warn('[AI Classification] Error:', error.message);
            return currentType;
        }
    }

    // Reclassify a linked document based on its fetched content (v7.18)
    async function reclassifyFetchedDocument(url) {
        const fetchedDoc = state.linkedDocuments.fetched[url];
        const link = state.linkedDocuments.links.find(l => l.url === url);

        if (!fetchedDoc || !link || fetchedDoc.status !== 'success' || !fetchedDoc.text) {
            return;
        }

        // Only reclassify if current type is generic ('document', 'exhibit', 'other')
        const genericTypes = ['document', 'exhibit', 'other'];
        if (!genericTypes.includes(link.type)) {
            // Already has a specific classification from URL
            return;
        }

        const newType = await classifyDocumentWithAI(fetchedDoc.text, link.type, link.name);

        if (newType !== link.type) {
            // Update the link's type
            link.type = newType;
            fetchedDoc.type = newType;
            fetchedDoc.aiClassified = true;

            // Update UI to reflect new classification
            updateLinkedDocsUI();
            updatePdfLinkedDocsPanel();
        }
    }

    // Auto-fetch all fetchable linked documents
    async function autoFetchLinkedDocuments() {
        const fetchableLinks = state.linkedDocuments.links.filter(l => l.fetchable);

        if (fetchableLinks.length === 0) {
            showToast('info', 'No Documents to Fetch', 'No fetchable supporting documents were found in the application.');
            return;
        }

        state.linkedDocuments.isFetching = true;
        state.linkedDocuments.fetchProgress = 0;
        updateLinkedDocsUI();

        showLoading('Fetching Supporting Documents', `Retrieving ${fetchableLinks.length} linked documents...`, true);

        let fetched = 0;
        let succeeded = 0;
        let failed = 0;
        let corsBlocked = 0;

        for (const link of fetchableLinks) {
            try {
                updateLoadingProgress(
                    Math.round((fetched / fetchableLinks.length) * 100),
                    `Fetching: ${link.name}`
                );

                const result = await fetchLinkedDocument(link);
                if (result.status === 'success') succeeded++;
                else if (result.status === 'cors_blocked') corsBlocked++;
                else failed++;

            } catch (err) {
                failed++;
            }

            fetched++;
            state.linkedDocuments.fetchProgress = Math.round((fetched / fetchableLinks.length) * 100);
        }

        // AI classification phase for documents with generic types (v7.18)
        const docsToClassify = fetchableLinks.filter(link => {
            const fetched = state.linkedDocuments.fetched[link.url];
            const genericTypes = ['document', 'exhibit', 'other'];
            return fetched?.status === 'success' && genericTypes.includes(link.type);
        });

        if (docsToClassify.length > 0 && state.apiKey) {
            updateLoadingProgress(100, `Classifying ${docsToClassify.length} documents with AI...`);
            showLoading('Analyzing Documents', `AI is classifying ${docsToClassify.length} documents by content...`, true);

            let classified = 0;
            for (const link of docsToClassify) {
                updateLoadingProgress(
                    Math.round((classified / docsToClassify.length) * 100),
                    `Classifying: ${link.name}`
                );
                await reclassifyFetchedDocument(link.url);
                classified++;
            }
        }

        state.linkedDocuments.isFetching = false;
        hideLoading();
        updateLinkedDocsUI();
        updatePdfLinkedDocsPanel(); // Update PDF viewer panel too
        updateLinkedDocsStatusPreview(); // Update Settings modal preview with fetched docs status (v7.21 fix)

        // Clear response cache since we have new context
        clearResponseCache();

        const classifiedCount = docsToClassify.filter(l => state.linkedDocuments.fetched[l.url]?.aiClassified).length;
        let message = `Successfully retrieved ${succeeded} of ${fetchableLinks.length} documents.`;
        if (corsBlocked > 0) message += ` ${corsBlocked} blocked by CORS (use View button).`;
        if (failed > 0) message += ` ${failed} other failures.`;
        if (classifiedCount > 0) message += ` AI classified ${classifiedCount} documents.`;

        // Show appropriate toast based on results
        const toastType = corsBlocked > 0 ? 'warning' : (succeeded > 0 ? 'success' : 'warning');
        const toastTitle = corsBlocked > 0 ? 'Documents Partially Fetched' : 'Documents Fetched';

        showToast(toastType, toastTitle, message);

        // Show additional info if many CORS blocked
        if (corsBlocked >= 3) {
            showToast('info', 'CORS Restriction Info',
                'Documents are hosted on a server that blocks browser requests. Click the View button to open them in Google Docs viewer, or use the link icon to open directly.'
            );
        }
    }

    // AUTO-FETCH with Missing Documents Report (v7.20)
    // This runs automatically when a PDF is uploaded and provides a report of any documents that couldn't be retrieved
    async function autoFetchLinkedDocumentsWithReport() {
        const fetchableLinks = state.linkedDocuments.links.filter(l => l.fetchable);

        if (fetchableLinks.length === 0) {
            console.log('[Auto-Fetch] No fetchable supporting documents found.');
            return;
        }

        console.log(`[Auto-Fetch] Starting automatic fetch of ${fetchableLinks.length} linked documents...`);

        state.linkedDocuments.isFetching = true;
        state.linkedDocuments.fetchProgress = 0;
        updateLinkedDocsUI();

        // Show loading indicator with different message for auto-fetch
        showLoading('Auto-Fetching Supporting Documents',
            `Automatically retrieving ${fetchableLinks.length} linked documents from application...`, true);

        let fetched = 0;
        let succeeded = 0;
        let failed = 0;
        let corsBlocked = 0;

        // Track results for report
        const fetchResults = {
            successful: [],
            corsBlocked: [],
            failed: []
        };

        for (const link of fetchableLinks) {
            try {
                updateLoadingProgress(
                    Math.round((fetched / fetchableLinks.length) * 100),
                    `Fetching: ${link.name}`
                );

                const result = await fetchLinkedDocument(link);

                if (result.status === 'success') {
                    succeeded++;
                    fetchResults.successful.push({
                        name: link.name,
                        type: link.type,
                        url: link.url
                    });
                } else if (result.status === 'cors_blocked') {
                    corsBlocked++;
                    fetchResults.corsBlocked.push({
                        name: link.name,
                        type: link.type,
                        url: link.url,
                        reason: 'Server blocks browser requests (CORS)'
                    });
                } else {
                    failed++;
                    fetchResults.failed.push({
                        name: link.name,
                        type: link.type,
                        url: link.url,
                        reason: result.error || 'Failed to fetch'
                    });
                }

            } catch (err) {
                failed++;
                fetchResults.failed.push({
                    name: link.name,
                    type: link.type,
                    url: link.url,
                    reason: err.message || 'Unknown error'
                });
            }

            fetched++;
            state.linkedDocuments.fetchProgress = Math.round((fetched / fetchableLinks.length) * 100);
        }

        // AI classification phase for documents with generic types
        const docsToClassify = fetchableLinks.filter(link => {
            const fetchedDoc = state.linkedDocuments.fetched[link.url];
            const genericTypes = ['document', 'exhibit', 'other'];
            return fetchedDoc?.status === 'success' && genericTypes.includes(link.type);
        });

        if (docsToClassify.length > 0 && state.apiKey) {
            updateLoadingProgress(100, `Classifying ${docsToClassify.length} documents with AI...`);
            showLoading('Analyzing Documents', `AI is classifying ${docsToClassify.length} documents by content...`, true);

            let classified = 0;
            for (const link of docsToClassify) {
                updateLoadingProgress(
                    Math.round((classified / docsToClassify.length) * 100),
                    `Classifying: ${link.name}`
                );
                await reclassifyFetchedDocument(link.url);
                classified++;
            }
        }

        state.linkedDocuments.isFetching = false;
        hideLoading();
        updateLinkedDocsUI();
        updatePdfLinkedDocsPanel();
        updateLinkedDocsStatusPreview(); // Update Settings modal preview with fetched docs status (v7.21 fix)

        // Clear response cache since we have new context
        clearResponseCache();

        // Generate and show the Missing Documents Report
        const missingCount = fetchResults.corsBlocked.length + fetchResults.failed.length;

        if (missingCount > 0) {
            // Show missing documents notification
            showMissingDocumentsNotification(fetchResults, fetchableLinks.length);
        } else if (succeeded > 0) {
            // All documents fetched successfully
            const classifiedCount = docsToClassify.filter(l =>
                state.linkedDocuments.fetched[l.url]?.aiClassified
            ).length;

            let message = `All ${succeeded} supporting documents retrieved successfully!`;
            if (classifiedCount > 0) {
                message += ` AI classified ${classifiedCount} documents.`;
            }

            showToast('success', '‚úÖ Documents Auto-Fetched', message);
        }

        console.log(`[Auto-Fetch] Complete. Succeeded: ${succeeded}, CORS: ${corsBlocked}, Failed: ${failed}`);
    }

    // Show notification for missing/failed documents (v7.20)
    function showMissingDocumentsNotification(results, totalCount) {
        const { successful, corsBlocked, failed } = results;
        const missingDocs = [...corsBlocked, ...failed];
        const successCount = successful.length;

        // Create a special notification modal for missing documents
        const modal = document.createElement('div');
        modal.id = 'missingDocsModal';
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[10000] animate-fade-in';
        modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
        };

        const docListHtml = missingDocs.map(doc => `
            <div class="flex items-start gap-3 p-3 bg-amber-50 rounded-lg border border-amber-200">
                <span class="text-lg">‚ö†Ô∏è</span>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-amber-900 truncate">${doc.name}</div>
                    <div class="text-xs text-amber-700">${getLinkTypeLabel(doc.type)}</div>
                    <div class="text-xs text-amber-600 mt-1">${doc.reason}</div>
                </div>
                <a href="${doc.url}" target="_blank"
                   class="text-xs bg-amber-600 text-white px-2 py-1 rounded hover:bg-amber-700 whitespace-nowrap">
                    Open Manually
                </a>
            </div>
        `).join('');

        const successListHtml = successful.length > 0 ? `
            <div class="mt-4 pt-4 border-t border-slate-200">
                <div class="text-sm font-medium text-green-700 mb-2">
                    ‚úÖ Successfully Retrieved (${successful.length}):
                </div>
                <div class="flex flex-wrap gap-1">
                    ${successful.map(doc => `
                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">
                            ${doc.name}
                        </span>
                    `).join('')}
                </div>
            </div>
        ` : '';

        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden animate-slide-up">
                <!-- Header -->
                <div class="bg-gradient-to-r from-amber-500 to-orange-500 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">üìã</span>
                            <div>
                                <h2 class="text-xl font-bold text-white">Supporting Documents Report</h2>
                                <p class="text-amber-100 text-sm">Auto-fetch completed with some issues</p>
                            </div>
                        </div>
                        <button onclick="this.closest('#missingDocsModal').remove()"
                                class="text-white/80 hover:text-white text-2xl font-bold">&times;</button>
                    </div>
                </div>

                <!-- Summary -->
                <div class="px-6 py-4 bg-slate-50 border-b">
                    <div class="flex items-center justify-center gap-8">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${successCount}</div>
                            <div class="text-xs text-slate-600">Retrieved</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-amber-600">${missingDocs.length}</div>
                            <div class="text-xs text-slate-600">Could Not Fetch</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-slate-600">${totalCount}</div>
                            <div class="text-xs text-slate-600">Total Links</div>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="px-6 py-4 overflow-y-auto" style="max-height: 400px;">
                    <div class="text-sm font-medium text-amber-800 mb-3">
                        ‚ö†Ô∏è Documents That Need Manual Review (${missingDocs.length}):
                    </div>
                    <div class="space-y-2">
                        ${docListHtml}
                    </div>
                    ${successListHtml}
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 bg-slate-50 border-t">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
                        <div class="text-xs text-slate-500 text-center sm:text-left">
                            üí° CORS-blocked documents can be viewed using the View button in the Linked Documents panel.
                        </div>
                        <button onclick="this.closest('#missingDocsModal').remove()"
                                class="px-6 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-800 font-medium flex-shrink-0 w-full sm:w-auto">
                            Got It
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Also show a toast so user knows something happened
        showToast('warning', 'üìã Documents Report',
            `${successCount} of ${totalCount} documents retrieved. ${missingDocs.length} need manual review.`);
    }

    // Build context from fetched linked documents for AI prompts
    function buildLinkedDocumentsContext() {
        const fetched = state.linkedDocuments.fetched;
        const docs = Object.values(fetched).filter(d => d.status === 'success' && d.text);

        if (docs.length === 0) return '';

        let context = '\n\n=== LINKED SUPPORTING DOCUMENTS ===\n';
        context += 'The following documents were linked in the application and have been retrieved:\n\n';

        for (const doc of docs) {
            context += `--- ${doc.name} (${getLinkTypeLabel(doc.type)}) ---\n`;
            // Include up to 10000 chars per document
            const text = doc.text.substring(0, 10000);
            context += text;
            if (doc.text.length > 10000) context += '\n[... content truncated ...]';
            context += '\n\n';
        }

        return context;
    }

    // Update Linked Documents UI
    function updateLinkedDocsUI() {
        const panel = document.getElementById('linkedDocsPanel');
        const count = document.getElementById('linkedDocsCount');
        const list = document.getElementById('linkedDocsList');
        const fetchBtn = document.getElementById('fetchLinkedDocsBtn');
        const fetchStatus = document.getElementById('linkedDocsFetchStatus');

        if (!panel) return;

        const links = state.linkedDocuments.links;
        const fetched = state.linkedDocuments.fetched;

        // Update count badge
        if (count) {
            count.textContent = links.length;
            count.classList.toggle('hidden', links.length === 0);
        }

        // Update list
        if (list) {
            if (links.length === 0) {
                list.innerHTML = '<p class="text-sm text-slate-500 italic">No hyperlinks found in the application PDF.</p>';
            } else {
                list.innerHTML = links.map(link => {
                    const fetchedDoc = fetched[link.url];
                    let statusIcon = '';
                    let statusClass = '';

                    if (fetchedDoc) {
                        if (fetchedDoc.status === 'success') {
                            statusIcon = '‚úÖ';
                            statusClass = 'bg-green-50 border-green-200';
                        } else if (fetchedDoc.status === 'error') {
                            statusIcon = '‚ùå';
                            statusClass = 'bg-red-50 border-red-200';
                        } else if (fetchedDoc.status === 'cors_blocked') {
                            statusIcon = 'üîí';
                            statusClass = 'bg-orange-50 border-orange-200';
                        } else if (fetchedDoc.status === 'unsupported') {
                            statusIcon = '‚ö†Ô∏è';
                            statusClass = 'bg-yellow-50 border-yellow-200';
                        }
                    } else if (link.fetchable) {
                        statusIcon = '‚è≥';
                        statusClass = 'bg-slate-50';
                    }

                    return `
                        <div class="p-2 border rounded ${statusClass} text-sm">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-1 flex-wrap">
                                        <span class="text-xs">${getLinkTypeLabel(link.type)}</span>
                                        ${fetchedDoc?.aiClassified ? '<span class="text-xs bg-purple-100 text-purple-700 px-1 py-0.5 rounded">ü§ñ AI</span>' : ''}
                                        ${statusIcon ? `<span>${statusIcon}</span>` : ''}
                                    </div>
                                    <p class="font-medium text-slate-700 truncate" title="${link.name}">${link.name}</p>
                                    <p class="text-xs text-slate-500">Page ${link.pageNum}</p>
                                    ${fetchedDoc?.status === 'success' ? `<p class="text-xs text-green-600">${fetchedDoc.charCount?.toLocaleString() || 0} chars extracted${fetchedDoc.format === 'docx' ? ' (Word doc)' : ''}</p>` : ''}
                                    ${fetchedDoc?.status === 'error' ? `<p class="text-xs text-red-600">${fetchedDoc.error}</p>` : ''}
                                    ${fetchedDoc?.status === 'cors_blocked' ? `<p class="text-xs text-orange-600">üîí ${fetchedDoc.error}</p>` : ''}
                                    ${fetchedDoc?.status === 'unsupported' ? `<p class="text-xs text-amber-600">${fetchedDoc.error}</p>` : ''}
                                </div>
                                <div class="flex flex-col gap-1 flex-shrink-0">
                                    ${(fetchedDoc?.status === 'unsupported' && fetchedDoc?.format === 'doc') || fetchedDoc?.status === 'cors_blocked' ? `
                                        <button onclick="openExternalDocViewer('${link.url}', '${link.name.replace(/'/g, "\\'")}'); event.stopPropagation();" class="px-2 py-1 ${fetchedDoc?.status === 'cors_blocked' ? 'bg-orange-100 text-orange-700 hover:bg-orange-200' : 'bg-amber-100 text-amber-700 hover:bg-amber-200'} rounded text-xs font-medium transition-colors flex items-center gap-1" title="View in app using Google Docs">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                            </svg>
                                            View
                                        </button>
                                    ` : ''}
                                    <a href="${link.url}" target="_blank" class="text-[#036CB6] hover:text-[#02538C] p-1" title="Open in new tab">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Update fetch button
        if (fetchBtn) {
            const fetchable = links.filter(l => l.fetchable).length;
            const alreadyFetched = Object.values(fetched).filter(f => f.status === 'success').length;
            fetchBtn.disabled = fetchable === 0 || state.linkedDocuments.isFetching;
            fetchBtn.textContent = state.linkedDocuments.isFetching
                ? `Fetching... ${state.linkedDocuments.fetchProgress}%`
                : `Auto-Fetch Documents (${fetchable})`;
        }

        // Update status
        if (fetchStatus) {
            const successCount = Object.values(fetched).filter(f => f.status === 'success').length;
            if (successCount > 0) {
                fetchStatus.textContent = `${successCount} document${successCount !== 1 ? 's' : ''} loaded for AI analysis`;
                fetchStatus.className = 'text-xs text-green-600 mt-2';
            } else {
                fetchStatus.textContent = '';
            }
        }
    }

    // Toggle linked documents panel visibility
    function toggleLinkedDocsPanel() {
        const modal = document.getElementById('linkedDocsModal');
        if (modal) {
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                updateLinkedDocsUI();
            }
        }
    }

    // Toggle PDF viewer linked documents panel (v7.17)
    function togglePdfLinkedDocsPanel() {
        const content = document.getElementById('pdfLinkedDocsContent');
        const chevron = document.getElementById('pdfLinkedDocsChevron');
        if (content && chevron) {
            content.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }
    }

    // Open external document viewer for legacy formats (v7.19)
    function openExternalDocViewer(url, name) {
        const modal = document.getElementById('externalDocViewerModal');
        const frame = document.getElementById('externalDocFrame');
        const title = document.getElementById('externalDocTitle');
        const subtitle = document.getElementById('externalDocSubtitle');
        const downloadBtn = document.getElementById('externalDocDownloadBtn');
        const loading = document.getElementById('externalDocLoading');

        if (!modal || !frame) return;

        // Set document info
        if (title) title.textContent = name || 'Document Viewer';
        if (subtitle) {
            const ext = url.split('.').pop().toLowerCase();
            subtitle.textContent = ext === 'doc'
                ? 'Legacy .doc format - viewing via Google Docs'
                : `Viewing ${ext.toUpperCase()} file via Google Docs`;
        }
        if (downloadBtn) downloadBtn.href = url;

        // Show loading state
        if (loading) loading.classList.remove('hidden');

        // Use Google Docs Viewer to display the document
        // Format: https://docs.google.com/gview?url=ENCODED_URL&embedded=true
        const encodedUrl = encodeURIComponent(url);
        const viewerUrl = `https://docs.google.com/gview?url=${encodedUrl}&embedded=true`;

        frame.src = viewerUrl;

        // Show modal
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    // Handle iframe load completion
    function onExternalDocFrameLoad() {
        const loading = document.getElementById('externalDocLoading');
        if (loading) {
            // Small delay to ensure content is rendered
            setTimeout(() => {
                loading.classList.add('hidden');
            }, 500);
        }
    }

    // Close external document viewer
    function closeExternalDocViewer() {
        const modal = document.getElementById('externalDocViewerModal');
        const frame = document.getElementById('externalDocFrame');
        const loading = document.getElementById('externalDocLoading');

        if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }
        if (frame) {
            frame.src = 'about:blank'; // Clear iframe
        }
        if (loading) {
            loading.classList.remove('hidden'); // Reset loading for next use
        }
    }

    // Update PDF viewer linked documents panel (v7.17)
    function updatePdfLinkedDocsPanel() {
        const panel = document.getElementById('pdfLinkedDocsPanel');
        const count = document.getElementById('pdfLinkedDocsCount');
        const list = document.getElementById('pdfLinkedDocsList');

        if (!panel) return;

        const links = state.linkedDocuments.links;
        const fetched = state.linkedDocuments.fetched;

        // Show/hide panel based on whether links exist
        if (links.length === 0) {
            panel.classList.add('hidden');
            return;
        }

        panel.classList.remove('hidden');

        // Update count badge
        if (count) {
            count.textContent = links.length;
        }

        // Render list of linked documents
        if (list) {
            // Group links by type for better organization
            const linksByType = {};
            links.forEach(link => {
                if (!linksByType[link.type]) {
                    linksByType[link.type] = [];
                }
                linksByType[link.type].push(link);
            });

            // Sort types by importance
            const typeOrder = ['audit', 'budget', 'board', 'nonprofit-status', 'exhibit', 'org-chart', 'governance', 'compliance', 'mission', 'other'];
            const sortedTypes = Object.keys(linksByType).sort((a, b) => {
                return (typeOrder.indexOf(a) === -1 ? 999 : typeOrder.indexOf(a)) -
                       (typeOrder.indexOf(b) === -1 ? 999 : typeOrder.indexOf(b));
            });

            let html = '';
            sortedTypes.forEach(type => {
                const typeLinks = linksByType[type];
                html += `<div class="mb-2">
                    <div class="text-xs font-semibold text-slate-600 mb-1">${getLinkTypeLabel(type)} (${typeLinks.length})</div>`;

                typeLinks.forEach(link => {
                    const fetchedDoc = fetched[link.url];
                    let statusBadge = '';
                    let bgClass = 'bg-white hover:bg-slate-50';

                    if (fetchedDoc) {
                        if (fetchedDoc.status === 'success') {
                            statusBadge = '<span class="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded">‚úì Analyzed</span>';
                            // Add AI classification badge if document was classified by AI (v7.18)
                            if (fetchedDoc.aiClassified) {
                                statusBadge += ' <span class="text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded">ü§ñ AI Classified</span>';
                            }
                            bgClass = 'bg-green-50 hover:bg-green-100';
                        } else if (fetchedDoc.status === 'error') {
                            statusBadge = '<span class="text-xs bg-red-100 text-red-700 px-1.5 py-0.5 rounded">‚ö† Fetch failed</span>';
                            bgClass = 'bg-red-50 hover:bg-red-100';
                        } else if (fetchedDoc.status === 'cors_blocked') {
                            statusBadge = '<span class="text-xs bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded">üîí CORS blocked</span>';
                            bgClass = 'bg-orange-50 hover:bg-orange-100';
                        } else if (fetchedDoc.status === 'unsupported') {
                            statusBadge = `<span class="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">‚ö† ${fetchedDoc.format === 'doc' ? 'Legacy .doc' : 'Unsupported'}</span>`;
                            bgClass = 'bg-amber-50 hover:bg-amber-100';
                        }
                    } else if (link.fetchable) {
                        statusBadge = '<span class="text-xs bg-[#E3EDF5] text-[#036CB6] px-1.5 py-0.5 rounded">Can fetch</span>';
                    }

                    // Check if this needs the View button (legacy doc or CORS blocked)
                    const needsViewButton = (fetchedDoc?.status === 'unsupported' && fetchedDoc?.format === 'doc') ||
                                           fetchedDoc?.status === 'cors_blocked';

                    html += `
                        <div class="flex items-center justify-between p-2 ${bgClass} border border-slate-200 rounded mb-1 transition-colors group">
                            <div class="flex-1 min-w-0 mr-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-medium text-slate-700 truncate" title="${link.name}">${link.name}</span>
                                    ${statusBadge}
                                </div>
                                <span class="text-xs text-slate-500">Page ${link.pageNum}</span>
                            </div>
                            <div class="flex items-center gap-1 flex-shrink-0">
                                ${needsViewButton ? `
                                    <button onclick="openExternalDocViewer('${link.url}', '${link.name.replace(/'/g, "\\'")}'); event.stopPropagation();"
                                            class="px-2 py-1 ${fetchedDoc?.status === 'cors_blocked' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-amber-500 hover:bg-amber-600'} text-white rounded text-xs font-medium transition-colors flex items-center gap-1"
                                            title="View in app using Google Docs">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                        </svg>
                                        View
                                    </button>
                                ` : ''}
                                <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="text-[#38939B] hover:text-[#036CB6] p-1" title="Open in new tab">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            });

            // Add auto-fetch button if there are fetchable links
            const fetchableCount = links.filter(l => l.fetchable && !fetched[l.url]).length;
            const fetchedCount = Object.values(fetched).filter(f => f.status === 'success').length;

            if (fetchableCount > 0 || fetchedCount > 0) {
                html += `<div class="mt-3 pt-3 border-t border-slate-200">`;
                if (fetchedCount > 0) {
                    html += `<p class="text-xs text-green-600 mb-2">‚úì ${fetchedCount} document${fetchedCount !== 1 ? 's' : ''} analyzed - content included in AI evaluation</p>`;
                }
                if (fetchableCount > 0) {
                    html += `<button onclick="autoFetchLinkedDocuments(); updatePdfLinkedDocsPanel();"
                                class="w-full px-3 py-2 bg-[#38939B] text-white text-sm font-medium rounded-lg hover:bg-[#2a7078] transition-colors flex items-center justify-center gap-2"
                                ${state.linkedDocuments.isFetching ? 'disabled' : ''}>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        ${state.linkedDocuments.isFetching ? 'Fetching...' : `Auto-Fetch ${fetchableCount} PDF${fetchableCount !== 1 ? 's' : ''} for AI Analysis`}
                    </button>`;
                }
                html += `</div>`;
            }

            list.innerHTML = html;
        }
    }

    // Update linked documents status preview in settings
    function updateLinkedDocsStatusPreview() {
        const preview = document.getElementById('linkedDocsStatusPreview');
        const countBadge = document.getElementById('linkedDocsCount');
        if (!preview) return;

        const links = state.linkedDocuments.links;
        const fetchedCount = Object.values(state.linkedDocuments.fetched).filter(f => f.status === 'success').length;

        if (links.length === 0) {
            preview.innerHTML = '<span class="text-slate-500">Upload an application PDF to detect linked documents</span>';
            if (countBadge) countBadge.classList.add('hidden');
        } else {
            const fetchable = links.filter(l => l.fetchable).length;
            let status = `<span class="text-purple-600">üìé ${links.length} links found</span>`;
            if (fetchedCount > 0) {
                status += ` ‚Ä¢ <span class="text-green-600">‚úì ${fetchedCount} fetched for AI</span>`;
            } else if (fetchable > 0) {
                status += ` ‚Ä¢ <span class="text-amber-600">${fetchable} can be auto-fetched</span>`;
            }
            preview.innerHTML = status;

            if (countBadge) {
                countBadge.textContent = links.length;
                countBadge.classList.remove('hidden');
            }
        }
    }

    // Update reference documents UI
    function updateReferenceDocsUI() {
        // Funding Priorities
        const fp = state.referenceDocuments.fundingPriorities;
        const fpStatus = document.getElementById('fundingPrioritiesStatus');
        const fpInfo = document.getElementById('fundingPrioritiesInfo');
        const fpName = document.getElementById('fundingPrioritiesName');
        const fpDetails = document.getElementById('fundingPrioritiesDetails');

        if (fp) {
            fpStatus.textContent = '‚úì Loaded';
            fpStatus.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-700';
            fpInfo.classList.remove('hidden');
            fpName.textContent = fp.name;
            fpDetails.textContent = `${fp.pageCount} pages ‚Ä¢ ${fp.charCount.toLocaleString()} chars${fp.truncated ? ' (truncated)' : ''} ‚Ä¢ Uploaded ${new Date(fp.uploadedAt).toLocaleDateString()}`;
        } else {
            fpStatus.textContent = 'Not loaded';
            fpStatus.className = 'text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600';
            fpInfo.classList.add('hidden');
        }

        // Guidelines
        const gl = state.referenceDocuments.guidelines;
        const glStatus = document.getElementById('guidelinesStatus');
        const glInfo = document.getElementById('guidelinesInfo');
        const glName = document.getElementById('guidelinesName');
        const glDetails = document.getElementById('guidelinesDetails');

        if (gl) {
            glStatus.textContent = '‚úì Loaded';
            glStatus.className = 'text-xs px-2 py-1 rounded-full bg-green-100 text-green-700';
            glInfo.classList.remove('hidden');
            glName.textContent = gl.name;
            glDetails.textContent = `${gl.pageCount} pages ‚Ä¢ ${gl.charCount.toLocaleString()} chars${gl.truncated ? ' (truncated)' : ''} ‚Ä¢ Uploaded ${new Date(gl.uploadedAt).toLocaleDateString()}`;
        } else {
            glStatus.textContent = 'Not loaded';
            glStatus.className = 'text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600';
            glInfo.classList.add('hidden');
        }
    }

    // Update the preview in settings modal
    function updateRefDocsPreview() {
        const preview = document.getElementById('refDocsStatusPreview');
        if (!preview) return;

        const fp = state.referenceDocuments.fundingPriorities;
        const gl = state.referenceDocuments.guidelines;

        let html = '';
        if (fp) {
            html += `<div class="flex items-center gap-2 text-green-700"><span>‚úì</span><span>Funding Priorities: ${fp.name}</span></div>`;
        } else {
            html += `<div class="flex items-center gap-2 text-slate-400"><span>‚óã</span><span>Funding Priorities: Not uploaded</span></div>`;
        }
        if (gl) {
            html += `<div class="flex items-center gap-2 text-green-700"><span>‚úì</span><span>Guidelines: ${gl.name}</span></div>`;
        } else {
            html += `<div class="flex items-center gap-2 text-slate-400"><span>‚óã</span><span>Guidelines: Not uploaded</span></div>`;
        }

        preview.innerHTML = html;
    }

    // Build reference context for AI prompts
    function buildReferenceContext() {
        let context = '';

        const fp = state.referenceDocuments.fundingPriorities;
        if (fp && fp.text) {
            context += `\n\n=== COUNTY FUNDING PRIORITIES ===\nThe following are the official funding priorities from "${fp.name}":\n${fp.text}\n=== END FUNDING PRIORITIES ===`;
        }

        const gl = state.referenceDocuments.guidelines;
        if (gl && gl.text) {
            context += `\n\n=== NOFA GUIDELINES ===\nThe following are the official NOFA guidelines from "${gl.name}":\n${gl.text}\n=== END GUIDELINES ===`;
        }

        return context;
    }

    // ============================================================
    // CONSISTENCY & CACHING UTILITIES
    // ============================================================

    // In-memory cache for faster lookups (avoids repeated JSON parsing)
    let responseCacheMap = null;
    let cacheDirty = false;

    // Initialize in-memory cache from localStorage
    function initResponseCache() {
        if (responseCacheMap === null) {
            try {
                const stored = localStorage.getItem(CONFIG.RESPONSE_CACHE_KEY);
                responseCacheMap = stored ? new Map(Object.entries(JSON.parse(stored))) : new Map();
            } catch (e) {
                console.warn('Cache init error:', e);
                responseCacheMap = new Map();
            }
        }
        return responseCacheMap;
    }

    // Persist cache to localStorage (debounced to avoid frequent writes)
    let cacheWriteTimeout = null;
    function persistCache() {
        if (!cacheDirty || !responseCacheMap) return;
        if (cacheWriteTimeout) clearTimeout(cacheWriteTimeout);
        cacheWriteTimeout = setTimeout(() => {
            try {
                // Convert Map to object and filter old entries
                const now = Date.now();
                const expiry = 24 * 60 * 60 * 1000;
                const obj = {};
                responseCacheMap.forEach((value, key) => {
                    if (value.timestamp > now - expiry) {
                        obj[key] = value;
                    }
                });
                localStorage.setItem(CONFIG.RESPONSE_CACHE_KEY, JSON.stringify(obj));
                cacheDirty = false;
            } catch (e) {
                console.warn('Cache persist error:', e);
            }
        }, 500);
    }

    // Generate a deterministic hash from text (for caching AI responses)
    async function hashText(text) {
        const encoder = new TextEncoder();
        const data = encoder.encode(text);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Normalize text for consistent processing (removes variations that don't affect meaning)
    function normalizeText(text) {
        return text
            .replace(/\r\n/g, '\n')           // Normalize line endings
            .replace(/\r/g, '\n')              // Handle old Mac line endings
            .replace(/[ \t]+/g, ' ')           // Collapse multiple spaces/tabs to single space
            .replace(/\n{3,}/g, '\n\n')        // Collapse multiple newlines to max 2
            .replace(/^\s+|\s+$/gm, '')        // Trim each line
            .trim();                           // Trim overall
    }

    // Get cached AI response by hash, or return null if not cached
    function getCachedResponse(hash, criterionId) {
        const cache = initResponseCache();
        const key = `${hash}_${criterionId}`;
        const entry = cache.get(key);
        if (entry && entry.timestamp > Date.now() - 24 * 60 * 60 * 1000) {
            console.log(`[Cache HIT] Using cached response for ${criterionId}`);
            return entry.response;
        }
        return null;
    }

    // Store AI response in cache with hash key
    function setCachedResponse(hash, criterionId, response) {
        const cache = initResponseCache();
        const key = `${hash}_${criterionId}`;
        cache.set(key, {
            response: response,
            timestamp: Date.now()
        });
        cacheDirty = true;
        persistCache();
        console.log(`[Cache SET] Stored response for ${criterionId}`);
    }

    // Clear the response cache (for debugging or when user wants fresh analysis)
    function clearResponseCache() {
        localStorage.removeItem(CONFIG.RESPONSE_CACHE_KEY);
        responseCacheMap = new Map();  // Clear in-memory cache too
        cacheDirty = false;
        console.log('[Cache CLEARED]');
        showToast('info', 'Cache Cleared', 'AI responses will be regenerated on next analysis.');
    }

    // Clear cache entries for a specific criterion (v7.21)
    function clearCacheForCriterion(criterionId) {
        const cache = initResponseCache();
        const keysToDelete = [];
        cache.forEach((value, key) => {
            if (key.endsWith(`_${criterionId}`)) {
                keysToDelete.push(key);
            }
        });
        keysToDelete.forEach(key => cache.delete(key));
        if (keysToDelete.length > 0) {
            cacheDirty = true;
            persistCache();
            console.log(`[Cache] Cleared ${keysToDelete.length} entries for criterion ${criterionId}`);
        }
    }

    // Full reset: clear cache AND in-memory AI suggestions for complete fresh start
    function clearAllAndReset() {
        // Clear localStorage cache
        localStorage.removeItem(CONFIG.RESPONSE_CACHE_KEY);

        // Clear in-memory AI suggestions
        state.aiSuggestions = {};

        // Reset diagnostics counters
        state.diagnostics.mainContentChars = 0;
        state.diagnostics.attachmentChars = 0;
        state.diagnostics.criteriaAnalyzed = 0;
        state.diagnostics.lastAnalysisTimestamp = null;
        state.cachedCriteriaCount = 0;

        console.log('[FULL RESET] Cache and AI suggestions cleared');
        hideSettings();
        showToast('warning', 'Full Reset Complete', 'All AI suggestions cleared. Run Auto-Analyze to generate fresh analysis.');
        render();
    }

    // Get deterministic text chunk for AI analysis
    function getConsistentTextChunk(text, maxLength = CONFIG.TEXT_CHUNK_SIZE) {
        const normalized = normalizeText(text);
        // Always take from the beginning for consistency
        return normalized.substring(0, maxLength);
    }

    // Extract attachment/exhibit sections from document for comprehensive AI analysis
    function extractAttachmentContent(text) {
        const normalized = normalizeText(text);
        const attachmentContent = [];

        // Patterns to find attachment/exhibit sections
        const attachmentPatterns = [
            /attachment\s*\d+[:\s]*[^\n]{0,100}/gi,
            /exhibit\s*[a-z0-9]+[:\s]*[^\n]{0,100}/gi,
            /appendix\s*[a-z0-9]+[:\s]*[^\n]{0,100}/gi,
            /--- page \d+ ---[\s\S]{0,5000}(?=--- page|$)/gi  // Capture page blocks
        ];

        // Find where attachments section starts (usually has "Attachments" or "Attachment 1")
        const attachmentStartPatterns = [
            /attachment\s*1\s*:/i,
            /attachments?\s*index/i,
            /section\s*\d+\s*:\s*attachments/i,
            /exhibit\s*a\s*:/i
        ];

        let attachmentStartIndex = -1;
        for (const pattern of attachmentStartPatterns) {
            const match = normalized.search(pattern);
            if (match !== -1 && (attachmentStartIndex === -1 || match < attachmentStartIndex)) {
                attachmentStartIndex = match;
            }
        }

        // If we found an attachments section, extract it
        if (attachmentStartIndex !== -1) {
            const attachmentSection = normalized.substring(attachmentStartIndex, attachmentStartIndex + CONFIG.ATTACHMENT_CHUNK_SIZE);
            return attachmentSection;
        }

        return '';
    }

    // Get comprehensive text for AI including main content, attachments, and supplemental docs
    function getComprehensiveTextForAI(text, mainChunkSize = CONFIG.TEXT_CHUNK_SIZE) {
        const mainContent = getConsistentTextChunk(text, mainChunkSize);
        const attachmentContent = extractAttachmentContent(text);

        // Update diagnostics
        state.diagnostics.mainContentChars = mainContent.length;
        state.diagnostics.attachmentChars = attachmentContent.length;
        state.diagnostics.lastAnalysisTimestamp = new Date().toISOString();

        let combined = mainContent;

        // If we have attachment content that's not already in main content, append it
        if (attachmentContent && !mainContent.includes(attachmentContent.substring(0, 200))) {
            combined += '\n\n=== ATTACHMENTS & EXHIBITS ===\n' + attachmentContent;
        }

        // Include supplemental documents marked for AI analysis (v7.20)
        const supplementalText = getSupplementalTextForAI();
        if (supplementalText) {
            combined += '\n\n=== SUPPLEMENTAL DOCUMENTS (Applicant Updates) ===\n' + supplementalText;
            console.log(`[AI Text] Including ${supplementalText.length} chars from supplemental documents`);
        }

        console.log(`[AI Text] Main: ${mainContent.length}, Attachments: ${attachmentContent.length}, Supplements: ${supplementalText.length}, Total: ${combined.length} chars`);
        return combined;
    }

    // ============================================================
    // TEMPLATE PROFILE SYSTEM
    // ============================================================
    // Template profiles allow the app to work with different scoring templates
    // Each profile defines: reviewer sheets configuration + scoring criteria

    // Default profile for San Mateo County NOFA FY26-27
    const DEFAULT_TEMPLATE_PROFILE = {
        id: 'san-mateo-nofa-fy26-27',
        name: 'San Mateo County NOFA FY26-27',
        description: 'Winter FY26-27 Community Development Public Services',
        version: '1.0',
        isDefault: true,

        // Detection patterns for auto-matching templates
        detectionPatterns: {
            sheetNames: ['Threshold+Scoring - Reviewer 1', 'Scoring Sheet - Reviewer 2'],
            cellSignatures: {
                'E8': 'applicant',  // Cell E8 contains applicant name
                'H8': 'reviewer'    // Cell H8 contains reviewer name
            }
        },

        // Reviewer sheet configurations
        reviewerSheets: {
            'Threshold+Scoring - Reviewer 1': {
                name: 'Reviewer 1',
                description: 'Threshold + Scoring',
                hasThreshold: true,
                scores: {
                    '1a': 'H64', '1b': 'H65',
                    '2a': 'H68', '2b': 'H69', '2c': 'H70', '2d': 'H71',
                    '3a': 'H74', '3b': 'H75', '3c': 'H76', '3d': 'H77', '3e': 'H78',
                    '4a': 'H80',
                    '5b': 'H85', '5c': 'H86', '5d': 'H87'
                },
                comments: {
                    '1a': 'G64', '1b': 'G65',
                    '2a': 'G68', '2b': 'G69', '2c': 'G70', '2d': 'G71',
                    '3a': 'G74', '3b': 'G75', '3c': 'G76', '3d': 'G77', '3e': 'G78',
                    '4a': 'G80',
                    '5b': 'G85', '5c': 'G86', '5d': 'G87'
                },
                projectInfo: {
                    applicant: 'E8',
                    reviewedBy: 'H8',
                    project: 'E9',
                    reviewDate: 'H9',
                    amountRequested: 'E10',
                    totalCost: 'E11',
                    clientsServed: 'E12',
                    projectDescription: 'E14'
                },
                recommendation: {
                    yesNo: 'F19',
                    fundingSource: 'F20',
                    briefSummary: 'F21',
                    summaryComments: 'B100',
                    questionCells: ['D90', 'D91', 'D92', 'D93', 'D94']
                }
            },
            'Scoring Sheet - Reviewer 2': {
                name: 'Reviewer 2',
                description: 'Scoring Only',
                hasThreshold: false,
                scores: {
                    '1a': 'H36', '1b': 'H37',
                    '2a': 'H40', '2b': 'H41', '2c': 'H42', '2d': 'H43',
                    '3a': 'H46', '3b': 'H47', '3c': 'H48', '3d': 'H49', '3e': 'H50',
                    '4a': 'H52',
                    '5b': 'H57', '5c': 'H58', '5d': 'H59'
                },
                comments: {
                    '1a': 'G36', '1b': 'G37',
                    '2a': 'G40', '2b': 'G41', '2c': 'G42', '2d': 'G43',
                    '3a': 'G46', '3b': 'G47', '3c': 'G48', '3d': 'G49', '3e': 'G50',
                    '4a': 'G52',
                    '5b': 'G57', '5c': 'G58', '5d': 'G59'
                },
                projectInfo: {
                    applicant: 'E8',
                    reviewedBy: 'H8',
                    project: 'E9',
                    reviewDate: 'H9',
                    amountRequested: 'E10',
                    totalCost: 'E11',
                    clientsServed: 'E12',
                    projectDescription: 'E14'
                },
                recommendation: {
                    yesNo: 'F19',
                    fundingSource: 'F20',
                    briefSummary: 'F21',
                    summaryComments: 'B72',
                    questionCells: ['D62', 'D63', 'D64', 'D65', 'D66']
                }
            }
        },

        // Scoring criteria definitions
        criteria: [] // Will be populated below
    };

    // Template profiles storage (includes default + user-created profiles)
    let TEMPLATE_PROFILES = {
        'san-mateo-nofa-fy26-27': DEFAULT_TEMPLATE_PROFILE
    };

    // Active profile reference (defaults to San Mateo)
    let activeProfileId = 'san-mateo-nofa-fy26-27';

    // Helper functions for template profile system
    function getActiveProfile() {
        return TEMPLATE_PROFILES[activeProfileId] || DEFAULT_TEMPLATE_PROFILE;
    }

    function getReviewerSheets() {
        return getActiveProfile().reviewerSheets;
    }

    function getCriteria() {
        return getActiveProfile().criteria;
    }

    function setActiveProfile(profileId) {
        if (TEMPLATE_PROFILES[profileId]) {
            activeProfileId = profileId;
            localStorage.setItem('nofa_active_profile', profileId);
            return true;
        }
        return false;
    }

    // Load saved template profiles from localStorage
    function loadTemplateProfiles() {
        try {
            const saved = localStorage.getItem(CONFIG.TEMPLATE_PROFILES_KEY);
            if (saved) {
                const customProfiles = JSON.parse(saved);
                // Merge with default (default always takes precedence for its ID)
                TEMPLATE_PROFILES = { ...customProfiles, 'san-mateo-nofa-fy26-27': DEFAULT_TEMPLATE_PROFILE };
            }
            // Load active profile preference
            const savedActive = localStorage.getItem('nofa_active_profile');
            if (savedActive && TEMPLATE_PROFILES[savedActive]) {
                activeProfileId = savedActive;
            }
        } catch (e) {
            console.warn('Failed to load template profiles:', e);
        }
    }

    // Save custom template profiles to localStorage
    function saveTemplateProfiles() {
        try {
            // Only save non-default profiles
            const customProfiles = {};
            for (const [id, profile] of Object.entries(TEMPLATE_PROFILES)) {
                if (!profile.isDefault) {
                    customProfiles[id] = profile;
                }
            }
            localStorage.setItem(CONFIG.TEMPLATE_PROFILES_KEY, JSON.stringify(customProfiles));
        } catch (e) {
            console.warn('Failed to save template profiles:', e);
        }
    }

    // Detect which template profile matches a given workbook
    function detectTemplateProfile(workbook) {
        for (const [id, profile] of Object.entries(TEMPLATE_PROFILES)) {
            const patterns = profile.detectionPatterns;
            if (!patterns) continue;

            // Check if sheet names match
            if (patterns.sheetNames) {
                const workbookSheets = workbook.SheetNames || [];
                const matchCount = patterns.sheetNames.filter(name => workbookSheets.includes(name)).length;
                if (matchCount >= patterns.sheetNames.length * 0.5) {
                    return id;
                }
            }
        }
        return null; // No matching profile found
    }

    // Backwards compatibility: REVIEWER_SHEETS and CRITERIA as getters
    // This ensures existing code continues to work without modification
    const REVIEWER_SHEETS = new Proxy({}, {
        get: (target, prop) => getReviewerSheets()[prop],
        ownKeys: () => Object.keys(getReviewerSheets()),
        getOwnPropertyDescriptor: (target, prop) => {
            const sheets = getReviewerSheets();
            if (prop in sheets) {
                return { enumerable: true, configurable: true, value: sheets[prop] };
            }
        },
        has: (target, prop) => prop in getReviewerSheets()
    });

    // Default scoring criteria for San Mateo NOFA FY26-27
    // This populates the DEFAULT_TEMPLATE_PROFILE.criteria array
    DEFAULT_TEMPLATE_PROFILE.criteria = [
        {
            id: '1a', section: 1, sectionTitle: 'Funding Priority',
            question: 'Which County priority does project meet or need?',
            validScores: [0, 3],
            scoringRule: '0 - The project does not meet a County priority.\n3 - The project does meet a County priority.',
            aiPrompt: 'Does this project address a priority from the San Mateo County Consolidated Plan? Look for mentions of: homelessness prevention, fair housing, public services for low-income residents, housing rehabilitation, or economic development.',
            reasoningStarters: [
                'The project addresses the County priority of...',
                'Based on the Consolidated Plan, this project aligns with...',
                'The application does not clearly demonstrate connection to County priorities because...',
                'While the project has merit, the stated priority of... is not directly aligned with...'
            ]
        },
        {
            id: '1b', section: 1, sectionTitle: 'Funding Priority',
            question: 'What population is the program targeting?',
            validScores: [0, 1, 2, 3],
            scoringRule: '3 for ELI (0-30% AMI)\n2 for ELI to VLI (0-50% AMI)\n1 for VLI to Moderate (30-80% AMI)\n0 for moderate income only',
            aiPrompt: 'What income level population does this project serve? Look for: ELI (Extremely Low Income, 0-30% AMI), VLI (Very Low Income, 30-50% AMI), LI (Low Income, 50-80% AMI), or Moderate Income.',
            reasoningStarters: [
                'The application indicates they serve primarily... income households',
                'Based on the demographic data provided, the target population is...',
                'The income eligibility requirements specify...',
                'Historical client data shows the majority served are at... AMI level'
            ]
        },
        {
            id: '2a', section: 2, sectionTitle: 'Applicant Capacity',
            question: 'What is experience/capacity of applicant in performing proposed services?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if no demonstrated positive outcomes or missed targets by >50%\n1-2 if demonstrated outcomes with related work or met 50-75% targets\n3 if demonstrated outcomes with exact project type and 75%+ targets',
            aiPrompt: 'Does the applicant have experience with this exact type of program? What outcomes have they achieved? Have they met their targets in the past?',
            reasoningStarters: [
                'The applicant has... years of experience operating similar programs',
                'Past performance reports indicate they achieved...% of their targets',
                'While experienced in related services, this specific program type is new for them',
                'The organization lacks documented outcomes for this type of service'
            ]
        },
        {
            id: '2b', section: 2, sectionTitle: 'Applicant Capacity',
            question: "What is applicant's ability to measure the need/impact of services?",
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if they have no process/ability\n1-2 if they have some process\n3 if they have a very well defined process/ability',
            aiPrompt: 'Does the applicant describe how they will track outcomes and measure impact? Do they have data collection systems, reporting processes, or evaluation methods?',
            reasoningStarters: [
                'The application describes a comprehensive data collection system including...',
                'Their outcome measurement process includes...',
                'The evaluation methodology is limited to...',
                'No clear process for measuring impact was described in the application'
            ]
        },
        {
            id: '2c', section: 2, sectionTitle: 'Applicant Capacity',
            question: "What is the applicant's ability to complete administrative requirements (QPRs, HMIS)?",
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if no direct or related experience\n1 if direct experience that is not good or only related experience\n2 if direct experience that is OK\n3 if direct and positive experience',
            aiPrompt: 'Has the applicant managed federal or county grants before? Do they have experience with Quarterly Performance Reports (QPRs) or HMIS?',
            reasoningStarters: [
                'The applicant has successfully managed... grants with timely reporting',
                'Past QPR submissions have been...',
                'HMIS experience is evidenced by...',
                'The organization is new to federal grant reporting requirements'
            ]
        },
        {
            id: '2d', section: 2, sectionTitle: 'Applicant Capacity',
            question: 'Is organization fiscally and programmatically stable?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if audit has material findings or going concern issues\n1 if audit has minor findings or limited funding diversity\n2 if clean audit with adequate reserves OR diverse funding sources\n3 if clean audit, healthy reserves (3+ months), AND diverse funding portfolio',
            aiPrompt: 'NONPROFIT FINANCIAL EVALUATION: Review the audit (Exhibit 7) and budget information. For nonprofits, evaluate: (1) Audit status - any findings, material weaknesses, or going concern issues? (2) Funding diversity - do they have multiple grant sources, contracts, and/or donations rather than relying on a single funder? (3) Operating reserves - do they mention reserves or fund balance that provides organizational stability? (4) Grant management track record - have they successfully managed similar grants? Note: Nonprofits do not generate "income" like businesses - they secure grants and contracts, then spend those funds on programs. A budget showing expenses equal to revenue is NORMAL and HEALTHY for nonprofits (spending grants as intended). Do NOT penalize organizations for seeking grant funding to cover program costs.',
            reasoningStarters: [
                'The audit shows no material findings and the organization demonstrates...',
                'The nonprofit has diverse funding sources including... which indicates financial stability',
                'The organization maintains healthy operating reserves of... months',
                'As a 501(c)(3), they have successfully managed grants from... demonstrating fiscal capacity',
                'The audit reveals [findings/concerns] that may affect program delivery...'
            ]
        },
        {
            id: '3a', section: 3, sectionTitle: 'Project Feasibility',
            question: 'Is this an on-going program already in existence or a new program?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if not yet launched\n1 if launched within past 3 months\n2 if launched within past 6 months\n3 if launched 7+ months ago',
            aiPrompt: 'Is this an existing/continuing program or completely new? When did it start or when will it start?',
            reasoningStarters: [
                'This is a continuing program that has been operating since...',
                'The program launched... months ago and has served... clients',
                'This is a new program scheduled to begin...',
                'The program is in planning stages with implementation expected...'
            ]
        },
        {
            id: '3b', section: 3, sectionTitle: 'Project Feasibility',
            question: 'If new, when will program operations begin?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if it will start after Oct 1, 2026\n1 if by Sep 1, 2026\n2 if by Aug 15, 2026\n3 if by July 2026 or ongoing project',
            aiPrompt: 'When will the program begin operations? The fiscal year starts July 1, 2026. If ongoing, score as 3.',
            reasoningStarters: [
                'As an ongoing program, services will continue seamlessly into the new fiscal year',
                'The program is prepared to launch by... 2026',
                'Staff hiring and setup indicate a start date of...',
                'Implementation timeline shows operations beginning after October 2026'
            ]
        },
        {
            id: '3c', section: 3, sectionTitle: 'Project Feasibility',
            question: 'Have they received CDBG/County funding for this program before?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if never received County support\n1 if received local city support\n2 if received federal support from another city/county\n3 if received San Mateo County support',
            aiPrompt: 'Has this organization received San Mateo County CDBG or other County funding before? Or funding from other jurisdictions?',
            reasoningStarters: [
                'The applicant has received San Mateo County CDBG funding for... years',
                'Previous County support includes... totaling...',
                'The organization has managed CDBG funds from... (other jurisdiction)',
                'This would be the applicant\'s first County or federal grant'
            ]
        },
        {
            id: '3d', section: 3, sectionTitle: 'Project Feasibility',
            question: 'How will program be administered? Any partnerships/collaborations?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if done alone\n1-2 if done in partnership with 1-2 entities\n3 if done with an ecosystem of partners',
            aiPrompt: 'Does the applicant work with partners or collaborators? How many partner organizations are involved?',
            reasoningStarters: [
                'The applicant has established partnerships with... organizations including...',
                'Collaboration includes referral agreements with...',
                'The program operates with limited partnerships, primarily...',
                'No formal partnerships or collaborations were identified'
            ]
        },
        {
            id: '3e', section: 3, sectionTitle: 'Project Feasibility',
            question: 'Are there any unique features that may impede (0-1) or contribute (2-3) to success?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0-1 if concerns may impede success\n2-3 if unique features contribute to success',
            aiPrompt: 'Are there any innovative approaches, special partnerships, or unique features? Any red flags or concerns that could impede success?',
            reasoningStarters: [
                'Unique strengths include... which should enhance program success',
                'The innovative approach of... differentiates this program',
                'Potential concerns include... which may require monitoring',
                'Risk factors such as... could impede successful delivery'
            ]
        },
        {
            id: '4a', section: 4, sectionTitle: 'Cost Effectiveness',
            question: 'Is total unit cost of service (cost per household served) reasonable?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if it does not seem reasonable\n3 if it seems very reasonable\n*Intermediate scores allowed. Explain in comments.',
            aiPrompt: 'Calculate cost per client (Total Cost / Clients Served). Is this reasonable for the type of service?',
            requiresComment: true,
            reasoningStarters: [
                'At $... per client, the cost is reasonable given the intensity of services',
                'The cost per household of $... is competitive compared to similar programs',
                'While the unit cost of $... appears high, the comprehensive services justify...',
                'The cost of $... per client raises concerns because...'
            ]
        },
        {
            id: '5b', section: 5, sectionTitle: 'Leveraging',
            question: 'What is the timeframe for securing other funds?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if unclear\n1-2 if within 6 months\n3 if evidence of receipt within 6 months or already committed',
            aiPrompt: 'NONPROFIT CONTEXT: Nonprofits typically piece together funding from multiple grants, contracts, and donations. Evaluate the timeframe for their other funding sources. Look for: (1) Already awarded/committed grants or contracts, (2) Pending applications with expected decision dates, (3) Ongoing contracts being renewed, (4) Annual fundraising or donation income. Note: Multi-year grants and renewable contracts from established funders are strong indicators.',
            reasoningStarters: [
                'Matching funds of $... are already committed from...',
                'The organization has ongoing contracts with... that provide stable funding',
                'Award notifications for... funding are expected in...',
                'The timeline for securing other funds is unclear or speculative'
            ]
        },
        {
            id: '5c', section: 5, sectionTitle: 'Leveraging',
            question: 'What is probability that applicant will secure funding commitments?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if unlikely\n1-2 if relatively likely\n3 if highly probable or already secured',
            aiPrompt: 'NONPROFIT CONTEXT: Assess the likelihood of securing identified funding sources. Strong indicators include: (1) Multi-year relationships with funders, (2) Renewable contracts being continued, (3) Track record of receiving similar grants, (4) Federal/state formula funding they routinely receive, (5) Established foundation relationships. Note: Nonprofits often list pending applications - this is normal and does not indicate weakness if they have a history with those funders.',
            reasoningStarters: [
                'Funding from... is highly likely based on their multi-year relationship',
                'The applicant has a strong track record with... funder',
                'Pending applications to... have reasonable likelihood of success based on history',
                'The identified funding sources appear speculative with no clear commitment'
            ]
        },
        {
            id: '5d', section: 5, sectionTitle: 'Leveraging',
            question: 'Is percentage of County request to total cost reasonable?',
            validScores: [0, 1, 2, 3],
            scoringRule: '0 if 100% County funding\n1 if 75%+ County\n2 if 51-75% County\n3 if 50% or less County',
            aiPrompt: 'Calculate: (Amount Requested / Total Cost) x 100. Lower percentage = better leveraging.',
            autoCalculate: true,
            reasoningStarters: [
                'County funds represent...% of the total budget, demonstrating strong leveraging',
                'The applicant is leveraging $... in other funds for every County dollar',
                'At...% County funding, there is moderate leveraging',
                'The project relies heavily on County funds at...% of total cost'
            ]
        }
    ];

    // Backwards compatibility: CRITERIA as a proxy that returns the active profile's criteria
    // This ensures existing code continues to work without modification
    const CRITERIA = new Proxy([], {
        get: (target, prop) => {
            const criteria = getCriteria();
            if (prop === 'length') return criteria.length;
            if (prop === 'filter') return criteria.filter.bind(criteria);
            if (prop === 'map') return criteria.map.bind(criteria);
            if (prop === 'forEach') return criteria.forEach.bind(criteria);
            if (prop === 'find') return criteria.find.bind(criteria);
            if (prop === 'findIndex') return criteria.findIndex.bind(criteria);
            if (prop === 'some') return criteria.some.bind(criteria);
            if (prop === 'every') return criteria.every.bind(criteria);
            if (prop === 'reduce') return criteria.reduce.bind(criteria);
            if (prop === Symbol.iterator) return criteria[Symbol.iterator].bind(criteria);
            return criteria[prop];
        },
        has: (target, prop) => prop in getCriteria(),
        ownKeys: () => Reflect.ownKeys(getCriteria())
    });

    // ============================================================
    // STATE MANAGEMENT
    // ============================================================
    // ============================================================
    // SHARED API KEY CONFIGURATION
    // ============================================================
    // To pre-configure a shared API key for your team, replace the empty string below
    // with your Anthropic API key. Users can still override this in Settings.
    // Example: const SHARED_API_KEY = 'sk-ant-api03-xxxxxxxxxxxx';
    const SHARED_API_KEY = '';  // <-- PASTE YOUR SHARED API KEY HERE

    let state = {
        // UI Mode: 'simple' for beginners, 'pro' for advanced users (v7.21)
        uiMode: localStorage.getItem('nofa_ui_mode') || 'simple',
        apiKey: localStorage.getItem('nofa_api_key') || SHARED_API_KEY,
        reviewerName: localStorage.getItem('nofa_reviewer') || '',
        reviewerSheet: localStorage.getItem('nofa_reviewer_sheet') || 'Scoring Sheet - Reviewer 2',
        activeTemplateId: localStorage.getItem('nofa_active_profile') || 'san-mateo-nofa-fy26-27', // Current template profile
        templateData: null,
        templateName: '',
        scoringWorkbook: null, // Parsed XLSX workbook for export
        applicationPDF: null,
        pdfDocument: null,  // PDF.js document reference for vision rendering
        applicationText: '',
        pdfPages: [],
        projectInfo: {},
        scores: {},
        comments: {},
        notesIncluded: {}, // Track which criteria notes should be included in export
        aiSuggestions: {},
        recommendation: {},
        currentStep: 'upload',
        currentCriterionIndex: 0,
        pdfViewerCurrentPage: 0,
        lastSaved: null,
        hasUnsavedChanges: false,
        autoAnalyzeProgress: 0,
        isAutoAnalyzing: false,
        originalScores: {}, // For tracking changes in global review
        scoreHistory: [], // Undo stack for score changes [{criterionId, oldScore, newScore, timestamp}]
        autoAnalyzeCancelled: false, // Flag to cancel auto-analyze operation
        documentHash: null, // Hash of normalized document for consistency tracking
        cachedCriteriaCount: 0, // Number of criteria served from cache
        returnToSummary: false, // Flag to return to summary after editing a single criterion
        // Diagnostics tracking
        diagnostics: {
            totalPages: 0,
            totalCharacters: 0,
            mainContentChars: 0,
            attachmentChars: 0,
            attachmentStartPage: null,
            lastAnalysisTimestamp: null,
            criteriaAnalyzed: 0,
            visionPagesAnalyzed: 0
        },
        // Vision analysis
        visionEnabled: localStorage.getItem('nofa_vision_enabled') === 'true',
        visionAutoDetect: localStorage.getItem('nofa_vision_auto_detect') !== 'false',  // Default to true
        visionAutoEnabled: false,  // Track if vision was auto-enabled for this document
        visualContentDetected: false,  // Whether visual content was detected in current PDF
        pdfPageImages: [],  // Base64 images of PDF pages for vision analysis
        visionAnalysisCache: {},  // Cache vision analysis results per page
        // API error tracking (v7.19)
        apiErrors: [],  // Track API errors during analysis
        visionFailures: 0,  // Count of vision API failures
        // Reference Documents (v7.1)
        referenceDocuments: {
            fundingPriorities: JSON.parse(localStorage.getItem('nofa_ref_funding_priorities') || 'null'),
            guidelines: JSON.parse(localStorage.getItem('nofa_ref_guidelines') || 'null'),
            other: JSON.parse(localStorage.getItem('nofa_ref_other') || '[]')
        },
        // Linked Documents from Application PDF (v7.17)
        linkedDocuments: {
            links: [],           // All hyperlinks found in the PDF [{url, pageNum, type, name}]
            fetched: {},         // Fetched document content keyed by URL {url: {text, name, status, error}}
            fetchProgress: 0,    // Progress of auto-fetch (0-100)
            isFetching: false    // Whether auto-fetch is in progress
        },
        // Red Flags - Critical eligibility issues (v7.20)
        redFlags: [],  // Array of {type, severity, message, details, field} - severity: 'critical'|'warning'|'info'
        // Supplemental Documents - Documents uploaded to address red flags or provide additional info (v7.20)
        supplementalDocuments: {
            // Documents attached to specific red flags: { [flagType]: [{name, text, file, uploadedAt, includeInAnalysis}] }
            flagAttachments: {},
            // General supplemental documents not tied to a specific flag
            general: []  // [{name, text, file, uploadedAt, includeInAnalysis, notes}]
        }
    };

    // ============================================================
    // RED FLAGS - ELIGIBILITY VALIDATION (v7.20)
    // ============================================================
    const NOFA_ELIGIBILITY_RULES = {
        // Minimum and maximum award amounts by funding source
        CDBG: { minAward: 50000, maxAward: 150000, name: 'CDBG' },
        HOME: { minAward: 100000, maxAward: 500000, name: 'HOME' },
        ESG: { minAward: 25000, maxAward: 100000, name: 'ESG' },
        PLHA: { minAward: 50000, maxAward: 200000, name: 'PLHA' },
        // Default if funding source unknown
        DEFAULT: { minAward: 50000, maxAward: 500000, name: 'Unknown' }
    };

    function validateEligibility() {
        const flags = [];
        const info = state.projectInfo;
        const fundingSource = info.detectedFundingSource || 'DEFAULT';
        const rules = NOFA_ELIGIBILITY_RULES[fundingSource] || NOFA_ELIGIBILITY_RULES.DEFAULT;

        // Debug logging for eligibility validation
        console.log('[Red Flags] Validating eligibility:', {
            applicant: info.applicant,
            amountRequested: info.amountRequested,
            fundingSource: fundingSource,
            rules: rules,
            minCheck: info.amountRequested ? `${info.amountRequested} < ${rules.minAward} = ${info.amountRequested < rules.minAward}` : 'N/A',
            maxCheck: info.amountRequested ? `${info.amountRequested} > ${rules.maxAward} = ${info.amountRequested > rules.maxAward}` : 'N/A'
        });

        // 1. CRITICAL: Minimum Award Amount Check
        if (info.amountRequested && info.amountRequested < rules.minAward) {
            flags.push({
                type: 'min_award',
                severity: 'critical',
                message: `Amount Requested Below Minimum`,
                details: `The application requests ${formatCurrency(info.amountRequested)}, but the ${rules.name} minimum award is ${formatCurrency(rules.minAward)}. This application is INELIGIBLE for funding without a revised budget.`,
                field: 'amountRequested',
                actual: info.amountRequested,
                required: rules.minAward
            });
        }

        // 2. CRITICAL: Maximum Award Amount Check
        if (info.amountRequested && info.amountRequested > rules.maxAward) {
            flags.push({
                type: 'max_award',
                severity: 'critical',
                message: `Amount Requested Exceeds Maximum`,
                details: `The application requests ${formatCurrency(info.amountRequested)}, but the ${rules.name} maximum award is ${formatCurrency(rules.maxAward)}. The budget must be reduced to be eligible.`,
                field: 'amountRequested',
                actual: info.amountRequested,
                required: rules.maxAward
            });
        }

        // 3. WARNING: Missing critical project info
        if (!info.amountRequested) {
            flags.push({
                type: 'missing_amount',
                severity: 'warning',
                message: `Amount Requested Not Found`,
                details: `Could not extract the requested funding amount from the application. Please verify this manually before proceeding.`,
                field: 'amountRequested'
            });
        }

        // 4. WARNING: Very high cost per client
        if (info.amountRequested && info.clientsServed) {
            const costPerClient = info.amountRequested / info.clientsServed;
            if (costPerClient > 5000) {
                flags.push({
                    type: 'high_cost_per_client',
                    severity: 'warning',
                    message: `High Cost Per Client`,
                    details: `At ${formatCurrency(costPerClient)} per client, this is significantly above typical ranges. Verify the client count (${info.clientsServed}) is accurate.`,
                    field: 'costPerClient',
                    actual: costPerClient
                });
            }
        }

        // 5. WARNING: County funding is majority of project
        if (info.amountRequested && info.totalCost) {
            const countyPercent = (info.amountRequested / info.totalCost) * 100;
            if (countyPercent > 75) {
                flags.push({
                    type: 'high_county_share',
                    severity: 'warning',
                    message: `High County Funding Share`,
                    details: `County funding would be ${countyPercent.toFixed(1)}% of total project cost. Typical applications show more diversified funding (usually <50%).`,
                    field: 'countyPercent',
                    actual: countyPercent
                });
            }
        }

        // 6. INFO: No clients served specified
        if (!info.clientsServed || info.clientsServed === 0) {
            flags.push({
                type: 'missing_clients',
                severity: 'info',
                message: `Client Count Not Specified`,
                details: `No client/beneficiary count was extracted. This may affect cost-effectiveness evaluation.`,
                field: 'clientsServed'
            });
        }

        // 7. WARNING: Budget math doesn't add up (if we can detect it)
        if (info.amountRequested && info.totalCost && info.amountRequested > info.totalCost) {
            flags.push({
                type: 'budget_math_error',
                severity: 'critical',
                message: `Budget Calculation Error`,
                details: `Amount requested (${formatCurrency(info.amountRequested)}) exceeds total project cost (${formatCurrency(info.totalCost)}). This is mathematically impossible.`,
                field: 'amountRequested'
            });
        }

        // ============================================================
        // COMPLETENESS CHECKS (v7.21) - INFO level only
        // Based on NOFA Required Attachments, but non-blocking
        // ============================================================

        // 8. INFO: Check for linked supporting documents (Audits)
        const linkedDocs = state.linkedDocuments?.links || [];
        const fetchedDocs = state.linkedDocuments?.fetched || {};

        // Check if audit document was found and fetched
        const hasAuditLink = linkedDocs.some(l => l.type === 'audit');
        const hasAuditFetched = Object.entries(fetchedDocs).some(([url, doc]) =>
            doc.status === 'success' && (doc.aiClassified === 'audit' || linkedDocs.find(l => l.url === url)?.type === 'audit')
        );

        if (!hasAuditLink && !hasAuditFetched) {
            flags.push({
                type: 'missing_audit_link',
                severity: 'info',
                message: `Audit Document Not Detected`,
                details: `No linked financial audit document was detected in this application. NOFA requires audited financial statements or an agency operating budget. Verify this is included in the application attachments.`,
                field: 'attachments'
            });
        }

        // 9. INFO: Check for 501(c)(3) or nonprofit status reference
        const hasNonprofitLink = linkedDocs.some(l => l.type === 'nonprofit-status' || l.name?.toLowerCase().includes('501'));
        if (!hasNonprofitLink) {
            // Also check PDF text for mention of nonprofit status
            const pdfText = (state.pdfPages || []).join(' ').toLowerCase();
            const has501cMention = pdfText.includes('501(c)(3)') || pdfText.includes('501c3') || pdfText.includes('tax exempt');

            if (!has501cMention) {
                flags.push({
                    type: 'missing_nonprofit_status',
                    severity: 'info',
                    message: `Nonprofit Status Not Verified`,
                    details: `Could not detect 501(c)(3) documentation or tax-exempt status reference. NOFA requires proof of nonprofit status for eligible applicants.`,
                    field: 'attachments'
                });
            }
        }

        // 10. INFO: Check for project description completeness
        if (!info.project || info.project.length < 10) {
            flags.push({
                type: 'missing_project_title',
                severity: 'info',
                message: `Project Title Not Found`,
                details: `A clear project title could not be extracted from the application. Verify the application includes a descriptive project title.`,
                field: 'project'
            });
        }

        // 11. INFO: Check for applicant organization name
        if (!info.applicant || info.applicant.length < 3) {
            flags.push({
                type: 'missing_applicant',
                severity: 'info',
                message: `Applicant Organization Not Found`,
                details: `The applicant organization name could not be clearly identified. Verify the application includes complete organization information.`,
                field: 'applicant'
            });
        }

        state.redFlags = flags;
        console.log(`[Red Flags] Validation complete: ${flags.length} issues found`, flags);
        return flags;
    }

    function getRedFlagsSummary() {
        const critical = state.redFlags.filter(f => f.severity === 'critical').length;
        const warnings = state.redFlags.filter(f => f.severity === 'warning').length;
        const info = state.redFlags.filter(f => f.severity === 'info').length;
        return { critical, warnings, info, total: state.redFlags.length };
    }

    function hasCriticalRedFlags() {
        return state.redFlags.some(f => f.severity === 'critical');
    }

    // Render the Red Flags panel for the Project Info step
    function renderRedFlagsPanel() {
        if (state.redFlags.length === 0) return '';

        const summary = getRedFlagsSummary();

        // Severity styling
        const severityStyles = {
            critical: {
                bg: 'bg-red-50',
                border: 'border-red-300',
                text: 'text-red-800',
                icon: 'text-red-600',
                badge: 'bg-red-100 text-red-700',
                iconSvg: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`
            },
            warning: {
                bg: 'bg-amber-50',
                border: 'border-amber-300',
                text: 'text-amber-800',
                icon: 'text-amber-600',
                badge: 'bg-amber-100 text-amber-700',
                iconSvg: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`
            },
            info: {
                bg: 'bg-[#F3FAFE]',
                border: 'border-[#7CBEEC]',
                text: 'text-[#02538C]',
                icon: 'text-[#38939B]',
                badge: 'bg-[#E3EDF5] text-[#036CB6]',
                iconSvg: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`
            }
        };

        // Determine panel styling based on most severe flag
        const panelStyle = summary.critical > 0 ? severityStyles.critical :
                          summary.warnings > 0 ? severityStyles.warning :
                          severityStyles.info;

        // Header with counts
        const headerBadges = [];
        if (summary.critical > 0) headerBadges.push(`<span class="px-2 py-0.5 rounded-full text-xs font-semibold ${severityStyles.critical.badge}">${summary.critical} Critical</span>`);
        if (summary.warnings > 0) headerBadges.push(`<span class="px-2 py-0.5 rounded-full text-xs font-semibold ${severityStyles.warning.badge}">${summary.warnings} Warning${summary.warnings > 1 ? 's' : ''}</span>`);
        if (summary.info > 0) headerBadges.push(`<span class="px-2 py-0.5 rounded-full text-xs font-semibold ${severityStyles.info.badge}">${summary.info} Info</span>`);

        // Render individual flags with attachment options
        const flagsHtml = state.redFlags.map((flag, idx) => {
            const style = severityStyles[flag.severity];
            const hasAttachments = state.supplementalDocuments.flagAttachments[flag.type]?.length > 0;
            return `
                <div class="${style.bg} ${style.border} border rounded-lg p-3 mb-2">
                    <div class="flex items-start gap-3">
                        <div class="${style.icon} flex-shrink-0 mt-0.5">${style.iconSvg}</div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold ${style.text}">${flag.message}</span>
                                <span class="px-1.5 py-0.5 rounded text-xs font-medium ${style.badge} uppercase">${flag.severity}</span>
                                ${hasAttachments ? '<span class="px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700">üìé Doc Attached</span>' : ''}
                            </div>
                            <p class="text-sm ${style.text} opacity-90">${flag.details}</p>
                            ${renderFlagSupplements(flag.type)}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        return `
            <div class="${panelStyle.bg} ${panelStyle.border} border-2 rounded-xl p-4 mb-6" role="alert">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <div class="${panelStyle.icon}">${panelStyle.iconSvg}</div>
                        <h3 class="font-bold ${panelStyle.text}">üö© Eligibility Red Flags</h3>
                    </div>
                    <div class="flex gap-2">${headerBadges.join('')}</div>
                </div>
                <div class="space-y-2">
                    ${flagsHtml}
                </div>
                ${summary.critical > 0 ? `
                <div class="mt-4 pt-3 border-t ${panelStyle.border}">
                    <p class="text-sm font-semibold ${panelStyle.text}">‚ö†Ô∏è Critical issues must be resolved before this application can be considered for funding.</p>
                </div>
                ` : ''}
            </div>
        `;
    }

    // ============================================================
    // SUPPLEMENTAL DOCUMENTS (v7.20)
    // ============================================================

    // Upload a document to address a specific red flag (v7.21 - fully automatic)
    // User uploads ‚Üí AI analyzes ‚Üí Values update ‚Üí Red flag resolves (if valid)
    async function uploadSupplementForFlag(flagType) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.pdf,.xlsx,.xls,.csv,.tsv,.docx,.doc,.txt,.text,.md,.json,.xml,.html,.htm,.rtf';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showLoading('Reading Document', `Processing ${file.name}...`);

            try {
                // Step 1: Extract text from any document type
                const text = await extractTextFromFile(file);

                if (!state.supplementalDocuments.flagAttachments[flagType]) {
                    state.supplementalDocuments.flagAttachments[flagType] = [];
                }

                const doc = {
                    name: file.name,
                    text: text,
                    size: file.size,
                    type: file.type,
                    uploadedAt: new Date().toISOString(),
                    includeInAnalysis: true
                };

                state.supplementalDocuments.flagAttachments[flagType].push(doc);
                debouncedAutoSave();

                // Step 2: Automatically analyze to resolve the red flag
                const isBudgetFlag = ['min_award', 'max_award', 'budget_math_error'].includes(flagType);

                if (isBudgetFlag && state.apiKey) {
                    // Auto-analyze budget documents
                    await autoResolveBudgetFlag(doc, flagType);
                } else if (!state.apiKey) {
                    hideLoading();
                    showToast('info', 'Document Saved', `${file.name} attached. Add API key to enable auto-analysis.`);
                    render();
                } else {
                    hideLoading();
                    showToast('success', 'Document Attached', `${file.name} saved for reference.`);
                    render();
                }

            } catch (error) {
                hideLoading();
                showToast('error', 'Upload Failed', error.message);
            }
        };
        input.click();
    }

    // Automatically analyze a budget document and update values (v7.21)
    async function autoResolveBudgetFlag(doc, flagType) {
        updateLoadingMessage('Analyzing Document', 'AI is extracting budget information...');

        try {
            const flag = state.redFlags.find(f => f.type === flagType);
            const currentAmount = state.projectInfo.amountRequested || 0;
            const currentTotal = state.projectInfo.totalCost || 0;

            const prompt = `Extract the funding request amount from this document.

CONTEXT: An application originally requested ${formatCurrency(currentAmount)} but this may be below/above limits.
The applicant has submitted this document which may contain a revised budget.

DOCUMENT CONTENT:
${doc.text.substring(0, 15000)}

Find and extract:
1. The amount being requested from the County/jurisdiction (the funding request)
2. The total project cost (if shown)

Return ONLY valid JSON:
{
  "amountRequested": <number - funding request amount, or null if not clearly stated>,
  "totalCost": <number - total project cost, or null if not found>,
  "confidence": "<high/medium/low>",
  "source": "<brief description of where you found this, e.g. 'Line item: CDBG Request'>"
}`;

            const response = await callClaude(
                'You are a budget analyst. Extract dollar amounts from documents. Return only valid JSON, no explanation.',
                prompt
            );

            const jsonMatch = response.match(/\{[\s\S]*?\}/);

            if (jsonMatch) {
                const result = JSON.parse(jsonMatch[0]);

                if (result.amountRequested && result.confidence !== 'low') {
                    // Update the values automatically
                    const oldAmount = state.projectInfo.amountRequested;
                    state.projectInfo.amountRequested = result.amountRequested;

                    if (result.totalCost) {
                        state.projectInfo.totalCost = result.totalCost;
                    }

                    // Re-validate eligibility
                    validateEligibility();
                    updateRedFlagsIndicator();
                    debouncedAutoSave();

                    hideLoading();

                    // Check if the flag is now resolved
                    const flagStillExists = state.redFlags.some(f => f.type === flagType);

                    if (!flagStillExists) {
                        showToast('success', '‚úì Issue Resolved!',
                            `Budget updated: ${formatCurrency(oldAmount)} ‚Üí ${formatCurrency(result.amountRequested)}`);
                    } else {
                        showToast('warning', 'Budget Updated',
                            `Now ${formatCurrency(result.amountRequested)}, but issue remains. Check requirements.`);
                    }

                    render();
                    return;
                }
            }

            // Couldn't extract automatically
            hideLoading();
            showToast('info', 'Document Saved',
                `Couldn't auto-extract budget. You can update values manually in Project Info.`);
            render();

        } catch (error) {
            hideLoading();
            console.error('Auto budget extraction failed:', error);
            showToast('warning', 'Document Saved', `Auto-analysis failed. Document saved for reference.`);
            render();
        }
    }

    // Helper to update loading message
    function updateLoadingMessage(title, message) {
        const titleEl = document.getElementById('loadingTitle');
        const msgEl = document.getElementById('loadingMessage');
        if (titleEl) titleEl.textContent = title;
        if (msgEl) msgEl.textContent = message;
    }

    // Upload a general supplemental document
    async function uploadGeneralSupplement() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.pdf,.xlsx,.xls,.csv,.tsv,.docx,.doc,.txt,.text,.md,.json,.xml,.html,.htm,.rtf';
        input.multiple = true;
        input.onchange = async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            // Ask user if they want to include in AI analysis
            const includeInAnalysis = confirm(
                `üìÑ Uploading ${files.length} document(s)\n\n` +
                `Do you want to include these in AI analysis?\n\n` +
                `‚Ä¢ YES = AI will use these when scoring criteria\n` +
                `‚Ä¢ NO = Documents stored for reference only`
            );

            showLoading('Processing Documents', `Reading ${files.length} file(s)...`);

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    updateLoadingProgress(Math.round((i / files.length) * 100), `Processing ${file.name}...`);

                    const text = await extractTextFromFile(file);

                    const doc = {
                        name: file.name,
                        text: text,
                        size: file.size,
                        type: file.type,
                        uploadedAt: new Date().toISOString(),
                        includeInAnalysis: includeInAnalysis,
                        notes: ''
                    };

                    state.supplementalDocuments.general.push(doc);
                }

                hideLoading();
                debouncedAutoSave();
                showToast('success', 'Documents Uploaded', `${files.length} supplemental document(s) added.`);
                render();
            } catch (error) {
                hideLoading();
                showToast('error', 'Upload Failed', error.message);
            }
        };
        input.click();
    }

    // Try to extract budget info from a supplemental document (e.g., revised budget Excel)
    async function extractBudgetFromSupplement(doc, flagType) {
        showLoading('Analyzing Document', 'Looking for budget information...');

        try {
            // Use AI to extract budget amounts from the document
            const prompt = `Analyze this document and extract any funding/budget amounts. Look specifically for:
1. Amount requested from County/jurisdiction
2. Total project cost
3. Any revised budget figures

Document content:
${doc.text.substring(0, 8000)}

Respond in JSON format:
{
  "amountRequested": <number or null>,
  "totalCost": <number or null>,
  "isRevisedBudget": <true/false>,
  "notes": "<any relevant notes about the budget>"
}`;

            const response = await callClaude(
                'You are a budget analyst. Extract financial figures from documents. Return only valid JSON.',
                prompt
            );

            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const budgetInfo = JSON.parse(jsonMatch[0]);

                if (budgetInfo.amountRequested && budgetInfo.isRevisedBudget) {
                    const updateBudget = confirm(
                        `üìä Budget Information Found!\n\n` +
                        `Amount Requested: ${formatCurrency(budgetInfo.amountRequested)}\n` +
                        `Total Cost: ${budgetInfo.totalCost ? formatCurrency(budgetInfo.totalCost) : 'Not found'}\n` +
                        `${budgetInfo.notes ? `Notes: ${budgetInfo.notes}\n` : ''}\n` +
                        `Do you want to update the project info with these values?`
                    );

                    if (updateBudget) {
                        if (budgetInfo.amountRequested) {
                            state.projectInfo.amountRequested = budgetInfo.amountRequested;
                        }
                        if (budgetInfo.totalCost) {
                            state.projectInfo.totalCost = budgetInfo.totalCost;
                        }

                        // Re-validate eligibility
                        validateEligibility();
                        updateRedFlagsIndicator();

                        hideLoading();

                        if (hasCriticalRedFlags()) {
                            showToast('warning', 'Red Flags Remain', 'Some eligibility issues still exist after update.');
                        } else {
                            showToast('success', 'Red Flags Resolved', 'All critical eligibility issues have been addressed!');
                        }

                        render();
                        return;
                    }
                }
            }

            hideLoading();
            showToast('info', 'No Auto-Update', 'Could not automatically extract budget. Please update manually if needed.');
        } catch (error) {
            hideLoading();
            console.error('Budget extraction failed:', error);
            showToast('warning', 'Analysis Skipped', 'Could not analyze document for budget info.');
        }
    }

    // Re-analyze a red flag with attached supplemental documents (v7.21)
    async function reanalyzeRedFlagWithDocs(flagType) {
        const docs = state.supplementalDocuments.flagAttachments[flagType] || [];
        const aiDocs = docs.filter(doc => doc.includeInAnalysis);

        if (aiDocs.length === 0) {
            showToast('warning', 'No AI Documents', 'No documents marked for AI analysis. Upload a document first.');
            return;
        }

        showLoading('Analyzing Documents', 'AI is reviewing attached documents to resolve this issue...');

        try {
            // Combine all AI-enabled documents
            const combinedText = aiDocs.map(doc => `--- ${doc.name} ---\n${doc.text}`).join('\n\n');

            // Get the current red flag details for context
            const flag = state.redFlags.find(f => f.type === flagType);
            const flagDescription = flag ? flag.description : 'eligibility issue';

            // Use AI to extract relevant information based on the flag type
            let prompt = '';

            if (['min_award', 'max_award', 'budget_math_error'].includes(flagType)) {
                prompt = `You are analyzing supplemental documents to resolve a budget-related eligibility issue.

CURRENT ISSUE: ${flagDescription}

The application originally requested: ${formatCurrency(state.projectInfo.amountRequested || 0)}
The total project cost was: ${formatCurrency(state.projectInfo.totalCost || 0)}

Please analyze the following document(s) and extract the REVISED budget information:

${combinedText.substring(0, 12000)}

Look for:
1. A revised funding request amount (what they're now asking from the County)
2. A revised total project cost
3. Any indication this is a budget revision or amendment

Respond in JSON format:
{
  "amountRequested": <number - the revised funding request, or null if not found>,
  "totalCost": <number - the revised total cost, or null if not found>,
  "isRevisedBudget": <true if this appears to be a budget revision/amendment>,
  "confidence": "<high/medium/low>",
  "explanation": "<brief explanation of what you found>"
}`;
            } else {
                // Generic analysis for other flag types
                prompt = `You are analyzing supplemental documents to help resolve an eligibility issue.

CURRENT ISSUE: ${flagDescription}

Please analyze the following document(s) and determine if they address this issue:

${combinedText.substring(0, 12000)}

Respond in JSON format:
{
  "addressesIssue": <true/false>,
  "explanation": "<how the document addresses or doesn't address the issue>",
  "suggestedAction": "<what action should be taken based on this document>"
}`;
            }

            const response = await callClaude(
                'You are a grant application analyst. Extract specific data from supplemental documents. Return only valid JSON.',
                prompt
            );

            const jsonMatch = response.match(/\{[\s\S]*\}/);

            if (jsonMatch) {
                const result = JSON.parse(jsonMatch[0]);

                hideLoading();

                if (['min_award', 'max_award', 'budget_math_error'].includes(flagType)) {
                    // Budget-related flag
                    if (result.amountRequested && result.isRevisedBudget) {
                        // Show what was found and ask to update
                        const message = `üìä AI Analysis Results\n\n` +
                            `Found in documents:\n` +
                            `‚Ä¢ Revised Amount Requested: ${formatCurrency(result.amountRequested)}\n` +
                            `${result.totalCost ? `‚Ä¢ Revised Total Cost: ${formatCurrency(result.totalCost)}\n` : ''}` +
                            `‚Ä¢ Confidence: ${result.confidence}\n\n` +
                            `${result.explanation}\n\n` +
                            `Do you want to update the application with these values?`;

                        if (confirm(message)) {
                            // Update project info
                            state.projectInfo.amountRequested = result.amountRequested;
                            if (result.totalCost) {
                                state.projectInfo.totalCost = result.totalCost;
                            }

                            // Re-validate eligibility
                            validateEligibility();
                            updateRedFlagsIndicator();
                            debouncedAutoSave();

                            if (hasCriticalRedFlags()) {
                                showToast('warning', 'Issues Remain', 'Budget updated but some eligibility issues still exist.');
                            } else {
                                showToast('success', '‚úì Issue Resolved!', `Budget updated to ${formatCurrency(result.amountRequested)}. Red flag cleared!`);
                            }

                            render();
                        }
                    } else {
                        showToast('info', 'No Revision Found', result.explanation || 'Could not find a revised budget amount in the documents.');
                    }
                } else {
                    // Non-budget flag
                    showToast(
                        result.addressesIssue ? 'success' : 'info',
                        result.addressesIssue ? 'Issue May Be Resolved' : 'Review Needed',
                        result.explanation.substring(0, 100)
                    );
                }
            } else {
                hideLoading();
                showToast('warning', 'Analysis Failed', 'Could not parse AI response. Please review documents manually.');
            }

        } catch (error) {
            hideLoading();
            console.error('Red flag re-analysis failed:', error);
            showToast('error', 'Analysis Error', error.message || 'Failed to analyze documents.');
        }
    }

    // Extract text from various file types
    // Extract text from various file formats (v7.21 - enhanced support)
    async function extractTextFromFile(file) {
        const extension = file.name.split('.').pop().toLowerCase();
        const fileName = file.name;

        console.log(`[Document Ingestion] Processing ${fileName} (${extension})`);

        if (extension === 'pdf') {
            // Use PDF.js for PDF files
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n\n';
            }
            console.log(`[Document Ingestion] PDF: ${pdf.numPages} pages, ${text.length} chars`);
            return text;

        } else if (['xlsx', 'xls', 'csv', 'tsv'].includes(extension)) {
            // Use SheetJS for spreadsheet files
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer);
            let text = '';
            let totalRows = 0;
            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const csv = XLSX.utils.sheet_to_csv(sheet);
                const rowCount = csv.split('\n').filter(r => r.trim()).length;
                totalRows += rowCount;
                text += `=== Sheet: ${sheetName} (${rowCount} rows) ===\n`;
                text += csv + '\n\n';
            });
            console.log(`[Document Ingestion] Spreadsheet: ${workbook.SheetNames.length} sheets, ${totalRows} total rows`);
            return text;

        } else if (extension === 'docx') {
            // Use Mammoth.js for Word .docx files
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            console.log(`[Document Ingestion] DOCX: ${result.value.length} chars`);
            if (result.messages && result.messages.length > 0) {
                console.log(`[Document Ingestion] DOCX warnings:`, result.messages);
            }
            return result.value;

        } else if (extension === 'doc') {
            // Legacy .doc format - attempt with Mammoth (may have limited success)
            // Mammoth primarily supports .docx but sometimes works with .doc
            try {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                if (result.value && result.value.length > 50) {
                    console.log(`[Document Ingestion] DOC: ${result.value.length} chars (Mammoth succeeded)`);
                    return result.value;
                }
            } catch (e) {
                console.log(`[Document Ingestion] DOC: Mammoth failed, trying binary extraction`);
            }

            // Fallback: Try to extract readable text from binary .doc file
            const arrayBuffer = await file.arrayBuffer();
            const bytes = new Uint8Array(arrayBuffer);
            let text = '';
            let currentWord = '';

            for (let i = 0; i < bytes.length; i++) {
                const byte = bytes[i];
                // Extract printable ASCII characters (32-126) and common extended chars
                if ((byte >= 32 && byte <= 126) || byte === 10 || byte === 13 || byte === 9) {
                    currentWord += String.fromCharCode(byte);
                } else {
                    if (currentWord.length > 2) {
                        text += currentWord;
                    }
                    currentWord = '';
                }
            }
            if (currentWord.length > 2) text += currentWord;

            // Clean up the extracted text
            text = text
                .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g, '') // Remove control chars
                .replace(/\s+/g, ' ') // Normalize whitespace
                .replace(/(.)\1{5,}/g, '$1$1') // Remove repeated characters (artifacts)
                .trim();

            if (text.length < 100) {
                throw new Error(`Legacy .doc file could not be read. Please convert to .docx format for better compatibility.`);
            }

            console.log(`[Document Ingestion] DOC (binary extraction): ${text.length} chars`);
            return `[Note: Extracted from legacy .doc format - some formatting may be lost]\n\n${text}`;

        } else if (['txt', 'text', 'md', 'markdown'].includes(extension)) {
            // Plain text files
            const text = await file.text();
            console.log(`[Document Ingestion] Text: ${text.length} chars`);
            return text;

        } else if (['json'].includes(extension)) {
            // JSON files - format nicely
            const text = await file.text();
            try {
                const parsed = JSON.parse(text);
                const formatted = JSON.stringify(parsed, null, 2);
                console.log(`[Document Ingestion] JSON: ${formatted.length} chars`);
                return formatted;
            } catch (e) {
                return text;
            }

        } else if (['xml', 'html', 'htm'].includes(extension)) {
            // XML/HTML - extract text content
            const text = await file.text();
            // Simple tag removal for text extraction
            const textContent = text
                .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
                .replace(/<[^>]+>/g, ' ')
                .replace(/&nbsp;/g, ' ')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/\s+/g, ' ')
                .trim();
            console.log(`[Document Ingestion] ${extension.toUpperCase()}: ${textContent.length} chars`);
            return textContent;

        } else if (['rtf'].includes(extension)) {
            // RTF - basic text extraction
            const text = await file.text();
            // Remove RTF control words and extract plain text
            const plainText = text
                .replace(/\\[a-z]+\d*\s?/g, '') // Remove control words
                .replace(/[{}]/g, '') // Remove braces
                .replace(/\\'[0-9a-f]{2}/gi, '') // Remove hex escapes
                .replace(/\s+/g, ' ')
                .trim();
            console.log(`[Document Ingestion] RTF: ${plainText.length} chars`);
            return plainText;

        } else {
            // Unsupported format
            const supportedFormats = 'PDF, Word (.docx, .doc), Excel (.xlsx, .xls), CSV, TXT, JSON, XML, HTML, RTF, Markdown';
            throw new Error(`Unsupported file type: .${extension}\n\nSupported formats: ${supportedFormats}`);
        }
    }

    // Remove a supplemental document
    function removeSupplementalDoc(flagType, index) {
        if (flagType === 'general') {
            state.supplementalDocuments.general.splice(index, 1);
        } else {
            state.supplementalDocuments.flagAttachments[flagType].splice(index, 1);
            if (state.supplementalDocuments.flagAttachments[flagType].length === 0) {
                delete state.supplementalDocuments.flagAttachments[flagType];
            }
        }
        debouncedAutoSave();
        render();
        showToast('info', 'Document Removed', 'Supplemental document has been removed.');
    }

    // Get all supplemental text for AI analysis
    function getSupplementalTextForAI() {
        let text = '';

        // Flag attachments
        Object.values(state.supplementalDocuments.flagAttachments).forEach(docs => {
            docs.forEach(doc => {
                if (doc.includeInAnalysis && doc.text) {
                    text += `\n\n=== SUPPLEMENTAL: ${doc.name} ===\n${doc.text}`;
                }
            });
        });

        // General supplements
        state.supplementalDocuments.general.forEach(doc => {
            if (doc.includeInAnalysis && doc.text) {
                text += `\n\n=== SUPPLEMENTAL: ${doc.name} ===\n${doc.text}`;
            }
        });

        return text;
    }

    // Count total supplemental documents
    function getSupplementalDocCount() {
        let count = state.supplementalDocuments.general.length;
        Object.values(state.supplementalDocuments.flagAttachments).forEach(docs => {
            count += docs.length;
        });
        return count;
    }

    // Render supplemental documents for a red flag (v7.21 - simplified)
    function renderFlagSupplements(flagType) {
        const docs = state.supplementalDocuments.flagAttachments[flagType] || [];

        if (docs.length === 0) {
            return `
                <button onclick="uploadSupplementForFlag('${flagType}')" class="mt-2 text-xs px-3 py-1.5 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 flex items-center gap-1" title="Upload a corrected document - AI will automatically extract values">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Upload Corrected Document
                </button>
            `;
        }

        // Simple list of attached documents
        const docsHtml = docs.map((doc, idx) => `
            <div class="flex items-center justify-between bg-white border border-slate-200 rounded px-2 py-1 text-xs mt-1">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span class="font-medium truncate max-w-[200px]">${doc.name}</span>
                </div>
                <button onclick="removeSupplementalDoc('${flagType}', ${idx})" class="text-red-500 hover:text-red-700 p-1" title="Remove">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
        `).join('');

        return `
            <div class="mt-2">
                <div class="text-xs text-slate-600 mb-1">üìé Attached:</div>
                ${docsHtml}
                <button onclick="uploadSupplementForFlag('${flagType}')" class="mt-1 text-xs text-[#036CB6] hover:text-[#02538C] flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Upload Another
                </button>
            </div>
        `;
    }

    // Render the general supplemental documents panel
    function renderSupplementalDocsPanel() {
        const docs = state.supplementalDocuments.general;
        const totalDocs = getSupplementalDocCount();

        const docsListHtml = docs.length > 0 ? docs.map((doc, idx) => `
            <div class="flex items-center justify-between bg-white border border-slate-200 rounded-lg px-3 py-2">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <div>
                        <div class="font-medium text-sm text-slate-800">${doc.name}</div>
                        <div class="text-xs text-slate-500">
                            ${new Date(doc.uploadedAt).toLocaleDateString()} ‚Ä¢
                            ${doc.includeInAnalysis ?
                                '<span class="text-[#036CB6]">‚úì Included in AI analysis</span>' :
                                '<span class="text-slate-400">Reference only</span>'}
                        </div>
                    </div>
                </div>
                <button onclick="removeSupplementalDoc('general', ${idx})" class="text-red-500 hover:text-red-700 p-1" title="Remove document">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
            </div>
        `).join('') : '';

        return `
            <div class="mt-6 bg-purple-50 border border-purple-200 rounded-xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <h3 class="font-semibold text-purple-800">üìé Supplemental Documents</h3>
                        ${totalDocs > 0 ? `<span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">${totalDocs} file${totalDocs !== 1 ? 's' : ''}</span>` : ''}
                    </div>
                </div>
                <p class="text-sm text-purple-700 mb-3">
                    Upload additional documents from the applicant (revised budgets, clarifications, missing exhibits, etc.)
                </p>
                ${docs.length > 0 ? `<div class="space-y-2 mb-3">${docsListHtml}</div>` : ''}
                <button onclick="uploadGeneralSupplement()" class="w-full py-2.5 px-4 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Upload Supplemental Document(s)
                </button>
                <p class="text-xs text-purple-600 mt-2 text-center">Supports: PDF, Word (.docx/.doc), Excel, CSV, TXT, JSON, XML, HTML, RTF</p>
            </div>
        `;
    }

    let autoSaveTimeout = null;
    let lastRetryAction = null;

    // ============================================================
    // AUTO-SAVE FUNCTIONALITY
    // ============================================================
    function saveToLocalStorage() {
        const saveData = {
            projectInfo: state.projectInfo,
            scores: state.scores,
            comments: state.comments,
            aiSuggestions: state.aiSuggestions,
            recommendation: state.recommendation,
            currentStep: state.currentStep,
            currentCriterionIndex: state.currentCriterionIndex,
            applicationText: state.applicationText,
            pdfPages: state.pdfPages,
            templateName: state.templateName,
            savedAt: new Date().toISOString()
        };

        try {
            localStorage.setItem(CONFIG.AUTO_SAVE_KEY, JSON.stringify(saveData));
            state.lastSaved = new Date();
            state.hasUnsavedChanges = false;
            showAutoSaveIndicator();
        } catch (e) {
            console.error('Auto-save failed:', e);
        }
    }

    function debouncedAutoSave() {
        state.hasUnsavedChanges = true;
        if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(saveToLocalStorage, CONFIG.AUTO_SAVE_DEBOUNCE_MS);
    }

    function showAutoSaveIndicator() {
        const indicator = document.getElementById('autoSaveIndicator');
        indicator.classList.remove('hidden');
        setTimeout(() => indicator.classList.add('hidden'), 2000);

        // Update the persistent "last saved" indicator (v7.21)
        updateLastSavedIndicator();
    }

    // Update the persistent "last saved X ago" indicator (v7.21)
    function updateLastSavedIndicator() {
        const indicator = document.getElementById('lastSavedIndicator');
        const textEl = document.getElementById('lastSavedText');
        if (!indicator || !textEl) return;

        if (state.lastSaved) {
            indicator.classList.remove('hidden');
            indicator.classList.add('flex');
            const now = new Date();
            const diff = Math.floor((now - state.lastSaved) / 1000); // seconds

            let timeText;
            if (diff < 5) {
                timeText = 'Just saved';
            } else if (diff < 60) {
                timeText = `Saved ${diff}s ago`;
            } else if (diff < 3600) {
                const mins = Math.floor(diff / 60);
                timeText = `Saved ${mins}m ago`;
            } else {
                const hours = Math.floor(diff / 3600);
                timeText = `Saved ${hours}h ago`;
            }
            textEl.textContent = timeText;
        } else {
            indicator.classList.add('hidden');
            indicator.classList.remove('flex');
        }
    }

    // Update undo button visibility based on history (v7.21)
    function updateUndoButton() {
        const undoBtn = document.getElementById('undoBtn');
        if (!undoBtn) return;

        if (state.scoreHistory && state.scoreHistory.length > 0) {
            undoBtn.classList.remove('hidden');
            undoBtn.classList.add('flex');
        } else {
            undoBtn.classList.add('hidden');
            undoBtn.classList.remove('flex');
        }
    }

    // Start interval to update "last saved" time periodically (v7.21)
    setInterval(updateLastSavedIndicator, 30000); // Update every 30 seconds

    function checkForDraft() {
        try {
            const saved = localStorage.getItem(CONFIG.AUTO_SAVE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                if (data.projectInfo?.applicant) {
                    const savedDate = new Date(data.savedAt);
                    const draftInfo = document.getElementById('draftInfo');
                    draftInfo.textContent = `${data.projectInfo.applicant} - saved ${savedDate.toLocaleString()}`;
                    document.getElementById('draftBanner').classList.remove('hidden');
                    return true;
                }
            }
        } catch (e) {
            console.error('Error checking draft:', e);
        }
        return false;
    }

    function restoreDraft() {
        try {
            const saved = localStorage.getItem(CONFIG.AUTO_SAVE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                state.projectInfo = data.projectInfo || {};
                state.scores = data.scores || {};
                state.comments = data.comments || {};
                state.aiSuggestions = data.aiSuggestions || {};
                state.recommendation = data.recommendation || {};
                state.currentStep = data.currentStep || 'upload';
                state.currentCriterionIndex = data.currentCriterionIndex || 0;
                state.applicationText = data.applicationText || '';
                state.pdfPages = data.pdfPages || [];
                state.templateName = data.templateName || '';

                document.getElementById('draftBanner').classList.add('hidden');
                showToast('success', 'Draft Restored', 'Your previous evaluation has been restored.');
                render();
            }
        } catch (e) {
            showToast('error', 'Restore Failed', 'Could not restore the draft. Starting fresh.');
        }
    }

    function discardDraft() {
        localStorage.removeItem(CONFIG.AUTO_SAVE_KEY);
        document.getElementById('draftBanner').classList.add('hidden');
        showToast('info', 'Draft Discarded', 'Starting a fresh evaluation.');
    }

    // ============================================================
    // CLOSE WARNING
    // ============================================================
    window.addEventListener('beforeunload', (e) => {
        if (state.hasUnsavedChanges || (state.currentStep !== 'upload' && state.currentStep !== 'summary')) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });

    // ============================================================
    // TOAST NOTIFICATIONS
    // ============================================================
    function showToast(type, title, message) {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toastIcon');

        const icons = {
            success: '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
            error: '<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
            info: '<svg class="w-6 h-6 text-[#036CB6]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
        };

        icon.innerHTML = icons[type] || icons.info;
        document.getElementById('toastTitle').textContent = title;
        document.getElementById('toastMessage').textContent = message;

        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 5000);
    }

    function hideToast() {
        document.getElementById('toast').classList.remove('show');
    }

    // ============================================================
    // LOADING OVERLAY
    // ============================================================
    function showLoading(title, message, showProgress = false, showCancel = false) {
        document.getElementById('loadingTitle').textContent = title;
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingProgress').classList.toggle('hidden', !showProgress);

        // Show/hide cancel button (v7.21)
        const cancelBtn = document.getElementById('loadingCancelBtn');
        if (cancelBtn) {
            cancelBtn.classList.toggle('hidden', !showCancel);
        }

        document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function updateLoadingProgress(percent, text) {
        document.getElementById('loadingProgressBar').style.width = percent + '%';
        document.getElementById('loadingProgressText').textContent = text || (percent + '%');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
        // Reset cancel button state (v7.21)
        const cancelBtn = document.getElementById('loadingCancelBtn');
        if (cancelBtn) {
            cancelBtn.textContent = '‚èπ Stop Analysis';
            cancelBtn.disabled = false;
            cancelBtn.classList.add('hidden');
        }
    }

    // Cancel the current auto-analyze operation (v7.21)
    function cancelAutoAnalyze() {
        state.autoAnalyzeCancelled = true;
        const cancelBtn = document.getElementById('loadingCancelBtn');
        if (cancelBtn) {
            cancelBtn.textContent = 'Cancelling...';
            cancelBtn.disabled = true;
        }
    }

    // ============================================================
    // ERROR HANDLING
    // ============================================================
    function showError(message, details = null, retryFn = null) {
        document.getElementById('errorMessage').textContent = message;
        const detailsEl = document.getElementById('errorDetails');
        const retryBtn = document.getElementById('errorRetryBtn');

        if (details) {
            detailsEl.textContent = details;
            detailsEl.classList.remove('hidden');
        } else {
            detailsEl.classList.add('hidden');
        }

        if (retryFn) {
            lastRetryAction = retryFn;
            retryBtn.classList.remove('hidden');
        } else {
            retryBtn.classList.add('hidden');
        }

        document.getElementById('errorModal').classList.remove('hidden');
    }

    function hideErrorModal() {
        document.getElementById('errorModal').classList.add('hidden');
    }

    function retryLastAction() {
        hideErrorModal();
        if (lastRetryAction) lastRetryAction();
    }

    // Show analysis error summary modal (v7.19)
    function showAnalysisErrorSummary(errors, total, successful) {
        const failedCriteria = errors.map(e => e.criterion.toUpperCase()).join(', ');
        const networkErrors = errors.filter(e => e.isNetwork);
        const visionErrors = errors.filter(e => e.isVision);

        let detailsHtml = `<div class="text-left space-y-3">`;
        detailsHtml += `<p class="font-medium">Analysis completed with issues:</p>`;
        detailsHtml += `<ul class="list-disc ml-4 space-y-1">`;
        detailsHtml += `<li class="text-green-700">‚úì ${successful} criteria analyzed successfully</li>`;
        detailsHtml += `<li class="text-red-700">‚úó ${errors.length} criteria failed: ${failedCriteria}</li>`;
        detailsHtml += `</ul>`;

        if (networkErrors.length > 0) {
            detailsHtml += `<div class="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">`;
            detailsHtml += `<p class="font-medium text-amber-800 flex items-center gap-2">`;
            detailsHtml += `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`;
            detailsHtml += `Connection Issues Detected</p>`;
            detailsHtml += `<p class="text-sm text-amber-700 mt-1">${networkErrors.length} API calls failed due to network/connection errors. This may indicate:</p>`;
            detailsHtml += `<ul class="text-sm text-amber-700 list-disc ml-4 mt-1">`;
            detailsHtml += `<li>Unstable internet connection</li>`;
            detailsHtml += `<li>API service temporarily unavailable</li>`;
            detailsHtml += `<li>Firewall or proxy blocking requests</li>`;
            detailsHtml += `</ul>`;
            detailsHtml += `</div>`;
        }

        if (visionErrors.length > 0 && state.visionEnabled) {
            detailsHtml += `<div class="mt-3 p-3 bg-purple-50 border border-purple-200 rounded-lg">`;
            detailsHtml += `<p class="font-medium text-purple-800 flex items-center gap-2">`;
            detailsHtml += `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>`;
            detailsHtml += `Vision Analysis Issues</p>`;
            detailsHtml += `<p class="text-sm text-purple-700 mt-1">${visionErrors.length} vision-enabled requests failed. You may want to:</p>`;
            detailsHtml += `<ul class="text-sm text-purple-700 list-disc ml-4 mt-1">`;
            detailsHtml += `<li>Disable vision mode in Settings and re-analyze</li>`;
            detailsHtml += `<li>Check that your API key has vision access</li>`;
            detailsHtml += `<li>Try again when connection is stable</li>`;
            detailsHtml += `</ul>`;
            detailsHtml += `</div>`;
        }

        detailsHtml += `<p class="mt-3 text-sm text-slate-600">You can re-analyze failed criteria individually or click "Auto-Analyze" again to retry all failures.</p>`;
        detailsHtml += `</div>`;

        // Create and show a custom modal
        const modal = document.createElement('div');
        modal.id = 'analysisErrorModal';
        modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl">
                <div class="p-6 border-b border-slate-200">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">Analysis Partially Complete</h3>
                            <p class="text-sm text-slate-500">Some criteria could not be analyzed</p>
                        </div>
                    </div>
                </div>
                <div class="p-6 text-slate-700">
                    ${detailsHtml}
                </div>
                <div class="p-4 border-t border-slate-200 flex justify-end gap-3">
                    <button onclick="document.getElementById('analysisErrorModal').remove()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 transition-colors">
                        Continue Reviewing
                    </button>
                    <button onclick="document.getElementById('analysisErrorModal').remove(); autoAnalyzeRemaining();" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors">
                        Retry Failed Criteria
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Close on backdrop click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }

    // Update API error indicator in header (v7.19)
    function updateApiErrorIndicator() {
        const indicator = document.getElementById('apiErrorIndicator');
        const text = document.getElementById('apiErrorText');
        if (!indicator || !text) return;

        const errorCount = state.apiErrors.length;
        if (errorCount > 0) {
            indicator.classList.remove('hidden');
            indicator.classList.add('flex');
            text.textContent = `${errorCount} Failed`;
        } else {
            indicator.classList.add('hidden');
            indicator.classList.remove('flex');
        }
    }

    // Show last error summary (called from header indicator) (v7.19)
    function showLastErrorSummary() {
        if (state.apiErrors.length === 0) {
            showToast('info', 'No Errors', 'All API calls completed successfully.');
            return;
        }
        const totalAnalyzed = CRITERIA.length;
        const successful = totalAnalyzed - state.apiErrors.length;
        showAnalysisErrorSummary(state.apiErrors, totalAnalyzed, successful);
    }

    // ============================================================
    // UTILITY FUNCTIONS
    // ============================================================
    function formatCurrency(amount) {
        if (amount === null || amount === undefined || isNaN(amount)) return '$0.00';
        return new Intl.NumberFormat('en-US', {
            style: 'currency', currency: 'USD',
            minimumFractionDigits: 2, maximumFractionDigits: 2
        }).format(amount);
    }

    function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) return '0';
        return new Intl.NumberFormat('en-US').format(num);
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // ============================================================
    // INITIALIZATION
    // ============================================================
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    function init() {
        initResponseCache();  // Initialize in-memory cache early
        loadTemplateProfiles(); // Load saved template profiles from localStorage
        initModeToggle();  // Initialize Simple/Pro mode toggle (v7.21)
        updateApiStatus();
        checkForDraft();
        renderImmediate();  // Use immediate render for initial load (no debounce)
        setupDropZones();
    }

    function updateApiStatus() {
        const dot = document.getElementById('apiDot');
        const text = document.getElementById('apiText');
        if (state.apiKey) {
            dot.className = 'w-2 h-2 rounded-full bg-green-400';
            text.textContent = 'API Connected';
        } else {
            dot.className = 'w-2 h-2 rounded-full bg-red-400';
            text.textContent = 'No API Key';
        }
    }

    // Update Red Flags indicator in header (v7.20)
    function updateRedFlagsIndicator() {
        const indicator = document.getElementById('redFlagsIndicator');
        const text = document.getElementById('redFlagsText');
        if (!indicator || !text) return;

        const summary = getRedFlagsSummary();
        if (summary.total > 0) {
            indicator.classList.remove('hidden');
            indicator.classList.add('flex');
            // Change color based on severity
            if (summary.critical > 0) {
                indicator.className = indicator.className.replace(/bg-amber-\d+\/?\d*/g, '').replace(/bg-red-\d+\/?\d*/g, '');
                indicator.classList.add('bg-red-600/90', 'hover:bg-red-600');
                text.textContent = `üö© ${summary.critical} Critical`;
            } else if (summary.warnings > 0) {
                indicator.className = indicator.className.replace(/bg-red-\d+\/?\d*/g, '').replace(/bg-amber-\d+\/?\d*/g, '');
                indicator.classList.add('bg-amber-500/90', 'hover:bg-amber-500');
                indicator.classList.remove('animate-pulse');
                text.textContent = `‚ö†Ô∏è ${summary.warnings} Warning${summary.warnings > 1 ? 's' : ''}`;
            } else {
                indicator.className = indicator.className.replace(/bg-red-\d+\/?\d*/g, '').replace(/bg-amber-\d+\/?\d*/g, '');
                indicator.classList.add('bg-[#F3FAFE]0/90', 'hover:bg-[#E3EDF5]0');
                indicator.classList.remove('animate-pulse');
                text.textContent = `‚ÑπÔ∏è ${summary.info} Info`;
            }
        } else {
            indicator.classList.add('hidden');
            indicator.classList.remove('flex');
        }
    }

    // Show Red Flags modal with full details (v7.20)
    function showRedFlagsModal() {
        if (state.redFlags.length === 0) {
            showToast('success', 'No Issues', 'No eligibility red flags detected.');
            return;
        }

        const summary = getRedFlagsSummary();

        // Build detailed list with upload options (v7.21 - added upload support)
        const flagsList = state.redFlags.map(flag => {
            const severityIcon = flag.severity === 'critical' ? 'üî¥' :
                                flag.severity === 'warning' ? 'üü°' : 'üîµ';
            const severityLabel = flag.severity.charAt(0).toUpperCase() + flag.severity.slice(1);
            const hasAttachments = state.supplementalDocuments.flagAttachments[flag.type]?.length > 0;
            return `
                <div class="border-b border-slate-200 pb-4 mb-4 last:border-0 last:pb-0 last:mb-0">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-lg">${severityIcon}</span>
                        <span class="font-semibold text-slate-800">${flag.message}</span>
                        <span class="px-2 py-0.5 text-xs font-medium rounded-full ${
                            flag.severity === 'critical' ? 'bg-red-100 text-red-700' :
                            flag.severity === 'warning' ? 'bg-amber-100 text-amber-700' :
                            'bg-[#E3EDF5] text-[#036CB6]'
                        }">${severityLabel}</span>
                        ${hasAttachments ? '<span class="px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700">üìé Doc Attached</span>' : ''}
                    </div>
                    <p class="text-sm text-slate-600 ml-7">${flag.details}</p>
                    <div class="ml-7 mt-2">
                        ${renderFlagSupplements(flag.type)}
                    </div>
                </div>
            `;
        }).join('');

        // Create modal
        const modalHtml = `
            <div id="redFlagsModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onclick="if(event.target.id==='redFlagsModal')closeRedFlagsModal()">
                <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
                    <div class="bg-gradient-to-r ${summary.critical > 0 ? 'from-red-600 to-red-700' : summary.warnings > 0 ? 'from-amber-500 to-amber-600' : 'from-[#38939B] to-[#036CB6]'} text-white p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/>
                                </svg>
                                <div>
                                    <h2 class="text-xl font-bold">üö© Eligibility Red Flags</h2>
                                    <p class="text-white/80 text-sm">${state.projectInfo.applicant || 'This application'}</p>
                                </div>
                            </div>
                            <button onclick="closeRedFlagsModal()" class="text-white/80 hover:text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div class="flex gap-3 mt-4">
                            ${summary.critical > 0 ? `<span class="px-3 py-1 bg-white/20 rounded-full text-sm font-medium">${summary.critical} Critical</span>` : ''}
                            ${summary.warnings > 0 ? `<span class="px-3 py-1 bg-white/20 rounded-full text-sm font-medium">${summary.warnings} Warning${summary.warnings > 1 ? 's' : ''}</span>` : ''}
                            ${summary.info > 0 ? `<span class="px-3 py-1 bg-white/20 rounded-full text-sm font-medium">${summary.info} Info</span>` : ''}
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[50vh]">
                        ${flagsList}
                    </div>
                    ${summary.critical > 0 ? `
                    <div class="border-t border-slate-200 p-4 bg-red-50">
                        <p class="text-sm text-red-800 font-medium text-center">
                            ‚ö†Ô∏è Critical issues must be resolved before this application can be considered for funding.
                        </p>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existing = document.getElementById('redFlagsModal');
        if (existing) existing.remove();

        // Add modal to DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Add escape key handler
        document.addEventListener('keydown', handleRedFlagsEscape);
    }

    function closeRedFlagsModal() {
        const modal = document.getElementById('redFlagsModal');
        if (modal) modal.remove();
        document.removeEventListener('keydown', handleRedFlagsEscape);
    }

    function handleRedFlagsEscape(e) {
        if (e.key === 'Escape') closeRedFlagsModal();
    }

    // ============================================================
    // ============================================================
    // SIMPLE / PRO MODE TOGGLE (v7.21)
    // ============================================================

    // Set UI mode (simple or pro)
    function setUIMode(mode) {
        state.uiMode = mode;
        localStorage.setItem('nofa_ui_mode', mode);

        // Toggle body class for CSS-based visibility (v7.21)
        document.body.classList.remove('simple-mode', 'pro-mode');
        document.body.classList.add(mode + '-mode');

        updateModeToggleUI();
        render(); // Re-render to apply mode-specific UI changes

        // Show helpful toast on mode change
        if (mode === 'simple') {
            showToast('info', 'Simple Mode', 'Streamlined interface for quick evaluations.');
        } else {
            showToast('info', 'Pro Mode', 'All advanced features enabled.');
        }
    }

    // Check if we're in simple mode
    function isSimpleMode() {
        return state.uiMode === 'simple';
    }

    // Update the mode toggle button appearance
    function updateModeToggleUI() {
        const simpleBtn = document.getElementById('simpleModeBtn');
        const proBtn = document.getElementById('proModeBtn');
        const settingsBtn = document.getElementById('settingsBtn');

        if (simpleBtn && proBtn) {
            if (state.uiMode === 'simple') {
                simpleBtn.className = 'px-3 py-1.5 rounded-md text-xs font-medium transition-all bg-white text-[#02538C]';
                proBtn.className = 'px-3 py-1.5 rounded-md text-xs font-medium transition-all text-white/70 hover:text-white';
            } else {
                simpleBtn.className = 'px-3 py-1.5 rounded-md text-xs font-medium transition-all text-white/70 hover:text-white';
                proBtn.className = 'px-3 py-1.5 rounded-md text-xs font-medium transition-all bg-white text-[#02538C]';
            }
        }

        // In Simple Mode, show minimal settings button
        if (settingsBtn) {
            // Settings always visible but may show different content based on mode
        }

        // Hide/show Pro-only header elements
        const autoAnalyzeBtn = document.getElementById('autoAnalyzeHeaderBtn');
        const apiErrorIndicator = document.getElementById('apiErrorIndicator');

        // Auto-analyze button: hidden in simple mode (still works, just not shown in header)
        if (autoAnalyzeBtn && state.uiMode === 'simple') {
            // In simple mode, we control this differently - it will be embedded in the workflow
        }
    }

    // Initialize mode toggle on page load
    function initModeToggle() {
        // Set initial body class based on saved mode (v7.21)
        document.body.classList.remove('simple-mode', 'pro-mode');
        document.body.classList.add(state.uiMode + '-mode');
        updateModeToggleUI();
    }

    // ============================================================
    // SETTINGS
    // ============================================================
    function showSettings() {
        document.getElementById('apiKeyInput').value = state.apiKey;
        document.getElementById('reviewerName').value = state.reviewerName;
        document.getElementById('reviewerSheet').value = state.reviewerSheet;

        // Update active profile display
        const profile = getActiveProfile();
        const displayEl = document.getElementById('activeProfileDisplay');
        if (displayEl) {
            displayEl.textContent = profile.name + (profile.isDefault ? ' (Default)' : '');
        }

        // Set vision toggle states
        const visionAutoDetectToggle = document.getElementById('visionAutoDetectToggle');
        if (visionAutoDetectToggle) {
            visionAutoDetectToggle.checked = state.visionAutoDetect;
        }

        const visionToggle = document.getElementById('visionToggle');
        if (visionToggle) {
            // Show manual toggle as checked only if explicitly enabled (not auto-enabled)
            visionToggle.checked = state.visionEnabled && !state.visionAutoEnabled;
        }

        updateVisionStatusText();

        // Update reference docs preview (v7.1)
        updateRefDocsPreview();

        const modal = document.getElementById('settingsModal');
        modal.classList.remove('hidden');

        // Focus the modal for keyboard events
        modal.focus();
    }

    function hideSettings() {
        document.getElementById('settingsModal').classList.add('hidden');
    }

    // Global keyboard handler for modals (Escape to close)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            // Close any open modal (v7.19: added external doc viewer)
            const externalDocModal = document.getElementById('externalDocViewerModal');
            const settingsModal = document.getElementById('settingsModal');
            const pdfViewerModal = document.getElementById('pdfViewerModal');
            const evidenceModal = document.getElementById('evidenceModal');
            const counterArgModal = document.getElementById('counterArgModal');
            const commentPromptModal = document.getElementById('commentPromptModal');

            // External doc viewer has highest z-index, close it first
            if (externalDocModal && !externalDocModal.classList.contains('hidden')) {
                closeExternalDocViewer();
            } else if (settingsModal && !settingsModal.classList.contains('hidden')) {
                hideSettings();
            } else if (pdfViewerModal && !pdfViewerModal.classList.contains('hidden')) {
                hidePdfViewer();
            } else if (evidenceModal) {
                evidenceModal.remove();
            } else if (counterArgModal) {
                counterArgModal.remove();
            } else if (commentPromptModal && !commentPromptModal.classList.contains('hidden')) {
                commentPromptModal.classList.add('hidden');
            }
        }
    });

    // Keyboard shortcuts for scoring and undo (v7.21)
    document.addEventListener('keydown', function(e) {
        // Don't trigger if user is typing in an input/textarea
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
            return;
        }

        // Don't trigger if a modal is open
        const settingsModal = document.getElementById('settingsModal');
        const pdfViewerModal = document.getElementById('pdfViewerModal');
        if ((settingsModal && !settingsModal.classList.contains('hidden')) ||
            (pdfViewerModal && !pdfViewerModal.classList.contains('hidden'))) {
            return;
        }

        // Ctrl+Z or Cmd+Z for undo
        if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
            e.preventDefault();
            undoLastScoreChange();
            return;
        }

        // Number keys 0-4 for quick scoring (only on scoring/globalReview steps)
        if (state.currentStep === 'scoring' || state.currentStep === 'globalReview') {
            const key = parseInt(e.key);
            if (!isNaN(key) && key >= 0 && key <= 4) {
                // Find the currently focused/visible criterion
                let targetCriterionId = null;

                if (state.currentStep === 'scoring') {
                    // In scoring step, use current criterion
                    const criterion = CRITERIA[state.currentCriterionIndex];
                    if (criterion && criterion.validScores.includes(key)) {
                        targetCriterionId = criterion.id;
                    }
                } else if (state.currentStep === 'globalReview') {
                    // In global review, find the criterion card that's most visible/focused
                    const focusedCard = document.querySelector('.global-review-card:hover, .global-review-card:focus-within');
                    if (focusedCard) {
                        const criterionDiv = focusedCard.querySelector('[data-criterion]');
                        if (criterionDiv) {
                            targetCriterionId = criterionDiv.getAttribute('data-criterion');
                        }
                    }
                }

                if (targetCriterionId) {
                    const criterion = CRITERIA.find(c => c.id === targetCriterionId);
                    if (criterion && criterion.validScores.includes(key)) {
                        updateGlobalScore(targetCriterionId, key);
                        showToast('info', 'Score Set', `${targetCriterionId.toUpperCase()}: Score ${key} (keyboard shortcut)`);
                    }
                }
            }
        }
    });

    // Click outside modal to close (for Settings modal)
    document.getElementById('settingsModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            hideSettings();
        }
    });

    // Click outside modal to close (for External Document Viewer - v7.19)
    document.getElementById('externalDocViewerModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeExternalDocViewer();
        }
    });

    // Attach onload handler for external doc viewer iframe (v7.19)
    document.getElementById('externalDocFrame')?.addEventListener('load', function() {
        onExternalDocFrameLoad();
    });

    // Prevent background scroll when modal is open and mouse is over modal content
    function preventBackgroundScroll(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;

        // When modal is shown, prevent body scroll
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === 'class') {
                    if (!modal.classList.contains('hidden')) {
                        document.body.style.overflow = 'hidden';
                    } else {
                        document.body.style.overflow = '';
                    }
                }
            });
        });
        observer.observe(modal, { attributes: true });

        // Also handle wheel events on the modal backdrop to prevent scroll-through
        modal.addEventListener('wheel', function(e) {
            const scrollableContent = modal.querySelector('.overflow-auto, .overflow-y-auto');
            if (scrollableContent) {
                const isScrollable = scrollableContent.scrollHeight > scrollableContent.clientHeight;
                const isAtTop = scrollableContent.scrollTop === 0;
                const isAtBottom = scrollableContent.scrollTop + scrollableContent.clientHeight >= scrollableContent.scrollHeight;

                // Allow scroll if content is scrollable and not at boundaries
                // Or if scrolling in the allowed direction at boundaries
                if (isScrollable) {
                    if ((isAtTop && e.deltaY < 0) || (isAtBottom && e.deltaY > 0)) {
                        e.preventDefault(); // Prevent scroll-through at boundaries
                    }
                    // Otherwise let the scroll happen naturally within the modal
                } else {
                    e.preventDefault(); // No scrollable content, prevent all scroll
                }
            }
        }, { passive: false });
    }

    // Apply scroll prevention to all modals
    preventBackgroundScroll('settingsModal');
    preventBackgroundScroll('pdfViewerModal');
    preventBackgroundScroll('commentPromptModal');

    // ============================================================
    // VISION ANALYSIS TOGGLE
    // ============================================================
    function toggleVisionAutoDetect() {
        state.visionAutoDetect = document.getElementById('visionAutoDetectToggle').checked;
        localStorage.setItem(CONFIG.VISION_AUTO_DETECT_KEY, state.visionAutoDetect);
        updateVisionStatusText();
        console.log(`[Vision] Auto-detect ${state.visionAutoDetect ? 'enabled' : 'disabled'}`);
    }

    function toggleVisionAnalysis() {
        const manualEnabled = document.getElementById('visionToggle').checked;
        state.visionEnabled = manualEnabled;
        state.visionAutoEnabled = false;  // Manual toggle overrides auto
        localStorage.setItem(CONFIG.VISION_ENABLED_KEY, state.visionEnabled);
        updateVisionStatusText();
        console.log(`[Vision] Vision analysis manually ${state.visionEnabled ? 'enabled' : 'disabled'}`);

        // If enabling and we have a PDF loaded, render pages for vision
        if (state.visionEnabled && state.pdfDocument && state.pdfPageImages.length === 0) {
            renderPdfPagesForVision(state.pdfDocument).then(() => {
                console.log(`[Vision] Rendered ${state.pdfPageImages.length} pages for vision analysis`);
                updateVisionStatusText();
            });
        }
    }

    function updateVisionStatusText() {
        const statusEl = document.getElementById('visionStatusText');
        if (!statusEl) return;

        let statusText = '';
        let statusClass = 'text-xs mt-1 ';

        if (state.visionAutoEnabled) {
            // Vision was auto-enabled for this document
            statusText = `Status: Auto-enabled for this document (${state.pdfPageImages.length} pages)`;
            statusClass += 'text-green-600 font-medium';
        } else if (state.visionEnabled) {
            // Vision is manually enabled
            if (state.pdfPageImages.length > 0) {
                statusText = `Status: Always on (${state.pdfPageImages.length} pages ready)`;
                statusClass += 'text-[#036CB6]';
            } else if (state.pdfDocument) {
                statusText = 'Status: Always on (preparing pages...)';
                statusClass += 'text-amber-600';
            } else {
                statusText = 'Status: Always on (load a PDF to begin)';
                statusClass += 'text-[#036CB6]';
            }
        } else if (state.visionAutoDetect) {
            // Auto-detect is on but no visual content detected yet
            if (state.visualContentDetected === false && state.pdfDocument) {
                statusText = 'Status: No visual content detected in current PDF';
                statusClass += 'text-slate-500';
            } else {
                statusText = 'Status: Auto-detect enabled (will scan PDFs for charts/graphs)';
                statusClass += 'text-slate-600';
            }
        } else {
            statusText = 'Status: Disabled (text-only analysis)';
            statusClass += 'text-slate-500';
        }

        statusEl.textContent = statusText;
        statusEl.className = statusClass;
    }

    // ============================================================
    // ADMIN DIAGNOSTICS PANEL
    // ============================================================
    function toggleDiagnosticsPanel() {
        const panel = document.getElementById('diagnosticsPanel');
        const toggleText = document.getElementById('diagnosticsToggleText');
        if (panel.classList.contains('hidden')) {
            updateDiagnosticsPanel();
            panel.classList.remove('hidden');
            toggleText.textContent = 'Hide';
        } else {
            panel.classList.add('hidden');
            toggleText.textContent = 'Show';
        }
    }

    function updateDiagnosticsPanel() {
        const diag = state.diagnostics;

        // Recalculate document stats if they're missing but document is loaded
        // (This happens after page refresh since diagnostics aren't persisted)
        if (diag.totalPages === 0 && state.pdfPages && state.pdfPages.length > 0) {
            diag.totalPages = state.pdfPages.length;
            diag.totalCharacters = state.applicationText ? state.applicationText.length : 0;
            // Recalculate attachment start page
            const attachmentPageIndex = state.pdfPages.findIndex(pageText =>
                /attachment\s*1\s*:|attachments?\s*index|exhibit\s*a\s*:/i.test(pageText)
            );
            diag.attachmentStartPage = attachmentPageIndex !== -1 ? attachmentPageIndex + 1 : null;
            console.log(`[Diagnostics] Recalculated from loaded document: ${diag.totalPages} pages, ${diag.totalCharacters} chars`);
        }

        // Total document info
        document.getElementById('diagTotalPages').textContent = diag.totalPages > 0 ? diag.totalPages : 'No PDF loaded';
        document.getElementById('diagTotalChars').textContent = diag.totalCharacters > 0 ? diag.totalCharacters.toLocaleString() : '-';
        document.getElementById('diagAttachStart').textContent = diag.attachmentStartPage ? `Page ${diag.attachmentStartPage}` : 'Not detected';

        // AI analysis coverage - show "Pending analysis" if document loaded but not analyzed yet
        const hasDocument = diag.totalPages > 0;
        const hasAnalysis = diag.mainContentChars > 0 || diag.criteriaAnalyzed > 0;
        const pendingText = hasDocument ? 'Pending analysis' : '-';

        document.getElementById('diagMainChars').textContent = diag.mainContentChars > 0 ? diag.mainContentChars.toLocaleString() : pendingText;
        document.getElementById('diagAttachChars').textContent = diag.attachmentChars > 0 ? diag.attachmentChars.toLocaleString() : pendingText;

        const totalToAI = diag.mainContentChars + diag.attachmentChars;
        document.getElementById('diagTotalToAI').textContent = totalToAI > 0 ? totalToAI.toLocaleString() : pendingText;

        // Calculate coverage percentage
        if (diag.totalCharacters > 0 && totalToAI > 0) {
            const coverage = Math.min(100, (totalToAI / diag.totalCharacters) * 100).toFixed(1);
            document.getElementById('diagCoverage').textContent = `${coverage}%`;
        } else {
            document.getElementById('diagCoverage').textContent = pendingText;
        }

        // Criteria and timestamp
        document.getElementById('diagCriteriaCount').textContent = diag.criteriaAnalyzed > 0 ? diag.criteriaAnalyzed : pendingText;

        if (diag.lastAnalysisTimestamp) {
            const date = new Date(diag.lastAnalysisTimestamp);
            document.getElementById('diagLastAnalysis').textContent = date.toLocaleString();
        } else {
            document.getElementById('diagLastAnalysis').textContent = 'Not yet analyzed';
        }

        // Vision analysis status
        const visionStatusEl = document.getElementById('diagVisionStatus');
        if (visionStatusEl) {
            if (state.visionAutoEnabled) {
                visionStatusEl.textContent = `Auto-enabled (${state.pdfPageImages.length} pages)`;
                visionStatusEl.className = 'text-green-600 font-medium';
            } else if (state.visionEnabled) {
                if (state.pdfPageImages.length > 0) {
                    visionStatusEl.textContent = `Always on (${state.pdfPageImages.length} pages)`;
                    visionStatusEl.className = 'text-[#036CB6] font-medium';
                } else {
                    visionStatusEl.textContent = 'Always on (no pages rendered)';
                    visionStatusEl.className = 'text-amber-600 font-medium';
                }
            } else if (state.visionAutoDetect) {
                visionStatusEl.textContent = 'Auto-detect (no visuals found)';
                visionStatusEl.className = 'text-slate-500';
            } else {
                visionStatusEl.textContent = 'Disabled';
                visionStatusEl.className = 'text-slate-500';
            }
        }
    }

    function copyDiagnosticsToClipboard() {
        const diag = state.diagnostics;
        const totalToAI = diag.mainContentChars + diag.attachmentChars;
        const coverage = diag.totalCharacters > 0 ? ((totalToAI / diag.totalCharacters) * 100).toFixed(1) : 0;

        let visionStatus = 'Disabled';
        if (state.visionAutoEnabled) {
            visionStatus = `Auto-enabled (${state.pdfPageImages.length} pages rendered)`;
        } else if (state.visionEnabled) {
            visionStatus = `Always on (${state.pdfPageImages.length} pages rendered)`;
        } else if (state.visionAutoDetect) {
            visionStatus = 'Auto-detect enabled (no visuals detected)';
        }

        const text = `NOFA AI Evaluator - Document Diagnostics
==========================================
Document: ${state.projectInfo.projectName || 'Unnamed'}
Total Pages: ${diag.totalPages}
Total Characters: ${diag.totalCharacters.toLocaleString()}
Attachments Start: ${diag.attachmentStartPage ? 'Page ' + diag.attachmentStartPage : 'Not detected'}

AI Analysis Coverage:
- Main Content: ${diag.mainContentChars.toLocaleString()} chars
- Attachments: ${diag.attachmentChars.toLocaleString()} chars
- Total Sent to AI: ${totalToAI.toLocaleString()} chars
- Coverage: ${coverage}%
- Vision Analysis: ${visionStatus}

Criteria Analyzed: ${diag.criteriaAnalyzed}
Last Analysis: ${diag.lastAnalysisTimestamp ? new Date(diag.lastAnalysisTimestamp).toLocaleString() : 'N/A'}
==========================================`;

        navigator.clipboard.writeText(text).then(() => {
            showToast('success', 'Copied', 'Diagnostics copied to clipboard');
        }).catch(() => {
            showToast('error', 'Copy Failed', 'Could not copy to clipboard');
        });
    }

    function saveSettings() {
        state.apiKey = document.getElementById('apiKeyInput').value.trim();
        state.reviewerName = document.getElementById('reviewerName').value.trim();
        state.reviewerSheet = document.getElementById('reviewerSheet').value;
        localStorage.setItem('nofa_api_key', state.apiKey);
        localStorage.setItem('nofa_reviewer', state.reviewerName);
        localStorage.setItem('nofa_reviewer_sheet', state.reviewerSheet);
        updateApiStatus();
        hideSettings();
        showToast('success', 'Settings Saved', 'Your settings have been updated.');
        render();
    }

    function clearApiKey() {
        state.apiKey = '';
        localStorage.removeItem('nofa_api_key');
        document.getElementById('apiKeyInput').value = '';
        updateApiStatus();
    }

    function toggleApiKeyVisibility() {
        const input = document.getElementById('apiKeyInput');
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    // ============================================================
    // TEMPLATE CONFIGURATION UI
    // ============================================================
    let editingProfileId = null;
    let editingProfile = null;

    function showTemplateConfig() {
        editingProfileId = activeProfileId;
        editingProfile = JSON.parse(JSON.stringify(getActiveProfile())); // Deep copy
        populateTemplateProfileSelector();
        renderTemplateConfigContent();
        document.getElementById('templateConfigModal').classList.remove('hidden');
    }

    function hideTemplateConfig() {
        document.getElementById('templateConfigModal').classList.add('hidden');
        editingProfileId = null;
        editingProfile = null;
    }

    function populateTemplateProfileSelector() {
        const selector = document.getElementById('templateProfileSelector');
        selector.innerHTML = '';
        for (const [id, profile] of Object.entries(TEMPLATE_PROFILES)) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = profile.name + (profile.isDefault ? ' (Default)' : '');
            option.selected = id === editingProfileId;
            selector.appendChild(option);
        }
    }

    function loadSelectedTemplateProfile() {
        const selector = document.getElementById('templateProfileSelector');
        editingProfileId = selector.value;
        editingProfile = JSON.parse(JSON.stringify(TEMPLATE_PROFILES[editingProfileId]));
        renderTemplateConfigContent();
    }

    function createNewTemplateProfile() {
        const baseName = 'Custom Template';
        let count = 1;
        let newId = 'custom-' + Date.now();

        // Create new profile based on default
        const newProfile = JSON.parse(JSON.stringify(DEFAULT_TEMPLATE_PROFILE));
        newProfile.id = newId;
        newProfile.name = baseName + ' ' + count;
        newProfile.isDefault = false;
        newProfile.description = 'Custom scoring template';
        newProfile.version = '1.0';

        TEMPLATE_PROFILES[newId] = newProfile;
        editingProfileId = newId;
        editingProfile = JSON.parse(JSON.stringify(newProfile));

        populateTemplateProfileSelector();
        renderTemplateConfigContent();
        showToast('info', 'New Profile', 'Created new template profile. Configure and save.');
    }

    function renderTemplateConfigContent() {
        const content = document.getElementById('templateConfigContent');
        if (!editingProfile) {
            content.innerHTML = '<p class="text-slate-500">No profile selected</p>';
            return;
        }

        const sheets = editingProfile.reviewerSheets || {};
        const sheetNames = Object.keys(sheets);

        let html = `
            <div class="space-y-6">
                <!-- Profile Info -->
                <div class="bg-slate-50 rounded-xl p-4">
                    <h4 class="font-semibold text-slate-800 mb-3">Profile Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Profile Name</label>
                            <input type="text" id="profileName" value="${editingProfile.name || ''}"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"
                                ${editingProfile.isDefault ? 'disabled' : ''}>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                            <input type="text" id="profileDescription" value="${editingProfile.description || ''}"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"
                                ${editingProfile.isDefault ? 'disabled' : ''}>
                        </div>
                    </div>
                    ${editingProfile.isDefault ? '<p class="text-xs text-amber-600 mt-2">Default profile cannot be modified. Create a new profile to customize.</p>' : ''}
                </div>

                <!-- Reviewer Sheets Configuration -->
                <div>
                    <h4 class="font-semibold text-slate-800 mb-3">Reviewer Sheet Mappings</h4>
                    <div class="space-y-4">
        `;

        for (const [sheetKey, sheetConfig] of Object.entries(sheets)) {
            html += `
                <div class="border border-slate-200 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h5 class="font-medium text-slate-800">${sheetConfig.name}</h5>
                            <p class="text-xs text-slate-500">Sheet: ${sheetKey}</p>
                        </div>
                        <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs">${sheetConfig.description}</span>
                    </div>

                    <!-- Project Info Mappings -->
                    <div class="mb-4">
                        <p class="text-sm font-medium text-slate-700 mb-2">Project Info Fields</p>
                        <div class="grid grid-cols-4 gap-2">
                            ${Object.entries(sheetConfig.projectInfo || {}).map(([field, cell]) => `
                                <div class="flex items-center gap-2">
                                    <label class="text-xs text-slate-600 w-20 truncate" title="${field}">${field}:</label>
                                    <input type="text" value="${cell}"
                                        data-sheet="${sheetKey}" data-section="projectInfo" data-field="${field}"
                                        class="flex-1 px-2 py-1 border border-slate-300 rounded text-xs font-mono template-cell-input"
                                        ${editingProfile.isDefault ? 'disabled' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Score Mappings -->
                    <div class="mb-4">
                        <p class="text-sm font-medium text-slate-700 mb-2">Score Cells</p>
                        <div class="grid grid-cols-7 gap-2">
                            ${Object.entries(sheetConfig.scores || {}).map(([id, cell]) => `
                                <div class="flex items-center gap-1">
                                    <label class="text-xs text-slate-600">${id}:</label>
                                    <input type="text" value="${cell}"
                                        data-sheet="${sheetKey}" data-section="scores" data-field="${id}"
                                        class="flex-1 px-2 py-1 border border-slate-300 rounded text-xs font-mono template-cell-input"
                                        ${editingProfile.isDefault ? 'disabled' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Comment Mappings -->
                    <div class="mb-4">
                        <p class="text-sm font-medium text-slate-700 mb-2">Comment Cells</p>
                        <div class="grid grid-cols-7 gap-2">
                            ${Object.entries(sheetConfig.comments || {}).map(([id, cell]) => `
                                <div class="flex items-center gap-1">
                                    <label class="text-xs text-slate-600">${id}:</label>
                                    <input type="text" value="${cell}"
                                        data-sheet="${sheetKey}" data-section="comments" data-field="${id}"
                                        class="flex-1 px-2 py-1 border border-slate-300 rounded text-xs font-mono template-cell-input"
                                        ${editingProfile.isDefault ? 'disabled' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Recommendation Mappings -->
                    <div>
                        <p class="text-sm font-medium text-slate-700 mb-2">Recommendation Fields</p>
                        <div class="grid grid-cols-3 gap-2">
                            ${Object.entries(sheetConfig.recommendation || {}).filter(([k]) => k !== 'questionCells').map(([field, cell]) => `
                                <div class="flex items-center gap-2">
                                    <label class="text-xs text-slate-600 w-24 truncate" title="${field}">${field}:</label>
                                    <input type="text" value="${cell}"
                                        data-sheet="${sheetKey}" data-section="recommendation" data-field="${field}"
                                        class="flex-1 px-2 py-1 border border-slate-300 rounded text-xs font-mono template-cell-input"
                                        ${editingProfile.isDefault ? 'disabled' : ''}>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        html += `
                    </div>
                </div>

                <!-- Help Section -->
                <div class="bg-[#F3FAFE] rounded-xl p-4">
                    <h4 class="font-semibold text-[#02538C] mb-2">Cell Reference Format</h4>
                    <p class="text-sm text-[#036CB6]">
                        Use Excel-style cell references (e.g., A1, B23, H64). These map to specific cells in your scoring template spreadsheet.
                    </p>
                </div>
            </div>
        `;

        content.innerHTML = html;

        // Add event listeners for cell inputs
        if (!editingProfile.isDefault) {
            document.querySelectorAll('.template-cell-input').forEach(input => {
                input.addEventListener('change', updateEditingProfile);
            });
        }
    }

    function updateEditingProfile(event) {
        const input = event.target;
        const sheetKey = input.dataset.sheet;
        const section = input.dataset.section;
        const field = input.dataset.field;
        const value = input.value.trim().toUpperCase();

        if (editingProfile && editingProfile.reviewerSheets[sheetKey]) {
            if (!editingProfile.reviewerSheets[sheetKey][section]) {
                editingProfile.reviewerSheets[sheetKey][section] = {};
            }
            editingProfile.reviewerSheets[sheetKey][section][field] = value;
        }
    }

    function saveTemplateConfig() {
        if (!editingProfile) return;

        // Update profile name and description
        const nameInput = document.getElementById('profileName');
        const descInput = document.getElementById('profileDescription');
        if (nameInput && !editingProfile.isDefault) {
            editingProfile.name = nameInput.value.trim() || editingProfile.name;
        }
        if (descInput && !editingProfile.isDefault) {
            editingProfile.description = descInput.value.trim() || editingProfile.description;
        }

        // Save to TEMPLATE_PROFILES
        TEMPLATE_PROFILES[editingProfileId] = editingProfile;

        // Set as active profile
        setActiveProfile(editingProfileId);
        state.activeTemplateId = editingProfileId;

        // Save to localStorage
        saveTemplateProfiles();

        hideTemplateConfig();
        showToast('success', 'Template Saved', `Profile "${editingProfile.name}" saved and activated.`);
        render();
    }

    // ============================================================
    // PDF VIEWER
    // ============================================================
    let currentEvidenceCriterion = null; // Track which criterion's evidence we're viewing
    let currentSearchTerms = []; // Store current search terms for highlighting
    let pdfViewMode = 'visual'; // 'visual' or 'text'
    let pdfZoomScale = 1.0; // Current zoom level for visual mode
    let currentPdfRenderTask = null; // Track current PDF render task to prevent canvas conflicts (v7.19)

    function showPdfViewer(context, searchTerms = [], fromEvidenceModal = false, criterionId = null) {
        document.getElementById('pdfViewerContext').textContent = context;
        document.getElementById('pdfViewerModal').classList.remove('hidden');

        // Store search terms for use when navigating pages
        currentSearchTerms = searchTerms;

        // Show/hide back button based on whether we came from evidence modal
        const backBtn = document.getElementById('backToEvidenceBtn');
        if (fromEvidenceModal && criterionId) {
            currentEvidenceCriterion = criterionId;
            backBtn.classList.remove('hidden');
            backBtn.classList.add('flex');
        } else {
            currentEvidenceCriterion = null;
            backBtn.classList.add('hidden');
            backBtn.classList.remove('flex');
        }

        // Set initial view mode and render
        setPdfViewMode(pdfViewMode);
        renderPdfPage(state.pdfViewerCurrentPage, searchTerms);

        // Update linked documents panel in PDF viewer (v7.17)
        updatePdfLinkedDocsPanel();
    }

    // Switch between visual and text view modes
    function setPdfViewMode(mode) {
        pdfViewMode = mode;
        const visualView = document.getElementById('pdfVisualView');
        const textView = document.getElementById('pdfTextView');
        const visualBtn = document.getElementById('visualViewBtn');
        const textBtn = document.getElementById('textViewBtn');
        const zoomControls = document.getElementById('zoomControls');

        if (mode === 'visual') {
            visualView.classList.remove('hidden');
            textView.classList.add('hidden');
            visualBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-md transition-colors bg-white text-[#036CB6] shadow-sm';
            textBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-md transition-colors text-slate-600 hover:text-slate-800';
            zoomControls.classList.remove('hidden');
            // Render visual PDF page
            renderVisualPdfPage(state.pdfViewerCurrentPage);
        } else {
            visualView.classList.add('hidden');
            textView.classList.remove('hidden');
            textBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-md transition-colors bg-white text-[#036CB6] shadow-sm';
            visualBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-md transition-colors text-slate-600 hover:text-slate-800';
            zoomControls.classList.add('hidden');
            // Render text view
            renderTextPdfPage(state.pdfViewerCurrentPage, currentSearchTerms);
        }
    }

    // Zoom controls for visual PDF view
    function zoomPdf(delta) {
        pdfZoomScale = Math.max(0.5, Math.min(3.0, pdfZoomScale + delta));
        document.getElementById('zoomLevel').textContent = Math.round(pdfZoomScale * 100) + '%';
        renderVisualPdfPage(state.pdfViewerCurrentPage);
    }

    // Render PDF page as visual image (shows graphics, charts, etc.)
    async function renderVisualPdfPage(pageIndex) {
        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');

        // Cancel any existing render task to prevent "Cannot use the same canvas during multiple render() operations" error (v7.19)
        if (currentPdfRenderTask) {
            try {
                currentPdfRenderTask.cancel();
                console.log('[PDF Visual] Cancelled previous render task');
            } catch (cancelError) {
                // Ignore cancel errors - task may have already completed
            }
            currentPdfRenderTask = null;
        }

        // Check if PDF document is available
        if (!state.pdfDocument) {
            console.warn('[PDF Visual] No PDF document loaded, attempting to reload from file');

            // Try to reload the PDF from the stored file
            if (state.applicationPDF) {
                try {
                    const arrayBuffer = await state.applicationPDF.arrayBuffer();
                    state.pdfDocument = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    console.log('[PDF Visual] Reloaded PDF document');
                } catch (reloadError) {
                    console.error('[PDF Visual] Failed to reload PDF:', reloadError);
                    showPdfLoadError(canvas, ctx, 'PDF not available. Please reload the document.');
                    return;
                }
            } else {
                // This happens when restoring a saved draft - text was saved but PDF file wasn't
                showPdfReuploadPrompt(canvas, ctx);
                return;
            }
        }

        try {
            const pageNum = Math.max(1, Math.min(pageIndex + 1, state.pdfDocument.numPages));
            console.log(`[PDF Visual] Rendering page ${pageNum} of ${state.pdfDocument.numPages}`);

            const page = await state.pdfDocument.getPage(pageNum);

            // Calculate scale based on zoom level
            const baseScale = 1.5; // Base rendering quality
            const scale = baseScale * pdfZoomScale;

            // Get viewport - let PDF.js handle rotation automatically
            // DO NOT pass page.rotate to getViewport() as it causes double-rotation on some PDFs
            // PDF.js already accounts for the page's rotation metadata internally
            const viewport = page.getViewport({ scale: scale });

            // Set canvas dimensions based on viewport (accounts for rotation)
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            // Ensure canvas is visible
            canvas.style.display = 'block';

            // Clear canvas with white background first
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Render the PDF page with proper transform
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport,
                background: 'white'
            };

            // Store the render task so it can be cancelled if user navigates/zooms quickly (v7.19)
            const renderTask = page.render(renderContext);
            currentPdfRenderTask = renderTask;

            await renderTask.promise;

            // Clear the task reference after successful completion
            currentPdfRenderTask = null;

            console.log(`[PDF Visual] Successfully rendered page ${pageNum} (${canvas.width}x${canvas.height}) at ${Math.round(pdfZoomScale * 100)}% zoom`);
        } catch (error) {
            // Check if this was a cancellation (not a real error) (v7.19)
            if (error && error.name === 'RenderingCancelledException') {
                console.log('[PDF Visual] Render was cancelled (user navigated/zoomed)');
                return; // Don't show error for intentional cancellation
            }
            console.error('[PDF Visual] Render error:', error);
            showPdfLoadError(canvas, ctx, 'Unable to render page: ' + (error?.message || 'Unknown error'));
        }
    }

    // Helper to show error message on canvas
    function showPdfLoadError(canvas, ctx, message) {
        canvas.width = 600;
        canvas.height = 400;
        ctx.fillStyle = '#f1f5f9';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#64748b';
        ctx.font = '16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(message, canvas.width / 2, canvas.height / 2);
    }

    // Show re-upload prompt when viewing restored draft without PDF file
    function showPdfReuploadPrompt(canvas, ctx) {
        // Hide the canvas and show a helpful message in the visual view container
        canvas.style.display = 'none';

        const visualView = document.getElementById('pdfVisualView');
        const existingPrompt = visualView.querySelector('.reupload-prompt');
        if (existingPrompt) return; // Already showing prompt

        const promptDiv = document.createElement('div');
        promptDiv.className = 'reupload-prompt text-center p-8';
        promptDiv.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg p-8 max-w-md mx-auto">
                <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">PDF File Needed for Visual View</h3>
                <p class="text-sm text-slate-600 mb-4">
                    This is a restored session. The text content was saved, but PDF files cannot be stored in the browser.
                    To view the visual PDF with charts and graphics, please re-upload the same PDF file.
                </p>
                <p class="text-xs text-slate-500 mb-4">
                    <strong>Your scores and comments are safe</strong> ‚Äî re-uploading will only add visual viewing capability.
                </p>
                <div class="flex gap-3 justify-center">
                    <label class="px-4 py-2 bg-[#38939B] text-white rounded-lg hover:bg-[#2a7078] cursor-pointer transition-colors">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Re-upload PDF
                        <input type="file" accept=".pdf" class="hidden" onchange="reuploadPdfForViewer(this.files[0])">
                    </label>
                    <button onclick="setPdfViewMode('text')" class="px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors">
                        Use Text View
                    </button>
                </div>
            </div>
        `;
        visualView.appendChild(promptDiv);
    }

    // Handle PDF re-upload from the visual viewer prompt
    async function reuploadPdfForViewer(file) {
        if (!file || !file.name.toLowerCase().endsWith('.pdf')) {
            showToast('error', 'Invalid File', 'Please select a PDF file.');
            return;
        }

        try {
            // Store the file and load the PDF document
            state.applicationPDF = file;
            const arrayBuffer = await file.arrayBuffer();
            state.pdfDocument = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            // Remove the re-upload prompt
            const visualView = document.getElementById('pdfVisualView');
            const prompt = visualView.querySelector('.reupload-prompt');
            if (prompt) prompt.remove();

            // Show the canvas again
            const canvas = document.getElementById('pdfCanvas');
            canvas.style.display = 'block';

            // Render the current page
            renderVisualPdfPage(state.pdfViewerCurrentPage);

            showToast('success', 'PDF Loaded', 'Visual view is now available. Your scores and comments are preserved.');
        } catch (error) {
            console.error('[PDF Reupload] Error:', error);
            showToast('error', 'Upload Failed', 'Could not load the PDF file. Please try again.');
        }
    }

    // Render PDF page as text with highlighting (original functionality)
    function renderTextPdfPage(pageIndex, searchTerms = null) {
        if (!state.pdfPages.length) return;
        const termsToUse = searchTerms !== null ? searchTerms : currentSearchTerms;
        const pageText = state.pdfPages[pageIndex] || '';
        let displayText = pageText;

        // Build search phrases and apply highlighting (v7.19 - improved accuracy)
        const searchPhrases = [];
        console.log(`[PDF Highlight] Processing ${termsToUse.length} search terms`);

        termsToUse.forEach((term, idx) => {
            if (!term || term.length < 4) return;

            const normalizedTerm = term.replace(/\s+/g, ' ').trim();
            console.log(`[PDF Highlight] Term ${idx + 1}: "${normalizedTerm.substring(0, 50)}..." (${normalizedTerm.length} chars)`);

            // Always add the full term (removed 100 char limit that was causing misses)
            if (normalizedTerm.length >= 10) {
                searchPhrases.push(normalizedTerm);
            }

            // Split by sentence boundaries and add meaningful phrases
            const sentences = normalizedTerm.split(/[.!?]/).filter(p => p.trim().length > 10);
            sentences.forEach(s => {
                const cleaned = s.trim();
                if (cleaned.length >= 10) searchPhrases.push(cleaned);
            });

            // Also split by commas for clause-level matching
            const clauses = normalizedTerm.split(/[,;]/).filter(p => p.trim().length > 15);
            clauses.forEach(c => {
                const cleaned = c.trim();
                if (cleaned.length >= 15 && cleaned.length <= 150) searchPhrases.push(cleaned);
            });

            // Add progressive substrings for very long excerpts (helps with partial matches)
            if (normalizedTerm.length > 80) {
                searchPhrases.push(normalizedTerm.substring(0, 80));
                searchPhrases.push(normalizedTerm.substring(0, 60));
            }
            if (normalizedTerm.length > 40) {
                searchPhrases.push(normalizedTerm.substring(0, 40));
            }
        });

        // Remove duplicates and sort by length (longest first for better matching)
        const uniquePhrases = [...new Set(searchPhrases)].sort((a, b) => b.length - a.length);
        console.log(`[PDF Highlight] Generated ${uniquePhrases.length} unique search phrases`);

        let matchCount = 0;
        uniquePhrases.forEach(phrase => {
            if (phrase && phrase.length >= 10) {
                const escaped = phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                // Allow flexible whitespace matching (PDF text often has different spacing)
                const flexiblePattern = escaped.replace(/ /g, '\\s+');
                try {
                    const regex = new RegExp(`(${flexiblePattern})`, 'gi');
                    const beforeLength = displayText.length;
                    displayText = displayText.replace(regex, '<span class="highlight-text">$1</span>');
                    if (displayText.length > beforeLength) matchCount++;
                } catch (e) {
                    console.warn(`[PDF Highlight] Invalid regex for phrase: ${phrase.substring(0, 30)}...`);
                }
            }
        });
        console.log(`[PDF Highlight] Applied ${matchCount} highlights`);

        document.getElementById('pdfTextView').innerHTML = `<div class="prose max-w-none"><div class="text-sm text-slate-600 whitespace-pre-wrap leading-relaxed">${displayText}</div></div>`;
    }

    function hidePdfViewer() {
        document.getElementById('pdfViewerModal').classList.add('hidden');
        currentEvidenceCriterion = null;
        currentSearchTerms = [];
        document.getElementById('backToEvidenceBtn').classList.add('hidden');
    }

    function backToEvidenceModal() {
        if (currentEvidenceCriterion) {
            // BUGFIX: Save criterion ID before hidePdfViewer() clears it
            const criterionId = currentEvidenceCriterion;
            hidePdfViewer();
            showEvidenceForCriterion(criterionId);
        }
    }

    // Main render function that handles both visual and text modes
    function renderPdfPage(pageIndex, searchTerms = null) {
        if (!state.pdfPages.length) return;

        // Store search terms
        if (searchTerms !== null) {
            currentSearchTerms = searchTerms;
        }

        // Update current page index
        state.pdfViewerCurrentPage = Math.max(0, Math.min(pageIndex, state.pdfPages.length - 1));

        // Update page input and total
        document.getElementById('pdfPageInput').value = state.pdfViewerCurrentPage + 1;
        document.getElementById('pdfPageInput').max = state.pdfPages.length;
        document.getElementById('pdfTotalPages').textContent = state.pdfPages.length;

        // Render based on current view mode
        if (pdfViewMode === 'visual') {
            renderVisualPdfPage(state.pdfViewerCurrentPage);
        } else {
            renderTextPdfPage(state.pdfViewerCurrentPage, currentSearchTerms);
        }
    }

    function pdfViewerPrevPage() { renderPdfPage(state.pdfViewerCurrentPage - 1); }
    function pdfViewerNextPage() { renderPdfPage(state.pdfViewerCurrentPage + 1); }

    function goToPage() {
        const input = document.getElementById('pdfPageInput');
        let pageNum = parseInt(input.value, 10);
        if (isNaN(pageNum) || pageNum < 1) pageNum = 1;
        if (pageNum > state.pdfPages.length) pageNum = state.pdfPages.length;
        input.value = pageNum; // Correct any out-of-range input
        renderPdfPage(pageNum - 1, currentSearchTerms);
    }

    function searchInPdf() {
        const term = document.getElementById('pdfSearchInput').value.trim();
        if (!term) return;

        // Find all pages containing the search term
        const matchingPages = [];
        for (let i = 0; i < state.pdfPages.length; i++) {
            if (state.pdfPages[i].toLowerCase().includes(term.toLowerCase())) {
                matchingPages.push(i);
            }
        }

        if (matchingPages.length === 0) {
            showToast('info', 'Not Found', `"${term}" not found in document.`);
            return;
        }

        // Find next matching page from current position (allows cycling through matches)
        let nextPage = matchingPages.find(p => p > state.pdfViewerCurrentPage);
        if (nextPage === undefined) {
            nextPage = matchingPages[0]; // Wrap to first match
        }

        // Update search terms and navigate to page
        currentSearchTerms = [term];
        state.pdfViewerCurrentPage = nextPage;
        renderPdfPage(nextPage, [term]);

        // Show result message
        if (pdfViewMode === 'visual') {
            showToast('success', 'Found', `Page ${nextPage + 1} (${matchingPages.length} match${matchingPages.length > 1 ? 'es' : ''}). Use Text view for highlighting.`);
        } else {
            showToast('success', 'Found', `Page ${nextPage + 1} of ${matchingPages.length} match${matchingPages.length > 1 ? 'es' : ''}`);
        }
    }

    // Helper function to find the best page for excerpts
    function findBestPageForExcerpts(excerpts) {
        if (!excerpts || excerpts.length === 0) return 0;

        // Try each excerpt and find the page with the best match
        for (const excerpt of excerpts) {
            // Normalize the excerpt - remove extra whitespace
            const normalizedExcerpt = excerpt.replace(/\s+/g, ' ').trim();

            // Try progressively shorter search terms
            const searchLengths = [80, 50, 30, 20];
            for (const len of searchLengths) {
                if (normalizedExcerpt.length < len) continue;
                const searchTerm = normalizedExcerpt.substring(0, len).toLowerCase();

                for (let i = 0; i < state.pdfPages.length; i++) {
                    // Normalize page text too
                    const normalizedPage = state.pdfPages[i].replace(/\s+/g, ' ').toLowerCase();
                    if (normalizedPage.includes(searchTerm)) {
                        return i;
                    }
                }
            }

            // Try searching for key phrases (split by commas or periods)
            const keyPhrases = normalizedExcerpt.split(/[,.]/).filter(p => p.trim().length > 15);
            for (const phrase of keyPhrases) {
                const cleanPhrase = phrase.trim().toLowerCase().substring(0, 40);
                for (let i = 0; i < state.pdfPages.length; i++) {
                    const normalizedPage = state.pdfPages[i].replace(/\s+/g, ' ').toLowerCase();
                    if (normalizedPage.includes(cleanPhrase)) {
                        return i;
                    }
                }
            }
        }

        return 0; // Default to first page if nothing found
    }

    // View document for a specific criterion - uses AI excerpts if available
    function viewDocumentForCriterion(criterionId) {
        const suggestion = state.aiSuggestions[criterionId];
        const criterion = CRITERIA.find(c => c.id === criterionId);
        const excerpts = suggestion?.relevantExcerpts || [];

        if (excerpts.length > 0) {
            state.pdfViewerCurrentPage = findBestPageForExcerpts(excerpts);
            showPdfViewer(`Reviewing: ${criterion?.question || criterionId}`, excerpts);
        } else {
            showPdfViewer(`Reviewing: ${criterion?.question || criterionId}`, []);
        }
    }

    // View document with specific excerpts and navigate to first match
    function viewDocumentWithExcerpts(excerpts) {
        if (excerpts && excerpts.length > 0) {
            state.pdfViewerCurrentPage = findBestPageForExcerpts(excerpts);
            showPdfViewer('Evidence Location', excerpts);
        } else {
            showPdfViewer('Document', []);
        }
    }

    // ============================================================
    // COMMENT PROMPT MODAL
    // ============================================================
    let pendingCommentCallback = null;

    function showCommentPrompt(criterion, selectedScore, aiSuggestedScore) {
        const isDifferentFromAI = aiSuggestedScore !== undefined && selectedScore !== aiSuggestedScore;
        let promptText = isDifferentFromAI
            ? `You selected a score of ${selectedScore}, which differs from the AI suggestion of ${aiSuggestedScore}. Please explain your reasoning.`
            : `Please provide your reasoning for the score of ${selectedScore}.`;
        document.getElementById('commentPromptText').textContent = promptText;
        const suggestionsHtml = criterion.reasoningStarters.map((starter, i) => `
            <button onclick="useReasoningStarter(${i})" class="text-left w-full px-3 py-2 text-sm text-[#036CB6] hover:bg-[#E3EDF5] rounded-lg transition-colors" role="listitem">
                "${starter}"
            </button>
        `).join('');
        document.getElementById('reasoningSuggestions').innerHTML = suggestionsHtml;
        document.getElementById('promptedComment').value = state.comments[criterion.id] || '';
        document.getElementById('commentPromptModal').classList.remove('hidden');
        pendingCommentCallback = criterion;
    }

    function useReasoningStarter(index) {
        const criterion = pendingCommentCallback;
        if (criterion && criterion.reasoningStarters[index]) {
            document.getElementById('promptedComment').value = criterion.reasoningStarters[index];
        }
    }

    function savePromptedComment() {
        if (pendingCommentCallback) {
            state.comments[pendingCommentCallback.id] = document.getElementById('promptedComment').value;
            debouncedAutoSave();
        }
        document.getElementById('commentPromptModal').classList.add('hidden');
        pendingCommentCallback = null;
        proceedToNextCriterion();
    }

    function skipCommentPrompt() {
        document.getElementById('commentPromptModal').classList.add('hidden');
        pendingCommentCallback = null;
        proceedToNextCriterion();
    }

    // ============================================================
    // DROP ZONES & FILE HANDLING
    // ============================================================
    function setupDropZones() {
        setTimeout(() => {
            const templateZone = document.getElementById('templateDropZone');
            const templateInput = document.getElementById('templateInput');
            if (templateZone && templateInput) setupDropZone(templateZone, templateInput, handleTemplateUpload);
            const pdfZone = document.getElementById('pdfDropZone');
            const pdfInput = document.getElementById('pdfInput');
            if (pdfZone && pdfInput) setupDropZone(pdfZone, pdfInput, handlePDFUpload);
        }, 100);
    }

    function setupDropZone(zone, input, handler) {
        // BUGFIX: Prevent duplicate event listeners by checking if already setup
        if (zone.dataset.dropzoneInitialized === 'true') return;
        zone.dataset.dropzoneInitialized = 'true';

        // Also mark the input to prevent duplicate change handlers
        if (input.dataset.inputInitialized === 'true') return;
        input.dataset.inputInitialized = 'true';

        zone.addEventListener('click', () => input.click());
        input.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handler(e.target.files[0]);
                // Reset the input value so the same file can be re-uploaded if needed
                e.target.value = '';
            }
        });
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', (e) => { e.preventDefault(); zone.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) handler(e.dataTransfer.files[0]); });
    }

    async function handlePDFUpload(file) {
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            showError('Invalid File Type', 'Please upload a PDF file.');
            return;
        }
        const maxSize = CONFIG.MAX_PDF_SIZE_MB * 1024 * 1024;
        if (file.size > maxSize) {
            showError('File Too Large', `Maximum file size is ${CONFIG.MAX_PDF_SIZE_MB}MB. Your file is ${formatFileSize(file.size)}.`);
            return;
        }
        state.applicationPDF = file;
        state.pdfDocument = null; // Store reference for vision rendering
        showLoading('Processing PDF', `Extracting text from ${file.name}...`, true);
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            state.pdfDocument = pdf; // Store for later vision rendering

            // OPTIMIZATION: Extract pages in parallel batches for faster processing
            const numPages = pdf.numPages;
            const pageTexts = new Array(numPages);
            const batchSize = 5; // Process 5 pages at a time

            for (let start = 0; start < numPages; start += batchSize) {
                const end = Math.min(start + batchSize, numPages);
                updateLoadingProgress(Math.round((start / numPages) * 100), `Pages ${start + 1}-${end} of ${numPages}`);

                // Process batch in parallel
                const batchPromises = [];
                for (let i = start; i < end; i++) {
                    batchPromises.push(
                        pdf.getPage(i + 1).then(async page => {
                            const textContent = await page.getTextContent();
                            return { index: i, text: textContent.items.map(item => item.str).join(' ') };
                        })
                    );
                }
                const results = await Promise.all(batchPromises);
                results.forEach(r => { pageTexts[r.index] = r.text; });
            }

            // Build full text from ordered pages
            state.pdfPages = pageTexts;
            let fullText = pageTexts.map((text, i) => `\n--- Page ${i + 1} ---\n${text}`).join('');
            state.applicationText = fullText;

            // CONSISTENCY: Compute and store document hash for tracking
            const normalizedText = normalizeText(fullText);
            state.documentHash = await hashText(normalizedText);
            state.cachedCriteriaCount = 0; // Reset cache counter for new document
            console.log(`[Document Hash] ${state.documentHash.substring(0, 16)}...`);

            // Update diagnostics
            state.diagnostics.totalPages = pdf.numPages;
            state.diagnostics.totalCharacters = fullText.length;
            state.diagnostics.criteriaAnalyzed = 0;

            // Find which page attachments start on
            const attachmentPageIndex = state.pdfPages.findIndex(pageText =>
                /attachment\s*1\s*:|attachments?\s*index|exhibit\s*a\s*:/i.test(pageText)
            );
            state.diagnostics.attachmentStartPage = attachmentPageIndex !== -1 ? attachmentPageIndex + 1 : null;

            console.log(`[Diagnostics] Pages: ${pdf.numPages}, Total chars: ${fullText.length}, Attachments start: Page ${state.diagnostics.attachmentStartPage || 'N/A'}`);

            // Auto-detect visual content if auto-detection is enabled
            state.visionAutoEnabled = false;
            state.visualContentDetected = false;

            if (state.visionAutoDetect && !state.visionEnabled) {
                const visualDetection = detectVisualContent(state.pdfPages, pdf);
                state.visualContentDetected = visualDetection.hasVisualContent;

                if (visualDetection.hasVisualContent) {
                    console.log(`[Vision Auto-Detect] Visual content detected: ${visualDetection.reasons.join(', ')}`);
                    state.visionEnabled = true;
                    state.visionAutoEnabled = true;
                    // Don't save to localStorage - this is just for this session
                }
            }

            // If vision is enabled (manually or auto), render pages to images
            if (state.visionEnabled) {
                updateLoadingProgress(100, 'Rendering pages for vision analysis...');
                await renderPdfPagesForVision(pdf);
            }

            // Extract hyperlinks from the PDF (v7.17)
            updateLoadingProgress(100, 'Extracting linked documents...');
            state.linkedDocuments.links = await extractHyperlinksFromPDF(pdf);
            state.linkedDocuments.fetched = {}; // Reset fetched docs for new PDF
            updateLinkedDocsUI();
            updateLinkedDocsStatusPreview();
            updatePdfLinkedDocsPanel();

            hideLoading();

            // Build toast message
            let toastMessage = `Successfully extracted ${pdf.numPages} pages.`;
            if (state.linkedDocuments.links.length > 0) {
                const fetchableCount = state.linkedDocuments.links.filter(l => l.fetchable).length;
                toastMessage += ` Found ${state.linkedDocuments.links.length} linked documents (${fetchableCount} fetchable).`;
            }
            if (state.visionAutoEnabled) {
                toastMessage += ' Visual content detected - Vision analysis auto-enabled.';
            } else if (state.visionEnabled) {
                toastMessage += ' Vision analysis enabled.';
            }
            showToast('success', 'PDF Loaded', toastMessage);

            // Extract project info first
            if (state.apiKey) await extractProjectInfo();
            render();

            // AUTO-FETCH: Automatically fetch linked supporting documents (v7.20)
            // This runs in the background after the main PDF is loaded
            const fetchableLinks = state.linkedDocuments.links.filter(l => l.fetchable);
            if (fetchableLinks.length > 0) {
                console.log(`[Auto-Fetch] Starting automatic fetch of ${fetchableLinks.length} linked documents...`);
                // Small delay to let the UI settle, then auto-fetch
                setTimeout(() => {
                    autoFetchLinkedDocumentsWithReport();
                }, 500);
            }
        } catch (error) {
            hideLoading();
            showError('PDF Processing Failed', 'Could not extract text from the PDF. The file may be corrupted or password-protected.', () => handlePDFUpload(file));
        }
    }

    // Detect visual content in PDF (charts, graphs, images)
    function detectVisualContent(pdfPages, pdf) {
        const reasons = [];
        let hasVisualContent = false;

        // Check 1: Look for pages with very little text (likely image/chart pages)
        let lowTextPages = 0;
        const pagesWithLowText = [];
        pdfPages.forEach((pageText, index) => {
            const charCount = pageText.trim().length;
            if (charCount < CONFIG.VISION_MIN_CHARS_PER_PAGE && charCount > 0) {
                lowTextPages++;
                pagesWithLowText.push(index + 1);
            }
        });

        if (lowTextPages >= 2) {
            hasVisualContent = true;
            reasons.push(`${lowTextPages} pages with minimal text (likely charts/images)`);
        }

        // Check 2: Look for chart/graph keywords in the text
        const fullText = pdfPages.join(' ').toLowerCase();
        const foundKeywords = CONFIG.VISION_CHART_KEYWORDS.filter(keyword =>
            fullText.includes(keyword.toLowerCase())
        );

        if (foundKeywords.length >= 2) {
            hasVisualContent = true;
            reasons.push(`Keywords found: ${foundKeywords.slice(0, 3).join(', ')}`);
        }

        // Check 3: Look for references to figures, exhibits, or attachments with visual content
        const figurePattern = /figure\s*\d+|exhibit\s*[a-z0-9]+|chart\s*\d+|graph\s*\d+|appendix\s*[a-z]/gi;
        const figureMatches = fullText.match(figurePattern);

        if (figureMatches && figureMatches.length >= 2) {
            hasVisualContent = true;
            reasons.push(`${figureMatches.length} figure/exhibit references`);
        }

        // Check 4: Pages in attachment section with low text (attachments often contain charts)
        if (state.diagnostics.attachmentStartPage) {
            const attachmentPages = pdfPages.slice(state.diagnostics.attachmentStartPage - 1);
            const lowTextAttachPages = attachmentPages.filter(p => p.trim().length < CONFIG.VISION_MIN_CHARS_PER_PAGE).length;
            if (lowTextAttachPages >= 1) {
                hasVisualContent = true;
                reasons.push(`${lowTextAttachPages} attachment pages likely contain visuals`);
            }
        }

        console.log(`[Vision Auto-Detect] Analysis complete. Visual content: ${hasVisualContent}. Reasons: ${reasons.length > 0 ? reasons.join('; ') : 'None'}`);

        return {
            hasVisualContent,
            reasons,
            lowTextPages: pagesWithLowText,
            keywords: foundKeywords
        };
    }

    // Render PDF pages to images for vision analysis
    async function renderPdfPagesForVision(pdf) {
        state.pdfPageImages = [];
        const maxPages = Math.min(pdf.numPages, CONFIG.VISION_MAX_PAGES);

        // Determine which pages to render - prioritize attachment pages if detected
        let pagesToRender = [];
        const attachStart = state.diagnostics.attachmentStartPage;

        if (attachStart && attachStart <= pdf.numPages) {
            // Include some main content pages and attachment pages
            const mainContentPages = Math.min(3, attachStart - 1);
            const attachmentPages = maxPages - mainContentPages;

            // First few pages of main content
            for (let i = 1; i <= mainContentPages; i++) {
                pagesToRender.push(i);
            }
            // Attachment pages
            for (let i = attachStart; i < attachStart + attachmentPages && i <= pdf.numPages; i++) {
                pagesToRender.push(i);
            }
        } else {
            // No attachments detected - render first N pages
            for (let i = 1; i <= maxPages; i++) {
                pagesToRender.push(i);
            }
        }

        console.log(`[Vision] Rendering ${pagesToRender.length} pages for vision analysis: ${pagesToRender.join(', ')}`);

        for (const pageNum of pagesToRender) {
            try {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: CONFIG.VISION_IMAGE_SCALE });

                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');

                // Render page to canvas
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                // Convert to base64 JPEG
                const imageData = canvas.toDataURL('image/jpeg', CONFIG.VISION_IMAGE_QUALITY);
                // Remove the data URL prefix for API
                const base64Data = imageData.replace(/^data:image\/jpeg;base64,/, '');

                state.pdfPageImages.push({
                    pageNum: pageNum,
                    base64: base64Data,
                    width: viewport.width,
                    height: viewport.height
                });

                console.log(`[Vision] Rendered page ${pageNum}: ${Math.round(base64Data.length / 1024)}KB`);
            } catch (err) {
                console.warn(`[Vision] Failed to render page ${pageNum}:`, err);
            }
        }

        state.diagnostics.visionPagesAnalyzed = state.pdfPageImages.length;
        console.log(`[Vision] Total ${state.pdfPageImages.length} pages rendered for vision analysis`);
    }

    async function handleTemplateUpload(file) {
        try {
            showLoading('Loading Template', `Parsing ${file.name}...`);
            const arrayBuffer = await file.arrayBuffer();
            state.templateData = arrayBuffer;
            state.templateName = file.name;

            // Parse the workbook using SheetJS (XLSX library)
            // cellStyles: true preserves cell formatting, colors, fills, etc.
            const workbook = XLSX.read(arrayBuffer, {
                type: 'array',
                cellStyles: true,    // Preserve cell styles
                cellNF: true,        // Preserve number formats
                cellDates: true      // Preserve date formatting
            });
            state.scoringWorkbook = workbook;

            // Try to detect and match template profile
            const detectedProfileId = detectTemplateProfile(workbook);
            if (detectedProfileId && detectedProfileId !== activeProfileId) {
                setActiveProfile(detectedProfileId);
                state.activeTemplateId = detectedProfileId;
                const profile = getActiveProfile();
                showToast('info', 'Template Detected', `Using profile: ${profile.name}`);
            }

            // Verify the reviewer sheet exists
            if (!workbook.SheetNames.includes(state.reviewerSheet)) {
                hideLoading();
                const availableSheets = workbook.SheetNames.join(', ');
                showToast('warning', 'Sheet Not Found', `"${state.reviewerSheet}" not found. Available: ${availableSheets}`);
                // Try to find a matching reviewer sheet
                const reviewerSheets = workbook.SheetNames.filter(s => s.toLowerCase().includes('reviewer') || s.toLowerCase().includes('scoring'));
                if (reviewerSheets.length > 0) {
                    state.reviewerSheet = reviewerSheets[0];
                    localStorage.setItem('nofa_reviewer_sheet', state.reviewerSheet);
                    showToast('info', 'Sheet Auto-Selected', `Using "${state.reviewerSheet}"`);
                }
            }

            hideLoading();
            showToast('success', 'Template Loaded', `${file.name} - Ready for export to "${state.reviewerSheet}"`);
            render();
        } catch (e) {
            hideLoading();
            showError('Template Load Failed', e.message);
        }
    }

    function clearTemplate() { state.templateData = null; state.templateName = ''; state.scoringWorkbook = null; render(); }
    function clearPdf() { state.applicationText = ''; state.pdfPages = []; state.projectInfo = {}; render(); }

    // ============================================================
    // AI INTEGRATION
    // ============================================================

    // Retry helper with exponential backoff
    async function withRetry(fn, maxAttempts = CONFIG.API_RETRY_ATTEMPTS) {
        let lastError;
        for (let attempt = 1; attempt <= maxAttempts; attempt++) {
            try {
                return await fn();
            } catch (error) {
                lastError = error;
                const isRetryable = error.message?.includes('rate') ||
                                   error.message?.includes('overloaded') ||
                                   error.message?.includes('529') ||
                                   error.message?.includes('500') ||
                                   error.message?.includes('timeout');

                if (attempt < maxAttempts && isRetryable) {
                    const delay = CONFIG.API_RETRY_DELAY_MS * Math.pow(2, attempt - 1);
                    console.log(`[API Retry] Attempt ${attempt} failed, retrying in ${delay}ms...`);
                    await new Promise(r => setTimeout(r, delay));
                } else if (!isRetryable) {
                    throw error; // Don't retry non-retryable errors
                }
            }
        }
        throw lastError;
    }

    async function callClaude(systemPrompt, userPrompt) {
        if (!state.apiKey) throw new Error('API key not configured');

        return withRetry(async () => {
            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: CONFIG.MODEL,
                    max_tokens: CONFIG.MAX_TOKENS,
                    temperature: 0,  // CRITICAL: Set to 0 for deterministic, consistent scoring
                    system: systemPrompt,
                    messages: [{ role: 'user', content: userPrompt }]
                })
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `API request failed (${response.status})`);
            }
            const data = await response.json();
            return data.content[0].text;
        });
    }

    // Call Claude with vision capability - sends images along with text
    async function callClaudeWithVision(systemPrompt, userPrompt, images = []) {
        if (!state.apiKey) throw new Error('API key not configured');

        // Build message content with text and images
        const messageContent = [];

        // Add images first (Claude processes them in order)
        for (const img of images) {
            messageContent.push({
                type: 'image',
                source: {
                    type: 'base64',
                    media_type: 'image/jpeg',
                    data: img.base64
                }
            });
        }

        // Add the text prompt
        messageContent.push({
            type: 'text',
            text: userPrompt
        });

        return withRetry(async () => {
            const response = await fetch(CONFIG.API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: CONFIG.MODEL,
                    max_tokens: CONFIG.MAX_TOKENS,
                    temperature: 0,
                    system: systemPrompt,
                    messages: [{ role: 'user', content: messageContent }]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `API request failed (${response.status})`);
            }
            const data = await response.json();
            return data.content[0].text;
        });
    }

    async function extractProjectInfo() {
        showLoading('Analyzing Application', 'AI is extracting project information...');
        // CONSISTENCY: Use normalized text for project info extraction
        const normalizedText = getConsistentTextChunk(state.applicationText, 15000);
        const systemPrompt = `You are a NOFA application reviewer for San Mateo County. Extract key project information from the application text. Return ONLY a JSON object with these exact fields: { "applicant": "Organization name", "project": "Project title", "amountRequested": 75000, "totalCost": 150000, "clientsServed": 500, "projectDescription": "Brief 2-3 sentence description", "detectedFundingSource": "HOME|CDBG|HOME+CDBG|Other|null", "fundingSourceReasoning": "Brief explanation of why this funding source was detected" }.

CRITICAL - AMOUNT REQUESTED EXTRACTION:
The "amountRequested" field MUST be the SPECIFIC grant amount being requested from the County of San Mateo for THIS application.

EXTRACTION RULES (apply in order):
1. Find the SPECIFIC line item or field showing the County of San Mateo grant request
2. If multiple funding sources, jurisdictions, or budget categories exist, extract ONLY the County's grant portion
3. Use the GRANT REQUEST amount - not totals, subtotals, or aggregate figures
4. When multiple numbers could apply, use the SMALLER, more specific figure rather than a larger total

COMMON EXTRACTION MISTAKES TO AVOID:
- Do NOT use "Total" rows that sum multiple line items together
- Do NOT use total project cost or total program budget (those go in totalCost field)
- Do NOT use agency-wide or organization-wide budget figures
- Do NOT use multi-year totals when single-year amounts are available
- Do NOT sum multiple funding sources or jurisdictions together
- Do NOT confuse the grant request with match funding, leveraged funds, or in-kind contributions
- Do NOT use the grand total when a specific County line item exists

LOOK FOR LABELS LIKE:
- "County of San Mateo" with "Amount Requested" or similar column
- "CDBG Request", "HOME Request", "ESG Request", "PLHA Request"
- "Grant Request", "Funding Request", "Amount Requested"
- Specific budget line items for County funding
- The County's portion in any jurisdiction breakdown table

CRITICAL - EXCLUDE OTHER JURISDICTIONS:
Many applicants submit to multiple funders. You MUST extract ONLY the County of San Mateo portion. IGNORE funding requests from:
- City of San Mateo (this is DIFFERENT from County of San Mateo)
- South San Francisco
- East Palo Alto
- Redwood City
- Daly City
- San Bruno
- Any other city or municipality within San Mateo County
If the application combines County and city funding in one total, look for the County-specific breakdown.

PRINCIPLE: When a budget shows breakdowns by jurisdiction, funder, category, or year - always extract the SPECIFIC County of San Mateo grant request line item, never the total.

FUNDING SOURCE DETECTION RULES:
- HOME: Housing development, housing rehabilitation, tenant-based rental assistance, homebuyer assistance, affordable housing projects
- CDBG: Public services (food programs, senior services, youth programs, homeless services), public facilities, infrastructure improvements, economic development, code enforcement
- HOME+CDBG: Projects that combine housing AND public services/facilities
- Other: Projects funded by other sources (ESG, HOPWA, etc.)

Look for explicit mentions of funding source on cover pages, budget sections, or check boxes. If not explicit, infer from project type.
Use numbers without formatting for monetary values. If not found, use null.`;
        try {
            const response = await callClaude(systemPrompt, `Extract project information:\n\n${normalizedText}`);
            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) state.projectInfo = JSON.parse(jsonMatch[0]);

            // RED FLAGS: Validate eligibility immediately after extraction (v7.20)
            validateEligibility();
            updateRedFlagsIndicator();
            if (hasCriticalRedFlags()) {
                console.warn('[Red Flags] CRITICAL issues detected!', state.redFlags);
                // Show prominent alert for critical issues
                showToast('error', 'üö© Critical Eligibility Issue', 'This application has critical red flags. Review before proceeding.', 8000);
            }

            hideLoading();
            debouncedAutoSave();
            render();
        } catch (error) {
            hideLoading();
            showError('AI Extraction Failed', error.message, extractProjectInfo);
        }
    }

    async function getAISuggestion(criterion) {
        const costPerClient = state.projectInfo.totalCost && state.projectInfo.clientsServed ? state.projectInfo.totalCost / state.projectInfo.clientsServed : null;
        const countyPercent = state.projectInfo.amountRequested && state.projectInfo.totalCost ? (state.projectInfo.amountRequested / state.projectInfo.totalCost) * 100 : null;

        // CONSISTENCY: Get comprehensive text including main content AND attachments/exhibits
        const normalizedText = getComprehensiveTextForAI(state.applicationText, CONFIG.TEXT_CHUNK_SIZE);

        // Include vision flag in cache key so vision/non-vision results are cached separately
        const visionFlag = state.visionEnabled && state.pdfPageImages.length > 0 ? '_vision' : '';

        // CONSISTENCY: Generate hash for caching
        const inputForHash = `${criterion.id}_${normalizedText}_${JSON.stringify(state.projectInfo)}${visionFlag}`;
        const inputHash = await hashText(inputForHash);

        // CONSISTENCY: Check cache first
        const cachedResponse = getCachedResponse(inputHash, criterion.id);
        if (cachedResponse) {
            state.cachedCriteriaCount++;
            console.log(`[Cache HIT] Criterion ${criterion.id} - Total cached: ${state.cachedCriteriaCount}`);
            return cachedResponse;
        }

        // Build system prompt - add vision context if enabled
        const visionContext = state.visionEnabled && state.pdfPageImages.length > 0
            ? `\n\nVISION ANALYSIS: You are also provided with ${state.pdfPageImages.length} page images from the PDF. Carefully examine these images for charts, graphs, tables, organizational diagrams, financial statements, and any visual evidence that supports or contradicts the application. Reference specific visual elements in your reasoning.`
            : '';

        // Build reference document context (v7.11)
        const referenceContext = buildReferenceContext();

        // Build linked documents context (v7.17)
        const linkedDocsContext = buildLinkedDocumentsContext();

        const systemPrompt = `You are an expert NOFA reviewer for San Mateo County Department of Housing. You are evaluating criterion: "${criterion.question}"\n\nCRITICAL - COUNTY OF SAN MATEO ONLY:\nThis review is ONLY for County of San Mateo funding. Many applicants request funding from multiple jurisdictions (e.g., City of San Mateo, South San Francisco, East Palo Alto, Redwood City, Daly City, etc.). You must:\n- ONLY consider the funding amount requested from COUNTY OF SAN MATEO\n- IGNORE funding amounts for other cities/jurisdictions when assessing the request\n- If the application bundles county funding with city funding, identify and separate the county-specific amount\n- When citing budget figures, specify that you are referencing the County of San Mateo portion only\n- The "Amount Requested" in Project Info should reflect County of San Mateo funds only\n\nIMPORTANT CONTEXT - NONPROFIT APPLICANTS:\nMost NOFA applicants are 501(c)(3) nonprofit organizations. When evaluating financial information, apply nonprofit-appropriate standards:\n- Nonprofits do NOT generate "income" like businesses - they secure grants, contracts, and donations\n- A budget showing expenses equal to revenue is NORMAL (spending grants as intended)\n- "Operating on reserves" can indicate HEALTHY financial management, not distress\n- Funding gaps often represent the portion being requested (why they're applying)\n- Evaluate: audit findings, funding diversity, reserve levels, and grant management track record\n- Do NOT penalize organizations for seeking grant funding or having budgets that rely on multiple funders\n\nSCORING RULE:\n${criterion.scoringRule}\n\nPROJECT INFO:\n- Applicant: ${state.projectInfo.applicant || 'Unknown'}\n- Project: ${state.projectInfo.project || 'Unknown'}\n- Amount Requested: ${formatCurrency(state.projectInfo.amountRequested)}\n- Total Cost: ${formatCurrency(state.projectInfo.totalCost)}\n- Clients Served: ${formatNumber(state.projectInfo.clientsServed)}\n- Cost Per Client: ${costPerClient ? formatCurrency(costPerClient) : 'N/A'}\n- County % of Total: ${countyPercent ? countyPercent.toFixed(1) + '%' : 'N/A'}${referenceContext}${linkedDocsContext}\n\nIMPORTANT: The application text includes BOTH the main narrative AND attachments/exhibits section. Look for evidence in attachments (financial statements, audits, organizational charts, letters of support, etc.) when evaluating criteria that reference them.${visionContext}\n\nWhen evaluating priority alignment, cross-reference the application against the County Funding Priorities document if provided. Cite specific priorities by name when relevant.\n\nProvide BOTH a recommendation AND a counter-argument.\n\nIMPORTANT: Keep your reasoning CONCISE and DIRECT. Maximum 2-3 sentences. State the key finding and evidence, not lengthy explanations.\n\nRespond with ONLY a JSON object:\n{\n    "suggestedScore": 2,\n    "reasoning": "CONCISE 2-3 sentence assessment. State the key finding and cite ONE specific piece of evidence. Be direct, not verbose.",\n    "counterArgument": "Brief 1-2 sentence alternative perspective",\n    "counterScore": 1,\n    "relevantExcerpts": ["Exact quote 1", "Exact quote 2"],\n    "pageReferences": [1, 3],\n    "confidence": "high|medium|low"\n}\n\nOnly suggest scores from: ${criterion.validScores.join(', ')}`;

        try {
            let response;

            // Use vision API if enabled and images are available
            if (state.visionEnabled && state.pdfPageImages.length > 0) {
                console.log(`[Vision] Analyzing criterion ${criterion.id} with ${state.pdfPageImages.length} page images`);
                response = await callClaudeWithVision(
                    systemPrompt,
                    `${criterion.aiPrompt}\n\nAPPLICATION TEXT:\n${normalizedText}\n\nThe images above show pages from the PDF application. Please analyze both the text and the visual elements (charts, graphs, tables, diagrams) when evaluating this criterion.`,
                    state.pdfPageImages
                );
            } else {
                // Standard text-only API call
                response = await callClaude(systemPrompt, `${criterion.aiPrompt}\n\nAPPLICATION TEXT:\n${normalizedText}`);
            }

            const jsonMatch = response.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const parsedResponse = JSON.parse(jsonMatch[0]);
                // CONSISTENCY: Cache the response
                setCachedResponse(inputHash, criterion.id, parsedResponse);
                // Track criteria analyzed for diagnostics
                state.diagnostics.criteriaAnalyzed++;
                return parsedResponse;
            }
            return null;
        } catch (error) {
            // Track API errors (v7.19)
            const isVisionError = state.visionEnabled && state.pdfPageImages.length > 0;
            const isNetworkError = error.message?.includes('fetch') ||
                                   error.message?.includes('network') ||
                                   error.message?.includes('Failed to fetch') ||
                                   error.message?.includes('SOCKET');

            state.apiErrors.push({
                criterion: criterion.id,
                error: error.message,
                isVision: isVisionError,
                isNetwork: isNetworkError,
                timestamp: new Date().toISOString()
            });

            if (isVisionError) {
                state.visionFailures++;
            }

            // Only show toast for non-network errors (network errors will be summarized at the end)
            if (!isNetworkError) {
                showToast('error', 'AI Analysis Failed', error.message);
            }
            return null;
        }
    }

    // ============================================================
    // RENDERING
    // ============================================================

    // Debounced render to prevent rapid DOM thrashing
    let renderTimeout = null;
    let renderScheduled = false;

    function render() {
        // Debounce rapid render calls
        if (renderScheduled) return;
        renderScheduled = true;

        if (renderTimeout) clearTimeout(renderTimeout);
        renderTimeout = setTimeout(() => {
            renderScheduled = false;
            renderImmediate();
        }, CONFIG.RENDER_DEBOUNCE_MS);
    }

    // Direct render without debouncing (for initial load)
    function renderImmediate() {
        const main = document.getElementById('mainContent');
        switch (state.currentStep) {
            case 'upload':
                // Use simple upload if in simple mode (v7.21)
                isSimpleMode() ? renderUploadStepSimple(main) : renderUploadStep(main);
                break;
            case 'projectInfo': renderProjectInfoStep(main); break;
            case 'scoring':
                // Use simple scoring if in simple mode (v7.21)
                isSimpleMode() ? renderScoringStepSimple(main) : renderScoringStep(main);
                break;
            case 'globalReview': renderGlobalReviewStep(main); break;
            case 'recommendation': renderRecommendationStep(main); break;
            case 'summary': renderSummaryStep(main); break;
        }
        setTimeout(setupDropZones, 100);
        updateAutoAnalyzeButton();
    }

    function updateAutoAnalyzeButton() {
        const btn = document.getElementById('autoAnalyzeHeaderBtn');
        const btnText = document.getElementById('autoAnalyzeBtnText');
        if (!btn || !btnText) return;

        // Count unscored criteria (check for both undefined and null)
        const unscoredCount = CRITERIA.filter(c => state.scores[c.id] === undefined || state.scores[c.id] === null).length;
        const hasApplication = state.applicationText && state.applicationText.length > 0;
        const hasApiKey = state.apiKey && state.apiKey.length > 0;

        // Show button when we have application loaded and API key, and we're in a relevant step
        const relevantSteps = ['projectInfo', 'scoring', 'globalReview'];
        const shouldShow = hasApplication && hasApiKey && relevantSteps.includes(state.currentStep);

        if (shouldShow) {
            // Use inline style to guarantee visibility
            btn.style.display = 'flex';
            btn.classList.remove('hidden');
            if (unscoredCount === CRITERIA.length) {
                btnText.textContent = 'Auto-Analyze All';
            } else if (unscoredCount > 0) {
                btnText.textContent = `Auto-Analyze (${unscoredCount} left)`;
            } else {
                btnText.textContent = 'Re-Analyze All';
            }
        } else {
            btn.style.display = 'none';
            btn.classList.add('hidden');
        }
    }

    function renderUploadStep(container) {
        // Pro Mode: Full-featured interface (Simple mode is handled in renderImmediate)
        container.innerHTML = `
            <div class="fade-in space-y-6">
                ${!state.apiKey ? `
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4" role="alert">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-amber-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-amber-800">API Key Required</p>
                                <p class="text-sm text-amber-700 mt-1">Click Settings to add your Anthropic API key for AI-assisted scoring.</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
                <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                    <h2 class="text-xl font-bold text-slate-800 mb-2">Step 1: Load Excel Template</h2>
                    <p class="text-slate-500 mb-4">Load the official County scoring template. Your evaluation will be exported to <strong>"${state.reviewerSheet}"</strong>.</p>
                    ${state.templateData ? `
                        <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    <span class="text-green-700 font-medium">${state.templateName || 'Template loaded'}</span>
                                </div>
                                <button onclick="clearTemplate()" class="text-sm text-green-600 hover:text-green-800">Change</button>
                            </div>
                        </div>
                    ` : `
                        <div id="templateDropZone" class="drop-zone border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-green-400 hover:bg-green-50/50 transition-all" role="button" tabindex="0" aria-label="Upload Excel template">
                            <svg class="w-12 h-12 mx-auto mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            <p class="text-slate-600 font-medium">Drop Excel template here or click to browse</p>
                            <p class="text-xs text-slate-400 mt-2">Supports .xlsx and .xls files (max ${CONFIG.MAX_PDF_SIZE_MB}MB)</p>
                            <input type="file" id="templateInput" accept=".xlsx,.xls" class="hidden" aria-hidden="true">
                        </div>
                    `}
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                    <h2 class="text-xl font-bold text-slate-800 mb-2">Step 2: Upload NOFA Application (PDF)</h2>
                    <p class="text-slate-500 mb-4">Upload the PDF application to begin AI-assisted evaluation</p>
                    ${state.applicationText ? `
                        <div class="bg-[#F3FAFE] border border-[#7CBEEC] rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-[#036CB6]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        <span class="text-[#036CB6] font-medium">Application Loaded</span>
                                    </div>
                                    <p class="text-sm text-[#036CB6] ml-7">${state.pdfPages.length} pages extracted</p>
                                </div>
                                <button onclick="clearPdf()" class="text-sm text-[#036CB6] hover:text-[#02538C]">Change</button>
                            </div>
                        </div>
                    ` : `
                        <div id="pdfDropZone" class="drop-zone border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-[#5bb5bd] hover:bg-[#E3EDF5]/50 transition-all" role="button" tabindex="0" aria-label="Upload PDF application">
                            <svg class="w-12 h-12 mx-auto mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                            <p class="text-slate-600 font-medium">Drop PDF application here or click to browse</p>
                            <p class="text-xs text-slate-400 mt-2">Maximum file size: ${CONFIG.MAX_PDF_SIZE_MB}MB</p>
                            <input type="file" id="pdfInput" accept=".pdf" class="hidden" aria-hidden="true">
                        </div>
                    `}
                </div>
                ${state.templateData && state.applicationText && state.projectInfo.applicant ? `
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                        <p class="font-semibold text-green-800">Ready to evaluate: ${state.projectInfo.applicant}</p>
                        ${state.projectInfo.project ? `<p class="text-green-700">${state.projectInfo.project}</p>` : ''}
                        ${state.projectInfo.amountRequested ? `<p class="text-green-600 text-sm">Requesting: ${formatCurrency(state.projectInfo.amountRequested)}</p>` : ''}
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="text-lg font-bold text-slate-800 mb-3">Choose Your Evaluation Method</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="goToProjectInfo()" class="bg-[#F3FAFE] border-2 border-[#7CBEEC] text-left p-5 rounded-xl hover:border-[#5bb5bd] hover:bg-[#E3EDF5] transition-all group">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 bg-[#38939B] rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-[#02538C] group-hover:text-[#02538C]">Manual Step-by-Step</p>
                                        <p class="text-sm text-[#036CB6] mt-1">Evaluate each criterion individually with AI assistance</p>
                                    </div>
                                </div>
                            </button>

                            <button onclick="startAutoAnalyzeAll()" class="bg-purple-50 border-2 border-purple-200 text-left p-5 rounded-xl hover:border-purple-400 hover:bg-purple-100 transition-all group">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-purple-800 group-hover:text-purple-900">Auto-Analyze All</p>
                                        <p class="text-sm text-purple-600 mt-1">AI analyzes everything, then you review and adjust in one view</p>
                                    </div>
                                </div>
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-3 text-center">Both methods let you modify scores and comments. Auto-analyze is faster but uses more API calls.</p>
                    </div>
                ` : `<p class="text-center text-slate-500">Upload both files to continue</p>`}
            </div>`;
    }

    // ============================================================
    // SIMPLE MODE UPLOAD SCREEN (v7.21)
    // ============================================================
    function renderUploadStepSimple(container) {
        const hasApiKey = state.apiKey && state.apiKey.length > 0;
        const hasTemplate = state.templateData;
        const hasApplication = state.applicationText && state.applicationText.length > 0;
        const isReady = hasTemplate && hasApplication && state.projectInfo.applicant;

        container.innerHTML = `
            <div class="fade-in max-w-2xl mx-auto">
                <!-- Welcome Message for Simple Mode -->
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-[#E3EDF5] rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-[#036CB6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Evaluate a NOFA Application</h2>
                    <p class="text-slate-600">Upload your files to get started. AI will help you score the application.</p>
                </div>

                ${!hasApiKey ? `
                    <div class="bg-[#F3FAFE] border border-[#7CBEEC] rounded-xl p-5 mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-[#E3EDF5] rounded-full flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-[#036CB6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-[#02538C]">Set Up AI Scoring</p>
                                <p class="text-sm text-[#036CB6]">Add your API key to enable AI-assisted evaluations.</p>
                            </div>
                            <button onclick="showSettings()" class="px-4 py-2 bg-[#38939B] text-white rounded-lg text-sm font-medium hover:bg-[#2a7078] transition-colors">
                                Set Up
                            </button>
                        </div>
                    </div>
                ` : ''}

                <!-- Step Progress -->
                <div class="flex items-center justify-center gap-4 mb-8">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full ${hasTemplate ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-500'} flex items-center justify-center text-sm font-bold">
                            ${hasTemplate ? '‚úì' : '1'}
                        </div>
                        <span class="text-sm ${hasTemplate ? 'text-green-600 font-medium' : 'text-slate-600'}">Template</span>
                    </div>
                    <div class="w-8 h-px bg-slate-300"></div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full ${hasApplication ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-500'} flex items-center justify-center text-sm font-bold">
                            ${hasApplication ? '‚úì' : '2'}
                        </div>
                        <span class="text-sm ${hasApplication ? 'text-green-600 font-medium' : 'text-slate-600'}">Application</span>
                    </div>
                    <div class="w-8 h-px bg-slate-300"></div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full ${isReady ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-500'} flex items-center justify-center text-sm font-bold">
                            ${isReady ? '‚úì' : '3'}
                        </div>
                        <span class="text-sm ${isReady ? 'text-green-600 font-medium' : 'text-slate-600'}">Evaluate</span>
                    </div>
                </div>

                <!-- Upload Cards -->
                <div class="space-y-4">
                    <!-- Excel Template -->
                    <div class="bg-white rounded-xl border ${hasTemplate ? 'border-green-200' : 'border-slate-200'} p-5 shadow-sm">
                        ${hasTemplate ? `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-medium text-slate-800">Scoring Template</p>
                                        <p class="text-sm text-green-600">${state.templateName || 'Template loaded'}</p>
                                    </div>
                                </div>
                                <button onclick="clearTemplate()" class="text-sm text-slate-500 hover:text-slate-700">Change</button>
                            </div>
                        ` : `
                            <div id="templateDropZone" class="drop-zone cursor-pointer" role="button" tabindex="0">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-slate-800">Upload Scoring Template</p>
                                        <p class="text-sm text-slate-500">The Excel file from the County (xlsx)</p>
                                    </div>
                                    <div class="px-4 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-medium">
                                        Browse
                                    </div>
                                </div>
                                <input type="file" id="templateInput" accept=".xlsx,.xls" class="hidden">
                            </div>
                        `}
                    </div>

                    <!-- PDF Application -->
                    <div class="bg-white rounded-xl border ${hasApplication ? 'border-green-200' : 'border-slate-200'} p-5 shadow-sm">
                        ${hasApplication ? `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-medium text-slate-800">NOFA Application</p>
                                        <p class="text-sm text-green-600">${state.pdfPages.length} pages ‚Ä¢ ${state.projectInfo.applicant || 'Loaded'}</p>
                                    </div>
                                </div>
                                <button onclick="clearPdf()" class="text-sm text-slate-500 hover:text-slate-700">Change</button>
                            </div>
                        ` : `
                            <div id="pdfDropZone" class="drop-zone cursor-pointer" role="button" tabindex="0">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-[#F3FAFE] rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-6 h-6 text-[#38939B]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-slate-800">Upload NOFA Application</p>
                                        <p class="text-sm text-slate-500">The PDF application to evaluate</p>
                                    </div>
                                    <div class="px-4 py-2 bg-[#F3FAFE] text-[#036CB6] rounded-lg text-sm font-medium">
                                        Browse
                                    </div>
                                </div>
                                <input type="file" id="pdfInput" accept=".pdf" class="hidden">
                            </div>
                        `}
                    </div>
                </div>

                <!-- Ready to Start -->
                ${isReady ? `
                    <div class="mt-8 bg-gradient-to-r from-[#38939B] to-[#036CB6] rounded-xl p-6 text-white text-center">
                        <h3 class="text-lg font-bold mb-2">Ready to Evaluate!</h3>
                        <p class="text-teal-100 mb-4">${state.projectInfo.applicant}${state.projectInfo.amountRequested ? ` ‚Ä¢ ${formatCurrency(state.projectInfo.amountRequested)}` : ''}</p>
                        <button onclick="startAutoAnalyzeAll()" class="px-6 py-3 bg-white text-[#036CB6] rounded-lg font-semibold hover:bg-[#E3EDF5] transition-colors">
                            Start AI Evaluation
                        </button>
                        <p class="text-xs text-teal-200 mt-3">AI will analyze the application and suggest scores. You'll review and finalize.</p>
                    </div>
                ` : ''}

                <!-- Simple Mode Red Flags Summary -->
                ${hasApplication && state.redFlags.length > 0 ? renderSimpleModeRedFlags() : ''}
            </div>
        `;
    }

    // Simplified red flags display for Simple Mode (v7.21)
    function renderSimpleModeRedFlags() {
        const summary = getRedFlagsSummary();
        if (summary.total === 0) return '';

        const criticalCount = summary.critical;
        const warningCount = summary.warnings;

        // In Simple Mode, we show a consolidated, less technical message
        let alertClass, iconColor, message;

        if (criticalCount > 0) {
            alertClass = 'bg-red-50 border-red-200';
            iconColor = 'text-red-500';
            message = `This application has ${criticalCount} issue${criticalCount > 1 ? 's' : ''} that may affect eligibility.`;
        } else if (warningCount > 0) {
            alertClass = 'bg-amber-50 border-amber-200';
            iconColor = 'text-amber-500';
            message = `${warningCount} item${warningCount > 1 ? 's' : ''} to review in this application.`;
        } else {
            alertClass = 'bg-[#F3FAFE] border-[#7CBEEC]';
            iconColor = 'text-[#38939B]';
            message = `${summary.info} note${summary.info > 1 ? 's' : ''} about this application.`;
        }

        return `
            <div class="mt-6 ${alertClass} border rounded-xl p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-sm font-medium text-slate-700">${message}</span>
                    </div>
                    <button onclick="showRedFlagsModal()" class="text-sm text-[#036CB6] hover:text-[#02538C] font-medium">
                        View Details
                    </button>
                </div>
            </div>
        `;
    }

    function goToProjectInfo() { state.currentStep = 'projectInfo'; render(); }

    function renderProjectInfoStep(container) {
        const info = state.projectInfo;
        container.innerHTML = `
            <div class="fade-in">
                <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <button onclick="goBack()" class="text-slate-400 hover:text-slate-600" aria-label="Go back">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        </button>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Project Information</h2>
                            <p class="text-sm text-slate-500">Verify AI-extracted data (edit if needed)</p>
                        </div>
                    </div>
                    <div class="bg-[#F3FAFE] border border-[#7CBEEC] rounded-xl p-4 mb-4" role="alert">
                        <div class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-[#036CB6] flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <p class="text-sm text-[#02538C]">This information was extracted by AI. Please verify accuracy before proceeding.</p>
                        </div>
                    </div>

                    ${renderRedFlagsPanel()}

                    ${state.documentHash ? `
                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-3 mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                                <span class="text-xs font-medium text-slate-600">Document Hash (Consistency ID)</span>
                            </div>
                            <code class="text-xs bg-white px-2 py-1 rounded border border-slate-200 font-mono text-slate-700">${state.documentHash.substring(0, 16)}...</code>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">This hash ensures consistent AI scoring. Same document = same scores.</p>
                    </div>
                    ` : ''}
                    <div class="space-y-4">
                        <div>
                            <label for="infoApplicant" class="block text-sm font-medium text-slate-700 mb-1">Applicant/Organization</label>
                            <input type="text" id="infoApplicant" value="${info.applicant || ''}" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#38939B]">
                        </div>
                        <div>
                            <label for="infoProject" class="block text-sm font-medium text-slate-700 mb-1">Project Title</label>
                            <input type="text" id="infoProject" value="${info.project || ''}" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#38939B]">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="infoAmount" class="block text-sm font-medium text-slate-700 mb-1">Amount Requested <span class="text-xs text-amber-600 font-normal">(County only)</span></label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                    <input type="number" id="infoAmount" value="${info.amountRequested || ''}" class="w-full pl-8 pr-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#38939B]">
                                </div>
                            </div>
                            <div>
                                <label for="infoTotalCost" class="block text-sm font-medium text-slate-700 mb-1">Total Project Cost</label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                                    <input type="number" id="infoTotalCost" value="${info.totalCost || ''}" class="w-full pl-8 pr-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#38939B]">
                                </div>
                            </div>
                        </div>
                        <!-- County-Only Funding Note (v7.21) -->
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                            <div class="flex items-start gap-2">
                                <svg class="w-4 h-4 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="text-xs text-amber-800">
                                    <p class="font-semibold">County of San Mateo Funding Only</p>
                                    <p class="mt-0.5 text-amber-700">Enter only the amount requested from <strong>County of San Mateo</strong>. Exclude funding requested from other jurisdictions (City of San Mateo, South San Francisco, East Palo Alto, Redwood City, etc.). The AI will evaluate based on county-specific funding only.</p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="infoClients" class="block text-sm font-medium text-slate-700 mb-1">Clients/Households Served</label>
                            <input type="number" id="infoClients" value="${info.clientsServed || ''}" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#38939B]">
                        </div>
                        <div>
                            <label for="infoDescription" class="block text-sm font-medium text-slate-700 mb-1">Project Description</label>
                            <textarea id="infoDescription" rows="3" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#38939B] resize-none">${info.projectDescription || ''}</textarea>
                        </div>
                    </div>

                    ${renderSupplementalDocsPanel()}

                    <button onclick="saveProjectInfoAndContinue()" class="mt-6 w-full bg-[#38939B] text-white py-4 rounded-xl font-semibold hover:bg-[#2a7078] transition-colors">
                        Continue to Scoring
                    </button>
                </div>
            </div>`;
    }

    function saveProjectInfoAndContinue() {
        state.projectInfo = {
            applicant: document.getElementById('infoApplicant').value,
            project: document.getElementById('infoProject').value,
            amountRequested: parseFloat(document.getElementById('infoAmount').value) || 0,
            totalCost: parseFloat(document.getElementById('infoTotalCost').value) || 0,
            clientsServed: parseInt(document.getElementById('infoClients').value) || 0,
            projectDescription: document.getElementById('infoDescription').value,
            detectedFundingSource: state.projectInfo.detectedFundingSource || null  // Preserve funding source
        };

        // RED FLAGS: Re-validate after manual edits (v7.20)
        validateEligibility();
        updateRedFlagsIndicator();

        // If critical red flags, show warning before continuing
        if (hasCriticalRedFlags()) {
            const criticalFlags = state.redFlags.filter(f => f.severity === 'critical');
            const proceed = confirm(
                '‚ö†Ô∏è CRITICAL ELIGIBILITY ISSUES DETECTED ‚ö†Ô∏è\n\n' +
                criticalFlags.map(f => `‚Ä¢ ${f.message}: ${f.details}`).join('\n\n') +
                '\n\nDo you want to continue anyway? (Not recommended)'
            );
            if (!proceed) return;
        }

        state.currentStep = 'scoring';
        state.currentCriterionIndex = 0;
        debouncedAutoSave();
        render();
    }

    // Update cover sheet field from Summary page (v7.21)
    function updateCoverSheetField(field, value) {
        if (!state.projectInfo) state.projectInfo = {};
        state.projectInfo[field] = value;
        debouncedAutoSave();
        showToast('success', 'Updated', `${field.charAt(0).toUpperCase() + field.slice(1).replace(/([A-Z])/g, ' $1')} updated.`);
    }

    async function renderScoringStep(container) {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const currentScore = state.scores[criterion.id];
        const currentComment = state.comments[criterion.id] || '';
        const suggestion = state.aiSuggestions[criterion.id];
        const progress = Math.round(((state.currentCriterionIndex) / CRITERIA.length) * 100);
        const totalScore = Object.values(state.scores).reduce((a, b) => a + b, 0);

        container.innerHTML = `
            <div class="fade-in flex flex-col" style="height: calc(100vh - 180px);">
                <!-- STICKY HEADER - Progress & Section Info -->
                <div class="flex-shrink-0 bg-gradient-to-r from-slate-800 via-slate-700 to-slate-800 text-white rounded-2xl p-4 mb-4 shadow-xl">
                    <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-[#F3FAFE]0 text-white rounded-xl flex items-center justify-center font-bold">${criterion.section}</div>
                            <div>
                                <h3 class="font-bold">${criterion.sectionTitle}</h3>
                                <p class="text-sm text-slate-300">Question ${state.currentCriterionIndex + 1} of ${CRITERIA.length} ‚Ä¢ Max ${criterion.validScores[criterion.validScores.length - 1]} pts</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            ${state.cachedCriteriaCount > 0 ? `
                            <span class="text-xs text-green-300 flex items-center gap-1" title="Cached responses ensure consistent scoring">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                ${state.cachedCriteriaCount} cached
                            </span>
                            ` : ''}
                            <div class="text-right">
                                <div class="text-xl font-bold">${totalScore} pts</div>
                                <div class="text-slate-300 text-xs">scored so far</div>
                            </div>
                            <button onclick="viewDocumentForCriterion('${criterion.id}')" class="flex items-center gap-2 px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                View Doc
                            </button>
                        </div>
                    </div>
                    <div class="h-2 bg-white/20 rounded-full overflow-hidden" role="progressbar" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                        <div class="h-full bg-[#5bb5bd] transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                </div>

                <!-- SCROLLABLE CONTENT -->
                <div class="flex-1 overflow-y-auto pr-2" style="scrollbar-width: thin;">
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-6">
                        <div class="mb-6">
                            <p class="text-lg font-semibold text-slate-800 mb-3">${criterion.question}</p>
                            <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                                <p class="text-xs font-semibold text-slate-500 mb-1">SCORING RULE:</p>
                                <p class="text-sm text-slate-700 whitespace-pre-line">${criterion.scoringRule}</p>
                            </div>
                            ${buildCriterionDocumentHint(criterion.id)}
                        </div>
                        <div id="aiSuggestionArea" class="mb-6">
                            ${suggestion ? renderAISuggestion(suggestion) : `
                                <button onclick="requestAISuggestion()" class="w-full bg-purple-50 border border-purple-200 rounded-xl p-4 text-left hover:bg-purple-100 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                                        <div>
                                            <p class="font-medium text-purple-800">Analyze with AI</p>
                                            <p class="text-sm text-purple-600">Get a recommendation and counter-argument</p>
                                        </div>
                                    </div>
                                </button>
                            `}
                        </div>
                        <div class="mb-6">
                            <p class="text-sm font-medium text-slate-700 mb-3">Your Score:</p>
                            <div class="flex flex-wrap gap-3" role="group" aria-label="Score selection">
                                ${criterion.validScores.map(score => `
                                    <button onclick="selectScore('${criterion.id}', ${score})"
                                        class="score-btn w-14 h-14 rounded-xl font-bold text-lg border-2 transition-all ${currentScore === score ? 'bg-[#38939B] text-white border-[#38939B] selected' : 'bg-white text-slate-700 border-slate-200 hover:border-[#5bb5bd]'}"
                                        aria-pressed="${currentScore === score}" aria-label="Score ${score}">
                                        ${score}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <label for="criterionComment" class="block text-sm font-medium text-slate-700 mb-2">
                                Your Reasoning ${criterion.requiresComment ? '<span class="text-red-500">(Required)</span>' : '<span class="text-slate-400">(Recommended)</span>'}
                            </label>
                            <textarea id="criterionComment" rows="3" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#38939B] resize-none" placeholder="Explain why you selected this score...">${currentComment}</textarea>
                        </div>
                    </div>
                </div>
                </div>
                <!-- END SCROLLABLE CONTENT -->

                <!-- STICKY FOOTER NAVIGATION -->
                <div class="flex-shrink-0 pt-4 border-t border-slate-200 bg-slate-50 rounded-b-2xl">
                    <div class="flex items-center justify-between">
                        ${state.returnToSummary ? `
                            <button onclick="cancelEditAndReturn()" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                Cancel
                            </button>
                            <button onclick="saveAndReturnToSummary()" class="px-6 py-2.5 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                Save & Return to Summary
                            </button>
                        ` : `
                            <button onclick="goBack()" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                                Back
                            </button>
                            <button onclick="handleNextCriterion()" class="px-6 py-2.5 bg-[#38939B] text-white rounded-lg font-medium hover:bg-[#2a7078] transition-colors flex items-center gap-2">
                                ${state.currentCriterionIndex < CRITERIA.length - 1 ? 'Next' : 'Finish'}
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            </button>
                        `}
                    </div>
                </div>
            </div>`;
    }

    // ============================================================
    // SIMPLE MODE SCORING STEP (v7.21)
    // Streamlined interface for beginners - hides advanced features
    // ============================================================
    async function renderScoringStepSimple(container) {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const currentScore = state.scores[criterion.id];
        const currentComment = state.comments[criterion.id] || '';
        const suggestion = state.aiSuggestions[criterion.id];
        const progress = Math.round(((state.currentCriterionIndex) / CRITERIA.length) * 100);
        const totalScore = Object.values(state.scores).reduce((a, b) => a + b, 0);
        const scoredCount = Object.values(state.scores).filter(s => s !== null && s !== undefined).length;

        container.innerHTML = `
            <div class="fade-in flex flex-col" style="height: calc(100vh - 180px);">
                <!-- STICKY HEADER - Progress & Section (Simple Mode) -->
                <div class="flex-shrink-0 bg-gradient-to-r from-[#38939B] to-[#036CB6] text-white rounded-2xl p-4 mb-4 shadow-xl">
                    <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center font-bold">${criterion.section}</div>
                            <div>
                                <h3 class="font-bold">${criterion.sectionTitle}</h3>
                                <p class="text-sm text-teal-100">Question ${state.currentCriterionIndex + 1} of ${CRITERIA.length} ‚Ä¢ Up to ${criterion.validScores[criterion.validScores.length - 1]} pts</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold">${scoredCount}/${CRITERIA.length}</div>
                            <div class="text-teal-100 text-xs">${totalScore} pts scored</div>
                        </div>
                    </div>
                    <div class="h-2 bg-white/20 rounded-full overflow-hidden">
                        <div class="h-full bg-white transition-all duration-300" style="width: ${progress}%"></div>
                    </div>
                </div>

                <!-- SCROLLABLE CONTENT -->
                <div class="flex-1 overflow-y-auto pr-2" style="scrollbar-width: thin;">
                <!-- Main Question Card -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-6">
                        <!-- Question -->
                        <div class="mb-6">
                            <p class="text-lg font-semibold text-slate-800 mb-4">${criterion.question}</p>
                            <details class="bg-slate-50 rounded-lg border border-slate-200">
                                <summary class="p-3 text-sm font-medium text-slate-600 cursor-pointer hover:bg-slate-100 rounded-lg">
                                    üìã View Scoring Guidelines
                                </summary>
                                <div class="p-3 pt-0 text-sm text-slate-700 whitespace-pre-line border-t border-slate-200 mt-2">
                                    ${criterion.scoringRule}
                                </div>
                            </details>
                        </div>

                        <!-- AI Analysis (Simplified) -->
                        <div id="aiSuggestionArea" class="mb-6">
                            ${suggestion ? renderAISuggestionSimple(suggestion) : `
                                <button onclick="requestAISuggestion()" class="w-full bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-xl p-4 text-left hover:from-purple-100 hover:to-indigo-100 transition-all">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-purple-600 rounded-xl flex items-center justify-center">
                                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-purple-800">ü§ñ Get AI Recommendation</p>
                                            <p class="text-sm text-purple-600">AI will analyze the application and suggest a score</p>
                                        </div>
                                    </div>
                                </button>
                            `}
                        </div>

                        <!-- Score Selection -->
                        <div class="mb-6">
                            <p class="text-sm font-semibold text-slate-700 mb-3">Select Your Score:</p>
                            <div class="grid grid-cols-${Math.min(criterion.validScores.length, 5)} gap-3">
                                ${criterion.validScores.map(score => `
                                    <button onclick="selectScore('${criterion.id}', ${score})"
                                        class="score-btn py-4 rounded-xl font-bold text-xl border-2 transition-all ${currentScore === score ? 'bg-[#38939B] text-white border-[#38939B] selected ring-2 ring-[#7CBEEC] ring-offset-2' : 'bg-white text-slate-700 border-slate-200 hover:border-[#5bb5bd] hover:bg-teal-50'}">
                                        ${score}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Comment (Optional in Simple Mode) -->
                        <div>
                            <label for="criterionComment" class="block text-sm font-medium text-slate-700 mb-2">
                                Add Notes <span class="text-slate-400">(optional)</span>
                            </label>
                            <textarea id="criterionComment" rows="2" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-[#38939B] resize-none" placeholder="Add any notes about your score...">${currentComment}</textarea>
                        </div>
                    </div>
                </div>
                </div>
                <!-- END SCROLLABLE CONTENT -->

                <!-- STICKY FOOTER NAVIGATION -->
                <div class="flex-shrink-0 pt-4 border-t border-slate-200 bg-slate-50 rounded-b-2xl">
                    <div class="flex items-center justify-between">
                        ${state.returnToSummary ? `
                            <button onclick="cancelEditAndReturn()" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg transition-colors">
                                Cancel
                            </button>
                            <button onclick="saveAndReturnToSummary()" class="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                Save
                            </button>
                        ` : `
                            <button onclick="goBack()" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                                Back
                            </button>
                            <button onclick="handleNextCriterion()" class="px-6 py-3 bg-[#38939B] text-white rounded-xl font-semibold hover:bg-[#2a7078] transition-colors flex items-center gap-2">
                                ${state.currentCriterionIndex < CRITERIA.length - 1 ? 'Next Question' : 'Finish Evaluation'}
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            </button>
                        `}
                    </div>
                </div>
            </div>`;
    }

    // Simplified AI Suggestion display for Simple Mode (v7.21)
    function renderAISuggestionSimple(suggestion) {
        return `
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4">
                <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-green-600 rounded-xl flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-bold text-green-800">AI Suggests: Score ${suggestion.suggestedScore}</span>
                            <span class="text-xs bg-green-200 text-green-700 px-2 py-0.5 rounded-full">${suggestion.confidence}</span>
                        </div>
                        <p class="text-sm text-green-900 mb-3">${suggestion.reasoning}</p>
                        <button onclick="useAIReasoningAsComment()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            Use This Score & Reasoning
                        </button>
                    </div>
                </div>
            </div>`;
    }

    function renderAISuggestion(suggestion) {
        // Escape quotes for JSON embedding in onclick handlers
        const escapedExcerpts = suggestion.relevantExcerpts ? JSON.stringify(suggestion.relevantExcerpts).replace(/'/g, "\\'").replace(/"/g, '&quot;') : '[]';
        const escapedReasoning = (suggestion.reasoning || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

        return `
            <div class="space-y-4">
                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span class="font-semibold text-green-800">Recommendation: Score ${suggestion.suggestedScore}</span>
                        <span class="text-xs bg-green-200 text-green-700 px-2 py-0.5 rounded-full">${suggestion.confidence} confidence</span>
                    </div>
                    <p class="text-sm text-green-900 mb-3">${suggestion.reasoning}</p>
                    ${suggestion.relevantExcerpts?.length ? `
                        <div class="bg-white rounded-lg p-3 border border-green-100">
                            <p class="text-xs font-semibold text-green-600 mb-2">SUPPORTING EVIDENCE:</p>
                            ${suggestion.relevantExcerpts.map(e => `<p class="text-xs text-slate-600 italic mb-1">"${e}"</p>`).join('')}
                            <button onclick="viewDocumentWithExcerpts(JSON.parse('${escapedExcerpts}'))" class="mt-2 text-xs text-green-600 hover:text-green-800 font-medium flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                View in document ‚Üí
                            </button>
                        </div>
                    ` : ''}
                    <div class="mt-3">
                        <button onclick="useAIReasoningAsComment()" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            Accept: Score ${suggestion.suggestedScore} + Comment
                        </button>
                    </div>
                </div>
                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span class="font-semibold text-amber-800">Counter-Argument: Consider Score ${suggestion.counterScore}</span>
                    </div>
                    <p class="text-sm text-amber-900">${suggestion.counterArgument}</p>
                    <div class="mt-3">
                        <button onclick="useCounterArgumentAsComment()" class="text-xs bg-amber-600 text-white px-3 py-1.5 rounded-lg hover:bg-amber-700 transition-colors flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            Accept: Score ${suggestion.counterScore} + Comment
                        </button>
                    </div>
                </div>
            </div>`;
    }

    function useAIReasoningAsComment() {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const suggestion = state.aiSuggestions[criterion.id];
        if (suggestion && suggestion.reasoning) {
            const commentEl = document.getElementById('criterionComment');
            if (commentEl) {
                // Build a comprehensive comment from AI reasoning + evidence
                let comment = suggestion.reasoning;
                if (suggestion.relevantExcerpts?.length) {
                    comment += '\n\nEvidence: ' + suggestion.relevantExcerpts.map(e => '"' + e + '"').join('; ');
                }
                commentEl.value = comment;
                state.comments[criterion.id] = comment;

                // Auto-select the corresponding score
                state.scores[criterion.id] = suggestion.suggestedScore;

                debouncedAutoSave();
                showToast('success', 'Score & Comment Set', `Score ${suggestion.suggestedScore} selected with AI reasoning.`);
                render();
            }
        }
    }

    function useCounterArgumentAsComment() {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const suggestion = state.aiSuggestions[criterion.id];
        if (suggestion && suggestion.counterArgument) {
            const commentEl = document.getElementById('criterionComment');
            if (commentEl) {
                // Use counter-argument as the comment
                let comment = suggestion.counterArgument;
                commentEl.value = comment;
                state.comments[criterion.id] = comment;

                // Auto-select the corresponding counter score
                state.scores[criterion.id] = suggestion.counterScore;

                debouncedAutoSave();
                showToast('success', 'Score & Comment Set', `Score ${suggestion.counterScore} selected with counter-argument reasoning.`);
                render();
            }
        }
    }

    // ============================================================
    // AUTO-ANALYZE ALL FUNCTIONALITY
    // ============================================================

    // Called from header button - analyzes remaining unscored criteria
    async function autoAnalyzeRemaining() {
        if (!state.apiKey) {
            showToast('error', 'API Key Required', 'Please add your Anthropic API key in Settings to use Auto-Analyze.');
            showSettings();
            return;
        }

        if (!state.applicationText) {
            showToast('error', 'No Application', 'Please upload a PDF application first.');
            return;
        }

        // Find criteria that still need scoring (include null scores from AI unable to determine)
        const remainingCriteria = CRITERIA.filter(c =>
            state.scores[c.id] === undefined ||
            state.scores[c.id] === null ||
            !state.aiSuggestions[c.id]
        );

        if (remainingCriteria.length === 0) {
            // All scored - offer to re-analyze
            if (confirm('All criteria have been scored. Do you want to re-analyze everything with AI? This will generate new suggestions but preserve your current scores.')) {
                await reAnalyzeAll();
            }
            return;
        }

        state.isAutoAnalyzing = true;
        state.autoAnalyzeCancelled = false; // Reset cancel flag
        state.autoAnalyzeProgress = 0;
        // Reset error tracking (v7.19)
        state.apiErrors = [];
        state.visionFailures = 0;
        const totalToAnalyze = remainingCriteria.length;
        showLoading(`Auto-Analyzing ${totalToAnalyze} Criteria`, `Starting analysis...`, true, true); // showCancel=true

        try {
            for (let i = 0; i < remainingCriteria.length; i++) {
                // Check if cancelled
                if (state.autoAnalyzeCancelled) {
                    showToast('info', 'Analysis Cancelled', `Stopped after analyzing ${i} of ${totalToAnalyze} criteria.`);
                    break;
                }

                const criterion = remainingCriteria[i];
                state.autoAnalyzeProgress = Math.round(((i) / totalToAnalyze) * 100);
                updateLoadingProgress(state.autoAnalyzeProgress, `Analyzing ${criterion.id.toUpperCase()}: ${criterion.question.substring(0, 40)}...`);

                const suggestion = await getAISuggestion(criterion);
                if (suggestion) {
                    state.aiSuggestions[criterion.id] = suggestion;
                    // Only auto-fill if not already scored (include null scores)
                    if (state.scores[criterion.id] === undefined || state.scores[criterion.id] === null) {
                        state.scores[criterion.id] = suggestion.suggestedScore;
                        let comment = suggestion.reasoning;
                        if (suggestion.relevantExcerpts?.length) {
                            comment += '\n\nEvidence: ' + suggestion.relevantExcerpts.map(e => '"' + e + '"').join('; ');
                        }
                        state.comments[criterion.id] = comment;
                    }
                }
            }

            // Store original scores for impact tracking (preserve existing manual scores)
            if (Object.keys(state.originalScores).length === 0) {
                state.originalScores = { ...state.scores };
            }

            updateLoadingProgress(100, 'Analysis complete!');
            await new Promise(resolve => setTimeout(resolve, 500));

            hideLoading();
            state.isAutoAnalyzing = false;
            state.currentStep = 'globalReview';
            debouncedAutoSave();
            render();

            // Show analysis summary with any errors (v7.19)
            const successCount = totalToAnalyze - state.apiErrors.length;
            const networkErrors = state.apiErrors.filter(e => e.isNetwork).length;
            const visionErrors = state.visionFailures;

            if (state.apiErrors.length > 0) {
                // Show warning with details about failures
                let errorMsg = `${successCount} of ${totalToAnalyze} criteria analyzed.`;
                if (networkErrors > 0) {
                    errorMsg += ` ${networkErrors} failed due to connection issues.`;
                }
                if (visionErrors > 0 && state.visionEnabled) {
                    errorMsg += ` Vision analysis had ${visionErrors} failures.`;
                }
                showToast('warning', 'Analysis Partially Complete', errorMsg);

                // Show detailed error modal
                showAnalysisErrorSummary(state.apiErrors, totalToAnalyze, successCount);
            } else {
                showToast('success', 'Auto-Analysis Complete', `${totalToAnalyze} criteria analyzed. Review and adjust scores below.`);
            }

            // Update header error indicator (v7.19)
            updateApiErrorIndicator();
        } catch (error) {
            hideLoading();
            state.isAutoAnalyzing = false;
            updateApiErrorIndicator(); // Also update on failure (v7.19)
            showError('Auto-Analysis Failed', error.message, autoAnalyzeRemaining);
        }
    }

    // Re-analyze all criteria (generates new suggestions but doesn't overwrite existing scores)
    async function reAnalyzeAll() {
        state.isAutoAnalyzing = true;
        // Reset error tracking (v7.19)
        state.apiErrors = [];
        state.visionFailures = 0;
        showLoading('Re-Analyzing All Criteria', `Generating fresh AI suggestions...`, true);

        try {
            for (let i = 0; i < CRITERIA.length; i++) {
                const criterion = CRITERIA[i];
                updateLoadingProgress(Math.round((i / CRITERIA.length) * 100), `Re-analyzing ${criterion.id.toUpperCase()}...`);

                const suggestion = await getAISuggestion(criterion);
                if (suggestion) {
                    state.aiSuggestions[criterion.id] = suggestion;
                }
            }

            updateLoadingProgress(100, 'Re-analysis complete!');
            await new Promise(resolve => setTimeout(resolve, 500));

            hideLoading();
            state.isAutoAnalyzing = false;
            state.currentStep = 'globalReview';
            debouncedAutoSave();
            render();

            // Show analysis summary with any errors (v7.19)
            const totalToAnalyze = CRITERIA.length;
            const successCount = totalToAnalyze - state.apiErrors.length;

            if (state.apiErrors.length > 0) {
                let errorMsg = `${successCount} of ${totalToAnalyze} criteria re-analyzed.`;
                if (state.visionFailures > 0 && state.visionEnabled) {
                    errorMsg += ` Vision analysis had ${state.visionFailures} failures.`;
                }
                showToast('warning', 'Re-Analysis Partially Complete', errorMsg);
                showAnalysisErrorSummary(state.apiErrors, totalToAnalyze, successCount);
            } else {
                showToast('success', 'Re-Analysis Complete', 'Fresh AI suggestions generated. Your scores are preserved.');
            }

            updateApiErrorIndicator();
        } catch (error) {
            hideLoading();
            state.isAutoAnalyzing = false;
            updateApiErrorIndicator();
            showError('Re-Analysis Failed', error.message, reAnalyzeAll);
        }
    }

    // Original function - starts fresh auto-analyze from upload screen
    async function startAutoAnalyzeAll() {
        if (!state.apiKey) {
            showToast('error', 'API Key Required', 'Please add your Anthropic API key in Settings to use Auto-Analyze.');
            showSettings();
            return;
        }

        state.isAutoAnalyzing = true;
        state.autoAnalyzeProgress = 0;
        state.autoAnalyzeCancelled = false; // Reset cancel flag (v7.21)
        showLoading('Auto-Analyzing All Criteria', `Preparing batch analysis...`, true, true); // showCancel=true (v7.21)

        try {
            // Filter criteria that need analysis (don't have suggestions yet)
            const criteriaToAnalyze = CRITERIA.filter(c => !state.aiSuggestions[c.id]);
            const totalToAnalyze = criteriaToAnalyze.length;
            let completed = 0;
            let wasCancelled = false; // Track if cancelled (v7.21)

            // Process in parallel batches for speed (respects rate limits)
            const batchSize = CONFIG.API_PARALLEL_BATCH_SIZE;

            for (let i = 0; i < criteriaToAnalyze.length; i += batchSize) {
                // Check if cancelled before starting batch (v7.21)
                if (state.autoAnalyzeCancelled) {
                    wasCancelled = true;
                    showToast('info', 'Analysis Stopped', `Stopped after analyzing ${completed} of ${totalToAnalyze} criteria. Completed criteria have been saved.`);
                    break;
                }

                const batch = criteriaToAnalyze.slice(i, i + batchSize);
                const batchIds = batch.map(c => c.id.toUpperCase()).join(', ');

                updateLoadingProgress(
                    Math.round((completed / totalToAnalyze) * 100),
                    `Analyzing batch: ${batchIds}...`
                );

                // Process batch in parallel
                const results = await Promise.allSettled(
                    batch.map(criterion => getAISuggestion(criterion))
                );

                // Process results
                results.forEach((result, idx) => {
                    const criterion = batch[idx];
                    if (result.status === 'fulfilled' && result.value) {
                        const suggestion = result.value;
                        state.aiSuggestions[criterion.id] = suggestion;
                        state.scores[criterion.id] = suggestion.suggestedScore;
                        let comment = suggestion.reasoning;
                        if (suggestion.relevantExcerpts?.length) {
                            comment += '\n\nEvidence: ' + suggestion.relevantExcerpts.map(e => '"' + e + '"').join('; ');
                        }
                        state.comments[criterion.id] = comment;
                    } else if (result.status === 'rejected') {
                        console.warn(`[Auto-Analyze] Failed for ${criterion.id}:`, result.reason);
                    }
                    completed++;
                });

                // Small delay between batches to avoid rate limiting
                if (i + batchSize < criteriaToAnalyze.length) {
                    await new Promise(r => setTimeout(r, 200));
                }
            }

            // Store original scores for impact tracking
            state.originalScores = { ...state.scores };

            if (!wasCancelled) {
                updateLoadingProgress(100, 'Analysis complete!');
                await new Promise(resolve => setTimeout(resolve, 500)); // Brief pause to show completion
            }

            hideLoading();
            state.isAutoAnalyzing = false;
            state.currentStep = 'globalReview';
            debouncedAutoSave();
            render();

            if (!wasCancelled) {
                const cachedCount = CRITERIA.length - totalToAnalyze;
                const msg = cachedCount > 0
                    ? `Analyzed ${totalToAnalyze} criteria (${cachedCount} from cache). Review and adjust below.`
                    : `All ${CRITERIA.length} criteria analyzed. Review and adjust below.`;
                showToast('success', 'Auto-Analysis Complete', msg);
            }
        } catch (error) {
            hideLoading();
            state.isAutoAnalyzing = false;
            showError('Auto-Analysis Failed', error.message, startAutoAnalyzeAll);
        }
    }

    function calculateImpact() {
        const totalScore = Object.values(state.scores).reduce((a, b) => a + (b || 0), 0);
        const maxScore = CRITERIA.reduce((a, c) => a + c.validScores[c.validScores.length - 1], 0);
        const percentage = Math.round((totalScore / maxScore) * 100);

        // Calculate changes from original
        let changes = [];
        for (const c of CRITERIA) {
            const original = state.originalScores[c.id];
            const current = state.scores[c.id];
            if (original !== undefined && current !== undefined && original !== current) {
                changes.push({
                    criterion: c,
                    original,
                    current,
                    diff: current - original
                });
            }
        }

        // Funding recommendation based on score
        let fundingRecommendation = '';
        let fundingClass = '';
        if (percentage >= 75) {
            fundingRecommendation = 'Strong Candidate - Recommend Full Funding';
            fundingClass = 'text-green-600';
        } else if (percentage >= 60) {
            fundingRecommendation = 'Good Candidate - Recommend Funding with Conditions';
            fundingClass = 'text-[#036CB6]';
        } else if (percentage >= 45) {
            fundingRecommendation = 'Marginal Candidate - Consider Partial Funding';
            fundingClass = 'text-amber-600';
        } else {
            fundingRecommendation = 'Weak Candidate - Not Recommended for Funding';
            fundingClass = 'text-red-600';
        }

        return { totalScore, maxScore, percentage, changes, fundingRecommendation, fundingClass };
    }

    function renderGlobalReviewStep(container) {
        const impact = calculateImpact();
        const sections = [...new Set(CRITERIA.map(c => c.section))];
        const simpleMode = isSimpleMode();

        container.innerHTML = `
            <div class="fade-in flex flex-col" style="height: calc(100vh - 240px); min-height: 450px;">
                <!-- STICKY HEADER - Score Summary & Recommendation (v7.21 - Compact) -->
                <div class="flex-shrink-0 smc-review-gradient text-white rounded-xl ${simpleMode ? 'p-3' : 'px-4 py-2'} mb-3 shadow-lg">
                    <div class="flex items-center justify-between flex-wrap gap-2">
                        <div class="flex items-center gap-2">
                            <h2 class="${simpleMode ? 'text-lg' : 'text-base'} font-bold">${simpleMode ? 'Review Scores' : 'Global Review'}</h2>
                            ${!simpleMode ? `<span class="text-teal-200 text-xs hidden sm:inline">‚Ä¢ Adjust scores to see impact</span>` : ''}
                        </div>
                        <div class="flex items-center gap-3">
                            <!-- Funding Recommendation (compact) -->
                            <div class="flex items-center gap-1.5 bg-white/10 rounded-md px-2 py-1">
                                <svg class="w-3.5 h-3.5 ${impact.fundingClass === 'text-green-600' ? 'text-green-300' : impact.fundingClass === 'text-amber-600' ? 'text-amber-300' : impact.fundingClass === 'text-red-600' ? 'text-red-300' : 'text-teal-300'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="font-medium text-xs">${impact.fundingRecommendation}</span>
                            </div>
                            <!-- Score Display -->
                            <div class="text-right">
                                <div class="${simpleMode ? 'text-2xl' : 'text-xl'} font-bold leading-tight">${impact.totalScore} / ${impact.maxScore}</div>
                                <div class="text-teal-100 text-[10px]">${impact.percentage}% score</div>
                            </div>
                        </div>
                    </div>

                    ${!simpleMode && impact.changes.length > 0 ? `
                        <div class="mt-1.5 bg-amber-500/20 rounded-md px-2 py-1">
                            <p class="text-amber-200 text-[10px]">
                                <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                Changed ${impact.changes.length} score(s): ${impact.changes.map(ch => `${ch.criterion.id.toUpperCase()}`).join(', ')}
                            </p>
                        </div>
                    ` : ''}

                    <!-- Quick Stats Row (compact, single row) - Hidden in Simple Mode for more space -->
                    ${simpleMode ? '' : `
                    <div class="flex gap-1.5 mt-2">
                        ${sections.map(s => {
                            const sectionCriteria = CRITERIA.filter(c => c.section === s);
                            const sectionScore = sectionCriteria.reduce((a, c) => a + (state.scores[c.id] || 0), 0);
                            const sectionMax = sectionCriteria.reduce((a, c) => a + c.validScores[c.validScores.length - 1], 0);
                            const sectionPct = Math.round((sectionScore / sectionMax) * 100);
                            return `
                                <div class="flex-1 bg-white/10 rounded-md px-2 py-1 text-center min-w-0">
                                    <p class="text-[10px] text-teal-100 truncate">${sectionCriteria[0].sectionTitle}</p>
                                    <p class="text-sm font-bold ${sectionPct >= 70 ? 'text-green-300' : sectionPct >= 50 ? 'text-amber-300' : 'text-red-300'}">${sectionScore}/${sectionMax}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    `}
                </div>

                <!-- Global Notes Include/Exclude Toggle (v7.21 - Compact) -->
                <div class="flex-shrink-0 mb-2 flex items-center justify-between bg-slate-50 border border-slate-200 rounded-md px-3 py-1.5">
                    <div class="flex items-center gap-1.5">
                        <svg class="w-3.5 h-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        <span class="text-xs font-medium text-slate-600">Notes for Export</span>
                        <span class="text-[10px] text-slate-400">(${Object.values(state.notesIncluded).filter(v => v === false).length} excluded)</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <button onclick="toggleAllNotesIncluded(true)"
                            class="text-[11px] px-2 py-1 rounded-md transition-all bg-green-100 text-green-700 hover:bg-green-200 font-medium">
                            Include All
                        </button>
                        <button onclick="toggleAllNotesIncluded(false)"
                            class="text-[11px] px-2 py-1 rounded-md transition-all bg-slate-100 text-slate-500 hover:bg-slate-200 font-medium">
                            Exclude All
                        </button>
                    </div>
                </div>

                <!-- SCROLLABLE CONTENT AREA -->
                <div class="flex-1 overflow-y-auto pr-2" style="scrollbar-width: thin;">
                    <!-- All Criteria Cards -->
                <div class="space-y-4 mb-6">
                    ${CRITERIA.map((c, idx) => {
                        const suggestion = state.aiSuggestions[c.id];
                        const currentScore = state.scores[c.id];
                        const originalScore = state.originalScores[c.id];
                        const hasChanged = originalScore !== undefined && currentScore !== originalScore;
                        const currentComment = state.comments[c.id] || '';

                        // Simple Mode: Cleaner card with better readability (v7.21)
                        const notesIncluded = state.notesIncluded[c.id] !== false; // Default to true
                        if (simpleMode) {
                            return `
                                <div class="global-review-card bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                    <!-- Compact Header -->
                                    <div class="flex items-center justify-between px-4 py-2 bg-slate-50 border-b border-slate-200">
                                        <div class="flex items-center gap-2">
                                            <span class="w-7 h-7 bg-[#38939B] text-white rounded-lg flex items-center justify-center text-xs font-bold">${c.id.toUpperCase()}</span>
                                            <p class="font-medium text-slate-800 text-sm">${c.question.substring(0, 60)}${c.question.length > 60 ? '...' : ''}</p>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-lg font-bold ${currentScore >= c.validScores[c.validScores.length - 1] * 0.7 ? 'text-green-600' : currentScore >= c.validScores[c.validScores.length - 1] * 0.4 ? 'text-amber-600' : 'text-red-600'}">${currentScore}/${c.validScores[c.validScores.length - 1]}</span>
                                        </div>
                                    </div>
                                    <div class="p-4">
                                        <!-- Score Selection Row -->
                                        <div class="flex items-start gap-4 mb-3">
                                            <!-- Score Buttons -->
                                            <div class="flex gap-1 flex-shrink-0">
                                                ${c.validScores.map(score => `
                                                    <button onclick="updateGlobalScore('${c.id}', ${score})"
                                                        class="w-9 h-9 rounded-lg font-bold text-sm border-2 transition-all ${currentScore === score ? 'bg-[#38939B] text-white border-[#38939B]' : 'bg-white text-slate-600 border-slate-200 hover:border-[#5bb5bd]'}">
                                                        ${score}
                                                    </button>
                                                `).join('')}
                                            </div>
                                            <!-- AI Suggestion Badge -->
                                            ${suggestion ? `
                                                <div class="flex items-center gap-1 text-xs bg-green-50 text-green-700 px-2 py-1 rounded-lg">
                                                    <span class="font-semibold">AI: ${suggestion.suggestedScore}</span>
                                                </div>
                                            ` : ''}
                                        </div>

                                        <!-- AI Reasoning - Always Visible & Readable -->
                                        ${suggestion && suggestion.reasoning ? `
                                            <div class="bg-[#F3FAFE] border border-[#B2D5EE] rounded-lg p-3 mb-3 ${regeneratingCriteria.has(c.id) ? 'opacity-50' : ''}">
                                                <div class="flex items-start justify-between gap-2">
                                                    <p class="text-sm text-slate-700 leading-relaxed flex-1">${regeneratingCriteria.has(c.id) ? '<span class="italic text-slate-500">Regenerating AI comment...</span>' : suggestion.reasoning}</p>
                                                    <button onclick="regenerateComment('${c.id}')"
                                                        class="flex-shrink-0 p-1.5 text-[#036CB6] hover:bg-[#036CB6]/10 rounded-lg transition-colors ${regeneratingCriteria.has(c.id) ? 'animate-spin' : ''}"
                                                        title="Regenerate AI comment"
                                                        ${regeneratingCriteria.has(c.id) ? 'disabled' : ''}>
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                                    </button>
                                                </div>
                                            </div>
                                        ` : ''}

                                        <!-- Notes Section with Include Toggle -->
                                        <div class="border-t border-slate-100 pt-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <label class="flex items-center gap-2 text-xs font-medium text-slate-600">
                                                    Your Notes ${currentComment ? '<span class="text-[#38939B]">‚Ä¢</span>' : ''}
                                                </label>
                                                <div class="flex items-center gap-1.5">
                                                    ${currentComment ? `
                                                        <button onclick="clearNotes('${c.id}')"
                                                            class="flex items-center gap-1 text-xs px-2 py-1 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-all"
                                                            title="Clear notes">
                                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                                            Clear
                                                        </button>
                                                    ` : ''}
                                                    <button onclick="toggleNotesIncluded('${c.id}')"
                                                        class="flex items-center gap-1.5 text-xs px-2 py-1 rounded-lg transition-all ${notesIncluded ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}">
                                                        <span class="w-3 h-3 rounded-full border-2 flex items-center justify-center ${notesIncluded ? 'border-green-500 bg-green-500' : 'border-slate-400'}">
                                                            ${notesIncluded ? '<svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>' : ''}
                                                        </span>
                                                        ${notesIncluded ? 'Include' : 'Exclude'}
                                                    </button>
                                                </div>
                                            </div>
                                            <textarea id="comment-textarea-${c.id}"
                                                onchange="updateGlobalComment('${c.id}', this.value)"
                                                rows="3"
                                                class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-[#38939B] resize-y transition-all ${notesIncluded ? 'border-slate-200 bg-white text-slate-700' : 'border-slate-200/40 bg-slate-50/30 text-slate-400/60 hover:text-slate-500 hover:bg-slate-50 hover:border-slate-300 focus:text-slate-700 focus:bg-white focus:border-slate-300'}"
                                                placeholder="Add your notes about this criterion...">${currentComment}</textarea>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }

                        // Pro Mode: Full card with counter-arguments
                        return `
                            <div class="global-review-card bg-white rounded-xl border ${hasChanged ? 'border-amber-300 ring-2 ring-amber-100' : 'border-slate-200'} shadow-sm overflow-hidden">
                                <div class="flex items-center justify-between px-4 py-3 bg-slate-50 border-b border-slate-200">
                                    <div class="flex items-center gap-3">
                                        <span class="w-8 h-8 bg-[#38939B] text-white rounded-lg flex items-center justify-center text-sm font-bold">${c.id.toUpperCase()}</span>
                                        <div>
                                            <p class="font-semibold text-slate-800 text-sm">${c.question.substring(0, 60)}${c.question.length > 60 ? '...' : ''}</p>
                                            <p class="text-xs text-slate-500">${c.sectionTitle} ‚Ä¢ Max ${c.validScores[c.validScores.length - 1]} pts</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        ${hasChanged ? `<span class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded">Changed from ${originalScore}</span>` : ''}
                                        ${suggestion ? `<span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">${suggestion.confidence} confidence</span>` : ''}
                                    </div>
                                </div>
                                <div class="p-4">
                                    <div class="flex items-start gap-4">
                                        <!-- Score Selection -->
                                        <div class="flex-shrink-0">
                                            <p class="text-xs font-medium text-slate-500 mb-2">SCORE</p>
                                            <div class="flex gap-1">
                                                ${c.validScores.map(score => `
                                                    <button onclick="updateGlobalScore('${c.id}', ${score})"
                                                        class="w-10 h-10 rounded-lg font-bold text-sm border-2 transition-all ${currentScore === score ? 'bg-[#38939B] text-white border-[#38939B]' : 'bg-white text-slate-600 border-slate-200 hover:border-[#5bb5bd]'}">
                                                        ${score}
                                                    </button>
                                                `).join('')}
                                            </div>
                                        </div>

                                        <!-- AI Reasoning & Comment -->
                                        <div class="flex-1 min-w-0" data-criterion="${c.id}">
                                            ${suggestion ? `
                                                <div class="mb-3 grid grid-cols-1 ${suggestion.counterScore !== undefined && suggestion.counterScore > suggestion.suggestedScore ? 'md:grid-cols-2' : ''} gap-2">
                                                    <!-- AI Recommendation -->
                                                    <div class="bg-green-50 border border-green-200 rounded-lg p-2 ${regeneratingCriteria.has(c.id) ? 'opacity-50' : ''}">
                                                        <div class="flex items-center justify-between gap-2 mb-1">
                                                            <p class="text-xs font-bold ${suggestion.suggestedScore === currentScore ? 'text-green-700' : 'text-green-600'}">
                                                                ${regeneratingCriteria.has(c.id) ? 'REGENERATING...' : `RECOMMEND: Score ${suggestion.suggestedScore}`}
                                                                ${!regeneratingCriteria.has(c.id) && suggestion.suggestedScore === currentScore ? ' ‚úì' : ''}
                                                            </p>
                                                            <button onclick="regenerateComment('${c.id}')"
                                                                class="p-1 text-green-600 hover:bg-green-100 rounded transition-colors ${regeneratingCriteria.has(c.id) ? 'animate-spin' : ''}"
                                                                title="Regenerate AI comment"
                                                                ${regeneratingCriteria.has(c.id) ? 'disabled' : ''}>
                                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                                            </button>
                                                        </div>
                                                        <p class="text-xs text-green-800 line-clamp-2">${regeneratingCriteria.has(c.id) ? '<span class="italic">Getting fresh AI analysis...</span>' : (suggestion.reasoning?.substring(0, 100) + '...')}</p>
                                                        <button onclick="acceptRecommendationForCriterion('${c.id}')" class="text-xs text-green-700 hover:text-green-900 font-medium mt-1">
                                                            ${suggestion.suggestedScore === currentScore ? 'Already selected' : 'Accept ‚Üí'}
                                                        </button>
                                                    </div>

                                                    ${suggestion.counterScore !== undefined && suggestion.counterScore > suggestion.suggestedScore ? `
                                                        <!-- Counter-Argument (shown prominently when higher score) -->
                                                        <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-2">
                                                            <div class="flex items-center gap-2 mb-1">
                                                                <p class="text-xs font-bold text-amber-700">
                                                                    ‚¨ÜÔ∏è HIGHER SCORE POSSIBLE: ${suggestion.counterScore}
                                                                    ${suggestion.counterScore === currentScore ? ' ‚úì' : ''}
                                                                </p>
                                                            </div>
                                                            <p class="text-xs text-amber-800 line-clamp-2">${suggestion.counterArgument?.substring(0, 100)}...</p>
                                                            <button onclick="acceptCounterFromModal('${c.id}')" class="text-xs text-amber-700 hover:text-amber-900 font-medium mt-1">
                                                                ${suggestion.counterScore === currentScore ? 'Already selected' : 'Accept higher score ‚Üí'}
                                                            </button>
                                                        </div>
                                                    ` : suggestion.counterArgument ? `
                                                        <!-- Counter at lower score - less prominent -->
                                                        <button onclick="showCounterArgumentModal('${c.id}')" class="text-xs text-amber-600 hover:text-amber-800 bg-amber-50 px-2 py-1 rounded self-start">
                                                            View counter (Score ${suggestion.counterScore}) ‚Üí
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            ` : ''}
                                            <!-- Notes Section with Include Toggle (Pro Mode v7.21 - Always Visible) -->
                                            <div>
                                                <div class="flex items-center justify-between mb-1">
                                                    <label class="flex items-center gap-2 text-xs font-medium ${!currentComment.trim() ? 'text-red-500' : 'text-slate-600'}">
                                                        YOUR NOTES ${!currentComment.trim() ? '<span class="text-red-500">*</span>' : '<span class="w-2 h-2 bg-green-500 rounded-full"></span>'}
                                                    </label>
                                                    <div class="flex items-center gap-1.5">
                                                        ${currentComment.trim() ? `
                                                            <button onclick="clearNotes('${c.id}')"
                                                                class="flex items-center gap-1 text-xs px-2 py-1 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-all"
                                                                title="Clear notes">
                                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                                                Clear
                                                            </button>
                                                        ` : ''}
                                                        <button onclick="toggleNotesIncluded('${c.id}')"
                                                            class="flex items-center gap-1.5 text-xs px-2 py-1 rounded-lg transition-all ${notesIncluded ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}">
                                                            <span class="w-3 h-3 rounded-full border-2 flex items-center justify-center ${notesIncluded ? 'border-green-500 bg-green-500' : 'border-slate-400'}">
                                                                ${notesIncluded ? '<svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>' : ''}
                                                            </span>
                                                            ${notesIncluded ? 'Include' : 'Exclude'}
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="comment-textarea-pro-${c.id}"
                                                    onchange="updateGlobalComment('${c.id}', this.value)"
                                                    rows="4"
                                                    class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-[#38939B] resize-y min-h-[100px] transition-all ${!currentComment.trim() ? 'border-red-300 bg-red-50 text-slate-700' : notesIncluded ? 'border-slate-200 bg-white text-slate-700' : 'border-slate-200/40 bg-slate-50/30 text-slate-400/60 hover:text-slate-500 hover:bg-slate-50 hover:border-slate-300 focus:text-slate-700 focus:bg-white focus:border-slate-300'}"
                                                    placeholder="Add your notes explaining this score...">${currentComment}</textarea>
                                            </div>
                                        </div>

                                        <!-- View Evidence Button -->
                                        <div class="flex-shrink-0">
                                            ${suggestion?.relevantExcerpts?.length ? `
                                                <button onclick="showEvidenceForCriterion('${c.id}')" class="p-2 text-slate-400 hover:text-[#036CB6] hover:bg-[#E3EDF5] rounded-lg transition-colors" title="View evidence in document">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                </div>
                <!-- END SCROLLABLE CONTENT AREA -->

                <!-- STICKY FOOTER NAVIGATION (v7.21 - Fixed visibility) -->
                <div class="flex-shrink-0 pt-3 pb-3 px-4 mt-2 border-t border-slate-200 bg-slate-50 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                    <button onclick="goBack()" class="px-6 py-2.5 border border-slate-300 text-slate-700 rounded-xl hover:bg-slate-100 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        Back
                    </button>
                    <div class="flex items-center gap-3">
                        ${!simpleMode ? `
                            <button onclick="resetToAIRecommendations()" class="px-4 py-3 text-purple-600 hover:bg-purple-50 rounded-xl transition-colors text-sm font-medium">
                                Reset to AI Recommendations
                            </button>
                        ` : ''}
                        <button onclick="proceedFromGlobalReview()" class="px-6 py-2.5 bg-gradient-to-r from-[#38939B] to-[#036CB6] text-white font-semibold rounded-xl hover:from-[#2a7078] hover:to-[#02538C] transition-all shadow-lg hover:shadow-xl flex items-center gap-2">
                            ${simpleMode ? 'Finish' : 'Continue to Recommendation'}
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                    </div>
                </div>
            </div>
        `;
    }

    function updateGlobalScore(criterionId, score, skipHistory = false) {
        const oldScore = state.scores[criterionId];

        // Track in history for undo (unless skipping, e.g., during undo itself)
        if (!skipHistory && oldScore !== undefined && oldScore !== score) {
            state.scoreHistory.push({
                criterionId,
                oldScore,
                newScore: score,
                timestamp: Date.now()
            });
            // Keep only last 50 changes
            if (state.scoreHistory.length > 50) {
                state.scoreHistory.shift();
            }
        }

        state.scores[criterionId] = score;
        debouncedAutoSave();
        updateUndoButton(); // Show/hide undo button based on history (v7.21)
        render();
    }

    // Undo the last score change (v7.21)
    function undoLastScoreChange() {
        if (!state.scoreHistory || state.scoreHistory.length === 0) {
            showToast('info', 'Nothing to Undo', 'No recent score changes to undo.');
            return;
        }

        const lastChange = state.scoreHistory.pop();
        updateGlobalScore(lastChange.criterionId, lastChange.oldScore, true); // skipHistory=true
        updateUndoButton(); // Update button visibility after undo (v7.21)

        const criterion = CRITERIA.find(c => c.id === lastChange.criterionId);
        showToast('success', 'Undo Successful', `${criterion?.id.toUpperCase() || lastChange.criterionId}: Score reverted from ${lastChange.newScore} to ${lastChange.oldScore}`);
    }

    function updateGlobalComment(criterionId, comment) {
        state.comments[criterionId] = comment;
        debouncedAutoSave();
    }

    // Toggle whether notes for a criterion should be included in export (v7.21)
    function toggleNotesIncluded(criterionId) {
        // Default is true (included), toggle to opposite
        const currentValue = state.notesIncluded[criterionId] !== false;
        state.notesIncluded[criterionId] = !currentValue;
        debouncedAutoSave();
        render();
    }

    // Toggle all notes included/excluded at once (v7.21)
    function toggleAllNotesIncluded(includeAll) {
        CRITERIA.forEach(c => {
            state.notesIncluded[c.id] = includeAll;
        });
        debouncedAutoSave();
        render();
    }

    // Track which criteria are currently regenerating (v7.21)
    const regeneratingCriteria = new Set();

    // Regenerate AI comment for a specific criterion (v7.21)
    async function regenerateComment(criterionId) {
        const criterion = CRITERIA.find(c => c.id === criterionId);
        if (!criterion) return;

        // Prevent double-clicks while already regenerating
        if (regeneratingCriteria.has(criterionId)) {
            showToast('info', 'Please Wait', 'Already regenerating this comment...');
            return;
        }

        // Check for API key
        if (!state.apiKey) {
            showToast('error', 'No API Key', 'Please set your API key in settings first.');
            return;
        }

        // Check for application text (use applicationText, not documentText)
        if (!state.applicationText || state.applicationText.length === 0) {
            showToast('error', 'No Document', 'Please upload an application document first to regenerate comments.');
            return;
        }

        // Set loading state and re-render to show spinner
        regeneratingCriteria.add(criterionId);
        render();

        showToast('info', 'Regenerating...', `Getting fresh AI analysis for ${criterion.id.toUpperCase()}`);

        // Clear the cache for this criterion to force a fresh call
        clearCacheForCriterion(criterionId);

        try {
            // Re-analyze this criterion using getAISuggestion (which handles all the hashing/caching)
            const result = await getAISuggestion(criterion);

            if (result) {
                // Update the suggestion
                state.aiSuggestions[criterionId] = result;

                // Auto-populate the notes field with the new AI reasoning + evidence
                let comment = result.reasoning || '';
                if (result.relevantExcerpts?.length) {
                    comment += '\n\nEvidence: ' + result.relevantExcerpts.map(e => '"' + e + '"').join('; ');
                }
                state.comments[criterionId] = comment;

                debouncedAutoSave();
                showToast('success', 'Regenerated', `Fresh AI comment for ${criterion.id.toUpperCase()}`);
            } else {
                showToast('error', 'Failed', 'Could not regenerate comment. Please try again.');
            }
        } catch (error) {
            console.error('Regenerate error:', error);
            showToast('error', 'Error', error.message || 'Failed to regenerate comment');
        } finally {
            // Clear loading state and re-render
            regeneratingCriteria.delete(criterionId);
            render();
        }
    }

    // Clear notes for a specific criterion (v7.21)
    function clearNotes(criterionId) {
        state.comments[criterionId] = '';
        debouncedAutoSave();
        render();
        showToast('info', 'Notes Cleared', `Notes for ${criterionId.toUpperCase()} have been cleared.`);
    }

    function toggleCommentExpand(criterionId) {
        const area = document.getElementById(`comment-area-${criterionId}`);
        const chevron = document.getElementById(`comment-chevron-${criterionId}`);
        const textarea = document.getElementById(`comment-textarea-${criterionId}`);

        if (area && chevron) {
            const isHidden = area.classList.contains('hidden');
            if (isHidden) {
                area.classList.remove('hidden');
                chevron.classList.add('rotate-90');
                // Focus the textarea when expanded
                if (textarea) {
                    setTimeout(() => textarea.focus(), 100);
                }
            } else {
                area.classList.add('hidden');
                chevron.classList.remove('rotate-90');
            }
        }
    }

    function showEvidenceForCriterion(criterionId) {
        const suggestion = state.aiSuggestions[criterionId];
        const criterion = CRITERIA.find(c => c.id === criterionId);

        if (!suggestion) {
            showToast('info', 'No AI Analysis', 'No AI analysis available for this criterion. Run AI scoring first.');
            return;
        }

        // Create evidence modal with reasoning and excerpts
        const overlay = document.createElement('div');
        overlay.id = 'evidenceModal';
        overlay.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
        overlay.innerHTML = `
            <div class="bg-white rounded-2xl max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="p-6 border-b border-slate-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">${criterionId.toUpperCase()}: Evidence & Reasoning</h3>
                            <p class="text-sm text-slate-500 mt-1">${criterion?.question || ''}</p>
                        </div>
                        <button onclick="document.getElementById('evidenceModal').remove()" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-y-auto flex-1">
                    <!-- Score Badge -->
                    <div class="flex items-center gap-3 mb-4">
                        <span class="px-3 py-1 bg-[#E3EDF5] text-[#02538C] rounded-full text-sm font-semibold">
                            AI Suggested Score: ${suggestion.suggestedScore}
                        </span>
                        <span class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs">
                            Confidence: ${suggestion.confidence || 'medium'}
                        </span>
                    </div>

                    <!-- Reasoning Section -->
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                            <svg class="w-4 h-4 text-[#036CB6]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            AI Reasoning
                        </h4>
                        <div class="bg-[#F3FAFE] border border-[#7CBEEC] rounded-xl p-4">
                            <p class="text-sm text-slate-700 leading-relaxed">${suggestion.reasoning || 'No reasoning provided.'}</p>
                        </div>
                    </div>

                    <!-- Evidence Excerpts -->
                    ${suggestion.relevantExcerpts?.length ? `
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            Evidence from Application
                            ${suggestion.pageReferences?.length ? `<span class="text-xs text-slate-400">(Pages: ${suggestion.pageReferences.join(', ')})</span>` : ''}
                        </h4>
                        <div class="space-y-2">
                            ${suggestion.relevantExcerpts.map((excerpt, i) => `
                                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 cursor-pointer hover:bg-amber-100 transition-colors" onclick="findExcerptInPdf('${excerpt.replace(/'/g, "\\'")}', '${criterionId}')">
                                    <p class="text-sm text-slate-700 italic">"${excerpt}"</p>
                                    <p class="text-xs text-amber-600 mt-1">Click to find in document ‚Üí</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : '<p class="text-sm text-slate-500 italic mb-6">No specific excerpts identified.</p>'}

                    <!-- Counter Argument if exists -->
                    ${suggestion.counterArgument ? `
                    <div>
                        <h4 class="text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                            <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Counter-Argument (Score ${suggestion.counterScore})
                        </h4>
                        <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                            <p class="text-sm text-slate-700 leading-relaxed">${suggestion.counterArgument}</p>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Recommended Supporting Documents (v7.17) -->
                    ${buildDocumentRecommendationsHTML(criterionId)}
                </div>
                <div class="p-4 border-t border-slate-200 bg-slate-50">
                    <button onclick="document.getElementById('evidenceModal').remove(); showPdfViewer('Full Document', ${JSON.stringify(suggestion.relevantExcerpts || []).replace(/"/g, '&quot;')}, true, '${criterionId}')" class="w-full px-4 py-2 bg-[#38939B] text-white rounded-xl hover:bg-[#2a7078] transition-colors">
                        Open Document Viewer
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
        overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
    }

    function findExcerptInPdf(searchText, criterionId = null) {
        document.getElementById('evidenceModal')?.remove();

        // Use the improved page finding logic with whitespace normalization
        const foundPage = findBestPageForExcerpts([searchText]);

        if (foundPage > 0 || state.pdfPages.length > 0) {
            // Set page BEFORE showing viewer so it opens on the correct page
            state.pdfViewerCurrentPage = foundPage;
            showPdfViewer('Evidence Location', [searchText], true, criterionId);

            // Only show "not found" toast if we defaulted to page 0 and couldn't actually find the text
            if (foundPage === 0) {
                // Double-check if text was actually found on page 0
                const normalizedSearch = searchText.replace(/\s+/g, ' ').trim().toLowerCase().substring(0, 30);
                const normalizedPage0 = (state.pdfPages[0] || '').replace(/\s+/g, ' ').toLowerCase();
                if (!normalizedPage0.includes(normalizedSearch)) {
                    showToast('info', 'Excerpt Location', 'Showing document from beginning. Text may be on a different page.');
                }
            }
        } else {
            showPdfViewer('Document', [searchText], true, criterionId);
            showToast('info', 'Excerpt Not Found', 'Could not locate exact text. Showing full document.');
        }
    }

    function acceptRecommendationForCriterion(criterionId) {
        const suggestion = state.aiSuggestions[criterionId];
        if (suggestion) {
            state.scores[criterionId] = suggestion.suggestedScore;
            let comment = suggestion.reasoning;
            if (suggestion.relevantExcerpts?.length) {
                comment += '\n\nEvidence: ' + suggestion.relevantExcerpts.map(e => '"' + e + '"').join('; ');
            }
            state.comments[criterionId] = comment;
            debouncedAutoSave();
            render();
            showToast('success', 'Score & Comment Set', `${criterionId.toUpperCase()} set to ${suggestion.suggestedScore} with AI reasoning.`);
        }
    }

    function showCounterArgumentModal(criterionId) {
        const suggestion = state.aiSuggestions[criterionId];
        const criterion = CRITERIA.find(c => c.id === criterionId);
        if (!suggestion || !criterion) return;

        // Create a simple modal overlay
        const overlay = document.createElement('div');
        overlay.id = 'counterArgModal';
        overlay.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
        overlay.innerHTML = `
            <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-slate-800">Counter-Argument for ${criterionId.toUpperCase()}</h3>
                        <button onclick="document.getElementById('counterArgModal').remove()" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <span class="font-semibold text-amber-800">Consider Score ${suggestion.counterScore}</span>
                        </div>
                        <p class="text-sm text-amber-900">${suggestion.counterArgument}</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="document.getElementById('counterArgModal').remove()" class="flex-1 px-4 py-2 border border-slate-300 rounded-xl text-slate-600 hover:bg-slate-50">
                            Keep Current Score
                        </button>
                        <button onclick="acceptCounterFromModal('${criterionId}')" class="flex-1 px-4 py-2 bg-amber-600 text-white rounded-xl hover:bg-amber-700">
                            Accept Score ${suggestion.counterScore}
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
    }

    function acceptCounterFromModal(criterionId) {
        const suggestion = state.aiSuggestions[criterionId];
        if (suggestion) {
            state.scores[criterionId] = suggestion.counterScore;
            state.comments[criterionId] = suggestion.counterArgument;
            debouncedAutoSave();
            document.getElementById('counterArgModal')?.remove();
            render();
            showToast('success', 'Score Updated', `${criterionId.toUpperCase()} set to ${suggestion.counterScore} with counter-argument.`);
        }
    }

    function resetToAIRecommendations() {
        for (const c of CRITERIA) {
            const suggestion = state.aiSuggestions[c.id];
            if (suggestion) {
                state.scores[c.id] = suggestion.suggestedScore;
                let comment = suggestion.reasoning;
                if (suggestion.relevantExcerpts?.length) {
                    comment += '\n\nEvidence: ' + suggestion.relevantExcerpts.map(e => '"' + e + '"').join('; ');
                }
                state.comments[c.id] = comment;
            }
        }
        state.originalScores = { ...state.scores };
        debouncedAutoSave();
        render();
        showToast('info', 'Scores Reset', 'All scores have been reset to AI recommendations.');
    }

    function proceedFromGlobalReview() {
        // Check all scores are filled (check for both undefined AND null)
        const missingScores = CRITERIA.filter(c => state.scores[c.id] === undefined || state.scores[c.id] === null);
        if (missingScores.length > 0) {
            showToast('error', 'Missing Scores', `Please score: ${missingScores.map(c => c.id.toUpperCase()).join(', ')}`);
            return;
        }

        // Check all comments are filled (required)
        const missingComments = CRITERIA.filter(c => !state.comments[c.id] || state.comments[c.id].trim() === '');
        if (missingComments.length > 0) {
            showToast('error', 'Comments Required', `Please add comments for: ${missingComments.map(c => c.id.toUpperCase()).join(', ')}`);
            // Highlight the first missing comment
            const firstMissing = document.querySelector(`[data-criterion="${missingComments[0].id}"]`);
            if (firstMissing) firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        state.currentStep = 'recommendation';
        debouncedAutoSave();
        render();
    }

    function selectScore(criterionId, score) {
        state.scores[criterionId] = score;
        debouncedAutoSave();
        render();
    }

    // Jump directly to a specific criterion from summary/review screens
    function jumpToCriterion(index) {
        state.currentCriterionIndex = index;
        state.currentStep = 'scoring';
        state.returnToSummary = true; // Flag to return to summary after editing
        debouncedAutoSave();
        render();
        showToast('info', 'Edit Mode', `Editing criterion ${CRITERIA[index].id.toUpperCase()}. Click "Save & Return" when done.`);
    }

    // Save the current criterion and return to summary
    function saveAndReturnToSummary() {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const commentEl = document.getElementById('criterionComment');
        if (commentEl) state.comments[criterion.id] = commentEl.value;

        // Validate score is selected
        if (state.scores[criterion.id] === undefined || state.scores[criterion.id] === null) {
            showToast('error', 'Score Required', 'Please select a score before saving.');
            return;
        }

        // Clear the return flag and go back to summary
        state.returnToSummary = false;
        state.currentStep = 'summary';
        debouncedAutoSave();
        render();
        showToast('success', 'Saved', `${criterion.id.toUpperCase()} updated successfully.`);
    }

    // Cancel editing and return to summary without saving changes
    function cancelEditAndReturn() {
        state.returnToSummary = false;
        state.currentStep = 'summary';
        render();
    }

    async function requestAISuggestion() {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const area = document.getElementById('aiSuggestionArea');
        area.innerHTML = `<div class="ai-thinking rounded-xl p-4"><div class="flex items-center gap-3"><div class="typing-indicator flex gap-1"><span class="w-2 h-2 bg-[#38939B] rounded-full"></span><span class="w-2 h-2 bg-[#38939B] rounded-full"></span><span class="w-2 h-2 bg-[#38939B] rounded-full"></span></div><span class="text-[#02538C] font-medium">Analyzing application...</span></div></div>`;
        const suggestion = await getAISuggestion(criterion);
        if (suggestion) {
            state.aiSuggestions[criterion.id] = suggestion;
            debouncedAutoSave();
        }
        render();
    }

    function handleNextCriterion() {
        const criterion = CRITERIA[state.currentCriterionIndex];
        const suggestion = state.aiSuggestions[criterion.id];
        const commentEl = document.getElementById('criterionComment');
        if (commentEl) state.comments[criterion.id] = commentEl.value;
        if (state.scores[criterion.id] === undefined || state.scores[criterion.id] === null) {
            showToast('error', 'Score Required', 'Please select a score before continuing.');
            return;
        }
        const currentComment = state.comments[criterion.id] || '';
        const aiSuggestedScore = suggestion?.suggestedScore;
        const selectedScore = state.scores[criterion.id];
        if (!currentComment.trim()) {
            showCommentPrompt(criterion, selectedScore, aiSuggestedScore);
            return;
        }
        debouncedAutoSave();
        proceedToNextCriterion();
    }

    function proceedToNextCriterion() {
        if (state.currentCriterionIndex < CRITERIA.length - 1) {
            state.currentCriterionIndex++;
            render();
        } else {
            state.currentStep = 'recommendation';
            render();
        }
    }

    function goBack() {
        if (state.currentStep === 'scoring' && state.currentCriterionIndex > 0) {
            const criterion = CRITERIA[state.currentCriterionIndex];
            const commentEl = document.getElementById('criterionComment');
            if (commentEl) state.comments[criterion.id] = commentEl.value;
            state.currentCriterionIndex--;
        } else if (state.currentStep === 'scoring') {
            state.currentStep = 'projectInfo';
        } else if (state.currentStep === 'projectInfo') {
            state.currentStep = 'upload';
        } else if (state.currentStep === 'globalReview') {
            state.currentStep = 'upload';
        } else if (state.currentStep === 'recommendation') {
            // Go back to globalReview if we came from there, otherwise scoring
            if (Object.keys(state.originalScores).length > 0) {
                state.currentStep = 'globalReview';
            } else {
                state.currentStep = 'scoring';
                state.currentCriterionIndex = CRITERIA.length - 1;
            }
        } else if (state.currentStep === 'summary') {
            state.currentStep = 'recommendation';
        }
        render();
    }

    function renderRecommendationStep(container) {
        const totalScore = Object.values(state.scores).reduce((a, b) => a + b, 0);
        const maxScore = CRITERIA.reduce((a, c) => a + c.validScores[c.validScores.length - 1], 0);
        const percentage = Math.round((totalScore / maxScore) * 100);

        // Determine recommendation strength
        let recommendationStrength = '';
        let strengthColor = '';
        if (percentage >= 75) { recommendationStrength = 'Strong Candidate'; strengthColor = 'text-green-600'; }
        else if (percentage >= 60) { recommendationStrength = 'Good Candidate'; strengthColor = 'text-[#036CB6]'; }
        else if (percentage >= 45) { recommendationStrength = 'Marginal Candidate'; strengthColor = 'text-amber-600'; }
        else { recommendationStrength = 'Weak Candidate'; strengthColor = 'text-red-600'; }

        container.innerHTML = `
            <div class="max-w-4xl mx-auto flex flex-col" style="height: calc(100vh - 180px);">
                <!-- STICKY HEADER -->
                <div class="flex-shrink-0 bg-gradient-to-r from-green-900 via-emerald-800 to-teal-900 text-white rounded-2xl p-4 mb-4 shadow-xl">
                    <div class="flex items-center justify-between flex-wrap gap-3">
                        <div class="flex items-center gap-3">
                            <button onclick="goBack()" class="p-2 hover:bg-white/10 rounded-lg transition-colors" aria-label="Go back">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            </button>
                            <div>
                                <h2 class="text-xl font-bold">Final Recommendation</h2>
                                <p class="text-green-200 text-sm">${state.projectInfo.project || 'Project'} ‚Ä¢ ${state.projectInfo.applicant || 'Applicant'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2 bg-white/10 rounded-lg px-3 py-2">
                                <svg class="w-5 h-5 ${percentage >= 70 ? 'text-green-300' : percentage >= 50 ? 'text-amber-300' : 'text-red-300'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="font-medium text-sm">${recommendationStrength}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold">${totalScore} / ${maxScore}</div>
                                <div class="text-green-200 text-sm">${percentage}% score</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SCROLLABLE CONTENT -->
                <div class="flex-1 overflow-y-auto pr-2" style="scrollbar-width: thin;">
                <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 mb-6">

                    <div class="space-y-4">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <label class="block text-sm font-medium text-slate-700" for="fundingSource">Recommended Funding Source *</label>
                                <div class="relative group">
                                    <button type="button" class="text-slate-400 hover:text-[#036CB6] transition-colors" aria-label="Help - Where to find funding source">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </button>
                                    <div class="absolute left-0 bottom-full mb-2 hidden group-hover:block z-50 w-72">
                                        <div class="bg-slate-800 text-white text-xs rounded-lg p-3 shadow-lg">
                                            <p class="font-semibold mb-2">Where to find this information:</p>
                                            <ul class="space-y-1 text-slate-200">
                                                <li>‚Ä¢ Check the <strong>Application Cover Page</strong> for funding request type</li>
                                                <li>‚Ä¢ Look in <strong>Section 4 (Budget)</strong> for requested funding amounts</li>
                                                <li>‚Ä¢ Review <strong>Attachment 1</strong> for project financing details</li>
                                                <li>‚Ä¢ The NOFA specifies eligible activities for each funding source</li>
                                            </ul>
                                            <p class="mt-2 text-slate-300 border-t border-slate-600 pt-2">
                                                <strong>HOME:</strong> Housing development/rehab<br>
                                                <strong>CDBG:</strong> Public services, facilities, infrastructure
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <select id="fundingSource" class="flex-1 px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-[#38939B] focus:border-[#38939B]" aria-required="true">
                                    <option value="">Select funding source...</option>
                                    <option value="HOME" ${state.recommendation.fundingSource === 'HOME' ? 'selected' : ''}>HOME</option>
                                    <option value="CDBG" ${state.recommendation.fundingSource === 'CDBG' ? 'selected' : ''}>CDBG</option>
                                    <option value="HOME+CDBG" ${state.recommendation.fundingSource === 'HOME+CDBG' ? 'selected' : ''}>HOME + CDBG</option>
                                    <option value="Other" ${state.recommendation.fundingSource === 'Other' ? 'selected' : ''}>Other</option>
                                    <option value="None" ${state.recommendation.fundingSource === 'None' ? 'selected' : ''}>Do Not Recommend</option>
                                </select>
                                <button onclick="applyDetectedFundingSource()" id="applyFundingSourceBtn" class="px-3 py-2 bg-[#E3EDF5] hover:bg-[#B2D5EE] text-[#036CB6] rounded-xl flex items-center gap-1 transition-colors ${state.projectInfo.detectedFundingSource ? '' : 'hidden'}" title="Apply AI-detected funding source">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    Apply AI Suggestion
                                </button>
                            </div>
                            ${state.projectInfo.detectedFundingSource ? `
                            <div class="mt-2 p-3 bg-[#F3FAFE] border border-[#7CBEEC] rounded-lg">
                                <div class="flex items-start gap-2">
                                    <svg class="w-5 h-5 text-[#036CB6] flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-[#02538C]">AI Detected: <span class="font-bold">${state.projectInfo.detectedFundingSource}</span></p>
                                        <p class="text-xs text-[#036CB6] mt-1">${state.projectInfo.fundingSourceReasoning || 'Based on application content analysis'}</p>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-slate-700">Summary Comments *</label>
                                <button onclick="generateAISummary()" class="text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded-lg flex items-center gap-1 transition-colors" id="generateSummaryBtn">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    Generate AI Summary
                                </button>
                            </div>
                            <!-- Selectable Summary Container -->
                            <div id="summaryContainer" class="border border-slate-200 rounded-xl p-4 bg-slate-50">
                                ${state.recommendation.summaryList && state.recommendation.summaryList.length > 0 ? '' : `
                                    <div class="text-center text-slate-500 py-4">
                                        <p class="text-sm">No summary generated yet. Click "Generate AI Summary" to create a summary.</p>
                                    </div>
                                `}
                            </div>
                            <p class="text-xs text-slate-400 mt-1">Select and edit paragraphs to customize your summary. You can add custom paragraphs too.</p>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-slate-700">Questions for Applicant</label>
                                <button onclick="generateAIQuestions()" class="text-xs bg-amber-100 hover:bg-amber-200 text-amber-700 px-3 py-1 rounded-lg flex items-center gap-1 transition-colors" id="generateQuestionsBtn">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    Generate AI Questions
                                </button>
                            </div>
                            <!-- Selectable Questions Container -->
                            <div id="questionsContainer" class="border border-slate-200 rounded-xl p-4 bg-slate-50">
                                ${state.recommendation.questionsList && state.recommendation.questionsList.length > 0 ? '' : `
                                    <div class="text-center text-slate-500 py-4">
                                        <p class="text-sm">No questions generated yet. Click "Generate AI Questions" to create questions.</p>
                                    </div>
                                `}
                            </div>
                            <p class="text-xs text-slate-400 mt-1">Select which questions to include in the evaluation. You can edit individual questions or add custom ones.</p>
                        </div>
                    </div>
                </div>
                </div>
                <!-- END SCROLLABLE CONTENT -->

                <!-- STICKY FOOTER NAVIGATION -->
                <div class="flex-shrink-0 pt-4 border-t border-slate-200 bg-slate-50 rounded-b-2xl">
                    <div class="flex justify-between items-center">
                        <button onclick="generateAIBoth()" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-semibold rounded-xl hover:from-purple-600 hover:to-indigo-600 transition-all shadow-lg hover:shadow-xl flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                            Generate All with AI
                        </button>
                        <button onclick="handleRecommendationNext()" class="px-8 py-3 bg-gradient-to-r from-[#38939B] to-[#036CB6] text-white font-semibold rounded-xl hover:from-[#2a7078] hover:to-[#02538C] transition-all shadow-lg hover:shadow-xl">
                            Review Summary
                            <svg class="w-5 h-5 inline ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                </div>
            </div>`;

        // Render selectable UI components if we have data
        setTimeout(() => {
            // Render summary paragraphs
            if (state.recommendation.summaryList && state.recommendation.summaryList.length > 0) {
                renderSelectableSummary();
            }
            // Render questions
            if (state.recommendation.questionsList && state.recommendation.questionsList.length > 0) {
                renderSelectableQuestions();
            }
        }, 100);

        // Auto-generate if empty and API key available
        if (state.apiKey && !state.recommendation.summaryComments && !state.recommendation.questions) {
            setTimeout(() => generateAIBoth(), 500);
        }
    }

    // Apply AI-detected funding source to the dropdown
    function applyDetectedFundingSource() {
        if (!state.projectInfo.detectedFundingSource) {
            showToast('info', 'No Detection', 'AI has not detected a funding source yet.');
            return;
        }

        const fundingSelect = document.getElementById('fundingSource');
        if (fundingSelect) {
            // Map detected source to dropdown value
            const detected = state.projectInfo.detectedFundingSource;
            const validValues = ['HOME', 'CDBG', 'HOME+CDBG', 'Other', 'None'];

            if (validValues.includes(detected)) {
                fundingSelect.value = detected;
                state.recommendation.fundingSource = detected;
                showToast('success', 'Funding Source Applied', `Set to ${detected} based on AI analysis.`);
                debouncedAutoSave();
            } else {
                showToast('warning', 'Unknown Source', `AI detected "${detected}" which is not a standard option.`);
            }
        }
    }

    // Generate AI Summary for recommendation
    async function generateAISummary() {
        if (!state.apiKey) {
            showToast('error', 'API Key Required', 'Please add your Anthropic API key in Settings.');
            return;
        }

        const btn = document.getElementById('generateSummaryBtn');
        if (btn) btn.innerHTML = '<span class="animate-spin">‚è≥</span> Generating...';

        try {
            const totalScore = Object.values(state.scores).reduce((a, b) => a + b, 0);
            const maxScore = CRITERIA.reduce((a, c) => a + c.validScores[c.validScores.length - 1], 0);
            const percentage = Math.round((totalScore / maxScore) * 100);

            // Build criteria summary
            const criteriaBreakdown = CRITERIA.map(c => {
                const score = state.scores[c.id];
                const maxCriteriaScore = c.validScores[c.validScores.length - 1];
                const comment = state.comments[c.id] || '';
                return `${c.id.toUpperCase()} (${c.name}): ${score}/${maxCriteriaScore} - ${comment.substring(0, 200)}`;
            }).join('\n');

            const prompt = `You are an expert NOFA (Notice of Funding Availability) evaluator for San Mateo County. Based on the following evaluation scores and comments, write a comprehensive summary recommendation.

PROJECT: ${state.projectInfo.projectName || 'Unknown'}
APPLICANT: ${state.projectInfo.applicantName || 'Unknown'}
TOTAL SCORE: ${totalScore}/${maxScore} (${percentage}%)

CRITERIA BREAKDOWN:
${criteriaBreakdown}

Write a 2-3 paragraph professional summary that:
1. Opens with the overall recommendation (fund/conditional fund/do not fund) and score context
2. Highlights the key STRENGTHS of the application (criteria where they scored well)
3. Notes areas of CONCERN or WEAKNESS (low-scoring criteria)
4. Provides a balanced conclusion on project viability and community impact
5. If score is below 60%, emphasize what would need to improve for future funding

Be direct, professional, and specific. Reference actual criteria scores. Do not use bullet points - write in flowing paragraphs.`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    temperature: 0,  // Consistent output for summaries
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (!response.ok) throw new Error('API request failed');
            const data = await response.json();
            const summary = data.content[0].text;

            // Parse summary into paragraphs for selectable UI
            const parsedSummary = parseSummaryToParagraphs(summary);
            state.recommendation.summaryList = parsedSummary;
            state.recommendation.summaryComments = summary; // Keep raw for backward compatibility
            debouncedAutoSave();
            renderSelectableSummary(); // Re-render the summary UI
            showToast('success', 'Summary Generated', 'AI summary has been generated. You can edit individual paragraphs.');

        } catch (error) {
            console.error('Error generating summary:', error);
            showToast('error', 'Generation Failed', error.message);
        } finally {
            if (btn) btn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Generate AI Summary';
        }
    }

    // Parse AI-generated summary into paragraphs for selectable UI
    function parseSummaryToParagraphs(summaryText) {
        if (!summaryText) return [];

        // Split by double newlines (paragraphs) or single newlines followed by blank line
        const paragraphs = summaryText.split(/\n\n+/).filter(p => p.trim());

        return paragraphs.map((p, idx) => ({
            id: `p${idx + 1}`,
            text: p.trim(),
            selected: true // Default to selected
        }));
    }

    // Render selectable summary UI in Recommendation step
    function renderSelectableSummary() {
        const container = document.getElementById('summaryContainer');
        if (!container) return;

        const paragraphs = state.recommendation.summaryList || [];

        if (paragraphs.length === 0) {
            container.innerHTML = `
                <div class="text-center text-slate-500 py-4">
                    <p class="text-sm">No summary generated yet. Click "Generate AI Summary" to create a summary.</p>
                </div>
            `;
            return;
        }

        const selectedCount = paragraphs.filter(p => p.selected).length;

        container.innerHTML = `
            <div class="mb-3 flex items-center justify-between">
                <span class="text-xs text-slate-500">${selectedCount} of ${paragraphs.length} paragraphs selected</span>
                <div class="flex gap-2">
                    <button onclick="toggleAllSummaryParagraphs(true)" class="text-xs px-2 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded transition-colors">
                        Select All
                    </button>
                    <button onclick="toggleAllSummaryParagraphs(false)" class="text-xs px-2 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded transition-colors">
                        Select None
                    </button>
                </div>
            </div>
            <div class="space-y-2">
                ${paragraphs.map((p, idx) => `
                    <div class="flex items-start gap-3 p-3 rounded-lg border ${p.selected ? 'bg-purple-50 border-purple-200' : 'bg-slate-50 border-slate-200'} transition-all">
                        <input type="checkbox"
                            id="summary-para-${idx}"
                            ${p.selected ? 'checked' : ''}
                            onchange="toggleSummaryParagraphSelection(${idx})"
                            class="mt-1 w-4 h-4 text-purple-600 rounded border-slate-300 focus:ring-purple-500 cursor-pointer">
                        <div class="flex-1">
                            <label for="summary-para-${idx}" class="flex items-center gap-2 cursor-pointer mb-1">
                                <span class="text-xs font-medium text-purple-600 bg-purple-100 px-2 py-0.5 rounded">¬∂${idx + 1}</span>
                            </label>
                            <textarea
                                id="summary-para-text-${idx}"
                                onchange="updateSummaryParagraphText(${idx}, this.value)"
                                rows="3"
                                class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-purple-500 resize-y ${!p.selected ? 'opacity-50' : ''}"
                                ${!p.selected ? 'disabled' : ''}
                            >${p.text}</textarea>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div class="mt-3 pt-3 border-t border-slate-200">
                <button onclick="addCustomSummaryParagraph()" class="text-xs px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Custom Paragraph
                </button>
            </div>
        `;
    }

    // Toggle selection of a single summary paragraph
    function toggleSummaryParagraphSelection(idx) {
        if (state.recommendation.summaryList && state.recommendation.summaryList[idx]) {
            state.recommendation.summaryList[idx].selected = !state.recommendation.summaryList[idx].selected;
            updateSummaryFromList();
            renderSelectableSummary();
            debouncedAutoSave();
        }
    }

    // Toggle all summary paragraphs on/off
    function toggleAllSummaryParagraphs(selectAll) {
        if (state.recommendation.summaryList) {
            state.recommendation.summaryList.forEach(p => p.selected = selectAll);
            updateSummaryFromList();
            renderSelectableSummary();
            debouncedAutoSave();
        }
    }

    // Update summary paragraph text
    function updateSummaryParagraphText(idx, newText) {
        if (state.recommendation.summaryList && state.recommendation.summaryList[idx]) {
            state.recommendation.summaryList[idx].text = newText;
            updateSummaryFromList();
            debouncedAutoSave();
        }
    }

    // Add a custom summary paragraph
    function addCustomSummaryParagraph() {
        if (!state.recommendation.summaryList) {
            state.recommendation.summaryList = [];
        }
        state.recommendation.summaryList.push({
            id: `p${state.recommendation.summaryList.length + 1}`,
            text: '',
            selected: true
        });
        updateSummaryFromList();
        renderSelectableSummary();
        // Focus the new paragraph's textarea
        setTimeout(() => {
            const newIdx = state.recommendation.summaryList.length - 1;
            const textarea = document.getElementById(`summary-para-text-${newIdx}`);
            if (textarea) textarea.focus();
        }, 100);
    }

    // Update the raw summary string from the list (for backward compatibility and export)
    function updateSummaryFromList() {
        if (!state.recommendation.summaryList) return;
        const selectedParagraphs = state.recommendation.summaryList
            .filter(p => p.selected && p.text.trim())
            .map(p => p.text)
            .join('\n\n');
        state.recommendation.summaryComments = selectedParagraphs;
    }

    // Get only selected summary paragraphs for display/export
    function getSelectedSummaryParagraphs() {
        if (!state.recommendation.summaryList) return [];
        return state.recommendation.summaryList.filter(p => p.selected && p.text.trim());
    }

    // Generate AI Questions for applicant
    async function generateAIQuestions() {
        if (!state.apiKey) {
            showToast('error', 'API Key Required', 'Please add your Anthropic API key in Settings.');
            return;
        }

        const btn = document.getElementById('generateQuestionsBtn');
        if (btn) btn.innerHTML = '<span class="animate-spin">‚è≥</span> Generating...';

        try {
            const totalScore = Object.values(state.scores).reduce((a, b) => a + b, 0);
            const maxScore = CRITERIA.reduce((a, c) => a + c.validScores[c.validScores.length - 1], 0);
            const percentage = Math.round((totalScore / maxScore) * 100);

            // Find weak areas (criteria scoring below 50% of max)
            const weakAreas = CRITERIA.filter(c => {
                const score = state.scores[c.id] || 0;
                const maxCriteriaScore = c.validScores[c.validScores.length - 1];
                return score < maxCriteriaScore * 0.5;
            }).map(c => `${c.id.toUpperCase()} (${c.name}): scored ${state.scores[c.id]}/${c.validScores[c.validScores.length - 1]}`);

            // Build criteria summary
            const criteriaBreakdown = CRITERIA.map(c => {
                const score = state.scores[c.id];
                const maxCriteriaScore = c.validScores[c.validScores.length - 1];
                const comment = state.comments[c.id] || '';
                return `${c.id.toUpperCase()} (${c.name}): ${score}/${maxCriteriaScore} - ${comment.substring(0, 150)}`;
            }).join('\n');

            const prompt = `You are an expert NOFA evaluator for San Mateo County conducting due diligence on a funding application.

PROJECT: ${state.projectInfo.projectName || 'Unknown'}
APPLICANT: ${state.projectInfo.applicantName || 'Unknown'}
TOTAL SCORE: ${totalScore}/${maxScore} (${percentage}%)

CRITERIA SCORES:
${criteriaBreakdown}

${weakAreas.length > 0 ? `WEAK AREAS NEEDING CLARIFICATION:\n${weakAreas.join('\n')}` : 'No major weak areas identified.'}

Generate EXACTLY 5 specific questions for the applicant (the template has 5 question slots). Include:

1. CLARIFYING QUESTIONS (2): Questions about weak scoring areas that could improve their score if answered well
2. DUE DILIGENCE QUESTIONS (2): Standard questions any funder should ask regardless of score (financial capacity, timeline feasibility, risk mitigation)
3. OPPORTUNITY QUESTION (1): A question that could reveal additional strengths not captured in the application

Format each question on its own numbered line (1., 2., 3., 4., 5.). Be specific and reference actual project details when possible. Questions should be professional and constructive, not accusatory.`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': state.apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    temperature: 0,  // Consistent output for questions
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (!response.ok) throw new Error('API request failed');
            const data = await response.json();
            const questions = data.content[0].text;

            // Parse questions into array format for selectable UI
            const parsedQuestions = parseQuestionsToArray(questions);
            state.recommendation.questionsList = parsedQuestions;
            state.recommendation.questions = questions; // Keep raw for backward compatibility
            debouncedAutoSave();
            renderSelectableQuestions(); // Re-render the questions UI
            showToast('success', 'Questions Generated', 'AI questions have been generated. Select which ones to include.');

        } catch (error) {
            console.error('Error generating questions:', error);
            showToast('error', 'Generation Failed', error.message);
        } finally {
            if (btn) btn.innerHTML = '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Generate AI Questions';
        }
    }

    // Parse AI-generated questions text into array of selectable question objects
    function parseQuestionsToArray(questionsText) {
        if (!questionsText) return [];

        // Split by numbered lines (1., 2., 3., etc.)
        const lines = questionsText.split(/\n/).filter(l => l.trim());
        const questions = [];
        let currentQuestion = '';

        for (const line of lines) {
            // Check if this line starts a new numbered question
            const match = line.match(/^\s*(\d+)\.\s*(.+)/);
            if (match) {
                // Save previous question if exists
                if (currentQuestion.trim()) {
                    const qIndex = questions.length + 1;
                    questions.push({
                        id: `q${qIndex}`,
                        originalIndex: qIndex, // Track original order for sorting (v7.21)
                        text: currentQuestion.trim(),
                        selected: true // Default to selected
                    });
                }
                currentQuestion = match[2];
            } else {
                // Continuation of previous question
                currentQuestion += ' ' + line.trim();
            }
        }

        // Don't forget the last question
        if (currentQuestion.trim()) {
            const qIndex = questions.length + 1;
            questions.push({
                id: `q${qIndex}`,
                originalIndex: qIndex, // Track original order for sorting (v7.21)
                text: currentQuestion.trim(),
                selected: true
            });
        }

        return questions;
    }

    // Render the selectable questions UI in the Recommendation step
    function renderSelectableQuestions() {
        const container = document.getElementById('questionsContainer');
        if (!container) return;

        const questions = state.recommendation.questionsList || [];

        if (questions.length === 0) {
            container.innerHTML = `
                <div class="text-center text-slate-500 py-4">
                    <p class="text-sm">No questions generated yet. Click "Generate AI Questions" to create questions.</p>
                </div>
            `;
            return;
        }

        const selectedCount = questions.filter(q => q.selected).length;

        container.innerHTML = `
            <div class="mb-3 flex items-center justify-between">
                <span class="text-xs text-slate-500">${selectedCount} of ${questions.length} questions selected</span>
                <div class="flex gap-2">
                    <button onclick="toggleAllQuestions(true)" class="text-xs px-2 py-1 bg-[#E3EDF5] hover:bg-[#B2D5EE] text-[#036CB6] rounded transition-colors">
                        Select All
                    </button>
                    <button onclick="toggleAllQuestions(false)" class="text-xs px-2 py-1 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded transition-colors">
                        Select None
                    </button>
                </div>
            </div>
            <div class="space-y-2">
                ${questions.map((q, idx) => `
                    <div class="flex items-start gap-3 p-3 rounded-lg border ${q.selected ? 'bg-amber-50 border-amber-200' : 'bg-slate-50 border-slate-200'} transition-all">
                        <input type="checkbox"
                            id="question-${idx}"
                            ${q.selected ? 'checked' : ''}
                            onchange="toggleQuestionSelection(${idx})"
                            class="mt-1 w-4 h-4 text-amber-600 rounded border-slate-300 focus:ring-amber-500 cursor-pointer">
                        <div class="flex-1">
                            <label for="question-${idx}" class="flex items-center gap-2 cursor-pointer">
                                <span class="text-xs font-medium text-amber-600 bg-amber-100 px-2 py-0.5 rounded">Q${idx + 1}</span>
                            </label>
                            <textarea
                                id="question-text-${idx}"
                                onchange="updateQuestionText(${idx}, this.value)"
                                rows="2"
                                class="w-full mt-2 px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-amber-500 resize-y ${!q.selected ? 'opacity-50' : ''}"
                                ${!q.selected ? 'disabled' : ''}
                            >${q.text}</textarea>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div class="mt-3 pt-3 border-t border-slate-200">
                <button onclick="addCustomQuestion()" class="text-xs px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Custom Question
                </button>
            </div>
        `;
    }

    // Toggle selection of a single question
    function toggleQuestionSelection(idx) {
        if (state.recommendation.questionsList && state.recommendation.questionsList[idx]) {
            state.recommendation.questionsList[idx].selected = !state.recommendation.questionsList[idx].selected;
            updateQuestionsFromList();
            renderSelectableQuestions();
            debouncedAutoSave();
        }
    }

    // Toggle all questions on/off
    function toggleAllQuestions(selectAll) {
        if (state.recommendation.questionsList) {
            state.recommendation.questionsList.forEach(q => q.selected = selectAll);
            updateQuestionsFromList();
            renderSelectableQuestions();
            debouncedAutoSave();
        }
    }

    // Update question text
    function updateQuestionText(idx, newText) {
        if (state.recommendation.questionsList && state.recommendation.questionsList[idx]) {
            state.recommendation.questionsList[idx].text = newText;
            updateQuestionsFromList();
            debouncedAutoSave();
        }
    }

    // Add a custom question
    function addCustomQuestion() {
        if (!state.recommendation.questionsList) {
            state.recommendation.questionsList = [];
        }
        const newIndex = state.recommendation.questionsList.length + 1;
        state.recommendation.questionsList.push({
            id: `q${newIndex}`,
            originalIndex: newIndex, // Track original order (v7.21)
            text: '',
            selected: true
        });
        updateQuestionsFromList();
        renderSelectableQuestions();
        // Focus the new question's textarea
        setTimeout(() => {
            const newIdx = state.recommendation.questionsList.length - 1;
            const textarea = document.getElementById(`question-text-${newIdx}`);
            if (textarea) textarea.focus();
        }, 100);
    }

    // Update the raw questions string from the list (for backward compatibility and export)
    // v7.21: Sort by original index to maintain chronological order regardless of selection order
    function updateQuestionsFromList() {
        if (!state.recommendation.questionsList) return;
        const selectedQuestions = state.recommendation.questionsList
            .filter(q => q.selected && q.text.trim())
            .sort((a, b) => (a.originalIndex || 0) - (b.originalIndex || 0)) // Sort by original order
            .map((q, idx) => `${idx + 1}. ${q.text}`)
            .join('\n\n');
        state.recommendation.questions = selectedQuestions;
    }

    // Get only selected questions for display/export
    function getSelectedQuestions() {
        if (!state.recommendation.questionsList) return [];
        return state.recommendation.questionsList.filter(q => q.selected && q.text.trim());
    }

    // Generate both summary and questions
    async function generateAIBoth() {
        showLoading('Generating AI Recommendation', 'Creating summary and questions...', true);
        try {
            updateLoadingProgress(30, 'Generating summary...');
            await generateAISummary();
            updateLoadingProgress(70, 'Generating questions...');
            await generateAIQuestions();
            updateLoadingProgress(100, 'Complete!');
            hideLoading();
            showToast('success', 'AI Generation Complete', 'Summary and questions have been generated.');
        } catch (error) {
            hideLoading();
            showToast('error', 'Generation Failed', error.message);
        }
    }

    function handleRecommendationNext() {
        const fundingSource = document.getElementById('fundingSource').value;

        if (!fundingSource) {
            showToast('error', 'Required Field', 'Please select a funding source recommendation.');
            return;
        }

        // Update from selectable lists
        updateSummaryFromList();
        updateQuestionsFromList();

        // Validate summary comments exist
        if (!state.recommendation.summaryComments || !state.recommendation.summaryComments.trim()) {
            showToast('error', 'Required Field', 'Please generate or add summary comments.');
            return;
        }

        // Preserve existing lists and update funding source
        state.recommendation.fundingSource = fundingSource;
        debouncedAutoSave();
        state.currentStep = 'summary';
        render();
    }

    function renderSummaryStep(container) {
        const totalScore = Object.values(state.scores).reduce((a, b) => a + b, 0);
        const maxScore = CRITERIA.reduce((a, c) => a + c.validScores[c.validScores.length - 1], 0);
        const percentage = Math.round((totalScore / maxScore) * 100);

        container.innerHTML = `
            <div class="max-w-5xl mx-auto flex flex-col" style="height: calc(100vh - 180px);">
                <!-- STICKY HEADER -->
                <div class="flex-shrink-0 smc-header-gradient text-white rounded-2xl p-4 mb-4 shadow-xl">
                    <div class="flex items-center justify-between flex-wrap gap-3">
                        <div class="flex items-center gap-3">
                            <button onclick="goBack()" class="p-2 hover:bg-white/10 rounded-lg transition-colors" aria-label="Go back">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            </button>
                            <div>
                                <h2 class="text-xl font-bold">Evaluation Summary</h2>
                                <p class="text-teal-200 text-sm">Review before exporting ‚Ä¢ Click any score to edit</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2 bg-white/10 rounded-lg px-3 py-2">
                                <span class="font-medium text-sm">${state.recommendation.fundingSource || 'No source selected'}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold">${totalScore} / ${maxScore}</div>
                                <div class="text-teal-200 text-sm">${percentage}% score</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SCROLLABLE CONTENT -->
                <div class="flex-1 overflow-y-auto pr-2" style="scrollbar-width: thin;">

                <!-- Cover Sheet Info - Editable Funding Amount (v7.21) -->
                <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl shadow-lg border border-amber-200 p-4 mb-4">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <h3 class="font-semibold text-amber-800 text-sm">Application Cover Sheet - County of San Mateo Only</h3>
                                <span class="text-[10px] text-amber-600 bg-amber-100 px-2 py-0.5 rounded">Click to edit</span>
                            </div>
                            <div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div class="bg-white rounded-lg p-2 border border-amber-200">
                                    <label class="text-[10px] text-amber-600 uppercase font-medium block">Applicant</label>
                                    <input type="text" id="summaryApplicant" value="${state.projectInfo.applicant || ''}"
                                        onchange="updateCoverSheetField('applicant', this.value)"
                                        class="w-full text-sm font-semibold text-slate-800 bg-transparent border-0 border-b border-transparent hover:border-amber-300 focus:border-amber-500 focus:ring-0 p-0 mt-0.5 truncate"
                                        placeholder="Enter applicant name">
                                </div>
                                <div class="bg-white rounded-lg p-2 border border-amber-200">
                                    <label class="text-[10px] text-amber-600 uppercase font-medium block">County Amount Requested</label>
                                    <div class="flex items-center mt-0.5">
                                        <span class="text-sm font-bold text-green-700">$</span>
                                        <input type="number" id="summaryAmountRequested" value="${state.projectInfo.amountRequested || ''}"
                                            onchange="updateCoverSheetField('amountRequested', parseFloat(this.value) || 0)"
                                            class="w-full text-sm font-bold text-green-700 bg-transparent border-0 border-b border-transparent hover:border-amber-300 focus:border-amber-500 focus:ring-0 p-0 ml-0.5"
                                            placeholder="0">
                                    </div>
                                </div>
                                <div class="bg-white rounded-lg p-2 border border-amber-200">
                                    <label class="text-[10px] text-amber-600 uppercase font-medium block">Total Project Cost</label>
                                    <div class="flex items-center mt-0.5">
                                        <span class="text-sm font-semibold text-slate-800">$</span>
                                        <input type="number" id="summaryTotalCost" value="${state.projectInfo.totalCost || ''}"
                                            onchange="updateCoverSheetField('totalCost', parseFloat(this.value) || 0)"
                                            class="w-full text-sm font-semibold text-slate-800 bg-transparent border-0 border-b border-transparent hover:border-amber-300 focus:border-amber-500 focus:ring-0 p-0 ml-0.5"
                                            placeholder="0">
                                    </div>
                                </div>
                                <div class="bg-white rounded-lg p-2 border border-amber-200">
                                    <label class="text-[10px] text-amber-600 uppercase font-medium block">Clients Served</label>
                                    <input type="number" id="summaryClientsServed" value="${state.projectInfo.clientsServed || ''}"
                                        onchange="updateCoverSheetField('clientsServed', parseInt(this.value) || 0)"
                                        class="w-full text-sm font-semibold text-slate-800 bg-transparent border-0 border-b border-transparent hover:border-amber-300 focus:border-amber-500 focus:ring-0 p-0 mt-0.5"
                                        placeholder="0">
                                </div>
                            </div>
                            <p class="mt-2 text-[10px] text-amber-700 flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Verify and edit to match the County of San Mateo funding request on the application cover page. Excludes other jurisdictions.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Score Summary - Compact Grid View -->
                <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="font-semibold text-slate-800">Score Summary</h3>
                            <p class="text-xs text-slate-500">Click any score to edit</p>
                        </div>
                        <div class="flex items-center gap-2 bg-slate-50 rounded-xl px-4 py-2">
                            <span class="font-bold text-slate-800">Total:</span>
                            <span class="text-2xl font-bold ${percentage >= 70 ? 'text-green-600' : percentage >= 50 ? 'text-amber-600' : 'text-red-600'}">${totalScore}</span>
                            <span class="text-slate-400">/ ${maxScore}</span>
                        </div>
                    </div>
                    <!-- Compact Grid of Scores -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                        ${CRITERIA.map((c, idx) => {
                            const isMissing = state.scores[c.id] === undefined || state.scores[c.id] === null;
                            const hasNoComment = !state.comments[c.id] || state.comments[c.id].trim() === '';
                            const maxPts = c.validScores[c.validScores.length - 1];
                            const score = state.scores[c.id] || 0;
                            const scorePct = (score / maxPts) * 100;
                            return `
                            <div onclick="jumpToCriterion(${idx})"
                                class="relative p-3 rounded-xl border cursor-pointer transition-all hover:shadow-md ${isMissing ? 'bg-red-50 border-red-200 hover:bg-red-100' : 'bg-slate-50 border-slate-200 hover:bg-slate-100'}">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-xs font-bold ${isMissing ? 'text-red-600' : 'text-slate-600'}">${c.id.toUpperCase()}</span>
                                    <div class="flex items-center gap-1">
                                        ${isMissing ? '<svg class="w-3 h-3 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>' : ''}
                                        ${hasNoComment && !isMissing ? '<svg class="w-3 h-3 text-amber-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>' : ''}
                                        <span class="text-sm font-bold ${isMissing ? 'text-red-500' : scorePct >= 70 ? 'text-green-600' : scorePct >= 40 ? 'text-amber-600' : 'text-red-600'}">${isMissing ? '?' : score}/${maxPts}</span>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500 line-clamp-1" title="${c.question}">${c.question.substring(0, 30)}${c.question.length > 30 ? '...' : ''}</p>
                            </div>
                        `}).join('')}
                    </div>
                </div>

                <!-- Recommendation Section - Full Width with Selectable Sections -->
                <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 mb-6">
                    <h3 class="font-semibold text-slate-800 mb-4">Recommendation</h3>

                    <!-- Funding Source - Compact Card -->
                    <div class="bg-gradient-to-br from-[#F3FAFE] to-[#E3EDF5] rounded-xl p-4 border border-[#B2D5EE] mb-4">
                        <p class="text-xs text-[#036CB6] uppercase tracking-wide font-medium mb-1">Funding Source</p>
                        <p class="text-lg font-bold text-[#02538C]">${state.recommendation.fundingSource || 'Not specified'}</p>
                    </div>

                    <!-- Summary Comments - Selectable Paragraphs -->
                    <details class="mb-4" open>
                        <summary class="cursor-pointer text-sm font-medium text-slate-700 hover:text-slate-900 flex items-center gap-2">
                            <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            Summary Comments
                            <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full ml-2">
                                ${getSelectedSummaryParagraphs().length} paragraphs
                            </span>
                        </summary>
                        <div class="mt-3" id="summarySummaryContainer">
                            <!-- Will be populated by renderSummarySummaryParagraphs() -->
                        </div>
                    </details>

                    ${(state.recommendation.questionsList && state.recommendation.questionsList.length > 0) || state.recommendation.questions ? `
                    <!-- Questions - Selectable in Summary -->
                    <details open>
                        <summary class="cursor-pointer text-sm font-medium text-slate-700 hover:text-slate-900 flex items-center gap-2">
                            <svg class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            Questions for Applicant
                            <span class="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full ml-2">
                                ${getSelectedQuestions().length} selected
                            </span>
                        </summary>
                        <div class="mt-3" id="summaryQuestionsContainer">
                            <!-- Will be populated by renderSummaryQuestions() -->
                        </div>
                    </details>
                    ` : ''}
                </div>

                <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 mb-6">
                    <h3 class="font-semibold text-slate-800 mb-4">Export Settings</h3>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-slate-600">
                                Exporting as: <span class="font-semibold ${state.reviewerSheet.includes('Reviewer 1') ? 'text-[#036CB6]' : 'text-green-600'}">
                                    ${REVIEWER_SHEETS[state.reviewerSheet]?.name || 'Unknown'} - ${REVIEWER_SHEETS[state.reviewerSheet]?.description || ''}
                                </span>
                            </p>
                            <p class="text-xs text-slate-500 mt-1">
                                Tab: "${state.reviewerSheet}" ‚Ä¢ Scores and comments will be written to this sheet
                            </p>
                            ${REVIEWER_SHEETS[state.reviewerSheet]?.hasThreshold ?
                                '<p class="text-xs text-[#036CB6] mt-1 font-medium">Note: As Reviewer 1, you are also responsible for Threshold evaluation (pass/fail eligibility)</p>' :
                                '<p class="text-xs text-green-600 mt-1 font-medium">Note: Threshold evaluation was completed by Reviewer 1</p>'
                            }
                        </div>
                        <button onclick="showSettings()" class="px-4 py-2 text-[#036CB6] hover:bg-[#E3EDF5] rounded-lg transition-colors">
                            Change
                        </button>
                    </div>

                    <!-- Template Upload Section -->
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        ${state.scoringWorkbook ? `
                            <div class="flex items-center gap-2 text-green-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <span class="text-sm font-medium">Template loaded: ${state.templateName || 'Ready for export'}</span>
                            </div>
                        ` : `
                            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                                <div class="flex items-start gap-3">
                                    <svg class="w-6 h-6 text-amber-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="font-semibold text-amber-800">Excel Template Required</p>
                                        <p class="text-sm text-amber-700 mt-1">Upload the County scoring template to export your evaluation.</p>
                                        <div id="summaryTemplateDropZone" class="mt-3 drop-zone border-2 border-dashed border-amber-300 rounded-lg p-4 text-center cursor-pointer hover:border-green-400 hover:bg-green-50/50 transition-all" role="button" tabindex="0">
                                            <svg class="w-8 h-8 mx-auto mb-2 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                            <p class="text-amber-700 font-medium text-sm">Click to upload Excel template</p>
                                            <input type="file" id="summaryTemplateInput" accept=".xlsx,.xls" class="hidden">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
                </div>
                <!-- END SCROLLABLE CONTENT -->

                <!-- STICKY FOOTER NAVIGATION -->
                <div class="flex-shrink-0 pt-4 border-t border-slate-200 bg-slate-50 rounded-b-2xl">
                    <div class="flex justify-between">
                        <button onclick="startNewEvaluation()" class="px-6 py-3 border border-slate-300 text-slate-700 font-semibold rounded-xl hover:bg-slate-50 transition-colors">
                            Start New Evaluation
                        </button>
                        <button onclick="exportToExcel()" class="px-8 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-semibold rounded-xl hover:from-green-700 hover:to-emerald-700 transition-all shadow-lg hover:shadow-xl ${!state.scoringWorkbook ? 'opacity-50' : ''}">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            Export to Excel
                        </button>
                    </div>
                </div>
            </div>`;

        // Setup template upload zone and render selectable components on summary page
        setTimeout(() => {
            const summaryZone = document.getElementById('summaryTemplateDropZone');
            const summaryInput = document.getElementById('summaryTemplateInput');
            if (summaryZone && summaryInput) {
                setupDropZone(summaryZone, summaryInput, handleTemplateUpload);
            }
            // Render the selectable summary paragraphs
            renderSummarySummaryParagraphs();
            // Render the selectable questions in summary
            renderSummaryQuestions();
        }, 100);
    }

    // Render selectable summary paragraphs UI in the Summary step
    function renderSummarySummaryParagraphs() {
        const container = document.getElementById('summarySummaryContainer');
        if (!container) return;

        // Try to initialize summaryList from raw summary if not already done
        if (!state.recommendation.summaryList && state.recommendation.summaryComments) {
            state.recommendation.summaryList = parseSummaryToParagraphs(state.recommendation.summaryComments);
        }

        const paragraphs = state.recommendation.summaryList || [];

        if (paragraphs.length === 0) {
            container.innerHTML = `
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-200 text-center text-slate-500">
                    <p class="text-sm">No summary comments available.</p>
                </div>
            `;
            return;
        }

        const selectedCount = paragraphs.filter(p => p.selected).length;

        container.innerHTML = `
            <div class="bg-purple-50 rounded-xl border border-purple-200 p-4">
                <div class="mb-3 flex items-center justify-between">
                    <span class="text-xs text-purple-700 font-medium">${selectedCount} of ${paragraphs.length} paragraphs will be included</span>
                    <div class="flex gap-2">
                        <button onclick="toggleAllSummarySummaryParagraphs(true)" class="text-xs px-2 py-1 bg-purple-200 hover:bg-purple-300 text-purple-800 rounded transition-colors">
                            Select All
                        </button>
                        <button onclick="toggleAllSummarySummaryParagraphs(false)" class="text-xs px-2 py-1 bg-white hover:bg-slate-100 text-slate-700 rounded border border-slate-200 transition-colors">
                            Select None
                        </button>
                    </div>
                </div>
                <div class="space-y-2">
                    ${paragraphs.map((p, idx) => `
                        <div class="flex items-start gap-3 p-3 rounded-lg ${p.selected ? 'bg-white border border-purple-300' : 'bg-purple-100/50 border border-transparent'} transition-all">
                            <input type="checkbox"
                                id="sum-summary-para-${idx}"
                                ${p.selected ? 'checked' : ''}
                                onchange="toggleSummarySummaryParagraphSelection(${idx})"
                                class="mt-1 w-4 h-4 text-purple-600 rounded border-purple-300 focus:ring-purple-500 cursor-pointer">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-medium ${p.selected ? 'text-purple-700 bg-purple-200' : 'text-slate-500 bg-slate-200'} px-2 py-0.5 rounded">¬∂${idx + 1}</span>
                                </div>
                                <textarea
                                    id="sum-summary-para-text-${idx}"
                                    onchange="updateSummarySummaryParagraphText(${idx}, this.value)"
                                    rows="3"
                                    class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-purple-500 resize-y ${!p.selected ? 'border-slate-200 bg-slate-50 opacity-60' : 'border-purple-200 bg-white'}"
                                    ${!p.selected ? 'disabled' : ''}
                                >${p.text}</textarea>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-3 pt-3 border-t border-purple-200">
                    <button onclick="addCustomSummarySummaryParagraph()" class="text-xs px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Add Custom Paragraph
                    </button>
                </div>
            </div>
        `;
    }

    // Toggle selection of a single summary paragraph in Summary step
    function toggleSummarySummaryParagraphSelection(idx) {
        if (state.recommendation.summaryList && state.recommendation.summaryList[idx]) {
            state.recommendation.summaryList[idx].selected = !state.recommendation.summaryList[idx].selected;
            updateSummaryFromList();
            renderSummarySummaryParagraphs();
            debouncedAutoSave();
        }
    }

    // Toggle all summary paragraphs on/off in Summary step
    function toggleAllSummarySummaryParagraphs(selectAll) {
        if (state.recommendation.summaryList) {
            state.recommendation.summaryList.forEach(p => p.selected = selectAll);
            updateSummaryFromList();
            renderSummarySummaryParagraphs();
            debouncedAutoSave();
        }
    }

    // Update summary paragraph text in Summary step
    function updateSummarySummaryParagraphText(idx, newText) {
        if (state.recommendation.summaryList && state.recommendation.summaryList[idx]) {
            state.recommendation.summaryList[idx].text = newText;
            updateSummaryFromList();
            debouncedAutoSave();
        }
    }

    // Add a custom summary paragraph in Summary step
    function addCustomSummarySummaryParagraph() {
        if (!state.recommendation.summaryList) {
            state.recommendation.summaryList = [];
        }
        state.recommendation.summaryList.push({
            id: `p${state.recommendation.summaryList.length + 1}`,
            text: '',
            selected: true
        });
        updateSummaryFromList();
        renderSummarySummaryParagraphs();
        // Focus the new paragraph's textarea
        setTimeout(() => {
            const newIdx = state.recommendation.summaryList.length - 1;
            const textarea = document.getElementById(`sum-summary-para-text-${newIdx}`);
            if (textarea) textarea.focus();
        }, 100);
    }

    // Render selectable questions UI in the Summary step
    function renderSummaryQuestions() {
        const container = document.getElementById('summaryQuestionsContainer');
        if (!container) return;

        // Try to initialize questionsList from raw questions if not already done
        if (!state.recommendation.questionsList && state.recommendation.questions) {
            state.recommendation.questionsList = parseQuestionsToArray(state.recommendation.questions);
        }

        const questions = state.recommendation.questionsList || [];

        if (questions.length === 0) {
            container.innerHTML = `
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-200 text-center text-slate-500">
                    <p class="text-sm">No questions available.</p>
                </div>
            `;
            return;
        }

        const selectedCount = questions.filter(q => q.selected).length;

        container.innerHTML = `
            <div class="bg-amber-50 rounded-xl border border-amber-200 p-4">
                <div class="mb-3 flex items-center justify-between">
                    <span class="text-xs text-amber-700 font-medium">${selectedCount} of ${questions.length} questions will be included</span>
                    <div class="flex gap-2">
                        <button onclick="toggleAllQuestionsSummary(true)" class="text-xs px-2 py-1 bg-amber-200 hover:bg-amber-300 text-amber-800 rounded transition-colors">
                            Select All
                        </button>
                        <button onclick="toggleAllQuestionsSummary(false)" class="text-xs px-2 py-1 bg-white hover:bg-slate-100 text-slate-700 rounded border border-slate-200 transition-colors">
                            Select None
                        </button>
                    </div>
                </div>
                <div class="space-y-2">
                    ${questions.map((q, idx) => `
                        <div class="flex items-start gap-3 p-3 rounded-lg ${q.selected ? 'bg-white border border-amber-300' : 'bg-amber-100/50 border border-transparent'} transition-all">
                            <input type="checkbox"
                                id="summary-question-${idx}"
                                ${q.selected ? 'checked' : ''}
                                onchange="toggleQuestionSelectionSummary(${idx})"
                                class="mt-1 w-4 h-4 text-amber-600 rounded border-amber-300 focus:ring-amber-500 cursor-pointer">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-medium ${q.selected ? 'text-amber-700 bg-amber-200' : 'text-slate-500 bg-slate-200'} px-2 py-0.5 rounded">Q${idx + 1}</span>
                                </div>
                                <textarea
                                    id="summary-question-text-${idx}"
                                    onchange="updateQuestionTextSummary(${idx}, this.value)"
                                    rows="2"
                                    class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-amber-500 resize-y ${!q.selected ? 'border-slate-200 bg-slate-50 opacity-60' : 'border-amber-200 bg-white'}"
                                    ${!q.selected ? 'disabled' : ''}
                                >${q.text}</textarea>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-3 pt-3 border-t border-amber-200">
                    <button onclick="addCustomQuestionSummary()" class="text-xs px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Add Custom Question
                    </button>
                </div>
            </div>
        `;
    }

    // Toggle selection of a single question in Summary
    function toggleQuestionSelectionSummary(idx) {
        if (state.recommendation.questionsList && state.recommendation.questionsList[idx]) {
            state.recommendation.questionsList[idx].selected = !state.recommendation.questionsList[idx].selected;
            updateQuestionsFromList();
            renderSummaryQuestions();
            debouncedAutoSave();
        }
    }

    // Toggle all questions on/off in Summary
    function toggleAllQuestionsSummary(selectAll) {
        if (state.recommendation.questionsList) {
            state.recommendation.questionsList.forEach(q => q.selected = selectAll);
            updateQuestionsFromList();
            renderSummaryQuestions();
            debouncedAutoSave();
        }
    }

    // Update question text in Summary
    function updateQuestionTextSummary(idx, newText) {
        if (state.recommendation.questionsList && state.recommendation.questionsList[idx]) {
            state.recommendation.questionsList[idx].text = newText;
            updateQuestionsFromList();
            debouncedAutoSave();
        }
    }

    // Add a custom question in Summary
    function addCustomQuestionSummary() {
        if (!state.recommendation.questionsList) {
            state.recommendation.questionsList = [];
        }
        const newIndex = state.recommendation.questionsList.length + 1;
        state.recommendation.questionsList.push({
            id: `q${newIndex}`,
            originalIndex: newIndex, // Track original order (v7.21)
            text: '',
            selected: true
        });
        updateQuestionsFromList();
        renderSummaryQuestions();
        // Focus the new question's textarea
        setTimeout(() => {
            const newIdx = state.recommendation.questionsList.length - 1;
            const textarea = document.getElementById(`summary-question-text-${newIdx}`);
            if (textarea) textarea.focus();
        }, 100);
    }

    // Toggle summary text expansion on Summary page
    function toggleSummaryExpand() {
        const textArea = document.getElementById('summaryTextArea');
        const btn = document.getElementById('summaryExpandBtn');
        if (textArea && btn) {
            const isExpanded = textArea.style.maxHeight !== '80px';
            if (isExpanded) {
                textArea.style.maxHeight = '80px';
                btn.textContent = 'Expand';
            } else {
                textArea.style.maxHeight = 'none';
                btn.textContent = 'Collapse';
            }
        }
    }

    // Helper function to set cell value while preserving formatting (for SheetJS - kept for backward compatibility)
    function setCellValue(sheet, cellAddress, value, type) {
        if (!cellAddress) return;
        const existingCell = sheet[cellAddress] || {};
        sheet[cellAddress] = {
            ...existingCell,
            t: type,
            v: value
        };
    }

    // NEW: ExcelJS-based export that preserves all formatting
    async function exportToExcel() {
        // Validate all scores are entered (check for both undefined AND null)
        const missingScores = CRITERIA.filter(c => state.scores[c.id] === undefined || state.scores[c.id] === null);
        if (missingScores.length > 0) {
            showToast('error', 'Missing Scores', `Please complete scoring for: ${missingScores.map(c => c.id.toUpperCase()).join(', ')}`);
            return;
        }

        if (!state.templateData) {
            showToast('error', 'No Template', 'Please upload a scoring template first.');
            return;
        }

        try {
            showLoading('Exporting to Excel...', 'Preserving template formatting...');
            const sheetMapping = REVIEWER_SHEETS[state.reviewerSheet];
            if (!sheetMapping) {
                throw new Error(`Sheet mapping not found for ${state.reviewerSheet}`);
            }

            // Use ExcelJS to load the original template (preserves ALL formatting)
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(state.templateData);

            // Find the target worksheet
            const worksheet = workbook.getWorksheet(state.reviewerSheet);
            if (!worksheet) {
                throw new Error(`Sheet "${state.reviewerSheet}" not found in workbook`);
            }

            // Helper to parse cell address (e.g., "H36" -> {col: 8, row: 36})
            function parseCellAddress(addr) {
                const match = addr.match(/^([A-Z]+)(\d+)$/);
                if (!match) return null;
                const colLetters = match[1];
                const row = parseInt(match[2]);
                let col = 0;
                for (let i = 0; i < colLetters.length; i++) {
                    col = col * 26 + (colLetters.charCodeAt(i) - 64);
                }
                return { col, row };
            }

            // Write scores - ExcelJS preserves cell formatting automatically
            for (const criterion of CRITERIA) {
                const scoreCell = sheetMapping.scores[criterion.id];
                const commentCell = sheetMapping.comments[criterion.id];

                if (scoreCell && state.scores[criterion.id] !== undefined) {
                    const pos = parseCellAddress(scoreCell);
                    if (pos) {
                        const cell = worksheet.getCell(pos.row, pos.col);
                        cell.value = state.scores[criterion.id];
                        // ExcelJS preserves all existing styling (fill, font, border, etc.)
                    }
                }
                if (commentCell && state.comments[criterion.id]) {
                    const pos = parseCellAddress(commentCell);
                    if (pos) {
                        const cell = worksheet.getCell(pos.row, pos.col);
                        cell.value = state.comments[criterion.id];
                        // Enable word wrap for comments to display properly
                        cell.alignment = { ...cell.alignment, wrapText: true, vertical: 'top' };
                    }
                }
            }

            // Write Project Info fields
            if (sheetMapping.projectInfo) {
                const pi = sheetMapping.projectInfo;

                // Applicant name
                if (pi.applicant && state.projectInfo.applicant) {
                    const pos = parseCellAddress(pi.applicant);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = state.projectInfo.applicant;
                }

                // Project title
                if (pi.project && state.projectInfo.project) {
                    const pos = parseCellAddress(pi.project);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = state.projectInfo.project;
                }

                // Reviewer name
                if (pi.reviewedBy && state.reviewerName) {
                    const pos = parseCellAddress(pi.reviewedBy);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = state.reviewerName;
                }

                // Review date (today's date)
                if (pi.reviewDate) {
                    const pos = parseCellAddress(pi.reviewDate);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = new Date().toLocaleDateString();
                }

                // Amount Requested
                if (pi.amountRequested && state.projectInfo.amountRequested) {
                    const pos = parseCellAddress(pi.amountRequested);
                    if (pos) {
                        const cell = worksheet.getCell(pos.row, pos.col);
                        cell.value = state.projectInfo.amountRequested;
                        cell.numFmt = '"$"#,##0';
                    }
                    // Also write to Completion Checklist E10 so formulas work
                    const checklistSheet = workbook.getWorksheet('Completion Checklist');
                    if (checklistSheet) {
                        const checklistCell = checklistSheet.getCell('E10');
                        checklistCell.value = state.projectInfo.amountRequested;
                        checklistCell.numFmt = '"$"#,##0';
                    }
                }

                // Total Project Cost
                if (pi.totalCost && state.projectInfo.totalCost) {
                    const pos = parseCellAddress(pi.totalCost);
                    if (pos) {
                        const cell = worksheet.getCell(pos.row, pos.col);
                        cell.value = state.projectInfo.totalCost;
                        cell.numFmt = '"$"#,##0';
                    }
                    // Also write to Completion Checklist E11 so formulas work
                    const checklistSheet = workbook.getWorksheet('Completion Checklist');
                    if (checklistSheet) {
                        const checklistCell = checklistSheet.getCell('E11');
                        checklistCell.value = state.projectInfo.totalCost;
                        checklistCell.numFmt = '"$"#,##0';
                    }
                }

                // Clients served
                if (pi.clientsServed && state.projectInfo.clientsServed) {
                    const pos = parseCellAddress(pi.clientsServed);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = state.projectInfo.clientsServed;
                }

                // Project description
                if (pi.projectDescription && state.projectInfo.projectDescription) {
                    const pos = parseCellAddress(pi.projectDescription);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = state.projectInfo.projectDescription;
                }
            }

            // Write Recommendation fields
            if (sheetMapping.recommendation) {
                const rec = sheetMapping.recommendation;

                // Recommendation Yes/No (derived from fundingSource - "None" means No)
                if (rec.yesNo && state.recommendation.fundingSource) {
                    const pos = parseCellAddress(rec.yesNo);
                    if (pos) {
                        const isApproved = state.recommendation.fundingSource !== 'None';
                        worksheet.getCell(pos.row, pos.col).value = isApproved ? 'Yes' : 'No';
                    }
                }

                // Funding source
                if (rec.fundingSource && state.recommendation.fundingSource) {
                    const pos = parseCellAddress(rec.fundingSource);
                    if (pos) worksheet.getCell(pos.row, pos.col).value = state.recommendation.fundingSource;
                }

                // Brief summary (abbreviated version for the header section)
                if (rec.briefSummary && state.recommendation.summaryComments) {
                    const pos = parseCellAddress(rec.briefSummary);
                    if (pos) {
                        // Create abbreviated summary - first 2-3 sentences or key points
                        const fullSummary = state.recommendation.summaryComments;
                        let briefText = '';

                        // Try to extract the recommendation and key reason
                        const isApproved = state.recommendation.fundingSource !== 'None';
                        const recommendText = isApproved ? 'RECOMMEND FOR FUNDING' : 'DO NOT RECOMMEND FOR FUNDING';

                        // Get first meaningful sentence after any header
                        const lines = fullSummary.split('\n').filter(l => l.trim().length > 0);
                        let keyPoints = [];

                        for (const line of lines) {
                            // Skip header lines with ** or all caps
                            if (line.includes('**') || line === line.toUpperCase()) continue;
                            // Get first 2-3 content lines
                            const cleaned = line.replace(/^\d+[\.\)]\s*/, '').trim();
                            if (cleaned.length > 20 && keyPoints.length < 3) {
                                keyPoints.push(cleaned);
                            }
                        }

                        if (keyPoints.length > 0) {
                            briefText = `${recommendText}. ${keyPoints[0]}`;
                            // Truncate to ~200 chars for the cell
                            if (briefText.length > 200) {
                                briefText = briefText.substring(0, 197) + '...';
                            }
                        } else {
                            // Fallback: just use first 200 chars of summary
                            briefText = `${recommendText}. ${fullSummary.substring(0, 150).replace(/\n/g, ' ')}...`;
                        }

                        const cell = worksheet.getCell(pos.row, pos.col);
                        cell.value = briefText;
                        cell.alignment = { wrapText: true, vertical: 'top' };
                    }
                }

                // Summary comments - with word wrap and auto-height
                if (rec.summaryComments && state.recommendation.summaryComments) {
                    const pos = parseCellAddress(rec.summaryComments);
                    if (pos) {
                        const cell = worksheet.getCell(pos.row, pos.col);
                        cell.value = state.recommendation.summaryComments;
                        cell.alignment = { wrapText: true, vertical: 'top' };
                        // Calculate row height based on content (roughly 15 per line, min 100)
                        const lineCount = (state.recommendation.summaryComments.match(/\n/g) || []).length + 1;
                        const charPerLine = 100; // Approximate characters per line in the cell
                        const estimatedLines = Math.ceil(state.recommendation.summaryComments.length / charPerLine);
                        const totalLines = Math.max(lineCount, estimatedLines);
                        worksheet.getRow(pos.row).height = Math.max(100, totalLines * 15);
                    }
                }

                // Questions to applicant - split into separate rows
                if (rec.questionCells && state.recommendation.questions) {
                    const questionsText = state.recommendation.questions;

                    // Split questions by numbered patterns (1., 2., etc.) at line starts
                    // This handles formats like "1. **QUESTION**:" or "1. Question text"
                    const questionParts = questionsText.split(/\n(?=\d+[\.\:\)]\s*)/)
                        .map(q => q.trim())
                        .filter(q => q.length > 0);

                    // If no numbered split found, try splitting by double newlines
                    let cleanedQuestions;
                    if (questionParts.length <= 1 && questionsText.includes('\n\n')) {
                        cleanedQuestions = questionsText.split(/\n\n+/)
                            .map(q => q.trim())
                            .filter(q => q.length > 0);
                    } else {
                        // Clean up each question - remove leading number and clean markdown
                        cleanedQuestions = questionParts.map(q => {
                            // Remove leading "1. " pattern
                            let cleaned = q.replace(/^\d+[\.\:\)]\s*/, '').trim();
                            // Remove markdown bold markers **text** -> text
                            cleaned = cleaned.replace(/\*\*([^*]+)\*\*/g, '$1');
                            return cleaned;
                        }).filter(q => q.length > 0);
                    }

                    // Write each question to its corresponding cell
                    // If more questions than cells, combine extras into the last cell
                    const maxCells = rec.questionCells.length;
                    rec.questionCells.forEach((cellAddr, index) => {
                        const pos = parseCellAddress(cellAddr);
                        if (pos) {
                            let questionText = cleanedQuestions[index] || '';

                            // For the last cell, append any overflow questions
                            if (index === maxCells - 1 && cleanedQuestions.length > maxCells) {
                                const overflow = cleanedQuestions.slice(maxCells);
                                if (overflow.length > 0) {
                                    questionText += '\n\n' + overflow.map((q, i) => `${maxCells + i + 1}. ${q}`).join('\n\n');
                                }
                            }

                            if (questionText) {
                                const cell = worksheet.getCell(pos.row, pos.col);
                                cell.value = questionText;
                                cell.alignment = { wrapText: true, vertical: 'top' };
                                // Calculate row height based on content length
                                const charPerLine = 80;
                                const estimatedLines = Math.ceil(questionText.length / charPerLine);
                                worksheet.getRow(pos.row).height = Math.max(45, estimatedLines * 15);
                            }
                        }
                    });
                }
            }

            // Generate filename
            const projectName = (state.projectInfo.projectName || 'Evaluation').replace(/[^a-zA-Z0-9]/g, '_');
            const date = new Date().toISOString().split('T')[0];
            const filename = `${projectName}_Scored_${date}.xlsx`;

            // Export using ExcelJS - preserves ALL formatting
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Clear draft after successful export
            localStorage.removeItem(CONFIG.AUTO_SAVE_KEY);
            state.hasUnsavedChanges = false;

            hideLoading();
            showToast('success', 'Export Complete', `Saved as ${filename} with formatting preserved!`);
        } catch (error) {
            hideLoading();
            console.error('Export error:', error);
            showErrorModal('Export Failed', `Could not export to Excel: ${error.message}`, () => exportToExcel());
        }
    }

    function startNewEvaluation() {
        if (state.hasUnsavedChanges) {
            if (!confirm('You have unsaved changes. Are you sure you want to start a new evaluation?')) {
                return;
            }
        }

        // Clear localStorage
        localStorage.removeItem(CONFIG.AUTO_SAVE_KEY);

        // Reset state
        state.applicationPdf = null;
        state.applicationText = '';
        state.scoringWorkbook = null;
        state.projectInfo = {};
        state.scores = {};
        state.comments = {};
        state.aiSuggestions = {};
        state.recommendation = {};
        state.currentStep = 'upload';
        state.currentCriterionIndex = 0;
        state.hasUnsavedChanges = false;

        render();
        showToast('info', 'New Evaluation', 'Ready to start a new evaluation.');
    }

    // Initialize the application
    init();
    </script>
</body>
</html>
